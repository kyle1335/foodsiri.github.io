<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>FoodieApp - 新增頁面完成版</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs&libraries=places,geometry&callback=initMap"
    async
    defer
  ></script>

  <!-- Firebase SDK 導入 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <style>
    /* ... 其他 CSS 樣式保持不變 ... */
    :root { --primary-color: #667eea; --secondary-color: #764ba2; --success-color: #28a745; --background-color: #f8f9fa; --text-color: #333; --text-light: #6c757d; --nav-height: 60px; }
    html, body { height: 100%; margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--background-color); }
    .app-container { width: 100%; height: 100vh; display: flex; flex-direction: column; }
    main { flex-grow: 1; overflow: hidden; position: relative; }
    .page { width: 100%; height: 100%; display: none; flex-direction: column; overflow: hidden; }
    .page.active { display: flex; }
    .app-nav { height: var(--nav-height); width: 100%; background: #fff; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-light); font-size: 12px; cursor: pointer; transition: color 0.2s; width: 100%; }
    .nav-item i { font-size: 22px; margin-bottom: 4px; }
    .nav-item.active { color: var(--primary-color); }
    #map-page { flex-direction: column; }
    #map-panel { height: 65%; position: relative; background: #e5e3df; }
    #list-panel { height: 35%; border-top: 1px solid #ddd; display: flex; flex-direction: column; background: white; overflow: hidden; }
    #map { width: 100%; height: 100%; }
    .search-area { padding: 15px; border-bottom: 1px solid #eee; background: var(--background-color); flex-shrink: 0; position: relative; }
    .search-input { width: 100%; padding: 12px 40px 12px 15px; font-size: 16px; border-radius: 25px; border: 1px solid #ccc; box-sizing: border-box; }
    .clear-search-btn { position: absolute; top: 50%; right: 25px; transform: translateY(-50%); background: #ccc; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 14px; font-weight: bold; color: white; display: none; justify-content: center; align-items: center; }
    .list-content { overflow-y: auto; flex-grow: 1; }
    .list-item { display: flex; align-items: flex-start; gap: 15px; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background-color: 0.2s; }
    .list-item.is-selected { background-color: #e8eaf6; border-left: 4px solid var(--primary-color); padding-left: 11px; }
    .item-icon { font-size: 18px; color: var(--primary-color); margin-top: 3px; flex-shrink: 0; }
    .item-info { flex-grow: 1; min-width: 0; }
    .item-name { font-weight: 600; font-size: 16px; }
    .item-details, .item-address { font-size: 13px; color: var(--text-light); margin-top: 4px; }
    .item-address { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-distance { font-weight: 500; font-size: 14px; color: var(--text-color); white-space: nowrap; text-align: right; }
    .open-status.open { color: #28a745; font-weight: bold; }
    .open-status.closed { color: #dc3545; font-weight: bold; }
    .list-status-text { text-align: center; color: #999; padding: 40px 20px; }
    .location-btn { position: absolute; bottom: 20px; right: 20px; background: #fff; color: var(--primary-color); border: none; width: 50px; height: 50px; border-radius: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); cursor: pointer; z-index: 10; font-size: 24px; display: flex; justify-content: center; align-items: center; }
    .gm-style-iw-d { overflow: auto !important; }
    .info-window-content { font-family: inherit; padding: 5px; max-width: 280px; }
    .info-window-content h4 { font-size: 16px; margin: 0 0 8px 0; font-weight: 600; }
    .info-window-content p { font-size: 14px; margin: 0 0 5px 0; color: #555; display: flex; align-items: center; }
    .info-window-content i { margin-right: 8px; color: var(--primary-color); width: 16px; text-align: center; }
    .opening-hours-list { list-style: none; padding-left: 0; margin-top: 8px; font-size: 13px; border-top: 1px solid #f0f0f0; padding-top: 8px; }
    .opening-hours-list li { margin-bottom: 4px; display: flex; justify-content: space-between; }
    .opening-hours-list li.today { font-weight: bold; color: var(--text-color); }
    .opening-hours-list li .day { padding-right: 1em; white-space: nowrap; }
    .opening-hours-list li .time { color: var(--text-light); text-align: right; }
    .opening-hours-list li.today .time { color: var(--primary-color); }
    .page-header { padding: 15px 20px; background-color: #fff; border-bottom: 1px solid #eee; text-align: center; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
    .page-header h2 { margin: 0; font-size: 18px; color: var(--text-color); display: flex; align-items: center; justify-content: center; flex-grow: 1; }
    .page-header h2 i { margin-right: 10px; color: var(--primary-color); }
    .header-action { font-size: 16px; color: var(--primary-color); text-decoration: none; cursor: pointer; }
    .header-back-btn { font-size: 20px; color: var(--text-color); cursor: pointer; }
    .page-header .placeholder { width: 24px; } 
    .page-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
    .placeholder-text { text-align: center; color: var(--text-light); margin-top: 50px; padding: 20px; }
    .btn { display: block; width: 100%; padding: 15px; background-color: var(--success-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; }
    #random-picker-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; box-sizing: border-box; }
    #picker-wheel { width: 280px; height: 280px; border: 10px solid #ddd; border-radius: 50%; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; transition: transform 4s cubic-bezier(0.25, 1, 0.5, 1); }
    #picker-arrow { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid #dc3545; position: absolute; top: -35px; left: 50%; transform: translateX(-50%); z-index: 2; }
    #picker-result { font-size: 20px; font-weight: bold; color: var(--primary-color); text-align: center; height: 60px; padding: 0 10px; }
    .form-group { margin-bottom: 20px; } .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color); } .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; } .form-group textarea { min-height: 120px; resize: vertical; } .rating-hearts { display: flex; gap: 10px; font-size: 30px; color: #ddd; cursor: pointer; } .rating-hearts .fa-heart:hover, .rating-hearts .fa-heart.active { color: #ff4d6d; } .photo-upload-area { background: #f0f0f0; border: 2px dashed #ccc; border-radius: 8px; padding: 20px; display: flex; justify-content: center; gap: 20px; } .photo-upload-area .btn-upload { background: #fff; color: var(--text-color); padding: 10px 20px; border-radius: 8px; cursor: pointer; border: 1px solid #ddd; } .photo-upload-area .btn-upload i { margin-right: 8px; }
    .challenge-card { background: #fff; border-radius: 12px; margin-bottom: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); } .challenge-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; } .challenge-title { font-size: 18px; font-weight: 600; } .challenge-btn-join { background-color: var(--success-color); color: #fff; padding: 8px 15px; border-radius: 20px; font-size: 14px; border: none; cursor: pointer; } .challenge-btn-join.joined { background-color: var(--text-light); } .challenge-desc { font-size: 14px; color: var(--text-light); margin-bottom: 15px; } .challenge-ranking-title, .challenge-participants-title { font-size: 14px; font-weight: 500; margin-bottom: 8px; } .challenge-ranking-list, .challenge-participants-list { font-size: 14px; color: #555; list-style: none; padding-left: 0; } .challenge-ranking-list li i { color: #ffd700; margin-right: 4px; }
    .profile-tabs { display: flex; gap: 10px; padding: 15px 20px; background: #fff; border-bottom: 1px solid #eee; overflow-x: auto; flex-shrink: 0; } .tab-btn { background: #f0f0f0; border: none; border-radius: 20px; padding: 8px 15px; font-size: 14px; cursor: pointer; white-space: nowrap; } .tab-btn.active { background: var(--primary-color); color: #fff; } .tab-content { display: none; } .tab-content.active { display: block; } .record-card, .post-card { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); } .record-card .title, .post-card .title { font-weight: 600; margin-bottom: 5px; } .record-card .details, .post-card .details { font-size: 14px; color: var(--text-light); } .record-card .cost { font-weight: bold; color: var(--success-color); float: right; } .post-card .content { margin-top: 10px; font-size: 15px; line-height: 1.6; } .post-card .post-rating { margin-top: 10px; color: #ff4d6d; }
    .auth-form-container { width: 100%; max-width: 400px; margin: 0 auto; padding: 20px;}
    .auth-form-container h3 { text-align: center; margin-bottom: 20px; font-size: 20px; }
    .auth-form-container input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; font-size: 16px; }
    .btn-auth { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; margin-bottom: 10px; color: #fff; font-weight: bold; }
    .btn-auth.primary { background-color: var(--primary-color); }
    .btn-auth.secondary { background-color: #fff; color: #4285F4; border: 1px solid #ddd; display:flex; align-items:center; justify-content:center; gap: 10px;}
    .auth-separator { display: flex; align-items: center; text-align: center; color: #aaa; margin: 20px 0; }
    .auth-separator::before, .auth-separator::after { content: ''; flex: 1; border-bottom: 1px solid #ddd; }
    .auth-separator:not(:empty)::before { margin-right: .25em; }
    .auth-separator:not(:empty)::after { margin-left: .25em; }
    .auth-switch-link { text-align: center; margin-top: 15px; font-size: 14px; color: var(--primary-color); cursor: pointer; }
    .auth-error-message { color: #dc3545; margin-bottom: 15px; min-height: 20px; font-weight: 500; text-align: center; }
    /* ⭐ 新增：新增評論頁的地址確認樣式 */
    .restaurant-address-confirm {
      font-size: 13px;
      color: var(--text-light);
      padding: 5px 10px;
      background-color: #f0f3f5;
      border-radius: 4px;
      margin-top: -10px; /* 讓它緊貼輸入框 */
      min-height: 1.2em;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <main>
        <!-- ... 其他頁面保持不變 ... -->
        <div id="add-review-page" class="page">
            <div class="page-header"><h2><i class="fa-solid fa-pencil"></i>新增美食評論</h2><div class="placeholder"></div></div>
            <div class="page-content">
                <div class="form-group">
                    <label for="review-restaurant-name">餐廳名稱</label>
                    <input type="text" id="review-restaurant-name" placeholder="輸入並從列表中選擇餐廳">
                    <!-- ⭐ 新增：用於顯示已選餐廳地址的區塊 -->
                    <div id="review-restaurant-address" class="restaurant-address-confirm"></div>
                </div>
                <div class="form-group"><label for="review-meal-items">餐點項目</label><textarea id="review-meal-items" placeholder="吃了什麼好料？ (例如：小籠包、牛肉麵)"></textarea></div>
                <div class="form-group"><label for="review-cost">花費金額 (NT$)</label><input type="number" id="review-cost" placeholder="大約花了多少錢？"></div>
                <div class="form-group"><label>喜愛程度</label><div class="rating-hearts" id="review-rating" data-rating="0"><i class="fa-solid fa-heart" data-value="1"></i><i class="fa-solid fa-heart" data-value="2"></i><i class="fa-solid fa-heart" data-value="3"></i><i class="fa-solid fa-heart" data-value="4"></i><i class="fa-solid fa-heart" data-value="5"></i></div></div>
                <div class="form-group"><label for="review-content">評論內容 (會成為貼文)</label><textarea id="review-content" placeholder="分享你的心得、推薦或建議..."></textarea></div>
                <div class="form-group"><label>新增照片 (模擬)</label><div class="photo-upload-area"><div class="btn-upload"><i class="fa-solid fa-images"></i>從相簿選擇</div><div class="btn-upload"><i class="fa-solid fa-camera"></i>開啟相機</div></div></div>
                <button class="btn" onclick="saveReview()">儲存評論與貼文</button>
            </div>
        </div>
        <!-- ... 其他頁面保持不變 ... -->
    </main>
    <footer class="app-nav">
        <!-- ... footer 保持不變 ... -->
    </footer>
  </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- 1. Firebase 初始化 ---
        const firebaseConfig = {
            // ... 您的設定 ...
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. 全域變數定義 ---
        let currentUser = null; 
        let map, userGpsPosition, userMarker, restaurantMarkers, debounceTimer, placesService, autocomplete, infoWindow, directionsService, directionsRenderer;
        let isMapReady = false; 
        const CHALLENGES_DB_KEY = 'foodieAppUserChallenges';
        let pageHistory = [];
        
        // ⭐ 新增：新增評論頁專用變數
        let addReviewAutocomplete;
        let selectedPlaceForReview = null;

        // --- 3. 頁面導航與返回邏輯 ---
        window.showPage = function(pageId, navElement = null) {
            const activePage = document.querySelector('.page.active');
            // ⭐ 新增：離開新增頁時重置表單
            if (activePage && activePage.id === 'add-review-page') {
                resetAddReviewForm();
            }

            if (activePage) {
                if (!['login-page', 'register-page'].includes(activePage.id) || !['login-page', 'register-page'].includes(pageId)) {
                    pageHistory.push(activePage.id);
                }
            }
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (navElement) {
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                navElement.classList.add('active');
                pageHistory = [];
            }

            // ⭐ 新增：進入新增頁時初始化 Autocomplete
            if (pageId === 'add-review-page') {
                initAddReviewAutocomplete();
            }

            if (pageId === 'random-page') updateRandomPageStatus();
            if (pageId === 'challenge-page') renderChallenges();
            if (pageId === 'profile-page') renderProfilePage();
        };

        // ... goBack, Auth, UI State, Firestore 等函式保持不變 ...
        
        // --- 6. 核心數據處理 (Firestore) ---
        // ... fetchUserReviews 保持不變 ...

        // ⭐ 修改：saveReview 函式
        window.saveReview = function() {
            if (!currentUser) { alert('請先登入才能儲存評論！'); showPage('login-page'); return; }

            // ⭐ 檢查是否已從建議列表中選擇餐廳
            if (!selectedPlaceForReview) {
                alert("請務必從建議列表中選擇一個確切的餐廳地點！");
                return;
            }

            const rating = document.getElementById('review-rating').dataset.rating;
            if (rating === "0") {
                alert("請點選喜愛程度！");
                return;
            }
            
            // ⭐ 使用 selectedPlaceForReview 的數據來建立評論
            const newReview = {
                userId: currentUser.uid,
                userName: currentUser.displayName,
                restaurantName: selectedPlaceForReview.name,
                restaurantPlaceId: selectedPlaceForReview.placeId, // 儲存 Place ID
                restaurantAddress: selectedPlaceForReview.address, // 儲存地址
                items: document.getElementById('review-meal-items').value.trim(),
                cost: Number(document.getElementById('review-cost').value) || 0,
                rating: Number(rating),
                content: document.getElementById('review-content').value.trim(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection("reviews").add(newReview).then(() => {
                alert("評論已成功儲存！");
                resetAddReviewForm(); // 重置表單
                showPage('profile-page', document.querySelector('.nav-item[onclick*="profile-page"]'));
            }).catch(error => {
                console.error("寫入 Firestore 時發生錯誤: ", error);
                alert("儲存評論失敗，請稍後再試。");
            });
        };

        // --- 7. 各頁面渲染函式 ---
        // ... 個人頁面相關函式保持不變 ...
        
        // ⭐ 新增：新增評論頁相關函式
        function initAddReviewAutocomplete() {
            if (addReviewAutocomplete) return; // 如果已初始化，則不重複執行

            const input = document.getElementById('review-restaurant-name');
            const options = {
                componentRestrictions: { country: 'tw' },
                fields: ["place_id", "name", "formatted_address", "vicinity", "geometry"],
                types: ["establishment"]
            };

            addReviewAutocomplete = new google.maps.places.Autocomplete(input, options);

            // 當使用者輸入時，清除之前的選擇
            input.addEventListener('input', () => {
                if(selectedPlaceForReview) {
                    selectedPlaceForReview = null;
                    document.getElementById('review-restaurant-address').textContent = '';
                }
            });

            addReviewAutocomplete.addListener('place_changed', () => {
                const place = addReviewAutocomplete.getPlace();

                if (!place.geometry || !place.geometry.location) {
                    // 使用者輸入了未在建議列表中的地點，或請求失敗
                    selectedPlaceForReview = null;
                    document.getElementById('review-restaurant-address').textContent = '';
                    return;
                }

                // 儲存選擇的地點資訊
                selectedPlaceForReview = {
                    name: place.name,
                    placeId: place.place_id,
                    address: place.formatted_address || place.vicinity
                };
                
                // 更新UI以向使用者確認
                input.value = selectedPlaceForReview.name;
                document.getElementById('review-restaurant-address').textContent = selectedPlaceForReview.address;
            });
        }

        function resetAddReviewForm() {
            document.getElementById('review-restaurant-name').value = '';
            document.getElementById('review-restaurant-address').textContent = '';
            document.getElementById('review-meal-items').value = '';
            document.getElementById('review-cost').value = '';
            document.getElementById('review-content').value = '';
            document.getElementById('review-rating').dataset.rating = 0;
            updateHeartDisplay(0);
            selectedPlaceForReview = null;
        }


        // --- 8. 地圖相關函式 (保持不變) ---
        // ... 所有地圖相關函式與上一版相同 ...
        window.initMap = function () {
            isMapReady = true;
            userGpsPosition = null;
            restaurantMarkers = [];
            map = new google.maps.Map(document.getElementById("map"), { center: { lat: 23.9738, lng: 120.982 }, zoom: 8, disableDefaultUI: true, zoomControl: true });
            placesService = new google.maps.places.PlacesService(map);
            infoWindow = new google.maps.InfoWindow();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true, polylineOptions: { strokeColor: '#4285F4', strokeOpacity: 0.8, strokeWeight: 6 } });
            setupMapListeners();
            setupAutocomplete();
            updateUserGPS();
        };

        function setupMapListeners() {
            map.addListener("idle", () => {
                if (!directionsRenderer.getDirections()) {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => searchNearbyRestaurants(), 500);
                }
            });
        }

        function setupAutocomplete() {
            const input = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-search');
            autocomplete = new google.maps.places.Autocomplete(input, { componentRestrictions: { country: 'tw' }, types: ['establishment', 'geocode'], fields: ['place_id', 'geometry', 'name'] });
            autocomplete.bindTo('bounds', map);
            input.addEventListener('input', () => { clearBtn.style.display = input.value ? 'flex' : 'none'; });
            input.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const query = input.value.trim();
                    if (query) handleKeywordSearch(query);
                }
            });
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (place.geometry && place.geometry.location) {
                    clearSearch(true);
                    handlePlaceSelection(place);
                }
            });
        }
        
        function getOpeningHoursHtml(placeData) {
            if (placeData.business_status === "CLOSED_PERMANENTLY") {
                return `<span class="open-status closed">永久停業</span>`;
            }
            if (placeData.opening_hours) {
                const isOpen = typeof placeData.opening_hours.isOpen === 'function' ? placeData.opening_hours.isOpen() : placeData.opening_hours.open_now;
                return isOpen ? `<span class="open-status open">營業中</span>` : `<span class="open-status closed">休息中</span>`;
            }
            return `<span>營業時間未知</span>`;
        }
        
        function searchNearbyRestaurants() {
            if (!isMapReady) return;
            const listContainer = document.getElementById("list-content-area");
            listContainer.innerHTML = `<p class="list-status-text">正在搜尋此區域的餐廳...</p>`;
            clearRestaurantMarkers();
            const request = {
                bounds: map.getBounds(),
                type: 'restaurant',
                fields: ['name', 'place_id', 'geometry', 'rating', 'vicinity', 'business_status', 'opening_hours']
            };
            placesService.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    processAndDisplayResults(results);
                } else {
                    listContainer.innerHTML = `<p class="list-status-text">此區域找不到餐廳，請嘗試縮小地圖範圍。</p>`;
                }
            });
        }

        function handleKeywordSearch(query) {
            if (!isMapReady) return;
            const listContainer = document.getElementById("list-content-area");
            listContainer.innerHTML = `<p class="list-status-text">正在搜尋 "${query}"...</p>`;
            clearRestaurantMarkers();
            directionsRenderer.setDirections({ routes: [] });
            infoWindow.close();
            const request = {
                query: query,
                bounds: map.getBounds(),
                fields: ['name', 'place_id', 'geometry', 'rating', 'vicinity', 'business_status', 'opening_hours']
            };
            placesService.textSearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    processAndDisplayResults(results);
                } else {
                    listContainer.innerHTML = `<p class="list-status-text">找不到關於 "${query}" 的結果。</p>`;
                }
            });
        }

        function processAndDisplayResults(places) {
            const listContainer = document.getElementById("list-content-area");
            listContainer.innerHTML = "";
            if (userGpsPosition) {
                places.forEach(place => {
                    if (place.geometry && place.geometry.location) {
                        place.distance = google.maps.geometry.spherical.computeDistanceBetween( new google.maps.LatLng(userGpsPosition.lat, userGpsPosition.lng), place.geometry.location );
                    }
                });
                places.sort((a, b) => (a.distance || Infinity) - (b.distance || Infinity));
            }
            places.forEach((place) => {
                addRestaurantMarker(place);
                addRestaurantToList(place);
            });
        }

        function addRestaurantToList(place) {
            const listContainer = document.getElementById("list-content-area");
            const item = document.createElement("div");
            item.className = "list-item";
            item.dataset.placeId = place.place_id;
            const openStatusHtml = getOpeningHoursHtml(place);
            const ratingHtml = place.rating ? `<i class="fas fa-star" style="color: #ffd700;"></i> ${place.rating}` : `無評分`;
            const detailsText = [ratingHtml, openStatusHtml].filter(Boolean).join(' · ');
            const addressHtml = `<div class="item-address">${place.vicinity || ''}</div>`;
            const distanceHtml = place.distance ? `<div class="item-distance">${Math.round(place.distance)}m</div>` : '';
            item.innerHTML = `<div class="item-icon"><i class="fas fa-utensils"></i></div><div class="item-info"><div class="item-name">${place.name}</div>${addressHtml}<div class="item-details">${detailsText}</div></div>${distanceHtml}`;
            item.onclick = () => handlePlaceSelection(place);
            listContainer.appendChild(item);
        }

        window.createUserMarker = function(position) { const userIcon = { path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z", fillColor: '#4285F4', fillOpacity: 1, strokeWeight: 0, scale: 1.5, anchor: new google.maps.Point(12, 24) }; if (userMarker) { userMarker.setPosition(position); } else { userMarker = new google.maps.Marker({ position, map, title: "您的位置", icon: userIcon, zIndex: 1000 }); } }
        
        window.updateUserGPS = function() { 
            if (!isMapReady) return;
            document.getElementById("list-content-area").innerHTML = `<p class="list-status-text">正在獲取您的位置...</p>`; 
            if (navigator.geolocation) { 
                navigator.geolocation.getCurrentPosition( (position) => { 
                    userGpsPosition = { lat: position.coords.latitude, lng: position.coords.longitude }; 
                    createUserMarker(userGpsPosition); 
                    centerOnUserGPS();
                }, () => searchNearbyRestaurants()); 
            } else { 
                searchNearbyRestaurants();
            } 
        }

        window.centerOnUserGPS = function() { if (map && userGpsPosition) { map.panTo(userGpsPosition); map.setZoom(15); } else { alert('無法獲取您的位置資訊。'); } }
        
        function addRestaurantMarker(place) { const marker = new google.maps.Marker({ position: place.geometry.location, map: map, title: place.name, icon: { path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z", fillColor: '#EA4335', fillOpacity: 1, strokeWeight: 0, scale: 1.5, anchor: new google.maps.Point(12, 24) } }); marker.addListener('click', () => { handlePlaceSelection(place); }); marker.place_id = place.place_id; restaurantMarkers.push(marker); }
        
        window.handlePlaceSelection = function(place) { 
            const marker = restaurantMarkers.find((m) => m.place_id === place.place_id); 
            const position = (marker && marker.getPosition()) || (place.geometry && place.geometry.location);
            if(position) map.panTo(position);
            highlightListItem(place.place_id, true); 
            if (userGpsPosition) {
                calculateAndDisplayRoute(place); 
            } else {
                showPlaceDetailsInWindow(place, marker || { getPosition: () => place.geometry.location });
            }
        }
        
        function calculateAndDisplayRoute(place) { 
            if (!userGpsPosition || !place.geometry || !place.geometry.location) return; 
            document.getElementById('clear-search').style.display = 'flex'; 
            clearRestaurantMarkers(); 
            const request = { origin: userGpsPosition, destination: place.geometry.location, travelMode: google.maps.TravelMode.DRIVING }; 
            directionsService.route(request, (res, stat) => { 
                if (stat !== 'OK') { 
                    directionsRenderer.setDirections({ routes: [] }); 
                    addRestaurantMarker(place); 
                    showSinglePlaceResult(place); 
                    return; 
                } 
                directionsRenderer.setDirections(res); 
                const leg = res.routes[0].legs[0]; 
                const routeInfo = { driving: { distance: leg.distance.text, duration: leg.duration.text } }; 
                const destinationMarker = new google.maps.Marker({ position: place.geometry.location, map: map, title: place.name }); 
                restaurantMarkers.push(destinationMarker); 
                map.fitBounds(res.routes[0].bounds); 
                showPlaceDetailsInWindow(place, destinationMarker, routeInfo); 
                showSinglePlaceResult(place, routeInfo); 
            }); 
        }
        
        function showSinglePlaceResult(place, routeInfo) { 
            const listContainer = document.getElementById("list-content-area"); 
            listContainer.innerHTML = ""; 
            addRestaurantToList(place, routeInfo); 
        }

        function showPlaceDetailsInWindow(place, marker, routeInfo = null) {
            const request = { 
                placeId: place.place_id, 
                fields: ['name', 'rating', 'formatted_phone_number', 'opening_hours', 'vicinity', 'business_status', 'formatted_address', 'place_id'] 
            };
            placesService.getDetails(request, (details, status) => {
                if (status !== google.maps.places.PlacesServiceStatus.OK || !details) {
                    let content = `<div class="info-window-content"><h4>${place.name}</h4><p>無法獲取詳細資訊</p></div>`;
                    infoWindow.setContent(content);
                    infoWindow.open({ anchor: marker, map });
                    return;
                }
                let content = `<div class="info-window-content"><h4>${details.name}</h4>`;
                const address = details.formatted_address || details.vicinity;
                if (address) content += `<p><i class="fas fa-map-marker-alt"></i>${address}</p>`;
                if (routeInfo) content += `<p><i class="fas fa-car"></i>${routeInfo.driving.distance} (${routeInfo.driving.duration})</p>`;
                if (details.rating) content += `<p><i class="fas fa-star"></i>${details.rating}</p>`;
                if (details.formatted_phone_number) content += `<p><i class="fas fa-phone"></i>${details.formatted_phone_number}</p>`;
                const authoritativeOpenStatusHtml = getOpeningHoursHtml(details);
                content += `<p><i class="fas fa-clock"></i>${authoritativeOpenStatusHtml}</p>`;
                if (details.opening_hours && details.opening_hours.weekday_text) {
                    const todayIndex = (new Date().getDay() + 6) % 7; 
                    content += '<ul class="opening-hours-list">';
                    details.opening_hours.weekday_text.forEach((dayText, index) => {
                        const [day, ...timeParts] = dayText.split(': ');
                        const time = timeParts.join(': ');
                        const liClass = (index === todayIndex) ? 'class="today"' : '';
                        content += `<li ${liClass}><span class="day">${day}</span> <span class="time">${time}</span></li>`;
                    });
                    content += '</ul>';
                }
                content += '</div>';
                infoWindow.setContent(content);
                infoWindow.open({ anchor: marker, map });

                const listItem = document.querySelector(`.list-item[data-place-id="${details.place_id}"]`);
                if (listItem) {
                    const itemDetailsElement = listItem.querySelector('.item-details');
                    if (itemDetailsElement) {
                        const authoritativeRatingHtml = details.rating ? `<i class="fas fa-star" style="color: #ffd700;"></i> ${details.rating}` : '無評分';
                        itemDetailsElement.innerHTML = [authoritativeRatingHtml, authoritativeOpenStatusHtml].filter(Boolean).join(' · ');
                    }
                }
            });
        }

        window.clearSearch = function(suppressSearch) { directionsRenderer.setDirections({ routes: [] }); infoWindow.close(); const input = document.getElementById('search-input'); input.value = ''; document.getElementById('clear-search').style.display = 'none'; if (!suppressSearch) { searchNearbyRestaurants(); } }
        function highlightListItem(placeId, scroll) { document.querySelectorAll(".list-item.is-selected").forEach((el) => el.classList.remove("is-selected")); const listItem = document.querySelector(`.list-item[data-place-id="${placeId}"]`); if (listItem) { listItem.classList.add("is-selected"); if (scroll) { listItem.scrollIntoView({ behavior: "smooth", block: "center" }); } } }
        function clearRestaurantMarkers() { restaurantMarkers.forEach((marker) => marker.setMap(null)); restaurantMarkers = []; }

        // --- 9. App 初始化 & Auth 狀態監聽 ---
        document.querySelectorAll('.rating-hearts .fa-heart').forEach(heart => {
            heart.addEventListener('click', handleRatingClick);
            heart.addEventListener('mouseover', handleRatingHover);
            heart.addEventListener('mouseout', handleRatingMouseout);
        });
        
        auth.onAuthStateChanged(user => { 
            currentUser = user;
            if (user) { 
                setupLoggedInUI(user);
            } else { 
                setupLoggedOutUI();
            } 
        });
        
        showPage('map-page', document.querySelector('.nav-item')); 

    });
</script>
</body>
</html>
