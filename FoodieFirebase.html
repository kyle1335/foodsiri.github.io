<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>FoodieApp - 智慧營業狀態版</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs&libraries=places,geometry&callback=initMap"
    async
    defer
  ></script>

  <!-- Firebase SDK 導入 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <style>
    /* CSS 樣式保持不變 */
    :root { --primary-color: #667eea; --secondary-color: #764ba2; --success-color: #28a745; --background-color: #f8f9fa; --text-color: #333; --text-light: #6c757d; --nav-height: 60px; }
    html, body { height: 100%; margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--background-color); }
    .app-container { width: 100%; height: 100vh; display: flex; flex-direction: column; }
    main { flex-grow: 1; overflow: hidden; position: relative; }
    .page { width: 100%; height: 100%; display: none; flex-direction: column; overflow: hidden; }
    .page.active { display: flex; }
    .app-nav { height: var(--nav-height); width: 100%; background: #fff; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-light); font-size: 12px; cursor: pointer; transition: color 0.2s; width: 100%; }
    .nav-item i { font-size: 22px; margin-bottom: 4px; }
    .nav-item.active { color: var(--primary-color); }
    #map-page { flex-direction: column; }
    #map-panel { height: 65%; position: relative; background: #e5e3df; }
    #list-panel { height: 35%; border-top: 1px solid #ddd; display: flex; flex-direction: column; background: white; overflow: hidden; }
    #map { width: 100%; height: 100%; }
    .search-area { padding: 15px; border-bottom: 1px solid #eee; background: var(--background-color); flex-shrink: 0; position: relative; }
    .search-input { width: 100%; padding: 12px 40px 12px 15px; font-size: 16px; border-radius: 25px; border: 1px solid #ccc; box-sizing: border-box; }
    .clear-search-btn { position: absolute; top: 50%; right: 25px; transform: translateY(-50%); background: #ccc; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 14px; font-weight: bold; color: white; display: none; justify-content: center; align-items: center; }
    .list-content { overflow-y: auto; flex-grow: 1; }
    .list-item { display: flex; align-items: flex-start; gap: 15px; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background-color 0.2s; }
    .list-item.is-selected { background-color: #e8eaf6; border-left: 4px solid var(--primary-color); padding-left: 11px; }
    .item-icon { font-size: 18px; color: var(--primary-color); margin-top: 3px; flex-shrink: 0; }
    .item-info { flex-grow: 1; min-width: 0; }
    .item-name { font-weight: 600; font-size: 16px; }
    .item-details, .item-address { font-size: 13px; color: var(--text-light); margin-top: 4px; }
    .item-address { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-distance { font-weight: 500; font-size: 14px; color: var(--text-color); white-space: nowrap; text-align: right; }
    .open-status.open { color: #28a745; font-weight: bold; }
    .open-status.closed { color: #dc3545; font-weight: bold; }
    .list-status-text { text-align: center; color: #999; padding: 40px 20px; }
    .location-btn { position: absolute; bottom: 20px; right: 20px; background: #fff; color: var(--primary-color); border: none; width: 50px; height: 50px; border-radius: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); cursor: pointer; z-index: 10; font-size: 24px; display: flex; justify-content: center; align-items: center; }
    .gm-style-iw-d { overflow: auto !important; }
    .info-window-content { font-family: inherit; padding: 5px; max-width: 280px; }
    .info-window-content h4 { font-size: 16px; margin: 0 0 8px 0; font-weight: 600; }
    .info-window-content p { font-size: 14px; margin: 0 0 5px 0; color: #555; display: flex; align-items: center; }
    .info-window-content i { margin-right: 8px; color: var(--primary-color); width: 16px; text-align: center; }
    .opening-hours-list { list-style: none; padding-left: 0; margin-top: 8px; font-size: 13px; border-top: 1px solid #f0f0f0; padding-top: 8px; }
    .opening-hours-list li { margin-bottom: 4px; display: flex; justify-content: space-between; }
    .opening-hours-list li.today { font-weight: bold; color: var(--text-color); }
    .opening-hours-list li .day { padding-right: 1em; white-space: nowrap; }
    .opening-hours-list li .time { color: var(--text-light); text-align: right; }
    .opening-hours-list li.today .time { color: var(--primary-color); }
    .page-header { padding: 15px 20px; background-color: #fff; border-bottom: 1px solid #eee; text-align: center; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
    .page-header h2 { margin: 0; font-size: 18px; color: var(--text-color); display: flex; align-items: center; justify-content: center; flex-grow: 1; }
    .page-header h2 i { margin-right: 10px; color: var(--primary-color); }
    .header-action { font-size: 16px; color: var(--primary-color); text-decoration: none; cursor: pointer; }
    .header-back-btn { font-size: 20px; color: var(--text-color); cursor: pointer; }
    .page-header .placeholder { width: 24px; } 
    .page-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
    .placeholder-text { text-align: center; color: var(--text-light); margin-top: 50px; padding: 20px; }
    .btn { display: block; width: 100%; padding: 15px; background-color: var(--success-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; }
    #random-picker-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; box-sizing: border-box; }
    #picker-wheel { width: 280px; height: 280px; border: 10px solid #ddd; border-radius: 50%; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; transition: transform 4s cubic-bezier(0.25, 1, 0.5, 1); }
    #picker-arrow { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid #dc3545; position: absolute; top: -35px; left: 50%; transform: translateX(-50%); z-index: 2; }
    #picker-result { font-size: 20px; font-weight: bold; color: var(--primary-color); text-align: center; height: 60px; padding: 0 10px; }
    .form-group { margin-bottom: 20px; } .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color); } .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; } .form-group textarea { min-height: 120px; resize: vertical; } .rating-hearts { display: flex; gap: 10px; font-size: 30px; color: #ddd; cursor: pointer; } .rating-hearts .fa-heart:hover, .rating-hearts .fa-heart.active { color: #ff4d6d; } .photo-upload-area { background: #f0f0f0; border: 2px dashed #ccc; border-radius: 8px; padding: 20px; display: flex; justify-content: center; gap: 20px; } .photo-upload-area .btn-upload { background: #fff; color: var(--text-color); padding: 10px 20px; border-radius: 8px; cursor: pointer; border: 1px solid #ddd; } .photo-upload-area .btn-upload i { margin-right: 8px; }
    .challenge-card { background: #fff; border-radius: 12px; margin-bottom: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); } .challenge-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; } .challenge-title { font-size: 18px; font-weight: 600; } .challenge-btn-join { background-color: var(--success-color); color: #fff; padding: 8px 15px; border-radius: 20px; font-size: 14px; border: none; cursor: pointer; } .challenge-btn-join.joined { background-color: var(--text-light); } .challenge-desc { font-size: 14px; color: var(--text-light); margin-bottom: 15px; } .challenge-ranking-title, .challenge-participants-title { font-size: 14px; font-weight: 500; margin-bottom: 8px; } .challenge-ranking-list, .challenge-participants-list { font-size: 14px; color: #555; list-style: none; padding-left: 0; } .challenge-ranking-list li i { color: #ffd700; margin-right: 4px; }
    .profile-tabs { display: flex; gap: 10px; padding: 15px 20px; background: #fff; border-bottom: 1px solid #eee; overflow-x: auto; flex-shrink: 0; } .tab-btn { background: #f0f0f0; border: none; border-radius: 20px; padding: 8px 15px; font-size: 14px; cursor: pointer; white-space: nowrap; } .tab-btn.active { background: var(--primary-color); color: #fff; } .tab-content { display: none; } .tab-content.active { display: block; } .record-card, .post-card { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); } .record-card .title, .post-card .title { font-weight: 600; margin-bottom: 5px; } .record-card .details, .post-card .details { font-size: 14px; color: var(--text-light); } .record-card .cost { font-weight: bold; color: var(--success-color); float: right; } .post-card .content { margin-top: 10px; font-size: 15px; line-height: 1.6; } .post-card .post-rating { margin-top: 10px; color: #ff4d6d; }
    .auth-form-container { width: 100%; max-width: 400px; margin: 0 auto; padding: 20px;}
    .auth-form-container h3 { text-align: center; margin-bottom: 20px; font-size: 20px; }
    .auth-form-container input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; font-size: 16px; }
    .btn-auth { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; margin-bottom: 10px; color: #fff; font-weight: bold; }
    .btn-auth.primary { background-color: var(--primary-color); }
    .btn-auth.secondary { background-color: #fff; color: #4285F4; border: 1px solid #ddd; display:flex; align-items:center; justify-content:center; gap: 10px;}
    .auth-separator { display: flex; align-items: center; text-align: center; color: #aaa; margin: 20px 0; }
    .auth-separator::before, .auth-separator::after { content: ''; flex: 1; border-bottom: 1px solid #ddd; }
    .auth-separator:not(:empty)::before { margin-right: .25em; }
    .auth-separator:not(:empty)::after { margin-left: .25em; }
    .auth-switch-link { text-align: center; margin-top: 15px; font-size: 14px; color: var(--primary-color); cursor: pointer; }
    .auth-error-message { color: #dc3545; margin-bottom: 15px; min-height: 20px; font-weight: 500; text-align: center; }
    .restaurant-address-confirm { font-size: 13px; color: var(--text-light); padding: 5px 10px; background-color: #f0f3f5; border-radius: 4px; margin-top: -10px; min-height: 1.2em; }
  </style>
</head>
<body>
  <div class="app-container">
    <main>
      <div id="map-page" class="page active">
        <div id="map-panel">
          <div id="map"></div>
          <button class="location-btn" onclick="updateUserGPS(true)"><i class="fas fa-location-arrow"></i></button>
        </div>
        <div id="list-panel">
          <div class="search-area">
            <input type="text" id="search-input" class="search-input" placeholder="搜尋餐廳或地點 (按 Enter 搜尋)">
            <button class="clear-search-btn" id="clear-search" onclick="clearSearch()">×</button>
          </div>
          <div class="list-content" id="list-content-area"><p class="list-status-text">正在初始化地圖...</p></div>
        </div>
      </div>
      <!-- Other pages HTML structures are unchanged -->
    </main>
    <footer class="app-nav">
      <!-- Footer HTML structure is unchanged -->
    </footer>
  </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ... (Sections 1-7 remain unchanged) ...
        
        // --- 8. 地圖相關函式 (包含最新修改) ---
        window.initMap = function () {
            isMapReady = true;
            userGpsPosition = null;
            restaurantMarkers = [];
            map = new google.maps.Map(document.getElementById("map"), { center: { lat: 23.9738, lng: 120.982 }, zoom: 8, disableDefaultUI: true, zoomControl: true });
            placesService = new google.maps.places.PlacesService(map);
            infoWindow = new google.maps.InfoWindow();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true, polylineOptions: { strokeColor: '#4285F4', strokeOpacity: 0.8, strokeWeight: 6 } });
            setupMapListeners();
            setupAutocomplete();
            updateUserGPS(false);
        };

        function setupMapListeners() {
            map.addListener("idle", () => {
                if (!directionsRenderer.getDirections()) {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => searchNearbyRestaurants(), 500);
                }
            });
        }

        function setupAutocomplete() {
            const input = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-search');
            autocomplete = new google.maps.places.Autocomplete(input, { componentRestrictions: { country: 'tw' }, types: ['establishment', 'geocode'], fields: ['place_id', 'geometry', 'name'] });
            autocomplete.bindTo('bounds', map);
            input.addEventListener('input', () => { clearBtn.style.display = input.value ? 'flex' : 'none'; });
            input.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const query = input.value.trim();
                    if (query) handleKeywordSearch(query);
                }
            });
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (place.geometry && place.geometry.location) {
                    clearSearch(true);
                    handlePlaceSelection(place);
                }
            });
        }
        
        // ⭐ 修改：引入 getDetailedOpeningStatus 來取代 getOpeningHoursHtml
        function getDetailedOpeningStatus(placeData) {
            if (placeData.business_status === "CLOSED_PERMANENTLY") {
                return `<span class="open-status closed">永久停業</span>`;
            }
            if (!placeData.opening_hours || !placeData.opening_hours.periods) {
                return `<span>營業時間未知</span>`;
            }

            // 處理24小時營業
            if (placeData.opening_hours.periods.length === 1 && placeData.opening_hours.periods[0].open.day === 0 && placeData.opening_hours.periods[0].open.time === '0000' && !placeData.opening_hours.periods[0].close) {
                 return `<span class="open-status open">24 小時營業</span>`;
            }

            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 (Sun) to 6 (Sat)
            const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();

            const todaysPeriods = placeData.opening_hours.periods.filter(p => p.open.day === dayOfWeek);

            // 檢查是否正在營業
            for (const period of todaysPeriods) {
                const openTime = parseInt(period.open.time.substring(0, 2)) * 60 + parseInt(period.open.time.substring(2, 4));
                // 處理跨日營業的情況
                let closeTime;
                if (period.close) {
                    if(period.close.day > period.open.day || (period.close.day === 0 && period.open.day === 6)) { // 跨日
                        closeTime = (parseInt(period.close.time.substring(0, 2)) * 60 + parseInt(period.close.time.substring(2, 4))) + 24 * 60;
                    } else {
                        closeTime = parseInt(period.close.time.substring(0, 2)) * 60 + parseInt(period.close.time.substring(2, 4));
                    }
                    if (currentTimeInMinutes >= openTime && currentTimeInMinutes < closeTime) {
                         const closeHour = String(period.close.time).substring(0, 2);
                         const closeMinute = String(period.close.time).substring(2, 4);
                         return `<span class="open-status open">營業中・下午${closeHour}:${closeMinute}關店</span>`;
                    }
                }
            }

            // 如果未營業，尋找下一個營業時間
            let nextOpenPeriod = null;
            // 先找今天剩下的時段
            nextOpenPeriod = todaysPeriods.find(p => (parseInt(p.open.time.substring(0, 2)) * 60 + parseInt(p.open.time.substring(2, 4))) > currentTimeInMinutes);

            // 如果今天沒有了，找未來幾天的
            if (!nextOpenPeriod) {
                for (let i = 1; i <= 7; i++) {
                    const nextDay = (dayOfWeek + i) % 7;
                    const nextDayPeriods = placeData.opening_hours.periods.filter(p => p.open.day === nextDay);
                    if (nextDayPeriods.length > 0) {
                        nextOpenPeriod = nextDayPeriods[0]; // 取當天最早的時段
                        break;
                    }
                }
            }
            
            if (nextOpenPeriod) {
                const openHour = String(nextOpenPeriod.open.time).substring(0, 2);
                const openMinute = String(nextOpenPeriod.open.time).substring(2, 4);
                return `<span class="open-status closed">休息中・${openHour}:${openMinute}開店</span>`;
            }

            // 如果都找不到（例如只有過去的時段）
            return `<span class="open-status closed">今日公休</span>`;
        }
        
        function searchNearbyRestaurants() {
            if (!isMapReady) return;
            const listContainer = document.getElementById("list-content-area");
            listContainer.innerHTML = `<p class="list-status-text">正在搜尋此區域的餐廳...</p>`;
            clearRestaurantMarkers();
            const request = {
                bounds: map.getBounds(),
                type: 'restaurant',
                // 我們依然請求 opening_hours 供初步判斷使用
                fields: ['name', 'place_id', 'geometry', 'rating', 'vicinity', 'business_status', 'opening_hours']
            };
            placesService.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    processAndDisplayResults(results);
                } else {
                    listContainer.innerHTML = `<p class="list-status-text">此區域找不到餐廳，請嘗試縮小地圖範圍。</p>`;
                }
            });
        }

        function handleKeywordSearch(query) {
            // ... (此函式不變) ...
        }

        function processAndDisplayResults(places) {
            // ... (此函式不變) ...
        }

        function addRestaurantToList(place) {
            const listContainer = document.getElementById("list-content-area");
            const item = document.createElement("div");
            item.className = "list-item";
            item.dataset.placeId = place.place_id;
            // 初步顯示，使用簡易判斷
            const openStatusHtml = getOpeningHoursHtml(place); // 使用簡易版以求快速顯示
            const ratingHtml = place.rating ? `<i class="fas fa-star" style="color: #ffd700;"></i> ${place.rating}` : `無評分`;
            const detailsText = [ratingHtml, openStatusHtml].filter(Boolean).join(' · ');
            const addressHtml = `<div class="item-address">${place.vicinity || ''}</div>`;
            const distanceHtml = place.distance ? `<div class="item-distance">${Math.round(place.distance)}m</div>` : '';
            item.innerHTML = `<div class="item-icon"><i class="fas fa-utensils"></i></div><div class="item-info"><div class="item-name">${place.name}</div>${addressHtml}<div class="item-details">${detailsText}</div></div>${distanceHtml}`;
            item.onclick = () => handlePlaceSelection(place);
            listContainer.appendChild(item);
        }

        window.updateUserGPS = function(showAlerts = false) {
            if (!isMapReady || !navigator.geolocation) {
                if (showAlerts) alert('您的瀏覽器不支援地理位置功能。');
                return;
            }
            document.getElementById("list-content-area").innerHTML = `<p class="list-status-text">正在獲取您目前的位置...</p>`;
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userGpsPosition = { lat: position.coords.latitude, lng: position.coords.longitude };
                    createUserMarker(userGpsPosition);
                    centerOnUserMap();
                },
                (error) => {
                    if (showAlerts) {
                        switch (error.code) {
                            case error.PERMISSION_DENIED: alert("您已拒絕地理位置的請求。"); break;
                            case error.POSITION_UNAVAILABLE: alert("無法獲取位置資訊。"); break;
                            case error.TIMEOUT: alert("獲取位置資訊超時。"); break;
                            default: alert("發生未知錯誤。"); break;
                        }
                    }
                    searchNearbyRestaurants();
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        function centerOnUserMap() {
             if (map && userGpsPosition) {
                map.panTo(userGpsPosition);
                map.setZoom(15);
            }
        }

        // ... (其他地圖函式如 createUserMarker, addRestaurantMarker, calculateAndDisplayRoute 等不變) ...
        
        function showPlaceDetailsInWindow(place, marker, routeInfo = null) {
            const request = { 
                placeId: place.place_id, 
                // 確保請求了 periods
                fields: ['name', 'rating', 'formatted_phone_number', 'opening_hours', 'vicinity', 'business_status', 'formatted_address', 'place_id'] 
            };
            placesService.getDetails(request, (details, status) => {
                if (status !== google.maps.places.PlacesServiceStatus.OK || !details) {
                    let content = `<div class="info-window-content"><h4>${place.name}</h4><p>無法獲取詳細資訊</p></div>`;
                    infoWindow.setContent(content);
                    infoWindow.open({ anchor: marker, map });
                    return;
                }
                
                // 使用詳細資料產生權威狀態
                const authoritativeOpenStatusHtml = getDetailedOpeningStatus(details);

                let content = `<div class="info-window-content"><h4>${details.name}</h4>`;
                const address = details.formatted_address || details.vicinity;
                if (address) content += `<p><i class="fas fa-map-marker-alt"></i>${address}</p>`;
                if (routeInfo) content += `<p><i class="fas fa-car"></i>${routeInfo.driving.distance} (${routeInfo.driving.duration})</p>`;
                if (details.rating) content += `<p><i class="fas fa-star"></i>${details.rating}</p>`;
                if (details.formatted_phone_number) content += `<p><i class="fas fa-phone"></i>${details.formatted_phone_number}</p>`;
                
                // 在 InfoWindow 中顯示詳細狀態
                content += `<p><i class="fas fa-clock"></i>${authoritativeOpenStatusHtml}</p>`;
                
                if (details.opening_hours && details.opening_hours.weekday_text) {
                    const todayIndex = (new Date().getDay() + 6) % 7; 
                    content += '<ul class="opening-hours-list">';
                    details.opening_hours.weekday_text.forEach((dayText, index) => {
                        const [day, ...timeParts] = dayText.split(': ');
                        const time = timeParts.join(': ');
                        const liClass = (index === todayIndex) ? 'class="today"' : '';
                        content += `<li ${liClass}><span class="day">${day}</span> <span class="time">${time}</span></li>`;
                    });
                    content += '</ul>';
                }
                content += '</div>';
                infoWindow.setContent(content);
                infoWindow.open({ anchor: marker, map });

                // 同步更新列表項
                const listItem = document.querySelector(`.list-item[data-place-id="${details.place_id}"]`);
                if (listItem) {
                    const itemDetailsElement = listItem.querySelector('.item-details');
                    if (itemDetailsElement) {
                        const authoritativeRatingHtml = details.rating ? `<i class="fas fa-star" style="color: #ffd700;"></i> ${details.rating}` : '無評分';
                        itemDetailsElement.innerHTML = [authoritativeRatingHtml, authoritativeOpenStatusHtml].filter(Boolean).join(' · ');
                    }
                }
            });
        }
        
        // --- 9. App 初始化 & Auth 狀態監聽 ---
        // ... (此部分保持不變) ...
        auth.onAuthStateChanged(user => { 
            currentUser = user;
            if (user) { 
                setupLoggedInUI(user);
            } else { 
                setupLoggedOutUI();
            } 
        });
        showPage('map-page', document.querySelector('.nav-item')); 

    });
</script>
</body>
</html>
