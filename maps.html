<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>FoodieApp</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs&libraries=places,geometry&callback=initMap"
    async
    defer
  ></script>

  <style>
    /* CSS 樣式與您提供的版本完全相同，此處省略以節省空間 */
    :root { --primary-color: #667eea; /* ... */ }
    html, body { height: 100%; margin: 0; /* ... */ }
    /* ... */
  </style>
</head>
<body>
  <div class="app-container">
    <main>
        <!-- HTML 結構與您提供的版本完全相同 -->
        <div id="map-page" class="page active">
            <div id="map-panel">
                <div id="map"></div>
                <button class="location-btn" onclick="centerOnUserGPS()"><i class="fas fa-location-arrow"></i></button>
            </div>
            <div id="list-panel">
                <div class="search-area">
                    <input type="text" id="search-input" class="search-input" placeholder="搜尋餐廳或地點...">
                    <button class="clear-search-btn" id="clear-search" onclick="clearSearch()">×</button>
                </div>
                <div class="list-content" id="list-content-area"><p class="list-status-text">正在初始化地圖...</p></div>
            </div>
        </div>
        <!-- ... 其他頁面 ... -->
    </main>
    <footer class="app-nav">
        <!-- ... 導航列 ... -->
    </footer>
  </div>

<script>
    // =================================================================
    // --- 全域變數與 Firebase 初始化 (與您版本相同) ---
    // =================================================================
    let currentUser = null, map, userGpsPosition, userMarker, restaurantMarkers = [], debounceTimer, placesService, autocomplete, infoWindow, directionsService, directionsRenderer, isMapReady = false;
    const POSTS_DB_KEY = 'foodieAppPosts', CHALLENGES_DB_KEY = 'foodieAppUserChallenges';
    let pageHistory = [];
    
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = { apiKey: "AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs", authDomain: "foodiedata-b4982.firebaseapp.com", /* ... */ };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        auth.onAuthStateChanged(user => { currentUser = user; if (user) setupLoggedInUI(user); else setupLoggedOutUI(); });
        
        // ... 其他非地圖功能的初始化 ...
    });

    // =================================================================
    // --- 地圖核心功能 (重構與優化) ---
    // =================================================================
    function initMap() {
        isMapReady = true;
        userGpsPosition = { lat: 25.0479, lng: 121.5171 };
        map = new google.maps.Map(document.getElementById("map"), { center: userGpsPosition, zoom: 15, disableDefaultUI: true, zoomControl: true, clickableIcons: false });
        placesService = new google.maps.places.PlacesService(map);
        infoWindow = new google.maps.InfoWindow();
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ map, suppressMarkers: true, polylineOptions: { strokeColor: '#4285F4', strokeWeight: 6, strokeOpacity: 0.8 } });
        
        createUserMarker(userGpsPosition);
        setupMapListeners();
        setupAutocomplete();
        updateUserGPS();
    }
    
    function setupMapListeners() {
        // 當地圖閒置且沒有路徑時，搜尋附近
        map.addListener("idle", () => {
            if (!directionsRenderer.getDirections()) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => searchNearbyRestaurants(map.getCenter()), 500);
            }
        });
        
        // 【核心優化 1】為地圖和 InfoWindow 新增事件監聽器
        map.addListener("click", () => resetMapView());
        infoWindow.addListener('closeclick', () => resetMapView());
    }
    
    function updateUserGPS() {
        if (!isMapReady) return;
        document.getElementById("list-content-area").innerHTML = `<p class="list-status-text">正在獲取您的位置...</p>`;
        navigator.geolocation?.getCurrentPosition(
            (position) => {
                userGpsPosition = { lat: position.coords.latitude, lng: position.coords.longitude };
                createUserMarker(userGpsPosition);
                centerOnUserGPS();
            },
            () => searchNearbyRestaurants(map.getCenter())
        );
    }
    
    function createUserMarker(position) {
        if (userMarker) {
            userMarker.setPosition(position);
        } else {
            userMarker = new google.maps.Marker({ position, map, title: "您的位置", zIndex: 1000,
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#4285F4', fillOpacity: 1, strokeColor: 'white', strokeWeight: 2 }
            });
        }
    }
    
    function centerOnUserGPS() { if (map && userGpsPosition) map.panTo(userGpsPosition); }

    function searchNearbyRestaurants(location) {
        if (!isMapReady) return;
        const listContainer = document.getElementById("list-content-area");
        listContainer.innerHTML = `<p class="list-status-text">正在搜尋附近餐廳...</p>`;
        clearRestaurantMarkers();
        placesService.nearbySearch({ location, radius: 1500, type: 'restaurant' }, (results, status) => {
            if (status === 'OK' && results) {
                processAndDisplayResults(results, location);
            } else {
                listContainer.innerHTML = `<p class="list-status-text">此區域找不到餐廳</p>`;
            }
        });
    }

    function processAndDisplayResults(places, center) {
        const listContainer = document.getElementById("list-content-area");
        listContainer.innerHTML = "";
        places.forEach((place) => {
            addRestaurantMarker(place);
            addRestaurantToList(place);
        });
    }

    function addRestaurantMarker(place) {
        const marker = new google.maps.Marker({ position: place.geometry.location, map, title: place.name,
            icon: { url: "https://maps.google.com/mapfiles/ms/icons/restaurant.png", scaledSize: new google.maps.Size(32, 32) }
        });
        marker.addListener('click', () => handlePlaceSelection(place, marker));
        restaurantMarkers.push(marker);
    }

    // 【核心優化 2】重構的點擊處理函式
    function handlePlaceSelection(place, marker) {
        // 隱藏其他 marker，突顯選中的
        restaurantMarkers.forEach(m => m.setVisible(m === marker));
        
        // 清除舊的列表，只顯示選中的
        document.getElementById("list-content-area").innerHTML = "";
        
        // 繪製路徑並在回呼中更新列表和 InfoWindow
        calculateAndDisplayRoute(place, marker);
    }

    function calculateAndDisplayRoute(place, marker) {
        if (!userGpsPosition) return;
        const request = { origin: userGpsPosition, destination: place.geometry.location, travelMode: 'DRIVING' };
        directionsService.route(request, (result, status) => {
            if (status === 'OK') {
                directionsRenderer.setDirections(result);
                const routeLeg = result.routes[0].legs[0];
                const routeInfo = { driving: { distance: routeLeg.distance.text, duration: routeLeg.duration.text } };
                // 在繪製路徑後，更新列表和 InfoWindow
                showPlaceDetailsInWindow(place, marker, routeInfo);
                addRestaurantToList(place, routeInfo);
            } else {
                // 如果無法規劃路徑，仍顯示基本資訊
                showPlaceDetailsInWindow(place, marker, null);
                addRestaurantToList(place, null);
            }
        });
    }

    function showPlaceDetailsInWindow(place, marker, routeInfo = null) {
        const fields = ['name', 'rating', 'formatted_phone_number', 'opening_hours', 'vicinity', 'business_status'];
        placesService.getDetails({ placeId: place.place_id, fields }, (details, status) => {
            let content = `<div class="info-window-content"><h4>${place.name}</h4>`;
            if (status === 'OK' && details) {
                // 地址
                content += `<p><i class="fas fa-map-marker-alt"></i>${details.vicinity}</p>`;
                // 電話
                if (details.formatted_phone_number) content += `<p><i class="fas fa-phone"></i>${details.formatted_phone_number}</p>`;
                // 營業時間
                if (details.opening_hours) {
                    const isOpen = details.opening_hours.isOpen();
                    content += `<p><i class="fas fa-clock"></i><span class="status ${isOpen ? 'open' : 'closed'}">${isOpen ? "營業中" : "休息中"}</span></p>`;
                }
                // Google 評價
                if (details.rating) {
                    const stars = Array(Math.round(details.rating)).fill('<i class="fas fa-star" style="color: #ffd700;"></i>').join('');
                    content += `<p>${stars} (${details.rating})</p>`;
                }
                // 好友評價 (模擬)
                if (currentUser) {
                    const hearts = Array(4).fill('<i class="fas fa-heart" style="color: #ff4d6d;"></i>').join('');
                    content += `<p>${hearts} (好友評價)</p>`;
                }
                // 路線資訊
                if (routeInfo) content += `<p><i class="fas fa-car"></i>${routeInfo.driving.distance} (${routeInfo.driving.duration})</p>`;
            } else {
                content += `<div>無法獲取詳細資訊</div>`;
            }
            content += '</div>';
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
        });
    }

    // 【核心優化 3】新增的重置函式
    function resetMapView() {
        directionsRenderer.setDirections({ routes: [] });
        infoWindow.close();
        restaurantMarkers.forEach(m => m.setVisible(true));
        // 重新搜尋附近的餐廳，並更新列表
        if (map.getCenter()) {
            searchNearbyRestaurants(map.getCenter());
        }
    }
    
    // 清除搜尋框和路徑的函式
    window.clearSearch = function() {
        document.getElementById('search-input').value = '';
        document.getElementById('clear-search').style.display = 'none';
        resetMapView(); // 呼叫重置函式
    }
    
    // ... 其他函式 (addRestaurantToList, setupAutocomplete, 等) 保持不變 ...
    function addRestaurantToList(place, routeInfo = null) { /* ... */ }
    function setupAutocomplete() { /* ... */ }

    // =================================================================
    // --- 其他頁面功能 (與您版本相同) ---
    // =================================================================
    // Page navigation, Auth, Profile, Accounting, Challenges...
    
</script>
</body>
</html>
