<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Google Maps - 自訂資訊卡片示範 (已修正)</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />

  <style>
    /* CSS 樣式與前一版完全相同 */
    html, body, #map { height: 100%; margin: 0; padding: 0; font-family: sans-serif; }
    .info-box-container { border: none !important; background: transparent !important; }
    .info-card { width: 320px; background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #3C4043; opacity: 0; transform: translateY(10px); animation: fadeIn 0.3s forwards; }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    .info-card-image { height: 140px; background-color: #e0e0e0; }
    .info-card-image img { width: 100%; height: 100%; object-fit: cover; }
    .info-card-content { padding: 16px; }
    .info-card-header .restaurant-name { font-size: 20px; font-weight: 600; margin: 0; }
    .info-card-header .restaurant-subname { font-size: 14px; color: #5f6368; margin: 2px 0 0 0; }
    .info-card-details { display: flex; align-items: center; font-size: 14px; color: #5f6368; margin-top: 8px; }
    .info-card-details .rating-score { font-weight: 500; color: #3C4043; }
    .info-card-details .rating-stars { color: #FDBF42; margin: 0 4px; }
    .info-card-details .meta-dot { margin: 0 6px; }
    .info-card-status { font-size: 14px; margin-top: 10px; }
    .info-card-status .status.open { color: #34A853; font-weight: 500; }
    .info-card-status .status.closed { color: #EA4335; font-weight: 500; }
    .info-card-status .hours { color: #5f6368; }
    .info-card-actions { display: flex; justify-content: space-around; padding: 8px; border-top: 1px solid #e0e0e0; }
    .info-card-actions .action-btn { background: none; border: none; border-radius: 8px; padding: 8px 12px; font-size: 14px; color: #1a73e8; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: background-color 0.2s; }
    .info-card-actions .action-btn:hover { background-color: #e8f0fe; }
    .info-card-actions .action-btn.primary { background-color: #1a73e8; color: #fff; }
    .info-card-actions .action-btn.primary:hover { background-color: #1866c8; }
    .info-box-close { position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; background-color: rgba(0, 0, 0, 0.4); color: #fff; border: none; border-radius: 50%; cursor: pointer; font-size: 16px; line-height: 28px; text-align: center; z-index: 10; transition: background-color 0.2s; }
    .info-box-close:hover { background-color: rgba(0, 0, 0, 0.6); }
  </style>
</head>
<body>
  
  <div id="map"></div>

  <!-- 
    【核心修改】
    在這裡引入 InfoBox.js 的腳本。
    它必須在載入 Google Maps API 的 <script> 標籤之前被引入。
    這樣可以確保當 Google Maps API 呼叫 initMap 時，InfoBox 已經被定義。
  -->
  <script src="https://cdn.jsdelivr.net/gh/googlemaps/v3-utility-library@master/infobox/src/infobox.min.js"></script>
  
  <!-- 引入 Google Maps API -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs&libraries=places&callback=initMap"
    async
  ></script>

  <script>
    // 全域變數
    let map;
    let infoBox;
    let placesService;
    let infoCardTemplate = '';

    // 模擬餐廳資料
    const mockRestaurantData = {
      placeId: "ChIJN1t_tDeuEmsRUsoyG83frY4", // Google 官方範例 Place ID (雪梨)
      name: "Google Sydney",
      position: { lat: -33.8665433, lng: 151.1956316 }
    };

    // 1. Google Maps 初始化函式
    async function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: mockRestaurantData.position,
        zoom: 16,
        clickableIcons: false,
      });

      placesService = new google.maps.places.PlacesService(map);
      
      infoCardTemplate = `
        <div class="info-card">
          <div class="info-card-image"><img src="{PHOTO_URL}" alt="{RESTAURANT_NAME}"></div>
          <div class="info-card-content">
            <div class="info-card-header">
              <h3 class="restaurant-name">{RESTAURANT_NAME}</h3><p class="restaurant-subname">{RESTAURANT_SUB_NAME}</p>
            </div>
            <div class="info-card-details">
              <span class="rating"><span class="rating-score">{RATING_SCORE}</span><span class="rating-stars">{RATING_STARS}</span><span class="rating-count">({RATING_COUNT})</span></span>
              <span class="meta-dot">·</span><span class="category">{CATEGORY}</span><span class="meta-dot">·</span><span class="price-range">{PRICE_RANGE}</span>
            </div>
            <div class="info-card-status"><span class="status {OPEN_STATUS_CLASS}">{OPEN_STATUS_TEXT}</span><span class="hours"> · {HOURS_TEXT}</span></div>
          </div>
          <div class="info-card-actions">
            <button class="action-btn primary"><i class="fas fa-directions"></i> 導航</button><button class="action-btn"><i class="far fa-bookmark"></i> 儲存</button><button class="action-btn"><i class="fas fa-share-square"></i> 分享</button>
          </div>
        </div>`;

      // 2. 初始化 InfoBox
      // 現在 InfoBox 是已定義的，這行程式碼將會成功執行
      infoBox = new InfoBox({
        content: "",
        disableAutoPan: false,
        maxWidth: 0,
        pixelOffset: new google.maps.Size(-160, -320),
        zIndex: null,
        boxClass: "info-box-container",
        closeBoxURL: "", // 我們用自己的 CSS 關閉按鈕，這裡留空
        infoBoxClearance: new google.maps.Size(1, 1),
        isHidden: false,
        pane: "floatPane",
        enableEventPropagation: false,
      });

      // 3. 建立 Marker
      const marker = new google.maps.Marker({
        position: mockRestaurantData.position,
        map: map,
        title: mockRestaurantData.name,
        icon: {
            url: "https://maps.google.com/mapfiles/ms/icons/restaurant.png",
            scaledSize: new google.maps.Size(32, 32)
        }
      });

      // 4. 為 Marker 設定點擊事件
      marker.addListener("click", () => {
        showInfoCard(mockRestaurantData.placeId, marker);
      });
      
      // 5. 點擊地圖空白處關閉 InfoBox
      map.addListener("click", () => {
        infoBox.close();
      });
    }

    // 函式：顯示資訊卡片
    function showInfoCard(placeId, marker) {
      infoBox.close();

      const request = {
        placeId: placeId,
        fields: ['name', 'formatted_address', 'photos', 'opening_hours', 'rating', 'user_ratings_total', 'types', 'price_level']
      };

      placesService.getDetails(request, (place, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && place) {
          const content = createInfoCardContent(place);
          infoBox.setContent(content);
          infoBox.open(map, marker);
        } else {
          console.error("無法獲取地點詳細資訊：" + status);
        }
      });
    }

    // 函式：根據 API 回傳的資料產生 HTML 內容
    function createInfoCardContent(place) {
      let photoUrl = "https://via.placeholder.com/320x140.png?text=No+Image";
      if (place.photos && place.photos.length > 0) {
        photoUrl = place.photos[0].getUrl({ maxWidth: 400 });
      }
      
      let starsHtml = '無評分';
      if (place.rating) {
        const roundedRating = Math.round(place.rating);
        starsHtml = '';
        for (let i = 0; i < 5; i++) {
          starsHtml += `<i class="fa-solid fa-star" ${i < roundedRating ? '' : 'style="opacity:0.3"'}></i>`;
        }
      }

      const priceRange = place.price_level ? '$'.repeat(place.price_level) : '';
      let openStatusText = '暫無營業時間資訊';
      let openStatusClass = '';
      let hoursText = '';
      if (place.opening_hours) {
        if (place.opening_hours.isOpen()) {
          openStatusText = '營業中';
          openStatusClass = 'open';
          const today = new Date().getDay();
          const period = place.opening_hours.periods.find(p => p.open.day === today);
          if (period && period.close) {
             hoursText = `營業至 ${period.close.hours}:${String(period.close.minutes).padStart(2, '0')}`;
          }
        } else {
          openStatusText = '休息中';
          openStatusClass = 'closed';
        }
      }
      
      let content = infoCardTemplate
        .replace(/{PHOTO_URL}/g, photoUrl)
        .replace(/{RESTAURANT_NAME}/g, place.name || '未知名稱')
        .replace(/{RESTAURANT_SUB_NAME}/g, '')
        .replace(/{RATING_SCORE}/g, place.rating?.toFixed(1) || '')
        .replace(/{RATING_STARS}/g, starsHtml)
        .replace(/{RATING_COUNT}/g, place.user_ratings_total?.toLocaleString() || '0')
        .replace(/{CATEGORY}/g, place.types ? place.types[0] : '餐廳')
        .replace(/{PRICE_RANGE}/g, priceRange)
        .replace(/{OPEN_STATUS_CLASS}/g, openStatusClass)
        .replace(/{OPEN_STATUS_TEXT}/g, openStatusText)
        .replace(/{HOURS_TEXT}/g, hoursText);

      const container = document.createElement('div');
      container.innerHTML = content;
      
      const closeButton = document.createElement('button');
      closeButton.className = 'info-box-close';
      closeButton.innerHTML = '×';
      closeButton.onclick = () => infoBox.close();
      container.querySelector('.info-card').prepend(closeButton);
      
      return container;
    }
  </script>
</body>
</html>
