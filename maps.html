<!-- ... æ‚¨çš„ HTML å’Œ CSS ä¿æŒä¸è®Š ... -->
<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- 1. Firebase åˆå§‹åŒ– ---
        const firebaseConfig = {
            apiKey: "AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs", // è«‹å‹™å¿…ä½¿ç”¨æ‚¨è‡ªå·±çš„ Firebase é‡‘é‘°
            authDomain: "foodiedata-b4982.firebaseapp.com",
            projectId: "foodiedata-b4982",
            storageBucket: "foodiedata-b4982.firebasestorage.app",
            messagingSenderId: "90315404352",
            appId: "1:90315404352:web:e12b4fc3f5a87a11191ba5",
            measurementId: "G-5FD72CVKGB"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // --- 2. æ‡‰ç”¨ç¨‹å¼è®Šæ•¸ ---
        let currentUser = null;
        let map, userGpsPosition, userMarker, placesService, autocomplete, infoWindow, directionsService, directionsRenderer;
        let restaurantMarkers = []; // ç¢ºä¿ restaurantMarkers è¢«åˆå§‹åŒ–ç‚ºä¸€å€‹ç©ºé™£åˆ—
        let debounceTimer;
        let isMapReady = false;
        const POSTS_DB_KEY = 'foodieAppPosts';
        const CHALLENGES_DB_KEY = 'foodieAppUserChallenges';
        let pageHistory = [];

        // ================== å‡½å¼å®šç¾©å€åŸŸ (éƒ½åœ¨åŒä¸€å€‹ä½œç”¨åŸŸå…§) ==================

        // 3.1 é é¢å°èˆªèˆ‡è¿”å›é‚è¼¯
        function showPage(pageId, navElement = null) {
            const activePage = document.querySelector('.page.active');
            if (activePage) {
                if (!['login-page', 'register-page'].includes(activePage.id) || !['login-page', 'register-page'].includes(pageId)) {
                    pageHistory.push(activePage.id);
                }
            }
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (navElement) {
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                navElement.classList.add('active');
                pageHistory = [];
            }
            if (pageId === 'random-page') updateRandomPageStatus();
            if (pageId === 'challenge-page') renderChallenges();
            if (pageId === 'profile-page') renderProfilePage();
        }

        function goBack() {
            if (pageHistory.length > 0) {
                const lastPageId = pageHistory.pop();
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(lastPageId).classList.add('active');
            } else {
                showPage('map-page', document.querySelector('.nav-item[onclick*="map-page"]'));
            }
        }

        // 3.2 Firebase Authentication ç›¸é—œå‡½å¼
        function handleRegister() {
            const name = document.getElementById('register-name-input').value.trim();
            const email = document.getElementById('register-email-input').value;
            const password = document.getElementById('register-password-input').value;
            const errorDiv = document.getElementById('register-error');
            errorDiv.textContent = '';
            if (!name || !email || !password) {
                errorDiv.textContent = 'æ‰€æœ‰æ¬„ä½éƒ½å¿…é ˆå¡«å¯«ï¼'; return;
            }
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => userCredential.user.updateProfile({ displayName: name }))
                .then(() => goBack())
                .catch(error => {
                    switch (error.code) {
                        case 'auth/email-already-in-use': errorDiv.textContent = 'æ­¤é›»å­éƒµä»¶å·²è¢«è¨»å†Šã€‚'; break;
                        case 'auth/invalid-email': errorDiv.textContent = 'é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢ºã€‚'; break;
                        case 'auth/weak-password': errorDiv.textContent = 'å¯†ç¢¼å¼·åº¦ä¸è¶³ (è‡³å°‘6ä½æ•¸)ã€‚'; break;
                        default: errorDiv.textContent = 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                    }
                });
        }

        function handleSignIn() {
            const email = document.getElementById('login-email-input').value;
            const password = document.getElementById('login-password-input').value;
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = '';
            auth.signInWithEmailAndPassword(email, password)
                .then(() => goBack())
                .catch(error => { errorDiv.textContent = 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¿¡ç®±æˆ–å¯†ç¢¼ã€‚'; });
        }

        function handleGoogleSignIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(() => goBack())
                .catch(error => {
                    const errorDiv = document.getElementById('login-error');
                    errorDiv.textContent = 'Google ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                });
        }

        function handleSignOut() {
            auth.signOut().catch(error => console.error("ç™»å‡ºéŒ¯èª¤:", error));
        }

        // 3.3 UI ç‹€æ…‹åˆ‡æ›
        function setupLoggedInUI(user) {
            document.getElementById('profile-login-btn').style.display = 'none';
            document.getElementById('profile-logout-btn').style.display = 'block';
            const userName = user.displayName || user.email;
            document.getElementById('profile-header').innerHTML = `<i class="fa-solid fa-user"></i> ${userName}`;
            renderProfilePage();
        }

        function setupLoggedOutUI() {
            document.getElementById('profile-login-btn').style.display = 'block';
            document.getElementById('profile-logout-btn').style.display = 'none';
            document.getElementById('profile-header').innerHTML = `<i class="fa-solid fa-user"></i> å€‹äººæª”æ¡ˆ`;
            renderProfilePage();
            document.getElementById('challenge-list-container').innerHTML = '<p class="placeholder-text">ç™»å…¥å¾Œå³å¯æŸ¥çœ‹ä¸¦åƒåŠ ç¾é£ŸæŒ‘æˆ°ï¼</p>';
            document.getElementById('random-status-text').textContent = 'ç™»å…¥å¾Œï¼Œç³»çµ±æœƒå¾æ‚¨çš„ç¾é£Ÿç´€éŒ„ä¸­éš¨æ©ŸæŠ½é¸ï¼';
            if (document.getElementById('picker-result')) {
                document.getElementById('picker-result').textContent = '?';
            }
        }

        // 3.4 è³‡æ–™å„²å­˜ (Local Storage)
        function getPosts() { if (!currentUser) return []; const key = `${POSTS_DB_KEY}_${currentUser.uid}`; return JSON.parse(localStorage.getItem(key)) || []; }
        function savePosts(posts) { if (!currentUser) return; const key = `${POSTS_DB_KEY}_${currentUser.uid}`; localStorage.setItem(key, JSON.stringify(posts)); }
        function getUserChallenges() { if (!currentUser) return {}; const key = `${CHALLENGES_DB_KEY}_${currentUser.uid}`; return JSON.parse(localStorage.getItem(key)) || {}; }
        function saveUserChallenges(challenges) { if (!currentUser) return; const key = `${CHALLENGES_DB_KEY}_${currentUser.uid}`; localStorage.setItem(key, JSON.stringify(challenges)); }

        // 3.5 Page 1: åœ°åœ–åŠŸèƒ½ (ä½¿ç”¨èˆŠç‰ˆ API)
        function initMap() {
            isMapReady = true;
            userGpsPosition = { lat: 25.0479, lng: 121.5171 };
            map = new google.maps.Map(document.getElementById("map"), { center: userGpsPosition, zoom: 15, disableDefaultUI: true, zoomControl: true });
            
            // ç¶­æŒä½¿ç”¨èˆŠç‰ˆ PlacesService ä»¥ç¢ºä¿ç©©å®šæ€§
            placesService = new google.maps.places.PlacesService(map); 
            
            infoWindow = new google.maps.InfoWindow();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true, polylineOptions: { strokeColor: '#4285F4', strokeOpacity: 0.8, strokeWeight: 6 } });
            createUserMarker(userGpsPosition);
            setupMapListeners();
            setupAutocomplete();
            updateUserGPS();
        }

        function createUserMarker(position) {
            const userIcon = { path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z", fillColor: '#4285F4', fillOpacity: 1, strokeWeight: 0, scale: 1.5, anchor: new google.maps.Point(12, 24) };
            if (userMarker) {
                userMarker.setPosition(position);
            } else {
                // ç¶­æŒä½¿ç”¨èˆŠç‰ˆ Marker
                userMarker = new google.maps.Marker({ position, map, title: "æ‚¨çš„ä½ç½®", icon: userIcon, zIndex: 1000 });
            }
        }

        function setupMapListeners() {
            map.addListener("idle", () => {
                if (!directionsRenderer.getDirections()) {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => searchNearbyRestaurants(map.getCenter()), 500);
                }
            });
        }

        function setupAutocomplete() {
            const input = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-search');
            autocomplete = new google.maps.places.Autocomplete(input, { componentRestrictions: { country: 'tw' }, types: ['establishment', 'geocode'], fields: ['place_id', 'geometry', 'name', 'formatted_address', 'vicinity'] });
            input.addEventListener('input', () => { clearBtn.style.display = input.value ? 'flex' : 'none'; });
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (place.geometry && place.geometry.location) {
                    clearSearch(true);
                    handlePlaceSelection(place);
                }
            });
        }

        function updateUserGPS() {
            if (!isMapReady) return;
            document.getElementById("list-content-area").innerHTML = `<p class="list-status-text">æ­£åœ¨ç²å–æ‚¨çš„ä½ç½®...</p>`;
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userGpsPosition = { lat: position.coords.latitude, lng: position.coords.longitude };
                        createUserMarker(userGpsPosition);
                        centerOnUserGPS();
                    },
                    () => searchNearbyRestaurants(map.getCenter())
                );
            } else {
                searchNearbyRestaurants(map.getCenter());
            }
        }

        function centerOnUserGPS() {
            if (map && userGpsPosition) {
                map.panTo(userGpsPosition);
            }
        }

        function searchNearbyRestaurants(location) {
            if (!isMapReady) return;
            const listContainer = document.getElementById("list-content-area");
            listContainer.innerHTML = `<p class="list-status-text">æ­£åœ¨æœå°‹é™„è¿‘é¤å»³...</p>`;
            clearRestaurantMarkers();
            const request = { location: location, radius: 1500, type: 'restaurant' };
            placesService.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    processAndDisplayResults(results, location);
                } else {
                    listContainer.innerHTML = `<p class="list-status-text">æ­¤å€åŸŸæ‰¾ä¸åˆ°é¤å»³</p>`;
                }
            });
        }

        function processAndDisplayResults(places, center) {
            const listContainer = document.getElementById("list-content-area");
            const placesWithDistance = places.map((place) => ({ ...place, distance: google.maps.geometry.spherical.computeDistanceBetween(center, place.geometry.location) }));
            placesWithDistance.sort((a, b) => a.distance - b.distance);
            listContainer.innerHTML = "";
            placesWithDistance.forEach((place) => {
                addRestaurantMarker(place);
                addRestaurantToList(place);
            });
        }

        function addRestaurantMarker(place) {
            // ç¶­æŒä½¿ç”¨èˆŠç‰ˆ Marker
            const marker = new google.maps.Marker({
                position: place.geometry.location,
                map: map,
                title: place.name,
                icon: { path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z", fillColor: '#EA4335', fillOpacity: 1, strokeWeight: 0, scale: 1.5, anchor: new google.maps.Point(12, 24) }
            });
            marker.addListener('click', () => handlePlaceSelection(place));
            marker.place_id = place.place_id;
            restaurantMarkers.push(marker);
        }

        function addRestaurantToList(place, routeInfo = null) {
            const listContainer = document.getElementById("list-content-area");
            const item = document.createElement("div");
            item.className = "list-item";
            item.dataset.placeId = place.place_id;
            let openStatusHtml = "";
            if (place.business_status === "CLOSED_PERMANENTLY") {
                openStatusHtml = `<span class="open-status closed">æ°¸ä¹…åœæ¥­</span>`;
            } else if (place.opening_hours && typeof place.opening_hours.open_now !== 'undefined') {
                openStatusHtml = place.opening_hours.open_now ? `<span class="open-status open">ç‡Ÿæ¥­ä¸­</span>` : `<span class="open-status closed">ä¼‘æ¯ä¸­</span>`;
            }
            const ratingHtml = place.rating ? `<i class="fas fa-star" style="color: #ffd700;"></i> ${place.rating}` : `ç„¡è©•åˆ†`;
            const detailsText = [ratingHtml, openStatusHtml].filter(Boolean).join(' Â· ');
            const addressHtml = `<div class="item-address">${place.vicinity || place.formatted_address || ''}</div>`;
            const distanceHtml = routeInfo ? `<div class="item-distance"><i class="fas fa-route"></i> ${routeInfo.driving.distance}</div>` : (place.distance ? `<div class="item-distance">${Math.round(place.distance)}m</div>` : '');
            item.innerHTML = `<div class="item-icon"><i class="fas fa-utensils"></i></div><div class="item-info"><div class="item-name">${place.name}</div>${addressHtml}<div class="item-details">${detailsText}</div></div>${distanceHtml}`;
            item.onclick = () => handlePlaceSelection(place);
            listContainer.appendChild(item);
        }

        function handlePlaceSelection(place) {
            const marker = restaurantMarkers.find((m) => m.place_id === place.place_id);
            if (marker) {
                map.panTo(marker.getPosition());
            } else {
                map.panTo(place.geometry.location);
            }
            highlightListItem(place.place_id, true);
            calculateAndDisplayRoute(place);
        }

        function calculateAndDisplayRoute(place) {
            if (!userGpsPosition || !place.geometry || !place.geometry.location) { return; }
            document.getElementById('clear-search').style.display = 'flex';
            clearRestaurantMarkers();
            const request = { origin: userGpsPosition, destination: place.geometry.location, travelMode: google.maps.TravelMode.DRIVING };
            directionsService.route(request, (res, stat) => {
                if (stat !== 'OK') {
                    directionsRenderer.setDirections({ routes: [] });
                    addRestaurantMarker(place);
                    showSinglePlaceResult(place);
                    return;
                }
                directionsRenderer.setDirections(res);
                const leg = res.routes[0].legs[0];
                const routeInfo = { driving: { distance: leg.distance.text, duration: leg.duration.text } };
                const destinationMarker = new google.maps.Marker({ position: place.geometry.location, map: map, title: place.name });
                restaurantMarkers.push(destinationMarker);
                map.fitBounds(res.routes[0].bounds);
                showPlaceDetailsInWindow(place, destinationMarker, routeInfo);
                showSinglePlaceResult(place, routeInfo);
            });
        }
        
        function showSinglePlaceResult(place, routeInfo) {
            const listContainer = document.getElementById("list-content-area");
            listContainer.innerHTML = "";
            addRestaurantToList(place, routeInfo);
        }

        function showPlaceDetailsInWindow(place, marker, routeInfo = null) {
            const request = { placeId: place.place_id, fields: ['name', 'rating', 'formatted_phone_number', 'opening_hours', 'vicinity', 'business_status', 'formatted_address'] };
            placesService.getDetails(request, (details, status) => {
                let content = `<div class="info-window-content"><h4>${place.name}</h4>`;
                if (status === google.maps.places.PlacesServiceStatus.OK && details) {
                    const address = details.formatted_address || details.vicinity;
                    if (address) content += `<p><i class="fas fa-map-marker-alt"></i>${address}</p>`;
                    if (routeInfo) content += `<p><i class="fas fa-car"></i>${routeInfo.driving.distance} (${routeInfo.driving.duration})</p>`;
                    if (details.rating) content += `<p><i class="fas fa-star"></i>${details.rating}</p>`;
                    if (details.formatted_phone_number) content += `<p><i class="fas fa-phone"></i>${details.formatted_phone_number}</p>`;
                    if (details.business_status === "CLOSED_PERMANENTLY") {
                        content += `<p><i class="fas fa-store-slash"></i><span style="color: #dc3545; font-weight: bold;">æ°¸ä¹…åœæ¥­</span></p>`;
                    } else if (details.opening_hours) {
                        const isOpen = details.opening_hours.isOpen();
                        const statusText = isOpen ? "ç‡Ÿæ¥­ä¸­" : "ä¼‘æ¯ä¸­";
                        const color = isOpen ? "#28a745" : "#dc3545";
                        content += `<p><i class="fas fa-clock"></i><span style="color: ${color}; font-weight: bold;">${statusText}</span></p>`;
                    }
                } else {
                    content += `<div>ç„¡æ³•ç²å–è©³ç´°è³‡è¨Š</div>`;
                }
                content += '</div>';
                infoWindow.setContent(content);
                infoWindow.open(map, marker);
            });
        }
        
        function clearSearch(suppressSearch) {
            directionsRenderer.setDirections({ routes: [] });
            infoWindow.close();
            const input = document.getElementById('search-input');
            input.value = '';
            document.getElementById('clear-search').style.display = 'none';
            if (!suppressSearch) {
                searchNearbyRestaurants(map.getCenter());
            }
        }

        function highlightListItem(placeId, scroll) {
            document.querySelectorAll(".list-item.is-selected").forEach((el) => el.classList.remove("is-selected"));
            const listItem = document.querySelector(`.list-item[data-place-id="${placeId}"]`);
            if (listItem) {
                listItem.classList.add("is-selected");
                if (scroll) {
                    listItem.scrollIntoView({ behavior: "smooth", block: "center" });
                }
            }
        }

        function clearRestaurantMarkers() {
            restaurantMarkers.forEach((marker) => marker.setMap(null));
            restaurantMarkers = [];
        }

        // --- å…¶ä»–é é¢åŠŸèƒ½ (ä¿æŒä¸è®Š) ---
        // (æ­¤è™•çœç•¥éš¨æ©Ÿé¸ã€æ–°å¢ã€æŒ‘æˆ°æ¦œã€å€‹äººé é¢ç­‰å‡½å¼ï¼Œå› ç‚ºå®ƒå€‘èˆ‡ä¸Šæ¬¡çš„ä¿®æ­£ç‰ˆå®Œå…¨ç›¸åŒ)

        // 3.6 Page 2: ç¾é£Ÿéš¨æ©Ÿé¸
        function updateRandomPageStatus() {
            if (!currentUser) {
                document.getElementById('random-status-text').textContent = 'ç™»å…¥å¾Œï¼Œç³»çµ±æœƒå¾æ‚¨çš„ç¾é£Ÿç´€éŒ„ä¸­éš¨æ©ŸæŠ½é¸ï¼';
                document.getElementById('picker-result').textContent = '?';
                return;
            }
            const allPosts = getPosts();
            const restaurants = [...new Set(allPosts.map(p => p.name))];
            const statusText = document.getElementById('random-status-text');
            const pickerResult = document.getElementById('picker-result');
            pickerResult.textContent = "?";
            pickerResult.style.color = 'var(--primary-color)';
            if (restaurants.length === 0) {
                statusText.textContent = "æ‚¨é‚„æ²’æœ‰æ–°å¢ä»»ä½•é¤å»³å–”ï¼è«‹åˆ°ã€Œæ–°å¢ã€é é¢åŠ å…¥å§ï¼";
            } else {
                statusText.textContent = `ç›®å‰æœ‰ ${restaurants.length} å®¶ç¨ç‰¹çš„é¤å»³åœ¨æ‚¨çš„å£è¢‹åå–®ä¸­ã€‚`;
            }
        }

        function startRandomPick() {
            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥æ‰èƒ½ä½¿ç”¨æ‚¨çš„ç¾é£Ÿæ¸…å–®é€²è¡ŒæŠ½ç±¤ï¼');
                showPage('login-page');
                return;
            }
            const allPosts = getPosts();
            const restaurants = [...new Set(allPosts.map(p => p.name))];
            if (restaurants.length === 0) {
                alert("å£è¢‹åå–®æ˜¯ç©ºçš„ï¼Œç„¡æ³•æŠ½ç±¤ï¼");
                return;
            }
            const wheel = document.getElementById('picker-wheel');
            const resultDiv = document.getElementById('picker-result');
            const pickButton = document.getElementById('random-pick-btn');
            pickButton.disabled = true;
            resultDiv.textContent = '...';
            const randomSpins = Math.floor(Math.random() * 5) + 5;
            const randomStopAngle = Math.floor(Math.random() * 360);
            wheel.style.transform = `rotate(${randomSpins * 360 + randomStopAngle}deg)`;
            setTimeout(() => {
                const randomIndex = Math.floor(Math.random() * restaurants.length);
                const winner = restaurants[randomIndex];
                resultDiv.textContent = winner;
                resultDiv.style.color = '#28a745';
                pickButton.disabled = false;
            }, 4000);
        }

        // 3.7 Page 3: æ–°å¢ç¾é£Ÿè©•è«–
        function handleRatingClick(e) {
            const rating = e.target.dataset.value;
            document.getElementById('review-rating').dataset.rating = rating;
            updateHeartDisplay(rating);
        }
        function handleRatingHover(e) { updateHeartDisplay(e.target.dataset.value); }
        function handleRatingMouseout() { updateHeartDisplay(document.getElementById('review-rating').dataset.rating); }
        function updateHeartDisplay(rating) { document.querySelectorAll('.rating-hearts .fa-heart').forEach(heart => { heart.classList.toggle('active', heart.dataset.value <= rating); }); }
        
        function saveReview() {
            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥æ‰èƒ½å„²å­˜è©•è«–ï¼');
                showPage('login-page');
                return;
            }
            const name = document.getElementById('review-restaurant-name').value.trim();
            const rating = document.getElementById('review-rating').dataset.rating;
            if (!name || rating === "0") {
                alert("è«‹å‹™å¿…å¡«å¯«ã€Œé¤å»³åç¨±ã€å’Œã€Œå–œæ„›ç¨‹åº¦ã€ï¼");
                return;
            }
            const newPost = { id: Date.now(), name, items: document.getElementById('review-meal-items').value.trim(), cost: Number(document.getElementById('review-cost').value) || 0, rating, content: document.getElementById('review-content').value.trim(), timestamp: new Date().toISOString() };
            const posts = getPosts();
            posts.unshift(newPost);
            savePosts(posts);
            alert("è©•è«–å·²æˆåŠŸå„²å­˜ï¼");
            ['review-restaurant-name', 'review-meal-items', 'review-cost', 'review-content'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('review-rating').dataset.rating = 0;
            updateHeartDisplay(0);
            showPage('profile-page', document.querySelector('.nav-item[onclick*="profile-page"]'));
        }
        
        // 3.8 Page 4: ç¾é£ŸæŒ‘æˆ°æ¦œ
        const challengesData = [ { id: 'healthy_week', title: 'æŒ‘æˆ°ä¸€é€±å¥åº·é¤', desc: 'é€£çºŒä¸ƒå¤©åªåƒåŸå‹é£Ÿç‰©å’Œå¥åº·çƒ¹èª¿çš„é¤é»ï¼', rank: '<li>1. Alice (7/7å¤©) ğŸ¥‡</li> <li>2. David (6/7å¤©) ğŸ¥ˆ</li> <li>3. ç¾é£Ÿæ¢éšªå®¶ (5/7å¤©)</li>', participants: 'Alice, David, ç¾é£Ÿæ¢éšªå®¶' }, { id: 'budget_200', title: 'çœéŒ¢å¤§ä½œæˆ°ï¼šæ—¥å‡$200', desc: 'æŒ‘æˆ°é€£çºŒäº”å¤©ï¼Œå¹³å‡æ¯æ—¥é¤è²»ä¸è¶…é200å…ƒã€‚', rank: '<li>1. Bob (å¹³å‡ $185) ğŸ¥‡</li> <li>2. Charlie (å¹³å‡ $198) ğŸ¥ˆ</li>', participants: 'Bob, Charlie' }, { id: 'vegan_exp', title: 'ç´ é£Ÿé«”é©—é€±', desc: 'æŒ‘æˆ°ä¸€é€±å®Œå…¨ç´ é£Ÿ(è›‹å¥¶ç´ å¯)ã€‚', rank: '<li>1. Eve (å®Œæˆ) ğŸ¥‡</li> <li>2. Frank (å®Œæˆ) ğŸ¥ˆ</li> <li>3. Grace (å®Œæˆ)</li>', participants: 'Eve, Frank, Grace' }];
        
        function renderChallenges() {
            const container = document.getElementById('challenge-list-container');
            if (!currentUser) {
                container.innerHTML = '<p class="placeholder-text">ç™»å…¥å¾Œå³å¯æŸ¥çœ‹ä¸¦åƒåŠ ç¾é£ŸæŒ‘æˆ°ï¼</p>';
                return;
            }
            const userChallenges = getUserChallenges();
            container.innerHTML = '';
            challengesData.forEach(c => {
                const isJoined = userChallenges[c.id];
                const card = document.createElement('div');
                card.className = 'challenge-card';
                card.innerHTML = `<div class="challenge-header"><div class="challenge-title">${c.title}</div><button class="challenge-btn-join ${isJoined ? 'joined' : ''}" onclick="toggleChallenge('${c.id}')">${isJoined ? 'å·²åƒåŠ ' : 'åƒåŠ '}</button></div><p class="challenge-desc">${c.desc}</p><div><div class="challenge-ranking-title">ğŸ† æ’è¡Œæ¦œï¼š</div><ul class="challenge-ranking-list" style="flex-direction:column; gap: 5px;">${c.rank}</ul></div><div style="margin-top:15px;"><div class="challenge-participants-title">ğŸ‘¥ åƒèˆ‡è€…ï¼š</div><div class="challenge-participants-list">${c.participants} ${isJoined ? ', <b>æ‚¨</b>' : ''}</div></div>`;
                container.appendChild(card);
            });
        }
        
        function toggleChallenge(challengeId) {
            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥æ‰èƒ½åƒåŠ æŒ‘æˆ°ï¼');
                showPage('login-page');
                return;
            }
            const userChallenges = getUserChallenges();
            userChallenges[challengeId] = !userChallenges[challengeId];
            saveUserChallenges(userChallenges);
            renderChallenges();
        }

        // 3.9 Page 5: å€‹äººåŠŸèƒ½
        function renderProfilePage() {
            const activeTabButton = document.querySelector('#profile-page .tab-btn.active');
            const tabId = activeTabButton ? (activeTabButton.dataset.tab || 'accounting') : 'accounting';
            showProfileTab(tabId, activeTabButton || document.querySelector('#profile-page .tab-btn'));
        }

        function showProfileTab(tabId, tabElement) {
            document.querySelectorAll('#profile-page .tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.removeAttribute('data-tab');
            });
            if (tabElement) {
                tabElement.classList.add('active');
                tabElement.dataset.tab = tabId;
            }
            
            document.querySelectorAll('#profile-page .tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabId}-content`).classList.add('active');

            if (tabId === 'accounting') renderAccountingRecords();
            if (tabId === 'posts') renderMyPosts();
            if (tabId === 'favorites') renderFavoriteRestaurants();
            if (tabId === 'friends') renderFriendsList();
        }

        const loggedOutPlaceholder = (message) => `<p class="placeholder-text">è«‹å…ˆ<a href="#" onclick="showPage('login-page')">ç™»å…¥</a>${message}</p>`;

        function renderAccountingRecords() {
            const container = document.getElementById('accounting-content');
            if (!currentUser) { container.innerHTML = loggedOutPlaceholder('ä»¥æŸ¥çœ‹æ‚¨çš„æ¶ˆè²»ç´€éŒ„ã€‚'); return; }
            const posts = getPosts().filter(p => p.cost > 0);
            if (posts.length === 0) { container.innerHTML = `<p class="placeholder-text">å°šç„¡æ¶ˆè²»ç´€éŒ„ã€‚</p>`; return; }
            container.innerHTML = '<h3>æ¶ˆè²»ç´€éŒ„</h3>' + posts.map(p => `<div class="record-card"><span class="cost">$${p.cost}</span><div class="title">${p.name}</div><div class="details">${new Date(p.timestamp).toLocaleDateString()}</div></div>`).join('');
        }
        function renderMyPosts() {
            const container = document.getElementById('posts-content');
            if (!currentUser) { container.innerHTML = loggedOutPlaceholder('ä»¥æŸ¥çœ‹æ‚¨çš„è²¼æ–‡ã€‚'); return; }
            const posts = getPosts();
            if (posts.length === 0) { container.innerHTML = `<p class="placeholder-text">æ‚¨é‚„æ²’æœ‰ç™¼è¡¨éè²¼æ–‡ã€‚</p>`; return; }
            container.innerHTML = posts.map(p => { let ratingHtml = Array(parseInt(p.rating)).fill('<i class="fa-solid fa-heart"></i>').join(''); return `<div class="post-card"><div class="title">${p.name}</div><div class="details">${new Date(p.timestamp).toLocaleString()}</div><p class="content">${p.content || 'ï¼ˆç„¡è©³ç´°è©•è«–ï¼‰'}</p><div class="post-rating">${ratingHtml}</div></div>`; }).join('');
        }
        function renderFavoriteRestaurants() {
            const container = document.getElementById('favorites-content');
            if (!currentUser) { container.innerHTML = loggedOutPlaceholder('ä»¥æŸ¥çœ‹æ‚¨çš„æœ€æ„›é¤å»³ã€‚'); return; }
            const favorites = getPosts().filter(p => p.rating >= 4).reduce((acc, cur) => { if (!acc.some(item => item.name === cur.name)) acc.push(cur); return acc; }, []).sort((a, b) => b.rating - a.rating);
            if (favorites.length === 0) { container.innerHTML = `<p class="placeholder-text">æ‚¨é‚„æ²’æœ‰è©•åˆ†é«˜çš„é¤å»³å–”ï¼</p>`; return; }
            container.innerHTML = '<h3>æœ€æ„›é¤å»³ (è©•åˆ†4é¡†å¿ƒä»¥ä¸Š)</h3>' + favorites.map(p => `<div class="record-card"><div class="title">${p.name}</div></div>`).join('');
        }
        function renderFriendsList() {
            const container = document.getElementById('friends-content');
            if (!currentUser) { container.innerHTML = loggedOutPlaceholder('ä»¥æŸ¥çœ‹å¥½å‹åå–®ã€‚'); return; }
            container.innerHTML = `<p class="placeholder-text">å¥½å‹åŠŸèƒ½é–‹ç™¼ä¸­ï¼</p>`;
        }


        // --- 4. åˆå§‹åŒ– & ç‹€æ…‹ç›£è½ ---
        document.querySelectorAll('.rating-hearts .fa-heart').forEach(heart => {
            heart.addEventListener('click', handleRatingClick);
            heart.addEventListener('mouseover', handleRatingHover);
            heart.addEventListener('mouseout', handleRatingMouseout);
        });
        
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                setupLoggedInUI(user);
            } else {
                setupLoggedOutUI();
            }
        });
        
        // åˆå§‹è¼‰å…¥
        showPage('map-page', document.querySelector('.nav-item'));


        // ================== å…¨åŸŸæ¥å£æ›è¼‰ ==================
        // å°‡éœ€è¦è¢« HTML onclick æˆ–å¤–éƒ¨ API callback å‘¼å«çš„å‡½å¼æ›è¼‰åˆ° window ç‰©ä»¶ä¸Š
        // é€™æ˜¯è§£æ±º ReferenceError çš„é—œéµæ­¥é©Ÿ
        window.initMap = initMap;
        window.centerOnUserGPS = centerOnUserGPS;
        window.clearSearch = clearSearch;
        window.showPage = showPage;
        window.goBack = goBack;
        window.startRandomPick = startRandomPick;
        window.saveReview = saveReview;
        window.toggleChallenge = toggleChallenge;
        window.showProfileTab = showProfileTab;
        window.handleSignOut = handleSignOut;
        window.handleSignIn = handleSignIn;
        window.handleGoogleSignIn = handleGoogleSignIn;
        window.handleRegister = handleRegister;

    });
</script>
