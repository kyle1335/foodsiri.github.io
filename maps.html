<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>FoodieApp</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  
  <!-- FIX 1: Updated the API script tag -->
  <!-- - Added the 'marker' library for AdvancedMarkerElement -->
  <!-- - Added 'loading="async"' attribute as recommended -->
  <script 
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs&libraries=places,geometry,marker&callback=initMap"
    loading="async"
    async
    defer>
  </script>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBQNGqpCU04OhQ-Py3iKvWcSxGuDgwIFsQ",
      authDomain: "foodiedata-b4982.firebaseapp.com",
      projectId: "foodiedata-b4982",
      storageBucket: "foodiedata-b4982.appspot.com",
      messagingSenderId: "90315404352",
      appId: "1:90315404352:web:e12b4fc3f5a87a11191ba5",
      measurementId: "G-5FD72CVKGB"
    };
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>

  <style>
    /* CSS 保持不變 */
    :root {--primary-color: #667eea;--secondary-color: #764ba2;--success-color: #28a745;--danger-color: #dc3545;--warning-color: #ffc107;--background-color: #f8f9fa;--text-color: #333;--text-light: #6c757d;--nav-height: 60px;}html,body {height: 100%;margin: 0;overflow: hidden;font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;background-color: var(--background-color);}.app-container {width: 100%;height: 100vh;display: flex;flex-direction: column;}main {flex-grow: 1;overflow: hidden;position: relative;}.page {width: 100%;height: 100%;display: none;flex-direction: column;overflow: hidden;animation: fadeIn 0.3s ease-in-out;}@keyframes fadeIn {from {opacity: 0;}to {opacity: 1;}}.page.active {display: flex;}
    #map-page { display: flex; flex-direction: column; height: 100%; }
    .map-container { height: 61.8%; position: relative; flex-shrink: 0; background-color: #e5e3df; }
    #map { width: 100%; height: 100%; }
    .search-area { position: absolute; top: 15px; left: 15px; right: 15px; z-index: 1000; display: flex; }
    
    /* FIX 2: Added styles for the new PlaceAutocompleteElement to match the old input */
    gmp-place-autocomplete {
      width: 100%;
    }
    gmp-place-autocomplete > input {
      width: 100%;
      padding: 14px 50px 14px 20px;
      font-size: 16px;
      border-radius: 30px;
      border: none;
      box-sizing: border-box;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .clear-search-btn { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); background: #ccc; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 16px; color: white; display: none; justify-content: center; align-items: center; z-index: 2; /* Ensure it's on top of the autocomplete input */ }
    .location-btn { position: absolute; bottom: 20px; right: 20px; background: #fff; color: var(--primary-color); border: none; width: 50px; height: 50px; border-radius: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 10; font-size: 22px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
    #details-panel { height: 38.2%; background: white; border-top: 1px solid #ddd; display: flex; flex-direction: column; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
    .panel-header { padding: 15px 20px; font-weight: bold; border-bottom: 1px solid #eee; flex-shrink: 0; }
    .details-content { overflow-y: auto; padding: 0 20px 20px; flex-grow: 1; }
    .details-placeholder { text-align: center; color: #aaa; padding: 40px 20px; }
    .details-placeholder i { font-size: 40px; margin-bottom: 15px; }
    .details-header { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px; padding-top: 15px; }
    .details-header-info h3 { margin: 0 0 5px; font-size: 22px; }
    .details-header-info p { margin: 0; font-size: 14px; color: var(--text-light); }
    .route-info { display: flex; gap: 15px; margin: 20px 0; padding: 15px; background: var(--background-color); border-radius: 12px; }
    .route-option { flex: 1; text-align: center; }
    .route-option i { font-size: 22px; color: var(--primary-color); }
    .route-option .time { font-size: 18px; font-weight: bold; display: block; margin-top: 5px; }
    .route-option .mode { font-size: 12px; color: var(--text-light); }
    .details-section { margin-bottom: 20px; }
    .details-section-title { font-weight: 600; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .details-section-content { font-size: 14px; color: #555; line-height: 1.6; }
    .details-section-content.collapsible { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .details-section-content.collapsible.expanded { max-height: 500px; }
    .details-section-content ul { list-style: none; padding: 0; margin: 0; }
    .details-section-content p { display: flex; align-items: center; gap: 10px; margin: 8px 0; }
    .details-section-content p i { width: 16px; text-align: center; color: var(--text-light); }
    .hours-list li { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f0f0f0; }
    .hours-list li:last-child { border-bottom: none; }
    .review-card { background: var(--background-color); padding: 15px; border-radius: 8px; margin-bottom: 10px; }
    .review-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .review-avatar { width: 30px; height: 30px; border-radius: 50%; background: var(--secondary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .review-author { font-weight: 600; }
    .review-rating { color: var(--warning-color); margin-left: auto; }
    .list-item { display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer; } .list-item:last-child { border-bottom: none; } .list-item .item-icon { font-size: 18px; color: var(--primary-color); flex-shrink: 0; } .list-item .item-info { flex-grow: 1; } .list-item .item-name { font-weight: 600; } .list-item .item-details { font-size: 13px; color: var(--text-light); margin-top: 4px; }
    .app-nav {height: var(--nav-height);width: 100%;background: #fff;border-top: 1px solid #e0e0e0;display: flex;justify-content: space-around;align-items: center;flex-shrink: 0;box-shadow: 0 -2px 10px rgba(0,0,0,0.05);}
    .nav-item {display: flex;flex-direction: column;align-items: center;justify-content: center;color: var(--text-light);font-size: 12px;cursor: pointer;transition: all 0.2s;width: 100%;height: 100%;}
    .nav-item i {font-size: 20px; margin-bottom: 5px;}
    .nav-item.active {color: var(--primary-color);transform: translateY(-2px);}
    .page-header {padding: 15px 20px;background-color: #fff;border-bottom: 1px solid #eee;text-align: center;flex-shrink: 0;display: flex;justify-content: space-between;align-items: center;box-shadow: 0 2px 4px rgba(0,0,0,0.05);position: relative;z-index: 10;}.page-header h2 {margin: 0;font-size: 18px;color: var(--text-color);display: flex;align-items: center;justify-content: center;flex-grow: 1;}.page-header h2 i {margin-right: 10px;color: var(--primary-color);}.header-action {font-size: 16px;color: var(--primary-color);text-decoration: none;cursor: pointer;padding: 8px 12px;border-radius: 6px;transition: background-color 0.2s;}.header-action:hover {background-color: rgba(102, 126, 234, 0.1);}.header-back-btn {font-size: 20px;color: var(--text-color);cursor: pointer;padding: 8px;border-radius: 50%;width: 36px;height: 36px;display: flex;align-items: center;justify-content: center;}.header-back-btn:hover {background-color: #f0f0f0;}.page-header .placeholder {width: 36px;}
    .form-group {margin-bottom: 20px;}
    .form-group-label, .form-group label {display: block;margin-bottom: 8px;font-weight: 500;color: var(--text-color);}
    .form-group input,.form-group textarea {width: 100%;padding: 12px;border: 1px solid #ccc;border-radius: 8px;box-sizing: border-box;font-size: 16px;transition: all 0.2s;}.form-group input:focus,.form-group textarea:focus {border-color: var(--primary-color);box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);outline: none;}.form-group textarea {min-height: 120px;resize: vertical;}.btn {display: flex;align-items: center;justify-content: center;gap: 8px;width: 100%;padding: 15px;background-color: var(--success-color);color: white;border: none;border-radius: 8px;font-size: 16px;font-weight: bold;cursor: pointer;text-align: center;transition: all 0.2s;}.btn:hover:not(:disabled) {background-color: #218838;transform: translateY(-2px);box-shadow: 0 4px 8px rgba(0,0,0,0.1);}.btn:disabled {background-color: #ccc;cursor: not-allowed;transform: none;box-shadow: none;}.rating-hearts {display: flex;gap: 10px;font-size: 30px;color: #ddd;cursor: pointer;}.rating-hearts .fa-heart {transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);}.rating-hearts .fa-heart:hover {transform: scale(1.2);}.rating-hearts .fa-heart.active {color: #ff4d6d;}.photo-upload-area {background: #f0f0f0;border: 2px dashed #ccc;border-radius: 8px;padding: 20px;display: flex;justify-content: center;gap: 20px;flex-wrap: wrap;}.photo-upload-area .btn-upload {background: #fff;color: var(--text-color);padding: 10px 20px;border-radius: 8px;cursor: pointer;border: 1px solid #ddd;transition: all 0.2s;}.photo-upload-area .btn-upload:hover {background-color: var(--primary-color);color: white;transform: translateY(-2px);}.photo-upload-area .btn-upload i {margin-right: 8px;}.photo-preview-container {display: flex;gap: 10px;flex-wrap: wrap;margin-top: 15px;}.photo-preview {position: relative;width: 80px;height: 80px;border-radius: 8px;overflow: hidden;box-shadow: 0 2px 8px rgba(0,0,0,0.1);}.photo-preview img {width: 100%;height: 100%;object-fit: cover;}.photo-preview .remove-btn {position: absolute;top: 4px;right: 4px;background: rgba(220, 53, 69, 0.8);color: white;border: none;border-radius: 50%;width: 20px;height: 20px;font-size: 12px;cursor: pointer;display: flex;align-items: center;justify-content: center;transition: all 0.2s;opacity: 0;}.photo-preview:hover .remove-btn {opacity: 1;}.photo-preview .remove-btn:hover {transform: scale(1.2);background: var(--danger-color);}.upload-progress {width: 100%;height: 4px;background: #f0f0f0;border-radius: 2px;margin-top: 10px;overflow: hidden;}.upload-progress-bar {height: 100%;background: var(--success-color);width: 0%;transition: width 0.3s ease;}#random-picker-container {display: flex;flex-direction: column;align-items: center;justify-content: center;height: 100%;padding: 20px;box-sizing: border-box;}#picker-wheel {width: 280px;height: 280px;border: 10px solid #ddd;border-radius: 50%;position: relative;display: flex;align-items: center;justify-content: center;margin-bottom: 30px;transition: transform 4s cubic-bezier(0.25, 1, 0.5, 1);background: linear-gradient(45deg, #667eea, #764ba2);box-shadow: 0 10px 20px rgba(0,0,0,0.2), inset 0 0 10px rgba(0,0,0,0.3);}#picker-arrow {width: 0;height: 0;border-left: 15px solid transparent;border-right: 15px solid transparent;border-top: 25px solid var(--danger-color);position: absolute;top: -35px;left: 50%;transform: translateX(-50%);z-index: 2;}#picker-result {font-size: 20px;font-weight: bold;color: white;text-align: center;height: 60px;padding: 0 10px;display: flex;align-items: center;justify-content: center;}.challenge-card {background: #fff;border-radius: 12px;margin-bottom: 20px;padding: 20px;box-shadow: 0 4px 15px rgba(0,0,0,0.08);transition: transform 0.2s, box-shadow 0.2s;}.challenge-card:hover {transform: translateY(-3px);box-shadow: 0 6px 20px rgba(0,0,0,0.1);}.challenge-header {display: flex;justify-content: space-between;align-items: center;margin-bottom: 15px;}.challenge-title {font-size: 18px;font-weight: 600;}.challenge-btn-join {background-color: var(--success-color);color: #fff;padding: 8px 15px;border-radius: 20px;font-size: 14px;border: none;cursor: pointer;transition: all 0.2s;}.challenge-btn-join:hover {transform: scale(1.05);}.challenge-btn-join.joined {background-color: var(--text-light);}.challenge-desc {font-size: 14px;color: var(--text-light);margin-bottom: 15px;}.challenge-ranking-title,.challenge-participants-title {font-size: 14px;font-weight: 500;margin-bottom: 8px;}.challenge-ranking-list,.challenge-participants-list {font-size: 14px;color: #555;list-style: none;padding-left: 0;margin: 0;}.challenge-ranking-list li {padding: 4px 0;}.challenge-ranking-list li i {color: #ffd700;margin-right: 4px;}.profile-tabs {display: flex;gap: 10px;padding: 10px 20px;background: #fff;border-bottom: 1px solid #eee;overflow-x: auto;flex-shrink: 0;}.tab-btn {background: #f0f0f0;border: none;border-radius: 20px;padding: 8px 15px;font-size: 14px;cursor: pointer;white-space: nowrap;transition: all 0.2s;}.tab-btn.active {background: var(--primary-color);color: #fff;box-shadow: 0 2px 5px rgba(102, 126, 234, 0.4);}.tab-content {display: none;}.tab-content.active {display: block;}.record-card,.post-card {background: #fff;padding: 15px;border-radius: 8px;margin-bottom: 10px;box-shadow: 0 2px 4px rgba(0,0,0,0.05);transition: transform 0.2s, box-shadow 0.2s;}.record-card:hover,.post-card:hover {transform: translateY(-2px);box-shadow: 0 4px 8px rgba(0,0,0,0.08);}.record-card .title,.post-card .title {font-weight: 600;margin-bottom: 5px;}.record-card .details,.post-card .details {font-size: 14px;color: var(--text-light);}.record-card .cost {font-weight: bold;color: var(--success-color);float: right;}.post-card .content {margin-top: 10px;font-size: 15px;line-height: 1.6;}.post-card .post-rating {margin-top: 10px;color: #ff4d6d;}.post-card .post-photos {display: flex;gap: 8px;margin-top: 10px;flex-wrap: wrap;}.post-photo {width: 60px;height: 60px;border-radius: 6px;object-fit: cover;cursor: pointer;transition: transform 0.2s, box-shadow 0.2s;}.post-photo:hover {transform: scale(1.05);box-shadow: 0 2px 5px rgba(0,0,0,0.2);}.auth-form-container {width: 100%;max-width: 400px;margin: 0 auto;padding: 20px;}.auth-form-container h3 {text-align: center;margin-bottom: 20px;font-size: 20px;}.auth-form-container input {width: 100%;padding: 12px;border: 1px solid #ccc;border-radius: 8px;box-sizing: border-box;margin-bottom: 15px;font-size: 16px;}.btn-auth {width: 100%;padding: 12px;font-size: 16px;border-radius: 8px;border: none;cursor: pointer;margin-bottom: 10px;color: #fff;font-weight: bold;transition: all 0.2s;}.btn-auth.primary {background-color: var(--primary-color);}.btn-auth.primary:hover {background-color: #5a6fd8;transform: translateY(-2px);}.btn-auth.secondary {background-color: #fff;color: #4285F4;border: 1px solid #ddd;display:flex;align-items:center;justify-content:center;gap: 10px;}.btn-auth.secondary:hover {background-color: #f8f9fa;}.auth-separator {display: flex;align-items: center;text-align: center;color: #aaa;margin: 20px 0;}.auth-separator::before,.auth-separator::after {content: '';flex: 1;border-bottom: 1px solid #ddd;}.auth-separator:not(:empty)::before {margin-right: .25em;}.auth-separator:not(:empty)::after {margin-left: .25em;}.auth-switch-link {text-align: center;margin-top: 15px;font-size: 14px;color: var(--primary-color);cursor: pointer;}.auth-error-message {color: var(--danger-color);margin-bottom: 15px;min-height: 20px;font-weight: 500;text-align: center;}.toast-container {position: fixed;top: 20px;right: 20px;z-index: 10000;display: flex;flex-direction: column;gap: 10px;}.toast {background: #333;color: white;padding: 15px 20px;border-radius: 8px;box-shadow: 0 4px 10px rgba(0,0,0,0.2);animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s forwards;}.toast.success {background: var(--success-color);}.toast.error {background: var(--danger-color);}.toast.warning {background: var(--warning-color);color: #333;}@keyframes slideInRight {from {transform: translateX(120%);}to {transform: translateX(0);}}@keyframes fadeOut {from {opacity: 1;}to {opacity: 0;}}.loading-spinner {display: inline-block;width: 18px;height: 18px;border: 3px solid rgba(255,255,255,0.3);border-top-color: #fff;border-radius: 50%;animation: spin 1s linear infinite;}@keyframes spin {0% {transform: rotate(0deg);}100% {transform: rotate(360deg);}}
  </style>
</head>
<body>
  <div class="app-container">
    <main>
      <div id="map-page" class="page active">
        <div class="map-container">
          <div id="map"></div>
          <!-- FIX 3: Replaced the <input> with a container for the new web component -->
          <div class="search-area">
             <!-- The new PlaceAutocompleteElement will be inserted here by JS -->
             <button class="clear-search-btn" id="clear-search" onclick="clearSearch()">×</button>
          </div>
          <button class="location-btn" onclick="centerOnUserGPS()"><i class="fas fa-location-arrow"></i></button>
        </div>
        <div id="details-panel" class="details-panel"><div class="panel-header" id="panel-header">附近餐廳</div><div class="details-content" id="details-content-area"></div></div>
      </div>
      <!-- Other pages' HTML remains unchanged -->
      <div id="random-page" class="page"><div class="page-header"><div class="placeholder"></div><h2><i class="fa-solid fa-dice"></i>美食隨機選</h2><div class="placeholder"></div></div><div id="random-picker-container"><div id="picker-arrow"></div><div id="picker-wheel"><div id="picker-result">?</div></div><button class="btn" id="random-pick-btn" onclick="startRandomPick()">開始抽籤！</button><p id="random-status-text" class="placeholder-text"></p></div></div>
      <div id="add-review-page" class="page">
        <div class="page-header"><div class="placeholder"></div><h2><i class="fa-solid fa-pencil"></i>新增美食評論</h2><div class="placeholder"></div></div>
        <div class="page-content">
            <div class="form-group"><label for="review-restaurant-name">餐廳名稱</label><input type="text" id="review-restaurant-name" placeholder="輸入吃過的餐廳" required></div>
            <div class="form-group"><label for="review-meal-items">餐點項目</label><textarea id="review-meal-items" placeholder="吃了什麼好料？ (例如：小籠包、牛肉麵)"></textarea></div>
            <div class="form-group"><label for="review-cost">花費金額 (NT$)</label><input type="number" id="review-cost" placeholder="大約花了多少錢？" min="0"></div>
            <div class="form-group"><div class="form-group-label">喜愛程度</div><div class="rating-hearts" id="review-rating" data-rating="0"><i class="fa-solid fa-heart" data-value="1"></i><i class="fa-solid fa-heart" data-value="2"></i><i class="fa-solid fa-heart" data-value="3"></i><i class="fa-solid fa-heart" data-value="4"></i><i class="fa-solid fa-heart" data-value="5"></i></div></div>
            <div class="form-group"><label for="review-content">評論內容 (會成為貼文)</label><textarea id="review-content" placeholder="分享你的心得、推薦或建議..."></textarea></div>
            <div class="form-group"><div class="form-group-label">新增照片</div><div class="photo-upload-area"><div class="btn-upload" onclick="photoManager.handlePhotoSelection('gallery')"><i class="fa-solid fa-images"></i> 從相簿選擇</div><div class="btn-upload" onclick="photoManager.handlePhotoSelection('camera')"><i class="fa-solid fa-camera"></i> 開啟相機</div></div><div id="photo-preview-container" class="photo-preview-container"></div><div id="upload-progress" class="upload-progress" style="display: none;"><div class="upload-progress-bar"></div></div></div>
            <button class="btn" onclick="saveReviewWithPhotos(event)">儲存評論與貼文</button>
        </div>
      </div>
      <div id="challenge-page" class="page"><div class="page-header"><div class="placeholder"></div><h2><i class="fa-solid fa-trophy"></i>美食挑戰榜</h2><div class="placeholder"></div></div><div class="page-content" id="challenge-list-container"></div></div>
      <div id="profile-page" class="page"><div class="page-header"><div class="placeholder"></div><h2 id="profile-header"><i class="fa-solid fa-user"></i>個人檔案</h2><a id="profile-login-btn" class="header-action" style="display: none;" onclick="showPage('login-page')">登入/註冊</a><a id="profile-logout-btn" class="header-action" style="display: none;" onclick="handleSignOut()">登出</a></div><div class="profile-tabs"><button class="tab-btn active" onclick="showProfileTab('accounting', this)">記帳顯示</button><button class="tab-btn" onclick="showProfileTab('posts', this)">我的貼文</button><button class="tab-btn" onclick="showProfileTab('favorites', this)">最愛餐廳</button><button class="tab-btn" onclick="showProfileTab('friends', this)">好友名單</button><button class="tab-btn" onclick="showProfileTab('analytics', this)">數據分析</button></div><div class="page-content" style="padding-top:0;"><div id="accounting-content" class="tab-content active"></div><div id="posts-content" class="tab-content"></div><div id="favorites-content" class="tab-content"></div><div id="friends-content" class="tab-content"></div><div id="analytics-content" class="tab-content"></div></div></div>
      <div id="login-page" class="page"><div class="page-header"><i class="fa-solid fa-chevron-left header-back-btn" onclick="goBack()"></i><h2>會員登入</h2><div class="placeholder"></div></div><div class="page-content"><div class="auth-form-container"><input type="email" id="login-email-input" placeholder="電子郵件" required><input type="password" id="login-password-input" placeholder="密碼" required><div id="login-error" class="auth-error-message"></div><button class="btn-auth primary" onclick="handleSignIn()">登入</button><div class="auth-separator">或</div><button class="btn-auth secondary" onclick="handleGoogleSignIn()"><i class="fab fa-google"></i> 使用 Google 登入</button><div class="auth-switch-link" onclick="showPage('register-page')">還沒有帳號？點此註冊</div></div></div></div>
      <div id="register-page" class="page"><div class="page-header"><i class="fa-solid fa-chevron-left header-back-btn" onclick="goBack()"></i><h2>註冊新帳號</h2><div class="placeholder"></div></div><div class="page-content"><div class="auth-form-container"><input type="text" id="register-name-input" placeholder="姓名或暱稱" required><input type="email" id="register-email-input" placeholder="電子郵件" required><input type="password" id="register-password-input" placeholder="設定密碼 (至少6位數)" required><div id="register-error" class="auth-error-message"></div><button class="btn-auth primary" onclick="handleRegister()">註冊送出</button><div class="auth-switch-link" onclick="showPage('login-page')">已經有帳號了？點此登入</div></div></div></div>
    </main>

    <footer class="app-nav"><div class="nav-item active" onclick="showPage('map-page', this)"><i class="fa-solid fa-map-location-dot"></i><span>地圖</span></div><div class="nav-item" onclick="showPage('random-page', this)"><i class="fa-solid fa-dice"></i><span>隨機選</span></div><div class="nav-item" onclick="showPage('add-review-page', this)"><i class="fa-solid fa-plus-circle"></i><span>新增</span></div><div class="nav-item" onclick="showPage('challenge-page', this)"><i class="fa-solid fa-trophy"></i><span>挑戰榜</span></div><div class="nav-item" onclick="showPage('profile-page', this)"><i class="fa-solid fa-user"></i><span>個人</span></div></footer>
  </div>

<div class="toast-container"></div>

<script>
    // === 全域變數 ===
    // FIX 4: Removed obsolete variables `placesService` and `autocomplete`.
    let map, userGpsPosition, userMarker, restaurantMarkers = [], debounceTimer, infoWindow, directionsService, directionsRenderer;
    let isMapReady = false;

    // The initMap function is the entry point after the Google Maps script loads.
    async function initMap() {
        // We need to wait for these libraries to be available.
        const { Map } = await google.maps.importLibrary("maps");
        const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
        const { Place } = await google.maps.importLibrary("places");
        
        isMapReady = true; 
        userGpsPosition = { lat: 25.0479, lng: 121.5171 };
        map = new Map(document.getElementById("map"), {
            center: userGpsPosition,
            zoom: 15,
            disableDefaultUI: true,
            zoomControl: true,
            mapId: 'FOODIE_APP_MAP_ID' // A Map ID is required for Advanced Markers
        });
        
        infoWindow = new google.maps.InfoWindow(); 
        directionsService = new google.maps.DirectionsService(); 
        directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true, polylineOptions: { strokeColor: '#4285F4', strokeOpacity: 0.8, strokeWeight: 6 } });
        
        initializeMapComponents();
    }

    function initializeMapComponents() {
        createUserMarker(userGpsPosition); 
        setupMapListeners(); 
        setupAutocomplete(); 
        updateUserGPS(); 
        resetDetailsPanel();
    }
</script>

<script>
    let currentUser = null; 
    let pageHistory = [];
    let selectedPlace = null;

    // --- All other classes and functions (Utils, DataManager, etc.) remain unchanged ---
    class Utils { static showToast(message, type = 'success') { const container = document.querySelector('.toast-container'); const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; container.appendChild(toast); setTimeout(() => { if (toast.parentNode) { toast.parentNode.removeChild(toast); }}, 3000); } static formatDate(dateString) { return new Date(dateString).toLocaleDateString('zh-TW'); } static formatDateTime(dateString) { return new Date(dateString).toLocaleString('zh-TW'); } static generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); } static sanitizeHTML(str) { const div = document.createElement('div'); div.textContent = str; return div.innerHTML; } static validateEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); } static debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; } }
    class DataManager { static _get(key, defaultValue) { if (!currentUser) return defaultValue; const storageKey = `${key}_${currentUser.uid}`; return JSON.parse(localStorage.getItem(storageKey)) || defaultValue; } static _set(key, value) { if (!currentUser) return; const storageKey = `${key}_${currentUser.uid}`; localStorage.setItem(storageKey, JSON.stringify(value)); } static getPosts() { return this._get('posts', []); } static savePosts(posts) { this._set('posts', posts); } static getUserChallenges() { return this._get('userChallenges', {}); } static saveUserChallenges(challenges) { this._set('userChallenges', challenges); } }
    class PhotoManager { constructor() { this.selectedPhotos = []; this.maxPhotos = 5; this.maxFileSize = 5 * 1024 * 1024; } handlePhotoSelection(type) { const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*'; input.multiple = true; if (type === 'camera') { input.capture = 'environment'; input.multiple = false; } input.onchange = (e) => this.processFiles(Array.from(e.target.files)); input.click(); } async processFiles(files) { if (this.selectedPhotos.length + files.length > this.maxPhotos) { Utils.showToast(`最多只能選擇${this.maxPhotos}張照片！`, 'warning'); return; } for (const file of files) { if (file.size > this.maxFileSize) { Utils.showToast(`檔案 ${file.name} 超過5MB限制！`, 'warning'); continue; } try { await this.processFile(file); } catch (error) { console.error('處理照片失敗:', error); Utils.showToast(`處理 ${file.name} 時發生錯誤`, 'error'); } } this.updatePhotoPreview(); } async processFile(file) { this.showProgress(true); try { const compressedFile = await this.compressImage(file); const preview = await this.convertToBase64(compressedFile); this.selectedPhotos.push({ id: Utils.generateId(), file: compressedFile, preview, name: file.name, uploaded: false, url: null }); } finally { this.showProgress(false); } } compressImage(file, maxWidth = 800, quality = 0.8) { return new Promise((resolve, reject) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); let { width, height } = img; if (width > maxWidth) { height = (height * maxWidth) / width; width = maxWidth; } canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); canvas.toBlob(blob => resolve(new File([blob], file.name, { type: 'image/jpeg' })), 'image/jpeg', quality); }; img.onerror = reject; img.src = URL.createObjectURL(file); }); } convertToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(file); });} showProgress(show) { const p = document.getElementById('upload-progress'); if (p) { p.style.display = show ? 'block' : 'none'; if(show){ const b = p.querySelector('.upload-progress-bar'); b.style.width = '0%'; setTimeout(() => b.style.width = '100%', 100);}}} updatePhotoPreview() { const c = document.getElementById('photo-preview-container'); if (!c) return; c.innerHTML = this.selectedPhotos.map(p => `<div class="photo-preview"><img src="${p.preview}" alt="預覽"><button class="remove-btn" onclick="photoManager.removePhoto('${p.id}')">×</button></div>`).join(''); } removePhoto(photoId) { this.selectedPhotos = this.selectedPhotos.filter(p => p.id !== photoId); this.updatePhotoPreview(); } async uploadAllPhotos() { return this.selectedPhotos.map(p => p.preview); } clearPhotos() { this.selectedPhotos = []; this.updatePhotoPreview(); } getPhotoCount() { return this.selectedPhotos.length; } }
    window.photoManager = new PhotoManager();
    window.showPage = function(pageId, navElement = null) { const activePage = document.querySelector('.page.active'); if (activePage && (!['login-page', 'register-page'].includes(activePage.id) || !['login-page', 'register-page'].includes(pageId))) { pageHistory.push(activePage.id); } document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); if (navElement) { document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active')); navElement.classList.add('active'); pageHistory = []; } setTimeout(() => { if (pageId === 'random-page') updateRandomPageStatus(); if (pageId === 'challenge-page') renderChallenges(); if (pageId === 'profile-page') renderProfilePage(); }, 0); }; window.goBack = function() { if (pageHistory.length > 0) { const lastPageId = pageHistory.pop(); document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(lastPageId).classList.add('active'); } else { showPage('map-page', document.querySelector('.nav-item[onclick*="map-page"]')); } };
    window.handleRegister = async function() { const name = document.getElementById('register-name-input').value.trim(); const email = document.getElementById('register-email-input').value; const password = document.getElementById('register-password-input').value; const errorDiv = document.getElementById('register-error'); errorDiv.textContent = ''; if (!name || !email || !password) { errorDiv.textContent = '所有欄位都必須填寫！'; return; } if (!Utils.validateEmail(email)) { errorDiv.textContent = '電子郵件格式不正確！'; return; } if (password.length < 6) { errorDiv.textContent = '密碼至少需要6位數！'; return; } try { const userCredential = await auth.createUserWithEmailAndPassword(email, password); await userCredential.user.updateProfile({ displayName: name }); Utils.showToast('註冊成功！', 'success'); goBack(); } catch (error) { errorDiv.textContent = '註冊失敗，該信箱可能已被使用。'; } }; window.handleSignIn = async function() { const email = document.getElementById('login-email-input').value; const password = document.getElementById('login-password-input').value; const errorDiv = document.getElementById('login-error'); errorDiv.textContent = ''; if (!email || !password) { errorDiv.textContent = '請填寫電子郵件和密碼！'; return; } try { await auth.signInWithEmailAndPassword(email, password); Utils.showToast('登入成功！', 'success'); goBack(); } catch (error) { errorDiv.textContent = '登入失敗，請檢查信箱或密碼。'; } }; window.handleGoogleSignIn = async function() { const provider = new firebase.auth.GoogleAuthProvider(); try { await auth.signInWithPopup(provider); Utils.showToast('Google 登入成功！', 'success'); goBack(); } catch (error) { document.getElementById('login-error').textContent = 'Google 登入失敗，請稍後再試。'; }}; window.handleSignOut = async function() { try { await auth.signOut(); Utils.showToast('已登出'); } catch (error) { console.error("登出錯誤:", error); }};
    function setupLoggedInUI(user) { document.getElementById('profile-login-btn').style.display = 'none'; document.getElementById('profile-logout-btn').style.display = 'block'; document.getElementById('profile-header').innerHTML = `<i class="fa-solid fa-user"></i> ${Utils.sanitizeHTML(user.displayName || user.email)}`; renderProfilePage(); } 
    function setupLoggedOutUI() { document.getElementById('profile-login-btn').style.display = 'block'; document.getElementById('profile-logout-btn').style.display = 'none'; document.getElementById('profile-header').innerHTML = `<i class="fa-solid fa-user"></i> 個人檔案`; renderProfilePage(); document.getElementById('challenge-list-container').innerHTML = '<p class="placeholder-text">登入後即可查看並參加美食挑戰！</p>'; document.getElementById('random-status-text').textContent = '登入後，系統會從您的美食紀錄中隨機抽選！'; if(document.getElementById('picker-result')) { document.getElementById('picker-result').textContent = '?'; } }

    // FIX 5: Migrated from `google.maps.Marker` to `AdvancedMarkerElement`.
    function createUserMarker (position) {
        if (userMarker) {
            userMarker.position = position;
        } else {
            const userIcon = document.createElement('div');
            userIcon.innerHTML = `<i class="fas fa-street-view" style="font-size: 28px; color: #4285F4; transform: translateY(14px);"></i>`;
            userMarker = new google.maps.marker.AdvancedMarkerElement({
                position,
                map,
                content: userIcon,
                title: "您的位置",
                zIndex: 1000
            });
        }
    }

    window.setupMapListeners = function() { if(!map) return; map.addListener("idle", () => { if (!selectedPlace) { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => searchNearbyRestaurants(map.getCenter()), 500); } }); map.addListener('click', () => { clearSearch(); }); }
    
    // FIX 6: Migrated from `google.maps.places.Autocomplete` to `PlaceAutocompleteElement`.
    function setupAutocomplete() {
        const searchArea = document.querySelector('.search-area');
        const clearBtn = document.getElementById('clear-search');
        
        const placeAutocomplete = new google.maps.places.PlaceAutocompleteElement({
            types: ['establishment', 'geocode'],
            componentRestrictions: { country: 'tw' }
        });
        placeAutocomplete.id = 'place-autocomplete-input';
        
        // The web component's internal input element
        const inputElement = placeAutocomplete.inputElement;
        inputElement.placeholder = "搜尋餐廳或地點...";

        searchArea.insertBefore(placeAutocomplete, clearBtn);
        
        inputElement.addEventListener('input', () => {
            clearBtn.style.display = inputElement.value ? 'flex' : 'none';
        });
        
        placeAutocomplete.addEventListener('gmp-placeselect', async ({place}) => {
            await place.fetchFields({ fields: ['id', 'displayName', 'location', 'formattedAddress', 'vicinity'] });
            handlePlaceSelection(place);
        });
    }

    window.updateUserGPS = function() { if (!isMapReady) return; if (navigator.geolocation) { navigator.geolocation.getCurrentPosition( (position) => { userGpsPosition = { lat: position.coords.latitude, lng: position.coords.longitude }; createUserMarker(userGpsPosition); centerOnUserGPS(); }, () => searchNearbyRestaurants(map.getCenter()) ); } else { searchNearbyRestaurants(map.getCenter()); } };
    window.centerOnUserGPS = function() { if (map && userGpsPosition) map.panTo(userGpsPosition); };
    
    // FIX 7: Migrated from `PlacesService.nearbySearch` to `Place.searchNearby`.
    async function searchNearbyRestaurants(location) {
        if (!isMapReady) return;
        resetDetailsPanel("正在搜尋附近餐廳...");
        clearRestaurantMarkers();

        const request = {
            fields: ['id', 'displayName', 'location', 'rating', 'userRatingCount', 'vicinity'],
            locationRestriction: { center: location, radius: 1500 },
            includedTypes: ['restaurant'],
            maxResultCount: 20
        };

        try {
            const { places } = await google.maps.places.Place.searchNearby(request);
            if (places && places.length > 0) {
                processAndDisplayResults(places);
            } else {
                resetDetailsPanel("此區域找不到餐廳");
            }
        } catch (error) {
            console.error("Nearby search failed", error);
            resetDetailsPanel("搜尋時發生錯誤");
        }
    }
    
    // FIX 8: Updated to handle new place object properties from `Place.searchNearby`.
    function processAndDisplayResults(places) {
        const contentArea = document.getElementById('details-content-area');
        document.getElementById('panel-header').textContent = '附近餐廳';
        contentArea.innerHTML = '';
        places.forEach((place) => {
            addRestaurantMarker(place);
            addRestaurantToList(place, contentArea);
        });
    }
    
    // FIX 9: Migrated to `AdvancedMarkerElement` for restaurant markers.
    function addRestaurantMarker(place) {
        const restaurantIcon = document.createElement('div');
        restaurantIcon.innerHTML = `<i class="fas fa-utensils" style="color: var(--primary-color); font-size: 20px; transform: translateY(10px);"></i>`;

        const marker = new google.maps.marker.AdvancedMarkerElement({ 
            position: place.location, 
            map: map, 
            title: place.displayName,
            content: restaurantIcon
        });
        marker.addListener('click', (e) => {
            e.domEvent?.stopPropagation();
            handlePlaceSelection(place);
        });
        marker.placeId = place.id;
        restaurantMarkers.push(marker);
    }
    
    // FIX 10: Updated to handle new place object properties.
    function addRestaurantToList(place, container) {
        const item = document.createElement("div");
        item.className = "list-item";
        const ratingHtml = place.rating ? `<i class="fas fa-star" style="color: #ffd700;"></i> ${place.rating}` : `無評分`;
        item.innerHTML = `<div class="item-icon"><i class="fas fa-utensils"></i></div><div class="item-info"><div class="item-name">${place.displayName}</div><div class="item-details">${place.vicinity || ''}<br>${ratingHtml}</div></div>`;
        item.onclick = () => handlePlaceSelection(place);
        container.appendChild(item);
    }

    async function handlePlaceSelection(place) {
        selectedPlace = place;
        clearRestaurantMarkers();
        directionsRenderer.setDirections({routes: []});

        const selectedIcon = document.createElement('div');
        selectedIcon.innerHTML = `<i class="fas fa-map-pin" style="color: var(--danger-color); font-size: 30px; transform: translateY(15px);"></i>`;
        
        const selectedMarker = new google.maps.marker.AdvancedMarkerElement({
             position: place.location,
             map: map,
             title: place.displayName,
             content: selectedIcon,
             zIndex: 1001
        });

        restaurantMarkers.push(selectedMarker);
        if (place.location) { map.panTo(place.location); }
        await calculateAndDisplayRoute(place);
    }

    async function calculateAndDisplayRoute(place) {
        if (!userGpsPosition) {
            await renderDetailsPanel(place, null);
            return;
        }
        const destination = place.location;
        const requests = [{ travelMode: 'DRIVING' }, { travelMode: 'WALKING' }];
        const promises = requests.map(req => new Promise(resolve => {
            directionsService.route({ origin: userGpsPosition, destination, travelMode: req.travelMode }, (result, status) => {
                resolve({ ...req, result, status });
            });
        }));
        
        const results = await Promise.all(promises);
        const drivingResult = results.find(r => r.travelMode === 'DRIVING');
        if (drivingResult && drivingResult.status === 'OK') {
            directionsRenderer.setDirections(drivingResult.result);
            map.fitBounds(drivingResult.result.routes[0].bounds);
        }
        const routeInfo = {
            driving: (drivingResult && drivingResult.status === 'OK') ? drivingResult.result.routes[0].legs[0] : null,
            walking: results.find(r => r.travelMode === 'WALKING' && r.status === 'OK')?.result.routes[0].legs[0] || null
        };
        await renderDetailsPanel(place, routeInfo);
    }
    
    // FIX 11: Migrated from `PlacesService.getDetails` to `place.fetchFields`.
    async function renderDetailsPanel(place, routeInfo) {
        const contentArea = document.getElementById('details-content-area');
        const panelHeader = document.getElementById('panel-header');
        contentArea.innerHTML = `<div class="details-placeholder"><p>正在載入餐廳詳情...</p></div>`;

        try {
            const fieldsToFetch = ['displayName', 'rating', 'userRatingCount', 'formattedPhoneNumber', 'regularOpeningHours', 'vicinity', 'formattedAddress'];
            await place.fetchFields({ fields: fieldsToFetch });
            
            const details = place; // Use the fetched place object
            panelHeader.textContent = details.displayName;

            const drivingTime = routeInfo?.driving?.duration.text || 'N/A';
            const walkingTime = routeInfo?.walking?.duration.text || 'N/A';
            let hoursHtml = '<ul><li>未提供營業時間資訊</li></ul>';
            if (details.regularOpeningHours) {
                hoursHtml = `<ul class="hours-list">${details.regularOpeningHours.weekdayDescriptions.map(day => `<li>${day.replace(/：/g, ': ')}</li>`).join('')}</ul>`;
            }

            const myReviews = DataManager.getPosts().filter(p => p.name === details.displayName);
            const reviewsHtml = myReviews.length > 0 ? myReviews.map(review => `<div class="review-card"><div class="review-card-header"><div class="review-avatar">${currentUser?.displayName?.charAt(0) || '我'}</div><div class="review-author">${currentUser?.displayName || '我'}</div><div class="review-rating">${'★'.repeat(review.rating)}</div></div><div class="details-section-content">${Utils.sanitizeHTML(review.content) || '(無評論內容)'}</div></div>`).join('') : '<p>尚無相關評論。</p>';
            
            contentArea.innerHTML = `
                <div class="details-header"><div class="details-header-info"><h3>${details.displayName}</h3><p>${details.rating || 'N/A'} ★ (${details.userRatingCount || 0} 則 Google 評論)</p></div></div>
                <div class="route-info"><div class="route-option"><i class="fas fa-car"></i><span class="time">${drivingTime}</span><span class="mode">開車</span></div><div class="route-option"><i class="fas fa-walking"></i><span class="time">${walkingTime}</span><span class="mode">步行</span></div></div>
                <div class="details-section"><div class="details-section-content"><p><i class="fas fa-map-marker-alt"></i> ${details.formattedAddress || details.vicinity}</p><p><i class="fas fa-phone"></i> ${details.formattedPhoneNumber || '未提供'}</p></div></div>
                <div class="details-section"><div class="details-section-title" onclick="this.nextElementSibling.classList.toggle('expanded')"><span>營業時間</span><i class="fas fa-chevron-down"></i></div><div class="details-section-content collapsible">${hoursHtml}</div></div>
                <div class="details-section"><div class="details-section-title">我的評論</div><div class="details-section-content">${reviewsHtml}</div></div>`;

        } catch (error) {
            console.error("Fetch details failed", error);
            contentArea.innerHTML = '<div class="details-placeholder"><p>無法載入餐廳詳情</p></div>';
        }
    }

    window.resetDetailsPanel = function(message = '點擊地圖上的餐廳圖釘<br>或使用上方搜尋功能') { const contentArea = document.getElementById('details-content-area'); document.getElementById('panel-header').textContent = '附近餐廳'; contentArea.innerHTML = `<div class="details-placeholder"><i class="fas fa-utensils"></i><p>${message}</p></div>`; }
    function clearRestaurantMarkers() { restaurantMarkers.forEach(marker => { marker.map = null; }); restaurantMarkers = []; }
    window.clearSearch = function(suppressSearch = false) { selectedPlace = null; directionsRenderer.setDirections({routes: []}); const autocompleteInput = document.getElementById('place-autocomplete-input')?.inputElement; if(autocompleteInput) autocompleteInput.value = ''; document.getElementById('clear-search').style.display = 'none'; if (!suppressSearch) { map.setZoom(15); centerOnUserGPS(); searchNearbyRestaurants(map.getCenter()); } }
    
    // --- Other function JS remains the same ---
    function updateRandomPageStatus() { if (!currentUser) { document.getElementById('random-status-text').textContent = '登入後，系統會從您的美食紀錄中隨機抽選！'; document.getElementById('picker-result').textContent = '?'; return; } const restaurants = [...new Set(DataManager.getPosts().map(p => p.name))]; const statusText = document.getElementById('random-status-text'); document.getElementById('picker-result').textContent = "?"; statusText.textContent = restaurants.length === 0 ? "您還沒有新增任何餐廳喔！請到「新增」頁面加入吧！" : `目前有 ${restaurants.length} 家獨特的餐廳在您的口袋名單中。`; }
    window.startRandomPick = function() { if (!currentUser) { Utils.showToast('請先登入！', 'warning'); showPage('login-page'); return; } const restaurants = [...new Set(DataManager.getPosts().map(p => p.name))]; if (restaurants.length === 0) { Utils.showToast("口袋名單是空的，無法抽籤！", 'warning'); return; } const wheel = document.getElementById('picker-wheel'), resultDiv = document.getElementById('picker-result'), pickButton = document.getElementById('random-pick-btn'); pickButton.disabled = true; resultDiv.textContent = '...'; const randomSpins = Math.floor(Math.random() * 5) + 5, randomStopAngle = Math.floor(Math.random() * 360); wheel.style.transform = `rotate(${randomSpins * 360 + randomStopAngle}deg)`; setTimeout(() => { const winner = restaurants[Math.floor(Math.random() * restaurants.length)]; resultDiv.textContent = winner; Utils.showToast(`抽中了：${winner}！`, 'success'); pickButton.disabled = false; }, 4000); };
    function handleRatingClick(e) { const rating = e.target.dataset.value; document.getElementById('review-rating').dataset.rating = rating; updateHeartDisplay(rating); } function handleRatingHover(e) { updateHeartDisplay(e.target.dataset.value); } function handleRatingMouseout() { updateHeartDisplay(document.getElementById('review-rating').dataset.rating); } function updateHeartDisplay(rating) { document.querySelectorAll('.rating-hearts .fa-heart').forEach(heart => heart.classList.toggle('active', heart.dataset.value <= rating)); }
    window.saveReviewWithPhotos = async function(event) { if (!currentUser) { Utils.showToast('請先登入才能儲存評論！', 'warning'); showPage('login-page'); return; } const name = document.getElementById('review-restaurant-name').value.trim(), rating = document.getElementById('review-rating').dataset.rating; if (!name || rating === "0") { Utils.showToast("請務必填寫「餐廳名稱」和「喜愛程度」！", 'warning'); return; } const saveBtn = event.target; try { saveBtn.innerHTML = '<div class="loading-spinner"></div> 儲存中...'; saveBtn.disabled = true; const photoUrls = await photoManager.uploadAllPhotos(); const newPost = { id: Utils.generateId(), name: Utils.sanitizeHTML(name), items: Utils.sanitizeHTML(document.getElementById('review-meal-items').value.trim()), cost: Number(document.getElementById('review-cost').value) || 0, rating: parseInt(rating), content: Utils.sanitizeHTML(document.getElementById('review-content').value.trim()), photos: photoUrls, timestamp: new Date().toISOString() }; const posts = DataManager.getPosts(); posts.unshift(newPost); DataManager.savePosts(posts); Utils.showToast("評論已成功儲存！", 'success'); ['review-restaurant-name', 'review-meal-items', 'review-cost', 'review-content'].forEach(id => { document.getElementById(id).value = ''; }); document.getElementById('review-rating').dataset.rating = 0; updateHeartDisplay(0); photoManager.clearPhotos(); showPage('profile-page', document.querySelector('.nav-item[onclick*="profile-page"]')); } catch (error) { console.error('儲存失敗:', error); Utils.showToast('儲存時發生錯誤！', 'error'); } finally { saveBtn.innerHTML = '儲存評論與貼文'; saveBtn.disabled = false; } };
    const challengesData = [ { id: 'healthy_week', title: '挑戰一週健康餐', desc: '連續七天只吃原型食物和健康烹調的餐點！', rank: [ { name: 'Alice', score: '7/7天', medal: '🥇' }, { name: 'David', score: '6/7天', medal: '🥈' }], participants: ['Alice', 'David', '美食探險家'] }, { id: 'budget_200', title: '省錢大作戰：日均$200', desc: '挑戰連續五天，平均每日餐費不超過200元。', rank: [ { name: 'Bob', score: '平均 $185', medal: '🥇' }, { name: 'Charlie', score: '平均 $198', medal: '🥈' }], participants: ['Bob', 'Charlie'] }, { id: 'vegan_exp', title: '素食體驗週', desc: '挑戰一週完全素食(蛋奶素可)。', rank: [ { name: 'Eve', score: '完成', medal: '🥇' }, { name: 'Frank', score: '完成', medal: '🥈' } ], participants: ['Eve', 'Frank'] }];
    function renderChallenges() { const container = document.getElementById('challenge-list-container'); if (!currentUser) { container.innerHTML = '<p class="placeholder-text">登入後即可查看並參加美食挑戰！</p>'; return; } const userChallenges = DataManager.getUserChallenges(); container.innerHTML = ''; challengesData.forEach(c => { const isJoined = userChallenges[c.id]; const card = document.createElement('div'); card.className = 'challenge-card'; const rankingHtml = c.rank.map(r => `<li>${r.medal} ${r.name} (${r.score})</li>`).join(''); const participantsText = isJoined ? `${c.participants.join(', ')}, <b>您</b>` : c.participants.join(', '); card.innerHTML = `<div class="challenge-header"><div class="challenge-title">${c.title}</div><button class="challenge-btn-join ${isJoined ? 'joined' : ''}" onclick="toggleChallenge('${c.id}')">${isJoined ? '已參加' : '參加'}</button></div><p class="challenge-desc">${c.desc}</p><div><div class="challenge-ranking-title">🏆 排行榜：</div><ul class="challenge-ranking-list">${rankingHtml}</ul></div><div style="margin-top:15px;"><div class="challenge-participants-title">👥 參與者：</div><div class="challenge-participants-list">${participantsText}</div></div>`; container.appendChild(card); }); }
    window.toggleChallenge = function(challengeId) { if (!currentUser) { Utils.showToast('請先登入！', 'warning'); showPage('login-page'); return; } const userChallenges = DataManager.getUserChallenges(), wasJoined = userChallenges[challengeId]; userChallenges[challengeId] = !wasJoined; DataManager.saveUserChallenges(userChallenges); const challenge = challengesData.find(c => c.id === challengeId); if (challenge) { Utils.showToast(wasJoined ? `已退出「${challenge.title}」` : `已參加「${challenge.title}」`, 'success'); } renderChallenges(); };
    function renderProfilePage() { const activeTabBtn = document.querySelector('#profile-page .tab-btn.active'); if (activeTabBtn) { const tabId = activeTabBtn.getAttribute('onclick').match(/'([^']+)'/)[1]; showProfileTab(tabId, activeTabBtn); } }
    window.showProfileTab = function(tabId, tabElement) { document.querySelectorAll('#profile-page .tab-btn').forEach(btn => btn.classList.remove('active')); tabElement.classList.add('active'); document.querySelectorAll('#profile-page .tab-content').forEach(content => content.classList.remove('active')); document.getElementById(`${tabId}-content`).classList.add('active'); switch(tabId) { case 'accounting': renderAccountingRecords(); break; case 'posts': renderMyPosts(); break; case 'favorites': renderFavoriteRestaurants(); break; case 'friends': renderFriendsList(); break; case 'analytics': renderAnalytics(); break; } };
    const loggedOutPlaceholder = (message) => `<p class="placeholder-text">請先<a href="#" onclick="showPage('login-page')" style="color: var(--primary-color);">登入</a>${message}</p>`;
    function renderAccountingRecords() { const c = document.getElementById('accounting-content'); if (!currentUser) { c.innerHTML = loggedOutPlaceholder('以查看您的消費紀錄。'); return; } const posts = DataManager.getPosts().filter(p => p.cost > 0); if (posts.length === 0) { c.innerHTML = `<p class="placeholder-text">尚無消費紀錄。</p>`; return; } const totalCost = posts.reduce((sum, p) => sum + p.cost, 0); const averageCost = posts.length > 0 ? Math.round(totalCost / posts.length) : 0; c.innerHTML = `<h3>消費紀錄 <span style="color: var(--text-light); font-size: 14px;">(共 ${posts.length} 筆，總計 $${totalCost}，平均 $${averageCost})</span></h3>${posts.map(p => `<div class="record-card"><span class="cost">$${p.cost}</span><div class="title">${p.name}</div><div class="details">${Utils.formatDate(p.timestamp)} - ${p.items || '無餐點記錄'}</div></div>`).join('')}`; }
    function renderMyPosts() { const c = document.getElementById('posts-content'); if (!currentUser) { c.innerHTML = loggedOutPlaceholder('以查看您的貼文。'); return; } const posts = DataManager.getPosts(); if (posts.length === 0) { c.innerHTML = `<p class="placeholder-text">您還沒有發表過貼文。</p>`; return; } c.innerHTML = posts.map(p => { const r = Array(p.rating || 0).fill('<i class="fa-solid fa-heart"></i>').join(''); const ph = p.photos && p.photos.length > 0 ? `<div class="post-photos">${p.photos.map(url => `<img src="${url}" class="post-photo" onclick="showPhotoModal('${url}')" alt="美食照片">`).join('')}</div>` : ''; return `<div class="post-card"><div class="title">${p.name}</div><div class="details">${Utils.formatDateTime(p.timestamp)}</div><p class="content">${p.content || '（無詳細評論）'}</p><div class="post-rating">${r}</div>${ph}</div>`; }).join(''); }
    function renderFavoriteRestaurants() { const c = document.getElementById('favorites-content'); if (!currentUser) { c.innerHTML = loggedOutPlaceholder('以查看您的最愛餐廳。'); return; } const favorites = DataManager.getPosts().filter(p => p.rating >= 4).reduce((acc, cur) => { if (!acc.some(item => item.name === cur.name)) acc.push(cur); return acc; }, []).sort((a, b) => b.rating - a.rating); if (favorites.length === 0) { c.innerHTML = `<p class="placeholder-text">您還沒有評分高的餐廳喔！</p>`; return; } c.innerHTML = `<h3>最愛餐廳 (評分4顆心以上)</h3>${favorites.map(p => `<div class="record-card"><div class="title">${p.name}</div><div class="details">${Array(p.rating || 0).fill('<i class="fa-solid fa-heart" style="color: #ff4d6d;"></i>').join('')} - 最近造訪：${Utils.formatDate(p.timestamp)}</div></div>`).join('')}`; }
    function renderFriendsList() { const c = document.getElementById('friends-content'); if (!currentUser) { c.innerHTML = loggedOutPlaceholder('以查看好友名單。'); return; } const mockFriends = [{ id: '1', name: 'Alice Chen', status: '最近評論了「鼎泰豐」', online: true }, { id: '2', name: 'Bob Wang', status: '參加了素食體驗週挑戰', online: false }, { id: '3', name: 'Carol Lin', status: '昨天去了新餐廳', online: true }]; c.innerHTML = `<div style="margin-bottom: 20px;"><button class="btn" onclick="showAddFriendModal()"><i class="fa-solid fa-user-plus"></i> 新增好友</button></div>${mockFriends.map(f => `<div class="friend-card"><div class="friend-avatar">${f.name.charAt(0)}</div><div class="friend-info"><div class="friend-name">${f.name}</div><div class="friend-status"><i class="fa-solid fa-circle" style="color: ${f.online ? '#28a745' : '#6c757d'}; font-size: 8px;"></i> ${f.status}</div></div><div class="friend-actions"><button class="btn-sm btn-primary" onclick="viewFriendProfile('${f.id}')">查看</button><button class="btn-sm btn-danger" onclick="removeFriend('${f.id}')">移除</button></div></div>`).join('')}`; }
    function renderAnalytics() { const c = document.getElementById('analytics-content'); if (!currentUser) { c.innerHTML = loggedOutPlaceholder('以查看數據分析。'); return; } const posts = DataManager.getPosts(); if (posts.length < 3) { c.innerHTML = `<p class="placeholder-text">還沒有足夠的數據進行分析(至少3筆)。</p>`; return; } const totalPosts = posts.length, totalCost = posts.reduce((sum, p) => sum + (p.cost || 0), 0), avgRating = posts.reduce((sum, p) => sum + p.rating, 0) / totalPosts, uniqueRestaurants = new Set(posts.map(p => p.name)).size; const topRestaurants = Object.entries(posts.reduce((acc,p)=>{acc[p.name]=(acc[p.name]||0)+1;return acc;},{})).sort(([,a],[,b])=>b-a).slice(0,5); c.innerHTML = `<h3>我的美食數據分析</h3><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 30px;"><div class="record-card" style="text-align: center;"><div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">${totalPosts}</div><div style="color: var(--text-light);">總評論數</div></div><div class="record-card" style="text-align: center;"><div style="font-size: 24px; font-weight: bold; color: var(--success-color);">$${totalCost}</div><div style="color: var(--text-light);">總消費</div></div><div class="record-card" style="text-align: center;"><div style="font-size: 24px; font-weight: bold; color: var(--warning-color);">${avgRating.toFixed(1)}★</div><div style="color: var(--text-light);">平均評分</div></div><div class="record-card" style="text-align: center;"><div style="font-size: 24px; font-weight: bold; color: var(--danger-color);">${uniqueRestaurants}</div><div style="color: var(--text-light);">探店數量</div></div></div><div class="record-card"><h4>最常造訪的餐廳</h4>${topRestaurants.map(([name, count]) => `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;"><span>${name}</span><span>${count} 次</span></div>`).join('')}</div>`; }
    window.showAddFriendModal = function() { const e = prompt('請輸入好友的電子郵件地址：'); if (e && Utils.validateEmail(e)) Utils.showToast(`已發送好友邀請給 ${e}`, 'success'); else if (e) Utils.showToast('請輸入有效的電子郵件地址', 'warning'); }; window.viewFriendProfile = function(id) { Utils.showToast('好友個人檔案功能開發中！', 'warning'); }; window.removeFriend = function(id) { if (confirm('確定要移除這位好友嗎？')) { Utils.showToast('已移除好友'); renderFriendsList(); }}; window.showPhotoModal = function(url) { const m = document.createElement('div'); m.style.cssText = `position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;cursor:pointer;`; const i = document.createElement('img'); i.src = url; i.style.cssText = `max-width:90%;max-height:90%;border-radius:8px;`; m.appendChild(i); document.body.appendChild(m); m.onclick = () => document.body.removeChild(m); };
    
    document.addEventListener('DOMContentLoaded', () => {
        auth.onAuthStateChanged(user => { const oldUser = currentUser; currentUser = user; if (user) { setupLoggedInUI(user); if (!oldUser) { const draftData = localStorage.getItem(`reviewDraft_${currentUser.uid}`); if (draftData) { if (confirm('偵測到未完成的評論草稿，是否要繼續編輯？')) { const draft = JSON.parse(draftData); showPage('add-review-page'); setTimeout(() => { Object.keys(draft).forEach(key => { const element = document.getElementById(key); if (element) element.value = draft[key]; }); }, 100); } else { localStorage.removeItem(`reviewDraft_${currentUser.uid}`); } } } } else { setupLoggedOutUI(); } });
        setupDraftSaving(); 
        showPage('map-page', document.querySelector('.nav-item'));
        document.querySelectorAll('.rating-hearts .fa-heart').forEach(h => { h.addEventListener('click', handleRatingClick); h.addEventListener('mouseover', handleRatingHover); h.addEventListener('mouseout', handleRatingMouseout); });
        new class NetworkMonitor { constructor() { this.isOnline = navigator.onLine; this.setupListeners(); } setupListeners() { window.addEventListener('online', () => { this.isOnline = true; Utils.showToast('網路連線已恢復', 'success'); }); window.addEventListener('offline', () => { this.isOnline = false; Utils.showToast('網路連線中斷，部分功能可能受限', 'warning'); }); } }();
        function setupDraftSaving() { const reviewForm = document.querySelector('#add-review-page'); if (!reviewForm) return; const inputs = reviewForm.querySelectorAll('input[type=text], input[type=number], textarea'); const saveDraft = Utils.debounce(() => { if (currentUser) { const draftData = {}; inputs.forEach(inp => { if (inp.value.trim()) { draftData[inp.id] = inp.value; }}); if (Object.keys(draftData).length > 0) { localStorage.setItem(`reviewDraft_${currentUser.uid}`, JSON.stringify(draftData)); } else { localStorage.removeItem(`reviewDraft_${currentUser.uid}`); } } }, 1000); inputs.forEach(input => { input.addEventListener('input', saveDraft); }); }
    });
</script>
</body>
</html>
