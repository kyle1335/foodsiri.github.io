< !DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>FoodieApp</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs&libraries=places,geometry&callback=initMap"
    async
    defer
  ></script>

  <!-- Firebase SDK å°å…¥ -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  
  <style>
    /* CSS æ¨£å¼å¤§éƒ¨åˆ†ä¸è®Š */
    :root { --primary-color: #667eea; --secondary-color: #764ba2; --success-color: #28a745; --background-color: #f8f9fa; --text-color: #333; --text-light: #6c757d; --nav-height: 60px; }
    html, body { height: 100%; margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--background-color); }
    .app-container { width: 100%; height: 100vh; display: flex; flex-direction: column; }
    main { flex-grow: 1; overflow: hidden; position: relative; }
    .page { width: 100%; height: 100%; display: none; flex-direction: column; overflow: hidden; }
    .page.active { display: flex; }
    .app-nav { height: var(--nav-height); width: 100%; background: #fff; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-light); font-size: 12px; cursor: pointer; transition: color 0.2s; width: 100%; }
    .nav-item i { font-size: 22px; margin-bottom: 4px; }
    .nav-item.active { color: var(--primary-color); }
    #map-page { flex-direction: column; }
    #map-panel { height: 65%; position: relative; background: #e5e3df; }
    #list-panel { height: 35%; border-top: 1px solid #ddd; display: flex; flex-direction: column; background: white; overflow: hidden; }
    #map { width: 100%; height: 100%; }
    .search-area { padding: 15px; border-bottom: 1px solid #eee; background: var(--background-color); flex-shrink: 0; position: relative; }
    .search-input { width: 100%; padding: 12px 40px 12px 15px; font-size: 16px; border-radius: 25px; border: 1px solid #ccc; box-sizing: border-box; }
    .clear-search-btn { position: absolute; top: 50%; right: 25px; transform: translateY(-50%); background: #ccc; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 14px; font-weight: bold; color: white; display: none; justify-content: center; align-items: center; }
    .list-content { overflow-y: auto; flex-grow: 1; }
    .list-item { display: flex; align-items: flex-start; gap: 15px; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background-color 0.2s; }
    .list-item.is-selected { background-color: #e8eaf6; border-left: 4px solid var(--primary-color); padding-left: 11px; }
    .item-icon { font-size: 18px; color: var(--primary-color); margin-top: 3px; flex-shrink: 0; }
    .item-info { flex-grow: 1; min-width: 0; }
    .item-name { font-weight: 600; font-size: 16px; }
    .item-details, .item-address { font-size: 13px; color: var(--text-light); margin-top: 4px; }
    .item-address { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-distance { font-weight: 500; font-size: 14px; color: var(--text-color); white-space: nowrap; text-align: right; }
    .open-status.open { color: #28a745; font-weight: bold; }
    .open-status.closed { color: #dc3545; font-weight: bold; }
    .list-status-text { text-align: center; color: #999; padding: 40px 20px; }
    .location-btn { position: absolute; bottom: 20px; right: 20px; background: #fff; color: var(--primary-color); border: none; width: 50px; height: 50px; border-radius: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); cursor: pointer; z-index: 10; font-size: 24px; display: flex; justify-content: center; align-items: center; }
    .gm-style-iw-d { overflow: hidden !important; }
    .info-window-content { font-family: inherit; padding: 5px; max-width: 280px; }
    .info-window-content h4 { font-size: 16px; margin: 0 0 8px 0; font-weight: 600; }
    .info-window-content p { font-size: 14px; margin: 0 0 5px 0; color: #555; display: flex; align-items: center; }
    .info-window-content i { margin-right: 8px; color: var(--primary-color); width: 16px; text-align: center; }
    .page-header { padding: 15px 20px; background-color: #fff; border-bottom: 1px solid #eee; text-align: center; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
    .page-header h2 { margin: 0; font-size: 18px; color: var(--text-color); display: flex; align-items: center; justify-content: center; flex-grow: 1; }
    .page-header h2 i { margin-right: 10px; color: var(--primary-color); }
    .header-action { font-size: 16px; color: var(--primary-color); text-decoration: none; cursor: pointer; }
    .header-back-btn { font-size: 20px; color: var(--text-color); cursor: pointer; }
    .page-header .placeholder { width: 24px; } /* ç”¨æ–¼å°é½Šçš„ä½”ä½ç¬¦ */
    .page-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
    .placeholder-text { text-align: center; color: var(--text-light); margin-top: 50px; padding: 20px; }
    .btn { display: block; width: 100%; padding: 15px; background-color: var(--success-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; }
    #random-picker-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; box-sizing: border-box; }
    #picker-wheel { width: 280px; height: 280px; border: 10px solid #ddd; border-radius: 50%; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; transition: transform 4s cubic-bezier(0.25, 1, 0.5, 1); }
    #picker-arrow { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid #dc3545; position: absolute; top: -35px; left: 50%; transform: translateX(-50%); z-index: 2; }
    #picker-result { font-size: 20px; font-weight: bold; color: var(--primary-color); text-align: center; height: 60px; padding: 0 10px; }
    .form-group { margin-bottom: 20px; } .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color); } .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; } .form-group textarea { min-height: 120px; resize: vertical; } .rating-hearts { display: flex; gap: 10px; font-size: 30px; color: #ddd; cursor: pointer; } .rating-hearts .fa-heart:hover, .rating-hearts .fa-heart.active { color: #ff4d6d; } .photo-upload-area { background: #f0f0f0; border: 2px dashed #ccc; border-radius: 8px; padding: 20px; display: flex; justify-content: center; gap: 20px; } .photo-upload-area .btn-upload { background: #fff; color: var(--text-color); padding: 10px 20px; border-radius: 8px; cursor: pointer; border: 1px solid #ddd; } .photo-upload-area .btn-upload i { margin-right: 8px; }
    .challenge-card { background: #fff; border-radius: 12px; margin-bottom: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); } .challenge-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; } .challenge-title { font-size: 18px; font-weight: 600; } .challenge-btn-join { background-color: var(--success-color); color: #fff; padding: 8px 15px; border-radius: 20px; font-size: 14px; border: none; cursor: pointer; } .challenge-btn-join.joined { background-color: var(--text-light); } .challenge-desc { font-size: 14px; color: var(--text-light); margin-bottom: 15px; } .challenge-ranking-title, .challenge-participants-title { font-size: 14px; font-weight: 500; margin-bottom: 8px; } .challenge-ranking-list, .challenge-participants-list { font-size: 14px; color: #555; list-style: none; padding-left: 0; } .challenge-ranking-list li i { color: #ffd700; margin-right: 4px; }
    .profile-tabs { display: flex; gap: 10px; padding: 15px 20px; background: #fff; border-bottom: 1px solid #eee; overflow-x: auto; flex-shrink: 0; } .tab-btn { background: #f0f0f0; border: none; border-radius: 20px; padding: 8px 15px; font-size: 14px; cursor: pointer; white-space: nowrap; } .tab-btn.active { background: var(--primary-color); color: #fff; } .tab-content { display: none; } .tab-content.active { display: block; } .record-card, .post-card { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); } .record-card .title, .post-card .title { font-weight: 600; margin-bottom: 5px; } .record-card .details, .post-card .details { font-size: 14px; color: var(--text-light); } .record-card .cost { font-weight: bold; color: var(--success-color); float: right; } .post-card .content { margin-top: 10px; font-size: 15px; line-height: 1.6; } .post-card .post-rating { margin-top: 10px; color: #ff4d6d; }
    /* --- é©—è­‰è¡¨å–®æ¨£å¼ --- */
    .auth-form-container { width: 100%; max-width: 400px; margin: 0 auto; padding: 20px;}
    .auth-form-container h3 { text-align: center; margin-bottom: 20px; font-size: 20px; }
    .auth-form-container input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; font-size: 16px; }
    .btn-auth { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; margin-bottom: 10px; color: #fff; font-weight: bold; }
    .btn-auth.primary { background-color: var(--primary-color); }
    .btn-auth.secondary { background-color: #fff; color: #4285F4; border: 1px solid #ddd; display:flex; align-items:center; justify-content:center; gap: 10px;}
    .auth-separator { display: flex; align-items: center; text-align: center; color: #aaa; margin: 20px 0; }
    .auth-separator::before, .auth-separator::after { content: ''; flex: 1; border-bottom: 1px solid #ddd; }
    .auth-separator:not(:empty)::before { margin-right: .25em; }
    .auth-separator:not(:empty)::after { margin-left: .25em; }
    .auth-switch-link { text-align: center; margin-top: 15px; font-size: 14px; color: var(--primary-color); cursor: pointer; }
    #auth-error { color: #dc3545; margin-top: 15px; min-height: 20px; font-weight: 500; text-align: center; }
  </style>
</head>
<body>
  <div class="app-container">
    <main>
      <!-- ä¸»è¦åŠŸèƒ½é é¢ -->
      <div id="map-page" class="page active">
        <div id="map-panel">
          <div id="map"></div>
          <button class="location-btn" onclick="centerOnUserGPS()"><i class="fas fa-location-arrow"></i></button>
        </div>
        <div id="list-panel">
          <div class="search-area">
            <input type="text" id="search-input" class="search-input" placeholder="æœå°‹é¤å»³æˆ–åœ°é»...">
            <button class="clear-search-btn" id="clear-search" onclick="clearSearch()">Ã—</button>
          </div>
          <div class="list-content" id="list-content-area"><p class="list-status-text">æ­£åœ¨åˆå§‹åŒ–åœ°åœ–...</p></div>
        </div>
      </div>
      <div id="random-page" class="page">
        <div class="page-header"><h2><i class="fa-solid fa-dice"></i>ç¾é£Ÿéš¨æ©Ÿé¸</h2><div class="placeholder"></div></div>
        <div id="random-picker-container">
            <div id="picker-arrow"></div>
            <div id="picker-wheel"><div id="picker-result">?</div></div>
            <button class="btn" id="random-pick-btn" onclick="startRandomPick()">é–‹å§‹æŠ½ç±¤ï¼</button>
            <p id="random-status-text" class="placeholder-text" style="background: none; margin-top: 20px;"></p>
        </div>
      </div>
      <div id="add-review-page" class="page">
        <div class="page-header"><h2><i class="fa-solid fa-pencil"></i>æ–°å¢ç¾é£Ÿè©•è«–</h2><div class="placeholder"></div></div>
        <div class="page-content">
            <div class="form-group"><label for="review-restaurant-name">é¤å»³åç¨±</label><input type="text" id="review-restaurant-name" placeholder="è¼¸å…¥åƒéçš„é¤å»³"></div>
            <div class="form-group"><label for="review-meal-items">é¤é»é …ç›®</label><textarea id="review-meal-items" placeholder="åƒäº†ä»€éº¼å¥½æ–™ï¼Ÿ (ä¾‹å¦‚ï¼šå°ç± åŒ…ã€ç‰›è‚‰éºµ)"></textarea></div>
            <div class="form-group"><label for="review-cost">èŠ±è²»é‡‘é¡ (NT$)</label><input type="number" id="review-cost" placeholder="å¤§ç´„èŠ±äº†å¤šå°‘éŒ¢ï¼Ÿ"></div>
            <div class="form-group"><label>å–œæ„›ç¨‹åº¦</label><div class="rating-hearts" id="review-rating" data-rating="0"><i class="fa-solid fa-heart" data-value="1"></i><i class="fa-solid fa-heart" data-value="2"></i><i class="fa-solid fa-heart" data-value="3"></i><i class="fa-solid fa-heart" data-value="4"></i><i class="fa-solid fa-heart" data-value="5"></i></div></div>
            <div class="form-group"><label for="review-content">è©•è«–å…§å®¹ (æœƒæˆç‚ºè²¼æ–‡)</label><textarea id="review-content" placeholder="åˆ†äº«ä½ çš„å¿ƒå¾—ã€æ¨è–¦æˆ–å»ºè­°..."></textarea></div>
            <div class="form-group"><label>æ–°å¢ç…§ç‰‡ (æ¨¡æ“¬)</label><div class="photo-upload-area"><div class="btn-upload"><i class="fa-solid fa-images"></i>å¾ç›¸ç°¿é¸æ“‡</div><div class="btn-upload"><i class="fa-solid fa-camera"></i>é–‹å•Ÿç›¸æ©Ÿ</div></div></div>
            <button class="btn" onclick="saveReview()">å„²å­˜è©•è«–èˆ‡è²¼æ–‡</button>
        </div>
      </div>
      <div id="challenge-page" class="page">
        <div class="page-header"><h2><i class="fa-solid fa-trophy"></i>ç¾é£ŸæŒ‘æˆ°æ¦œ</h2><div class="placeholder"></div></div>
        <div class="page-content" id="challenge-list-container"></div>
      </div>
      <div id="profile-page" class="page">
        <div class="page-header">
          <div class="placeholder"></div>
          <h2 id="profile-header"><i class="fa-solid fa-user"></i>å€‹äººæª”æ¡ˆ</h2>
          <a id="profile-login-btn" class="header-action" style="display: none;" onclick="showPage('login-page')">ç™»å…¥/è¨»å†Š</a>
          <a id="profile-logout-btn" class="header-action" style="display: none;" onclick="handleSignOut()">ç™»å‡º</a>
        </div>
        <div class="profile-tabs">
            <button class="tab-btn active" onclick="showProfileTab('accounting', this)">è¨˜å¸³é¡¯ç¤º</button>
            <button class="tab-btn" onclick="showProfileTab('posts', this)">æˆ‘çš„è²¼æ–‡</button>
            <button class="tab-btn" onclick="showProfileTab('favorites', this)">æœ€æ„›é¤å»³</button>
            <button class="tab-btn" onclick="showProfileTab('friends', this)">å¥½å‹åå–®</button>
        </div>
        <div class="page-content" style="padding-top:0;">
            <div id="accounting-content" class="tab-content active"></div>
            <div id="posts-content" class="tab-content"></div>
            <div id="favorites-content" class="tab-content"></div>
            <div id="friends-content" class="tab-content"></div>
        </div>
      </div>
      <div id="login-page" class="page">
        <div class="page-header">
          <i class="fa-solid fa-chevron-left header-back-btn" onclick="goBack()"></i>
          <h2>æœƒå“¡ç™»å…¥</h2>
          <div class="placeholder"></div>
        </div>
        <div class="page-content">
          <div class="auth-form-container">
            <input type="email" id="login-email-input" placeholder="é›»å­éƒµä»¶" required>
            <input type="password" id="login-password-input" placeholder="å¯†ç¢¼" required>
            <div id="login-error" class="auth-error-message"></div>
            <button class="btn-auth primary" onclick="handleSignIn()">ç™»å…¥</button>
            <div class="auth-separator">æˆ–</div>
            <button class="btn-auth secondary" onclick="handleGoogleSignIn()">
              <i class="fab fa-google"></i> ä½¿ç”¨ Google ç™»å…¥
            </button>
            <div class="auth-switch-link" onclick="showPage('register-page')">
              é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿé»æ­¤è¨»å†Š
            </div>
          </div>
        </div>
      </div>
      <div id="register-page" class="page">
         <div class="page-header">
          <i class="fa-solid fa-chevron-left header-back-btn" onclick="goBack()"></i>
          <h2>è¨»å†Šæ–°å¸³è™Ÿ</h2>
          <div class="placeholder"></div>
        </div>
        <div class="page-content">
          <div class="auth-form-container">
            <input type="text" id="register-name-input" placeholder="å§“åæˆ–æš±ç¨±" required>
            <input type="email" id="register-email-input" placeholder="é›»å­éƒµä»¶" required>
            <input type="password" id="register-password-input" placeholder="è¨­å®šå¯†ç¢¼ (è‡³å°‘6ä½æ•¸)" required>
            <div id="register-error" class="auth-error-message"></div>
            <button class="btn-auth primary" onclick="handleRegister()">è¨»å†Šé€å‡º</button>
            <div class="auth-switch-link" onclick="showPage('login-page')">
              å·²ç¶“æœ‰å¸³è™Ÿäº†ï¼Ÿé»æ­¤ç™»å…¥
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="app-nav">
      <div class="nav-item active" onclick="showPage('map-page', this)"><i class="fa-solid fa-map-location-dot"></i><span>åœ°åœ–</span></div>
      <div class="nav-item" onclick="showPage('random-page', this)"><i class="fa-solid fa-dice"></i><span>éš¨æ©Ÿé¸</span></div>
      <div class="nav-item" onclick="showPage('add-review-page', this)"><i class="fa-solid fa-plus-circle"></i><span>æ–°å¢</span></div>
      <div class="nav-item" onclick="showPage('challenge-page', this)"><i class="fa-solid fa-trophy"></i><span>æŒ‘æˆ°æ¦œ</span></div>
      <div class="nav-item" onclick="showPage('profile-page', this)"><i class="fa-solid fa-user"></i><span>å€‹äºº</span></div>
    </footer>
  </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- 1. Firebase åˆå§‹åŒ– ---
        const firebaseConfig = {
            apiKey: "AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs",
            authDomain: "foodiedata-b4982.firebaseapp.com",
            projectId: "foodiedata-b4982",
            storageBucket: "foodiedata-b4982.firebasestorage.app",
            messagingSenderId: "90315404352",
            appId: "1:90315404352:web:e12b4fc3f5a87a11191ba5",
            measurementId: "G-5FD72CVKGB"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // --- 2. å…¨åŸŸè®Šæ•¸å®šç¾© ---
        let currentUser = null; 
        let map, userGpsPosition, userMarker, restaurantMarkers, debounceTimer, placesService, autocomplete, infoWindow, directionsService, directionsRenderer;
        let isMapReady = false; 
        const POSTS_DB_KEY = 'foodieAppPosts'; 
        const CHALLENGES_DB_KEY = 'foodieAppUserChallenges';
        let pageHistory = []; 

        // 3.1 é é¢å°èˆªèˆ‡è¿”å›é‚è¼¯ (ç„¡è®Šå‹•)
        window.showPage = function(pageId, navElement = null) {
            const activePage = document.querySelector('.page.active');
            if (activePage) {
                if (!['login-page', 'register-page'].includes(activePage.id) || !['login-page', 'register-page'].includes(pageId)) {
                    pageHistory.push(activePage.id);
                }
            }
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (navElement) {
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                navElement.classList.add('active');
                pageHistory = []; 
            }
            if (pageId === 'random-page') updateRandomPageStatus();
            if (pageId === 'challenge-page') renderChallenges();
            if (pageId === 'profile-page') renderProfilePage();
        };
        window.goBack = function() {
            if (pageHistory.length > 0) {
                const lastPageId = pageHistory.pop();
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(lastPageId).classList.add('active');
            } else {
                showPage('map-page', document.querySelector('.nav-item[onclick*="map-page"]'));
            }
        };

        // 3.2 Firebase & 3.3 UI ç‹€æ…‹åˆ‡æ› & 3.9 å€‹äººé é¢ (ç„¡è®Šå‹•)
        window.handleRegister = function() { const name = document.getElementById('register-name-input').value.trim(); const email = document.getElementById('register-email-input').value; const password = document.getElementById('register-password-input').value; const errorDiv = document.getElementById('register-error'); errorDiv.textContent = ''; if (!name || !email || !password) { errorDiv.textContent = 'æ‰€æœ‰æ¬„ä½éƒ½å¿…é ˆå¡«å¯«ï¼'; return; } auth.createUserWithEmailAndPassword(email, password).then(userCredential => userCredential.user.updateProfile({ displayName: name })).then(() => { goBack(); }).catch(error => { switch(error.code) { case 'auth/email-already-in-use': errorDiv.textContent = 'æ­¤é›»å­éƒµä»¶å·²è¢«è¨»å†Šã€‚'; break; case 'auth/invalid-email': errorDiv.textContent = 'é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢ºã€‚'; break; case 'auth/weak-password': errorDiv.textContent = 'å¯†ç¢¼å¼·åº¦ä¸è¶³ (è‡³å°‘6ä½æ•¸)ã€‚'; break; default: errorDiv.textContent = 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'; } }); }
        window.handleSignIn = function() { const email = document.getElementById('login-email-input').value; const password = document.getElementById('login-password-input').value; const errorDiv = document.getElementById('login-error'); errorDiv.textContent = ''; auth.signInWithEmailAndPassword(email, password).then(() => { goBack(); }).catch(error => { errorDiv.textContent = 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¿¡ç®±æˆ–å¯†ç¢¼ã€‚'; }); }
        window.handleGoogleSignIn = function() { const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).then(() => { goBack(); }).catch(error => { const errorDiv = document.getElementById('login-error'); errorDiv.textContent = 'Google ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'; }); }
        window.handleSignOut = function() { auth.signOut().catch(error => console.error("ç™»å‡ºéŒ¯èª¤:", error)); }
        function setupLoggedInUI(user) { document.getElementById('profile-login-btn').style.display = 'none'; document.getElementById('profile-logout-btn').style.display = 'block'; const userName = user.displayName || user.email; document.getElementById('profile-header').innerHTML = `<i class="fa-solid fa-user"></i> ${userName}`; renderProfilePage(); }
        function setupLoggedOutUI() { document.getElementById('profile-login-btn').style.display = 'block'; document.getElementById('profile-logout-btn').style.display = 'none'; document.getElementById('profile-header').innerHTML = `<i class="fa-solid fa-user"></i> å€‹äººæª”æ¡ˆ`; renderProfilePage(); document.getElementById('challenge-list-container').innerHTML = '<p class="placeholder-text">ç™»å…¥å¾Œå³å¯æŸ¥çœ‹ä¸¦åƒåŠ ç¾é£ŸæŒ‘æˆ°ï¼</p>'; document.getElementById('random-status-text').textContent = 'ç™»å…¥å¾Œï¼Œç³»çµ±æœƒå¾æ‚¨çš„ç¾é£Ÿç´€éŒ„ä¸­éš¨æ©ŸæŠ½é¸ï¼'; if(document.getElementById('picker-result')) { document.getElementById('picker-result').textContent = '?'; } }
        function renderProfilePage() { showProfileTab(document.querySelector('#profile-page .tab-btn.active').dataset.tab || 'accounting', document.querySelector('#profile-page .tab-btn.active')); }
        window.showProfileTab = function(tabId, tabElement) { document.querySelectorAll('#profile-page .tab-btn').forEach(btn => { btn.classList.remove('active'); btn.removeAttribute('data-tab'); }); tabElement.classList.add('active'); tabElement.dataset.tab = tabId; document.querySelectorAll('#profile-page .tab-content').forEach(content => content.classList.remove('active')); document.getElementById(`${tabId}-content`).classList.add('active'); if (tabId === 'accounting') renderAccountingRecords(); if (tabId === 'posts') renderMyPosts(); if (tabId === 'favorites') renderFavoriteRestaurants(); if (tabId === 'friends') renderFriendsList(); }
        const loggedOutPlaceholder = (message) => `<p class="placeholder-text">è«‹å…ˆ<a href="#" onclick="showPage('login-page')">ç™»å…¥</a>${message}</p>`;
        function renderAccountingRecords() { const container = document.getElementById('accounting-content'); if (!currentUser) { container.innerHTML = loggedOutPlaceholder('ä»¥æŸ¥çœ‹æ‚¨çš„æ¶ˆè²»ç´€éŒ„ã€‚'); return; } const posts = getPosts().filter(p => p.cost > 0); if (posts.length === 0) { container.innerHTML = `<p class="placeholder-text">å°šç„¡æ¶ˆè²»ç´€éŒ„ã€‚</p>`; return; } container.innerHTML = '<h3>æ¶ˆè²»ç´€éŒ„</h3>' + posts.map(p => `<div class="record-card"><span class="cost">$${p.cost}</span><div class="title">${p.name}</div><div class="details">${new Date(p.timestamp).toLocaleDateString()}</div></div>`).join(''); }
        function renderMyPosts() { const container = document.getElementById('posts-content'); if (!currentUser) { container.innerHTML = loggedOutPlaceholder('ä»¥æŸ¥çœ‹æ‚¨çš„è²¼æ–‡ã€‚'); return; } const posts = getPosts(); if (posts.length === 0) { container.innerHTML = `<p class="placeholder-text">æ‚¨é‚„æ²’æœ‰ç™¼è¡¨éè²¼æ–‡ã€‚</p>`; return; } container.innerHTML = posts.map(p => { let ratingHtml = Array(parseInt(p.rating)).fill('<i class="fa-solid fa-heart"></i>').join(''); return `<div class="post-card"><div class="title">${p.name}</div><div class="details">${new Date(p.timestamp).toLocaleString()}</div><p class="content">${p.content || 'ï¼ˆç„¡è©³ç´°è©•è«–ï¼‰'}</p><div class="post-rating">${ratingHtml}</div></div>`; }).join(''); }
        function renderFavoriteRestaurants() { const container = document.getElementById('favorites-content'); if (!currentUser) { container.innerHTML = loggedOutPlaceholder('ä»¥æŸ¥çœ‹æ‚¨çš„æœ€æ„›é¤å»³ã€‚'); return; } const favorites = getPosts().filter(p => p.rating >= 4).reduce((acc, cur) => { if (!acc.some(item => item.name === cur.name)) acc.push(cur); return acc; }, []).sort((a, b) => b.rating - a.rating); if (favorites.length === 0) { container.innerHTML = `<p class="placeholder-text">æ‚¨é‚„æ²’æœ‰è©•åˆ†é«˜çš„é¤å»³å–”ï¼</p>`; return; } container.innerHTML = '<h3>æœ€æ„›é¤å»³ (è©•åˆ†4é¡†å¿ƒä»¥ä¸Š)</h3>' + favorites.map(p => `<div class="record-card"><div class="title">${p.name}</div></div>`).join(''); }
        function renderFriendsList() { const container = document.getElementById('friends-content'); if (!currentUser) { container.innerHTML = loggedOutPlaceholder('ä»¥æŸ¥çœ‹å¥½å‹åå–®ã€‚'); return; } container.innerHTML = `<p class="placeholder-text">å¥½å‹åŠŸèƒ½é–‹ç™¼ä¸­ï¼</p>`; }
        
        // 3.3 è³‡æ–™å„²å­˜ (ç„¡è®Šå‹•)
        function getPosts() { if (!currentUser) return []; const key = `${POSTS_DB_KEY}_${currentUser.uid}`; return JSON.parse(localStorage.getItem(key)) || []; }
        function savePosts(posts) { if (!currentUser) return; const key = `${POSTS_DB_KEY}_${currentUser.uid}`; localStorage.setItem(key, JSON.stringify(posts)); }
        function getUserChallenges() { if (!currentUser) return {}; const key = `${CHALLENGES_DB_KEY}_${currentUser.uid}`; return JSON.parse(localStorage.getItem(key)) || {}; }
        function saveUserChallenges(challenges) { if (!currentUser) return; const key = `${CHALLENGES_DB_KEY}_${currentUser.uid}`; localStorage.setItem(key, JSON.stringify(challenges)); }
        
        // ================== JAVASCRIPT ä¿®æ”¹é‡é»å€åŸŸ START ==================

        // 3.5 Page 1: åœ°åœ– (å¤§å¹…ä¿®æ”¹)
        window.initMap = function () { isMapReady = true; userGpsPosition = { lat: 25.0479, lng: 121.5171 }; restaurantMarkers = []; map = new google.maps.Map(document.getElementById("map"), { center: userGpsPosition, zoom: 15, disableDefaultUI: true, zoomControl: true }); placesService = new google.maps.places.PlacesService(map); infoWindow = new google.maps.InfoWindow(); directionsService = new google.maps.DirectionsService(); directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true, polylineOptions: { strokeColor: '#4285F4', strokeOpacity: 0.8, strokeWeight: 6 } }); createUserMarker(userGpsPosition); setupMapListeners(); setupAutocomplete(); updateUserGPS(); };
        window.createUserMarker = function(position) { const userIcon = { path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z", fillColor: '#4285F4', fillOpacity: 1, strokeWeight: 0, scale: 1.5, anchor: new google.maps.Point(12, 24) }; if (userMarker) { userMarker.setPosition(position); } else { userMarker = new google.maps.Marker({ position, map, title: "æ‚¨çš„ä½ç½®", icon: userIcon, zIndex: 1000 }); } }
        
        function setupMapListeners() {
            // ç›£è½ 'idle' äº‹ä»¶ï¼šç•¶åœ°åœ–åœæ­¢ç§»å‹•å¾Œè§¸ç™¼ï¼Œé‡æ–°æœå°‹é™„è¿‘é¤å»³
            map.addListener("idle", () => {
                if (!directionsRenderer.getDirections()) {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => searchNearbyRestaurants(map.getCenter()), 500);
                }
            });

            // ã€æ–°å¢åŠŸèƒ½ã€‘ç›£è½ 'click' äº‹ä»¶ï¼šé»æ“Šåœ°åœ–ç©ºç™½è™•ï¼Œå–æ¶ˆé¸å–ç‹€æ…‹
            map.addListener("click", (e) => {
                // æª¢æŸ¥é»æ“Šäº‹ä»¶æ˜¯å¦ä¾†è‡ª POI (Point of Interest)ï¼Œè‹¥æ˜¯å‰‡ä¸è™•ç†ï¼Œè®“ POI çš„é è¨­è¡Œç‚ºç™¼ç”Ÿ
                if (e.placeId) {
                    e.stop(); // åœæ­¢äº‹ä»¶ç¹¼çºŒå‚³æ’­ï¼Œé¿å…è§¸ç™¼ POI çš„ InfoWindow
                }
                // å‘¼å« clearSearch ä¾†é‡ç½®åœ°åœ–å’Œåˆ—è¡¨ç‹€æ…‹
                clearSearch();
            });
        }
        
        function setupAutocomplete() { const input = document.getElementById('search-input'); const clearBtn = document.getElementById('clear-search'); autocomplete = new google.maps.places.Autocomplete(input, { componentRestrictions: { country: 'tw' }, types: ['establishment', 'geocode'], fields: ['place_id', 'geometry', 'name', 'formatted_address', 'vicinity'] }); input.addEventListener('input', () => { clearBtn.style.display = input.value ? 'flex' : 'none'; }); autocomplete.addListener('place_changed', () => { const place = autocomplete.getPlace(); if (place.geometry && place.geometry.location) { clearSearch(true); handlePlaceSelection(place); } }); }
        window.updateUserGPS = function() { if (!isMapReady) return; document.getElementById("list-content-area").innerHTML = `<p class="list-status-text">æ­£åœ¨ç²å–æ‚¨çš„ä½ç½®...</p>`; if (navigator.geolocation) { navigator.geolocation.getCurrentPosition( (position) => { userGpsPosition = { lat: position.coords.latitude, lng: position.coords.longitude }; createUserMarker(userGpsPosition); centerOnUserGPS(); }, () => searchNearbyRestaurants(map.getCenter()) ); } else { searchNearbyRestaurants(map.getCenter()); } }
        window.centerOnUserGPS = function() { if (map && userGpsPosition) { map.panTo(userGpsPosition); } }
        function searchNearbyRestaurants(location) { if (!isMapReady) return; const listContainer = document.getElementById("list-content-area"); listContainer.innerHTML = `<p class="list-status-text">æ­£åœ¨æœå°‹é™„è¿‘é¤å»³...</p>`; clearRestaurantMarkers(); const request = { location: location, radius: 1500, type: 'restaurant' }; placesService.nearbySearch(request, (results, status) => { if (status === google.maps.places.PlacesServiceStatus.OK && results) { processAndDisplayResults(results, location); } else { listContainer.innerHTML = `<p class="list-status-text">æ­¤å€åŸŸæ‰¾ä¸åˆ°é¤å»³</p>`; } }); }
        function processAndDisplayResults(places, center) { const listContainer = document.getElementById("list-content-area"); const placesWithDistance = places.map((place) => ({ ...place, distance: google.maps.geometry.spherical.computeDistanceBetween(center, place.geometry.location) })); placesWithDistance.sort((a, b) => a.distance - b.distance); listContainer.innerHTML = ""; placesWithDistance.forEach((place) => { addRestaurantMarker(place); addRestaurantToList(place); }); }
        function addRestaurantMarker(place) { const marker = new google.maps.Marker({ position: place.geometry.location, map: map, title: place.name, icon: { path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z", fillColor: '#EA4335', fillOpacity: 1, strokeWeight: 0, scale: 1.5, anchor: new google.maps.Point(12, 24) } }); marker.addListener('click', () => { handlePlaceSelection(place); }); marker.place_id = place.place_id; restaurantMarkers.push(marker); }
        function addRestaurantToList(place, routeInfo = null) { const listContainer = document.getElementById("list-content-area"); const item = document.createElement("div"); item.className = "list-item"; item.dataset.placeId = place.place_id; let openStatusHtml = ""; if (place.business_status === "CLOSED_PERMANENTLY") { openStatusHtml = `<span class="open-status closed">æ°¸ä¹…åœæ¥­</span>`; } else if (place.opening_hours && typeof place.opening_hours.open_now !== 'undefined') { openStatusHtml = place.opening_hours.open_now ? `<span class="open-status open">ç‡Ÿæ¥­ä¸­</span>` : `<span class="open-status closed">ä¼‘æ¯ä¸­</span>`; } const ratingHtml = place.rating ? `<i class="fas fa-star" style="color: #ffd700;"></i> ${place.rating}` : `ç„¡è©•åˆ†`; const detailsText = [ratingHtml, openStatusHtml].filter(Boolean).join(' Â· '); const addressHtml = `<div class="item-address">${place.vicinity || place.formatted_address || ''}</div>`; let distanceHtml = ''; if (routeInfo && routeInfo.driving) { distanceHtml = `<div class="item-distance"><i class="fas fa-car"></i> ${routeInfo.driving.distance}</div>`; } else if (place.distance) { distanceHtml = `<div class="item-distance">${Math.round(place.distance)}m</div>`; } item.innerHTML = `<div class="item-icon"><i class="fas fa-utensils"></i></div><div class="item-info"><div class="item-name">${place.name}</div>${addressHtml}<div class="item-details">${detailsText}</div></div>${distanceHtml}`; item.onclick = () => handlePlaceSelection(place); listContainer.appendChild(item); }
        
        window.handlePlaceSelection = function(place) { 
            const marker = restaurantMarkers.find((m) => m.place_id === place.place_id); 
            if (marker) { 
                map.panTo(marker.getPosition()); 
            } else {
                map.panTo(place.geometry.location); 
            }
            highlightListItem(place.place_id, true); 
            initiateRouteAndDetailsFetch(place); 
        }

        async function initiateRouteAndDetailsFetch(place) {
            if (!userGpsPosition || !place.geometry || !place.geometry.location) {
                // å¦‚æœæ²’æœ‰ä½¿ç”¨è€…ä½ç½®ï¼Œåªé¡¯ç¤ºåŸºæœ¬è³‡è¨Š
                showPlaceDetailsInWindow(place, null, {});
                return;
            }

            document.getElementById('clear-search').style.display = 'flex';
            clearRestaurantMarkers();

            // ä½¿ç”¨ Promise.all åŒæ™‚è«‹æ±‚é–‹è»Šå’Œæ­¥è¡Œçš„è·¯ç·š
            const [drivingResult, walkingResult, placeDetails] = await Promise.all([
                getRoutePromise(userGpsPosition, place.geometry.location, google.maps.TravelMode.DRIVING),
                getRoutePromise(userGpsPosition, place.geometry.location, google.maps.TravelMode.WALKING),
                getPlaceDetailsPromise(place.place_id)
            ]);
            
            const routeInfo = {
                driving: drivingResult,
                walking: walkingResult
            };

            // è™•ç†è·¯ç·šé¡¯ç¤º
            if (drivingResult) {
                directionsRenderer.setDirections(drivingResult.response);
                map.fitBounds(drivingResult.response.routes[0].bounds);
            } else {
                // è‹¥é–‹è»Šè·¯ç·šå¤±æ•—ï¼Œæ¸…é™¤èˆŠè·¯ç·š
                directionsRenderer.setDirections({ routes: [] });
            }

            const destinationMarker = new google.maps.Marker({
                position: place.geometry.location,
                map: map,
                title: place.name
            });
            restaurantMarkers.push(destinationMarker);

            showPlaceDetailsInWindow(place, destinationMarker, routeInfo, placeDetails);
            showSinglePlaceResult(place, routeInfo);
        }
        
        // ã€æ–°å¢ã€‘è¼”åŠ©å‡½å¼ï¼šå°‡ DirectionsService.route ç•°æ­¥åŒ–
        function getRoutePromise(origin, destination, travelMode) {
            return new Promise(resolve => {
                const request = { origin, destination, travelMode };
                directionsService.route(request, (res, stat) => {
                    if (stat === 'OK') {
                        const leg = res.routes[0].legs[0];
                        resolve({
                            distance: leg.distance.text,
                            duration: leg.duration.text,
                            response: res
                        });
                    } else {
                        resolve(null); // è·¯ç·šè¦åŠƒå¤±æ•—
                    }
                });
            });
        }

        // ã€æ–°å¢ã€‘è¼”åŠ©å‡½å¼ï¼šå°‡ PlacesService.getDetails ç•°æ­¥åŒ–
        function getPlaceDetailsPromise(placeId) {
             // è«‹æ±‚å¤šå€‹æ¬„ä½ï¼Œç¬¦åˆ "èˆŠç‰ˆAPIè¦å‰‡" ä¸€æ¬¡æ€§ç²å–è³‡æ–™çš„ç¿’æ…£
            const request = {
                placeId: placeId,
                fields: ['name', 'rating', 'formatted_phone_number', 'opening_hours', 'vicinity', 'business_status', 'formatted_address']
            };
            return new Promise(resolve => {
                placesService.getDetails(request, (details, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && details) {
                        resolve(details);
                    } else {
                        resolve(null); // ç²å–å¤±æ•—
                    }
                });
            });
        }

        function showSinglePlaceResult(place, routeInfo) { const listContainer = document.getElementById("list-content-area"); listContainer.innerHTML = ""; addRestaurantToList(place, routeInfo); }
        
        // ã€ä¿®æ”¹ã€‘æ­¤å‡½å¼ç¾åœ¨æœƒæ¥æ”¶æ›´è±å¯Œçš„è³‡è¨Šä¸¦é¡¯ç¤º
        function showPlaceDetailsInWindow(place, marker, routeInfo = {}, details = null) {
            let content = `<div class="info-window-content"><h4>${place.name}</h4>`;
            
            const finalDetails = details || place; // å¦‚æœ getDetails æˆåŠŸï¼Œç”¨ detailsï¼Œå¦å‰‡ç”¨åŸå§‹çš„ place ç‰©ä»¶
            const address = finalDetails.formatted_address || finalDetails.vicinity;
            if (address) content += `<p><i class="fas fa-map-marker-alt"></i>${address}</p>`;

            // é¡¯ç¤ºé–‹è»Šè³‡è¨Š
            if (routeInfo.driving) {
                content += `<p><i class="fas fa-car"></i>${routeInfo.driving.distance} (${routeInfo.driving.duration})</p>`;
            }
            // é¡¯ç¤ºæ­¥è¡Œè³‡è¨Š
            if (routeInfo.walking) {
                 content += `<p><i class="fas fa-walking"></i>${routeInfo.walking.distance} (${routeInfo.walking.duration})</p>`;
            }
            // é¡¯ç¤ºé›»è©±
            if (details && details.formatted_phone_number) {
                content += `<p><i class="fas fa-phone"></i>${details.formatted_phone_number}</p>`;
            }
            // é¡¯ç¤ºç‡Ÿæ¥­ç‹€æ…‹
            if (details && details.business_status === "CLOSED_PERMANENTLY") {
                content += `<p><i class="fas fa-store-slash"></i><span style="color: #dc3545; font-weight: bold;">æ°¸ä¹…åœæ¥­</span></p>`;
            } else if (details && details.opening_hours) {
                const isOpen = details.opening_hours.isOpen();
                const statusText = isOpen ? "ç‡Ÿæ¥­ä¸­" : "ä¼‘æ¯ä¸­";
                const color = isOpen ? "#28a745" : "#dc3545";
                content += `<p><i class="fas fa-clock"></i><span style="color: ${color}; font-weight: bold;">${statusText}</span></p>`;
            } else {
                 content += `<p><i class="fas fa-clock"></i>ç‡Ÿæ¥­æ™‚é–“è³‡è¨Šä¸æ˜</p>`;
            }
            
            content += '</div>';
            infoWindow.setContent(content);
            infoWindow.open({
                anchor: marker,
                map: map,
                shouldFocus: false // é¿å… infoWindow æ‰“é–‹æ™‚åœ°åœ–è‡ªå‹•ç¸®æ”¾
            });
        }

        window.clearSearch = function(suppressSearch = false) { 
            directionsRenderer.setDirections({ routes: [] }); 
            infoWindow.close(); 
            const input = document.getElementById('search-input'); 
            input.value = ''; 
            document.getElementById('clear-search').style.display = 'none'; 
            highlightListItem(null);
            if (!suppressSearch) { 
                searchNearbyRestaurants(map.getCenter()); 
            } 
        }
        function highlightListItem(placeId, scroll) { document.querySelectorAll(".list-item.is-selected").forEach((el) => el.classList.remove("is-selected")); if(placeId) { const listItem = document.querySelector(`.list-item[data-place-id="${placeId}"]`); if (listItem) { listItem.classList.add("is-selected"); if (scroll) { listItem.scrollIntoView({ behavior: "smooth", block: "center" }); } } } }
        function clearRestaurantMarkers() { restaurantMarkers.forEach((marker) => marker.setMap(null)); restaurantMarkers = []; }

        // ================== JAVASCRIPT ä¿®æ”¹é‡é»å€åŸŸ END ==================

        // --- ä»¥ä¸‹å‡½å¼ä¿æŒä¸è®Šæˆ–åƒ…å¾®èª¿ ---
        // 3.6 Page 2: ç¾é£Ÿéš¨æ©Ÿé¸
        function updateRandomPageStatus() { if (!currentUser) { document.getElementById('random-status-text').textContent = 'ç™»å…¥å¾Œï¼Œç³»çµ±æœƒå¾æ‚¨çš„ç¾é£Ÿç´€éŒ„ä¸­éš¨æ©ŸæŠ½é¸ï¼'; document.getElementById('picker-result').textContent = '?'; return; } const allPosts = getPosts(); const restaurants = [...new Set(allPosts.map(p => p.name))]; const statusText = document.getElementById('random-status-text'); const pickerResult = document.getElementById('picker-result'); pickerResult.textContent = "?"; pickerResult.style.color = 'var(--primary-color)'; if (restaurants.length === 0) { statusText.textContent = "æ‚¨é‚„æ²’æœ‰æ–°å¢ä»»ä½•é¤å»³å–”ï¼è«‹åˆ°ã€Œæ–°å¢ã€é é¢åŠ å…¥å§ï¼"; } else { statusText.textContent = `ç›®å‰æœ‰ ${restaurants.length} å®¶ç¨ç‰¹çš„é¤å»³åœ¨æ‚¨çš„å£è¢‹åå–®ä¸­ã€‚`; } }
        window.startRandomPick = function() { if (!currentUser) { alert('è«‹å…ˆç™»å…¥æ‰èƒ½ä½¿ç”¨æ‚¨çš„ç¾é£Ÿæ¸…å–®é€²è¡ŒæŠ½ç±¤ï¼'); showPage('login-page'); return; } const allPosts = getPosts(); const restaurants = [...new Set(allPosts.map(p => p.name))]; if (restaurants.length === 0) { alert("å£è¢‹åå–®æ˜¯ç©ºçš„ï¼Œç„¡æ³•æŠ½ç±¤ï¼"); return; } const wheel = document.getElementById('picker-wheel'); const resultDiv = document.getElementById('picker-result'); const pickButton = document.getElementById('random-pick-btn'); pickButton.disabled = true; resultDiv.textContent = '...'; const randomSpins = Math.floor(Math.random() * 5) + 5; const randomStopAngle = Math.floor(Math.random() * 360); wheel.style.transform = `rotate(${randomSpins * 360 + randomStopAngle}deg)`; setTimeout(() => { const randomIndex = Math.floor(Math.random() * restaurants.length); const winner = restaurants[randomIndex]; resultDiv.textContent = winner; resultDiv.style.color = '#28a745'; pickButton.disabled = false; }, 4000); }

        // 3.7 Page 3: æ–°å¢ç¾é£Ÿè©•è«–
        function handleRatingClick(e) { const rating = e.target.dataset.value; document.getElementById('review-rating').dataset.rating = rating; updateHeartDisplay(rating); }
        function handleRatingHover(e) { updateHeartDisplay(e.target.dataset.value); }
        function handleRatingMouseout() { updateHeartDisplay(document.getElementById('review-rating').dataset.rating); }
        function updateHeartDisplay(rating) { document.querySelectorAll('.rating-hearts .fa-heart').forEach(heart => { heart.classList.toggle('active', heart.dataset.value <= rating); }); }
        window.saveReview = function() { if (!currentUser) { alert('è«‹å…ˆç™»å…¥æ‰èƒ½å„²å­˜è©•è«–ï¼'); showPage('login-page'); return; } const name = document.getElementById('review-restaurant-name').value.trim(); const rating = document.getElementById('review-rating').dataset.rating; if (!name || rating === "0") { alert("è«‹å‹™å¿…å¡«å¯«ã€Œé¤å»³åç¨±ã€å’Œã€Œå–œæ„›ç¨‹åº¦ã€ï¼"); return; } const newPost = { id: Date.now(), name, items: document.getElementById('review-meal-items').value.trim(), cost: Number(document.getElementById('review-cost').value) || 0, rating, content: document.getElementById('review-content').value.trim(), timestamp: new Date().toISOString() }; const posts = getPosts(); posts.unshift(newPost); savePosts(posts); alert("è©•è«–å·²æˆåŠŸå„²å­˜ï¼"); ['review-restaurant-name', 'review-meal-items', 'review-cost', 'review-content'].forEach(id => document.getElementById(id).value = ''); document.getElementById('review-rating').dataset.rating = 0; updateHeartDisplay(0); showPage('profile-page', document.querySelector('.nav-item[onclick*="profile-page"]')); }
        
        // 3.8 Page 4: ç¾é£ŸæŒ‘æˆ°æ¦œ
        const challengesData = [ { id: 'healthy_week', title: 'æŒ‘æˆ°ä¸€é€±å¥åº·é¤', desc: 'é€£çºŒä¸ƒå¤©åªåƒåŸå‹é£Ÿç‰©å’Œå¥åº·çƒ¹èª¿çš„é¤é»ï¼', rank: '<li>1. Alice (7/7å¤©) ğŸ¥‡</li> <li>2. David (6/7å¤©) ğŸ¥ˆ</li> <li>3. ç¾é£Ÿæ¢éšªå®¶ (5/7å¤©)</li>', participants: 'Alice, David, ç¾é£Ÿæ¢éšªå®¶' }, { id: 'budget_200', title: 'çœéŒ¢å¤§ä½œæˆ°ï¼šæ—¥å‡$200', desc: 'æŒ‘æˆ°é€£çºŒäº”å¤©ï¼Œå¹³å‡æ¯æ—¥é¤è²»ä¸è¶…é200å…ƒã€‚', rank: '<li>1. Bob (å¹³å‡ $185) ğŸ¥‡</li> <li>2. Charlie (å¹³å‡ $198) ğŸ¥ˆ</li>', participants: 'Bob, Charlie' }, { id: 'vegan_exp', title: 'ç´ é£Ÿé«”é©—é€±', desc: 'æŒ‘æˆ°ä¸€é€±å®Œå…¨ç´ é£Ÿ(è›‹å¥¶ç´ å¯)ã€‚', rank: '<li>1. Eve (å®Œæˆ) ğŸ¥‡</li> <li>2. Frank (å®Œæˆ) ğŸ¥ˆ</li> <li>3. Grace (å®Œæˆ)</li>', participants: 'Eve, Frank, Grace' }];
        function renderChallenges() { const container = document.getElementById('challenge-list-container'); if (!currentUser) { container.innerHTML = '<p class="placeholder-text">ç™»å…¥å¾Œå³å¯æŸ¥çœ‹ä¸¦åƒåŠ ç¾é£ŸæŒ‘æˆ°ï¼</p>'; return; } const userChallenges = getUserChallenges(); container.innerHTML = ''; challengesData.forEach(c => { const isJoined = userChallenges[c.id]; const card = document.createElement('div'); card.className = 'challenge-card'; card.innerHTML = `<div class="challenge-header"><div class="challenge-title">${c.title}</div><button class="challenge-btn-join ${isJoined ? 'joined' : ''}" onclick="toggleChallenge('${c.id}')">${isJoined ? 'å·²åƒåŠ ' : 'åƒåŠ '}</button></div><p class="challenge-desc">${c.desc}</p><div><div class="challenge-ranking-title">ğŸ† æ’è¡Œæ¦œï¼š</div><ul class="challenge-ranking-list" style="flex-direction:column; gap: 5px;">${c.rank}</ul></div><div style="margin-top:15px;"><div class="challenge-participants-title">ğŸ‘¥ åƒèˆ‡è€…ï¼š</div><div class="challenge-participants-list">${c.participants} ${isJoined ? ', <b>æ‚¨</b>' : ''}</div></div>`; container.appendChild(card); }); }
        window.toggleChallenge = function(challengeId) { if (!currentUser) { alert('è«‹å…ˆç™»å…¥æ‰èƒ½åƒåŠ æŒ‘æˆ°ï¼'); showPage('login-page'); return; } const userChallenges = getUserChallenges(); userChallenges[challengeId] = !userChallenges[challengeId]; saveUserChallenges(userChallenges); renderChallenges(); }

        // --- 4. App åˆå§‹åŒ– & Auth ç‹€æ…‹ç›£è½ ---
        document.querySelectorAll('.rating-hearts .fa-heart').forEach(heart => { heart.addEventListener('click', handleRatingClick); heart.addEventListener('mouseover', handleRatingHover); heart.addEventListener('mouseout', handleRatingMouseout); });
        
        auth.onAuthStateChanged(user => { 
            currentUser = user;
            if (user) { 
                setupLoggedInUI(user);
            } else { 
                setupLoggedOutUI();
            } 
        });
        
        // åˆå§‹è¼‰å…¥
        showPage('map-page', document.querySelector('.nav-item')); 

    });
</script>
</body>
</html>
