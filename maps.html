<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>FoodieApp - Firebase 整合版</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  
  <!-- Google Maps API -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs&libraries=places,geometry&callback=initMap"
    async
    defer
  ></script>

  <!-- Firebase v8 SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <!-- <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script> -->

  <!-- Chart.js for statistics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root { --primary-color: #ff5a5f; --secondary-color: #00a699; --text-color: #484848; --text-light: #767676; --background-color: #f7f7f7; --border-color: #ebebeb; --nav-height: 60px; }
    html, body { height: 100%; margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); color: var(--text-color); }
    .app-container { width: 100%; height: 100vh; display: flex; flex-direction: column; }
    main { flex-grow: 1; overflow: hidden; position: relative; }
    .page { width: 100%; height: 100%; display: none; flex-direction: column; overflow: hidden; }
    .page.active { display: flex; }
    .app-nav { height: var(--nav-height); width: 100%; background: #fff; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-light); font-size: 12px; cursor: pointer; transition: color 0.2s; width: 100%; }
    .nav-item i { font-size: 22px; margin-bottom: 4px; }
    .nav-item.active { color: var(--primary-color); }

    /* 全局組件 */
    .page-header { padding: 15px 20px; background-color: #fff; border-bottom: 1px solid var(--border-color); text-align: center; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
    .page-header h2 { margin: 0; font-size: 18px; color: var(--text-color); }
    .header-action, .auth-link { font-size: 16px; color: var(--primary-color); text-decoration: none; cursor: pointer; }
    .page-content { flex-grow: 1; overflow-y: auto; padding: 15px; }
    .placeholder-text { text-align: center; color: var(--text-light); margin-top: 50px; }
    .btn { display: inline-block; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; padding: 12px 20px; text-decoration: none; }
    .btn:disabled { background-color: #ccc; cursor: not-allowed; }
    
    /* 地圖頁面 */
    #map-container { flex-grow: 1; position: relative; }
    #map { width: 100%; height: 100%; }
    .location-btn { position: absolute; bottom: 150px; right: 20px; background: #fff; color: #555; border: none; width: 50px; height: 50px; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; z-index: 10; font-size: 22px; display: flex; justify-content: center; align-items: center; }
    #restaurant-card { position: absolute; bottom: calc(-100% + var(--nav-height)); left: 0; width: 100%; background-color: #fff; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 1001; transition: bottom 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); max-height: calc(100vh - 100px); display: flex; flex-direction: column; }
    #restaurant-card.active { bottom: var(--nav-height); }
    #restaurant-card .card-content { padding: 15px 20px; overflow-y: auto; }
    #restaurant-card .card-title { font-size: 22px; }
    #restaurant-card .card-meta .fa-star { color: #f5c518; }
    #restaurant-card .card-actions { display: flex; justify-content: space-around; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; }
    #restaurant-card .action-btn { background: none; border: none; font-size: 14px; color: #333; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
    #restaurant-card .action-btn i { font-size: 20px; color: var(--primary-color); }
    #card-favorite-btn.favorited i { font-family: "Font Awesome 6 Free"; font-weight: 900; }
    
    /* 登入/註冊頁 */
    .auth-form { max-width: 400px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .auth-form .form-group { margin-bottom: 15px; }
    .auth-form label { display: block; margin-bottom: 5px; font-weight: 500; }
    .auth-form input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; }
    .auth-form .btn { width: 100%; margin-top: 10px; }
    .auth-error { color: var(--primary-color); margin-top: 10px; text-align: center; min-height: 20px;}
    .auth-switch { text-align: center; margin-top: 15px; }

    /* 個人頁面 */
    .profile-tabs { display: flex; gap: 10px; padding: 10px 15px; background: #fff; border-bottom: 1px solid var(--border-color); overflow-x: auto; flex-shrink: 0; }
    .tab-btn { background: #f0f0f0; border: none; border-radius: 20px; padding: 8px 15px; font-size: 14px; cursor: pointer; white-space: nowrap; }
    .tab-btn.active { background: var(--primary-color); color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* 記帳頁 */
    #accounting-content .summary { display: flex; justify-content: space-around; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
    #accounting-content .summary-item { text-align: center; }
    #accounting-content .summary-item .label { font-size: 14px; color: var(--text-light); }
    #accounting-content .summary-item .amount { font-size: 20px; font-weight: bold; color: var(--primary-color); }
    #chart-container { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  </style>
</head>
<body>
  <div class="app-container">
    <main>
      <!-- 地圖頁 -->
      <div id="map-page" class="page active">
        <div id="map-container">
          <div id="map"></div>
          <button class="location-btn" onclick="centerOnUserGPS()"><i class="fas fa-location-crosshairs"></i></button>
          <div id="restaurant-card" class="restaurant-card-container">
             <!-- 卡片內容將由 JS 動態填充 -->
          </div>
        </div>
      </div>
      
      <!-- 個人頁 -->
      <div id="profile-page" class="page">
        <div class="page-header">
          <h2 id="profile-title">個人檔案</h2>
          <a id="auth-action-btn" class="header-action" onclick="handleAuthAction()">登入</a>
        </div>
        <div id="profile-tabs-container" style="display: none;">
            <div class="profile-tabs">
                <button class="tab-btn active" onclick="showProfileTab('favorites', this)">我的最愛</button>
                <button class="tab-btn" onclick="showProfileTab('reviews', this)">我的評論</button>
                <button class="tab-btn" onclick="showProfileTab('accounting', this)">記帳統計</button>
            </div>
            <div class="page-content">
                <div id="favorites-content" class="tab-content active"></div>
                <div id="reviews-content" class="tab-content"></div>
                <div id="accounting-content" class="tab-content"></div>
            </div>
        </div>
        <div id="logged-out-placeholder" class="page-content">
            <p class="placeholder-text">登入以查看您的收藏、評論與消費統計。</p>
            <button class="btn" style="display:block; max-width: 200px; margin: 20px auto;" onclick="showPage('auth-page')">立即登入/註冊</button>
        </div>
      </div>

      <!-- 認證頁 -->
      <div id="auth-page" class="page">
        <div class="page-header">
          <h2 id="auth-title">會員登入</h2>
        </div>
        <div class="page-content">
            <div class="auth-form">
                <div class="form-group" id="name-group" style="display: none;">
                    <label for="auth-name">暱稱</label>
                    <input type="text" id="auth-name" placeholder="您的顯示名稱">
                </div>
                <div class="form-group">
                    <label for="auth-email">電子郵件</label>
                    <input type="email" id="auth-email" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label for="auth-password">密碼</label>
                    <input type="password" id="auth-password" placeholder="至少6位數">
                </div>
                <div id="auth-error" class="auth-error"></div>
                <button id="auth-submit-btn" class="btn" onclick="handleAuthSubmit()">登入</button>
                <div class="auth-switch">
                    <a href="#" id="auth-switch-link" class="auth-link" onclick="toggleAuthMode()">還沒有帳號？點此註冊</a>
                </div>
            </div>
        </div>
      </div>
    </main>
    <footer class="app-nav">
      <div class="nav-item active" onclick="showPage('map-page', this)"><i class="fa-solid fa-map-location-dot"></i><span>地圖</span></div>
      <div class="nav-item" onclick="showPage('profile-page', this)"><i class="fa-solid fa-user"></i><span>個人</span></div>
    </footer>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 1. Firebase 初始化 ---
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- 2. 全域變數 ---
    let map, placesService, userMarker;
    let restaurantMarkers = [];
    let currentUser = null;
    let isLoginMode = true;
    let userFavorites = new Set();
    let accountingChart = null;

    // --- 3. Firebase Auth 模組 ---
    auth.onAuthStateChanged(user => {
        currentUser = user;
        if (user) {
            console.log("使用者已登入:", user.uid);
            document.getElementById('auth-action-btn').textContent = '登出';
            document.getElementById('profile-title').textContent = user.displayName || '個人檔案';
            document.getElementById('profile-tabs-container').style.display = 'block';
            document.getElementById('logged-out-placeholder').style.display = 'none';
            fetchUserFavorites();
            if (document.querySelector('.page.active').id === 'profile-page') {
                showProfileTab('favorites', document.querySelector('.tab-btn.active'));
            }
        } else {
            console.log("使用者已登出");
            document.getElementById('auth-action-btn').textContent = '登入';
            document.getElementById('profile-title').textContent = '個人檔案';
            document.getElementById('profile-tabs-container').style.display = 'none';
            document.getElementById('logged-out-placeholder').style.display = 'block';
            userFavorites.clear();
        }
    });

    window.handleAuthAction = function() {
        if (currentUser) {
            auth.signOut();
        } else {
            showPage('auth-page');
        }
    };
    
    window.toggleAuthMode = function() {
        isLoginMode = !isLoginMode;
        document.getElementById('auth-title').textContent = isLoginMode ? '會員登入' : '註冊新帳號';
        document.getElementById('auth-submit-btn').textContent = isLoginMode ? '登入' : '註冊';
        document.getElementById('name-group').style.display = isLoginMode ? 'none' : 'block';
        document.getElementById('auth-switch-link').textContent = isLoginMode ? '還沒有帳號？點此註冊' : '已經有帳號了？點此登入';
        document.getElementById('auth-error').textContent = '';
    };

    window.handleAuthSubmit = function() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const name = document.getElementById('auth-name').value;
        const errorDiv = document.getElementById('auth-error');
        errorDiv.textContent = '';

        if (isLoginMode) {
            auth.signInWithEmailAndPassword(email, password)
                .then(() => showPage('map-page', document.querySelector('.nav-item')))
                .catch(error => errorDiv.textContent = error.message);
        } else {
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    return userCredential.user.updateProfile({ displayName: name });
                })
                .then(() => showPage('map-page', document.querySelector('.nav-item')))
                .catch(error => errorDiv.textContent = error.message);
        }
    };

    // --- 4. Firestore CRUD 模組 ---
    async function fetchUserFavorites() {
        if (!currentUser) return;
        const snapshot = await db.collection('favorites').where('userId', '==', currentUser.uid).get();
        const favoriteIds = snapshot.docs.map(doc => doc.data().placeId);
        userFavorites = new Set(favoriteIds);
    }
    
    async function toggleFavorite(placeId) {
        if (!currentUser) { alert("請先登入才能收藏！"); return; }
        const isFavorited = userFavorites.has(placeId);
        const favoriteRef = db.collection('favorites').doc(`${currentUser.uid}_${placeId}`);

        if (isFavorited) {
            await favoriteRef.delete();
            userFavorites.delete(placeId);
            console.log("已取消收藏:", placeId);
        } else {
            await favoriteRef.set({
                userId: currentUser.uid,
                placeId: placeId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            userFavorites.add(placeId);
            console.log("已收藏:", placeId);
        }
        updateFavoriteButtonUI(placeId);
    }

    // --- 5. 地圖與UI互動模組 ---
    window.initMap = function() {
        const initialPosition = { lat: 25.0479, lng: 121.5171 };
        const mapStyle = [{"elementType":"geometry","stylers":[{"color":"#f5f5f5"}]},{"elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"elementType":"labels.text.fill","stylers":[{"color":"#616161"}]},{"elementType":"labels.text.stroke","stylers":[{"color":"#f5f5f5"}]},{"featureType":"administrative.land_parcel","elementType":"labels.text.fill","stylers":[{"color":"#bdbdbd"}]},{"featureType":"poi","elementType":"geometry","stylers":[{"color":"#eeeeee"}]},{"featureType":"poi","elementType":"labels.text.fill","stylers":[{"color":"#757575"}]},{"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#e5e5e5"}]},{"featureType":"poi.park","elementType":"labels.text.fill","stylers":[{"color":"#9e9e9e"}]},{"featureType":"road","elementType":"geometry","stylers":[{"color":"#ffffff"}]},{"featureType":"road.arterial","elementType":"labels.text.fill","stylers":[{"color":"#757575"}]},{"featureType":"road.highway","elementType":"geometry","stylers":[{"color":"#dadada"}]},{"featureType":"road.highway","elementType":"labels.text.fill","stylers":[{"color":"#616161"}]},{"featureType":"road.local","elementType":"labels.text.fill","stylers":[{"color":"#9e9e9e"}]},{"featureType":"transit.line","elementType":"geometry","stylers":[{"color":"#e5e5e5"}]},{"featureType":"transit.station","elementType":"geometry","stylers":[{"color":"#eeeeee"}]},{"featureType":"water","elementType":"geometry","stylers":[{"color":"#c9c9c9"}]},{"featureType":"water","elementType":"labels.text.fill","stylers":[{"color":"#9e9e9e"}]}];
        map = new google.maps.Map(document.getElementById("map"), { center: initialPosition, zoom: 15, styles: mapStyle, disableDefaultUI: true });
        
        setupMapListeners();
        updateUserGPS(initialPosition);
        getRecommendedRestaurants(initialPosition);
    }
    
    function setupMapListeners() {
        map.addListener('click', (event) => {
            if (!event.placeId) document.getElementById('restaurant-card').classList.remove('active');
        });
    }

    function addRestaurantMarker(place, isRecommended = false) {
        const isHot = place.rating > 4.5;
        const color = isRecommended ? '#ffc107' : (isHot ? '#ff385c' : '#00a699');
        const marker = new google.maps.Marker({
            position: place.geometry.location, map, title: place.name,
            icon: {
                url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${color}" width="36px" height="36px"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 0 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg>`)}`,
                scaledSize: new google.maps.Size(36, 36), anchor: new google.maps.Point(18, 36)
            },
            placeData: place
        });
        marker.addListener('click', () => handlePlaceSelection(marker.placeData));
        restaurantMarkers.push(marker);
    }
    
    function handlePlaceSelection(place) {
        // ... (內容與上一版相似，主要是填充卡片)
        const card = document.getElementById('restaurant-card');
        selectedCardPlaceId = place.place_id;
        
        let content = `
            <div class="card-content">
                <h3 class="card-title">${place.name}</h3>
                <p class="card-meta"><span><i class="fas fa-star"></i> ${place.rating || 'N/A'}</span></p>
                <p class="card-status">${place.opening_hours ? (place.opening_hours.open_now ? '<span class="status open">營業中</span>' : '<span class="status closed">休息中</span>') : '營業時間未提供'}</p>
                <p class="card-address"><i class="fas fa-map-marker-alt"></i> ${place.vicinity}</p>
                <div class="card-actions">
                    <button class="action-btn" onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${place.geometry.location.lat()},${place.geometry.location.lng()}', '_blank')"><i class="fas fa-diamond-turn-right"></i> 導航</button>
                    <button id="card-favorite-btn" class="action-btn" onclick="toggleFavorite('${place.place_id}')"><i class="far fa-heart"></i> 收藏</button>
                </div>
            </div>`;
        card.innerHTML = content;
        updateFavoriteButtonUI(place.place_id);
        card.classList.add('active');
        map.panTo(place.geometry.location);
    }
    
    function updateFavoriteButtonUI(placeId) {
        const favBtn = document.getElementById('card-favorite-btn');
        if (!favBtn) return;
        const isFavorited = userFavorites.has(placeId);
        favBtn.classList.toggle('favorited', isFavorited);
        favBtn.querySelector('i').className = isFavorited ? 'fas fa-heart' : 'far fa-heart';
    }

    // --- 6. 記帳與推薦模組 ---
    async function renderAccountingTab() {
        if (!currentUser) return;
        const container = document.getElementById('accounting-content');
        container.innerHTML = '<h4>正在載入消費紀錄...</h4>';
        const reviewsSnapshot = await db.collection('reviews').where('userId', '==', currentUser.uid).get();
        const spendingData = reviewsSnapshot.docs.map(doc => doc.data());
        
        let totalAmount = 0;
        const categorySpending = {};

        spendingData.forEach(item => {
            if(item.amount && item.amount > 0) {
                totalAmount += item.amount;
                const category = item.category || '其他'; // 假設 review 有 category
                categorySpending[category] = (categorySpending[category] || 0) + item.amount;
            }
        });

        container.innerHTML = `
            <div class="summary">
                <div class="summary-item">
                    <div class="label">本月總消費</div>
                    <div class="amount">$${totalAmount.toLocaleString()}</div>
                </div>
            </div>
            <div id="chart-container">
                <canvas id="spending-chart"></canvas>
            </div>`;
        
        if (Object.keys(categorySpending).length > 0) {
            if (accountingChart) accountingChart.destroy();
            accountingChart = new Chart(document.getElementById('spending-chart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(categorySpending),
                    datasets: [{
                        data: Object.values(categorySpending),
                        backgroundColor: ['#ff5a5f', '#ffb400', '#00a699', '#484848', '#767676'],
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        } else {
             container.querySelector('#chart-container').innerHTML = '<p class="placeholder-text">尚無消費資料可繪製圖表。</p>';
        }
    }

    async function getRecommendedRestaurants(location) {
        let recommendedKeywords = [];
        if (currentUser) {
            const reviewsSnapshot = await db.collection('reviews').where('userId', '==', currentUser.uid).limit(20).get();
            if (!reviewsSnapshot.empty) {
                const categoryCounts = {};
                reviewsSnapshot.docs.forEach(doc => {
                    const category = doc.data().category;
                    if(category) categoryCounts[category] = (categoryCounts[category] || 0) + 1;
                });
                recommendedKeywords = Object.keys(categoryCounts).sort((a,b) => categoryCounts[b] - categoryCounts[a]);
            }
        }
        
        const keyword = recommendedKeywords.length > 0 ? recommendedKeywords[0] : '美食'; // 優先推薦最常吃的類別
        console.log("推薦搜尋關鍵字:", keyword);

        const request = {
            location: location,
            radius: '2000',
            type: ['restaurant'],
            keyword: keyword
        };
        
        // 此處用模擬的 placesService
        // placesService.nearbySearch(request, (results, status) => { ... });
    }

    // --- 7. 頁面切換與初始化 ---
    window.showPage = (pageId, navEl) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        if(navEl) {
          document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
          navEl.classList.add('active');
        }
        if(pageId === 'profile-page') renderProfilePage();
    }
    
    function renderProfilePage() {
        if(currentUser) {
            showProfileTab('favorites', document.querySelector('.tab-btn'));
        }
    }

    window.showProfileTab = (tabId, tabEl) => {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        tabEl.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`${tabId}-content`).classList.add('active');
        
        if (tabId === 'accounting') {
            renderAccountingTab();
        }
    }

    // 將需要從 HTML onclick 呼叫的函式掛載到 window
    window.initMap = initMap;
    window.centerOnUserGPS = centerOnUserGPS;

});
</script>
</body>
</html>
