<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Google Maps - 自訂資訊卡片示範</title>
  
  <!-- 引入 Font Awesome 圖示庫 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />

  <style>
    /* 1. 基本網頁與地圖樣式 */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
    }

    /* 2. InfoBox 卡片樣式 */
    .info-box-container {
      /* 移除 InfoBox.js 預設的邊框和背景 */
      border: none !important;
      background: transparent !important;
    }

    .info-card {
      width: 320px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #3C4043; /* Google's text color */
      opacity: 0; /* 初始隱藏，用於動畫 */
      transform: translateY(10px); /* 初始位置，用於動畫 */
      animation: fadeIn 0.3s forwards;
    }
    
    @keyframes fadeIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .info-card-image {
      height: 140px;
      background-color: #e0e0e0; /* 圖片載入前的佔位背景色 */
    }
    .info-card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover; /* 確保圖片填滿容器且不變形 */
    }

    .info-card-content {
      padding: 16px;
    }

    .info-card-header .restaurant-name {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
    }
    .info-card-header .restaurant-subname {
      font-size: 14px;
      color: #5f6368;
      margin: 2px 0 0 0;
    }

    .info-card-details {
      display: flex;
      align-items: center;
      font-size: 14px;
      color: #5f6368;
      margin-top: 8px;
    }
    .info-card-details .rating-score {
      font-weight: 500;
      color: #3C4043;
    }
    .info-card-details .rating-stars {
      color: #FDBF42; /* Gold color for stars */
      margin: 0 4px;
    }
    .info-card-details .meta-dot {
      margin: 0 6px;
    }

    .info-card-status {
      font-size: 14px;
      margin-top: 10px;
    }
    .info-card-status .status.open {
      color: #34A853; /* Google Green */
      font-weight: 500;
    }
    .info-card-status .status.closed {
      color: #EA4335; /* Google Red */
      font-weight: 500;
    }
    .info-card-status .hours {
      color: #5f6368;
    }

    .info-card-actions {
      display: flex;
      justify-content: space-around;
      padding: 8px;
      border-top: 1px solid #e0e0e0;
    }
    .info-card-actions .action-btn {
      background: none;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      color: #1a73e8; /* Google Blue for actions */
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background-color 0.2s;
    }
    .info-card-actions .action-btn:hover {
      background-color: #e8f0fe;
    }
    .info-card-actions .action-btn.primary {
      background-color: #1a73e8;
      color: #fff;
    }
    .info-card-actions .action-btn.primary:hover {
      background-color: #1866c8;
    }

    /* InfoBox 關閉按鈕樣式 */
    .info-box-close {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 28px;
      height: 28px;
      background-color: rgba(0, 0, 0, 0.4);
      color: #fff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      line-height: 28px;
      text-align: center;
      z-index: 10;
      transition: background-color 0.2s;
    }
    .info-box-close:hover {
        background-color: rgba(0, 0, 0, 0.6);
    }
  </style>
</head>
<body>
  
  <div id="map"></div>

  <!-- 
    引入 Google Maps JavaScript API
    - `key`: 請替換成您自己的 API 金鑰
    - `callback=initMap`: API 載入完成後，自動執行名為 initMap 的函式
    - `async`: 非同步載入
  -->
  <script src="https://cdn.jsdelivr.net/gh/googlemaps/v3-utility-library@master/infobox/src/infobox.min.js"></script>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs&callback=initMap"
    async
  ></script>

  <script>
    // 全域變數
    let map;
    let infoBox;
    let infoCardTemplate = '';

    // 模擬從 Places API 獲取的餐廳資料
    const mockRestaurantData = {
      name: "Ichiran Ramen",
      subName: "一蘭拉麵 台灣台北本店",
      photoUrl: "https://images.unsplash.com/photo-1552634354-9a5160b83F43?q=80&w=1770&auto=format&fit=crop", // 使用 Unsplash 的範例圖片
      rating: 4.2,
      userRatingsTotal: 18500,
      types: ["拉麵店"],
      priceLevel: 3,
      openingHours: {
        isOpen: () => true // 模擬營業中
      },
      position: { lat: 25.0339, lng: 121.5645 } // 台北101 附近
    };

    // 1. Google Maps 初始化函式
    async function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: mockRestaurantData.position,
        zoom: 16,
        clickableIcons: false,
      });

      // 預先準備好 HTML 模板
      infoCardTemplate = `
        <div class="info-card">
          <div class="info-card-image"><img src="{PHOTO_URL}" alt="{RESTAURANT_NAME} 的照片"></div>
          <div class="info-card-content">
            <div class="info-card-header">
              <h3 class="restaurant-name">{RESTAURANT_NAME}</h3><p class="restaurant-subname">{RESTAURANT_SUB_NAME}</p>
            </div>
            <div class="info-card-details">
              <span class="rating"><span class="rating-score">{RATING_SCORE}</span><span class="rating-stars">{RATING_STARS}</span><span class="rating-count">({RATING_COUNT})</span></span>
              <span class="meta-dot">·</span><span class="category">{CATEGORY}</span><span class="meta-dot">·</span><span class="price-range">{PRICE_RANGE}</span>
            </div>
            <div class="info-card-status"><span class="status {OPEN_STATUS_CLASS}">{OPEN_STATUS_TEXT}</span><span class="hours"> · {HOURS_TEXT}</span></div>
          </div>
          <div class="info-card-actions">
            <button class="action-btn primary"><i class="fas fa-directions"></i> 導航</button><button class="action-btn"><i class="far fa-bookmark"></i> 儲存</button><button class="action-btn"><i class="fas fa-share-square"></i> 分享</button>
          </div>
        </div>`;

      // 2. 初始化 InfoBox
      infoBox = new InfoBox({
        content: "",
        disableAutoPan: false,
        maxWidth: 0,
        pixelOffset: new google.maps.Size(-160, -320), // 調整 Y 軸偏移，讓卡片底部更靠近 Marker
        zIndex: null,
        boxClass: "info-box-container",
        closeBoxMargin: "10px",
        closeBoxURL: "", // 我們用自己的 CSS 關閉按鈕，這裡留空
        infoBoxClearance: new google.maps.Size(1, 1),
        isHidden: false,
        pane: "floatPane",
        enableEventPropagation: false,
      });
      // 監聽 InfoBox 自己的關閉按鈕事件
      google.maps.event.addListener(infoBox, 'closeclick', function() {
        // 在這裡可以加入關閉後的額外邏輯
      });


      // 3. 建立 Marker
      const marker = new google.maps.Marker({
        position: mockRestaurantData.position,
        map: map,
        title: mockRestaurantData.name,
      });

      // 4. 為 Marker 設定點擊事件
      marker.addListener("click", () => {
        showInfoCard(mockRestaurantData, marker);
      });
      
      // 5. 點擊地圖空白處關閉 InfoBox
      map.addListener("click", () => {
        infoBox.close();
      });
    }

    // 函式：顯示資訊卡片
    function showInfoCard(data, marker) {
      infoBox.close(); // 先關閉可能已開啟的 InfoBox

      const content = createInfoCardContent(data);
      infoBox.setContent(content);
      
      infoBox.open(map, marker);
    }

    // 函式：根據資料產生 HTML 內容
    function createInfoCardContent(data) {
      // 處理評分星星
      let starsHtml = '';
      const roundedRating = Math.round(data.rating);
      for (let i = 0; i < 5; i++) {
        starsHtml += `<i class="fa-solid fa-star" ${i < roundedRating ? '' : 'style="opacity:0.3"'}></i>`;
      }

      const priceRange = '$'.repeat(data.priceLevel);
      const isOpen = data.openingHours.isOpen();
      
      // 動態替換模板中的佔位符
      let content = infoCardTemplate
        .replace(/{PHOTO_URL}/g, data.photoUrl)
        .replace(/{RESTAURANT_NAME}/g, data.name)
        .replace(/{RESTAURANT_SUB_NAME}/g, data.subName)
        .replace(/{RATING_SCORE}/g, data.rating.toFixed(1))
        .replace(/{RATING_STARS}/g, starsHtml)
        .replace(/{RATING_COUNT}/g, data.userRatingsTotal.toLocaleString())
        .replace(/{CATEGORY}/g, data.types.join(', '))
        .replace(/{PRICE_RANGE}/g, priceRange)
        .replace(/{OPEN_STATUS_CLASS}/g, isOpen ? 'open' : 'closed')
        .replace(/{OPEN_STATUS_TEXT}/g, isOpen ? '營業中' : '休息中')
        .replace(/{HOURS_TEXT}/g, "營業至下午10:00"); // 模擬時間

      // 建立一個 div 元素來包裹內容，並加上我們自訂的關閉按鈕
      const container = document.createElement('div');
      container.innerHTML = content;
      
      const closeButton = document.createElement('button');
      closeButton.className = 'info-box-close';
      closeButton.innerHTML = '×';
      closeButton.onclick = () => infoBox.close();
      
      container.prepend(closeButton);
      
      return container;
    }
  </script>
</body>
</html>
