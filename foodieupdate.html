<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>FoodieApp</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs&libraries=places,geometry&callback=initMap"
    async
    defer
  ></script>

  <style>
    /* --- 全域與基本樣式 --- */
    :root { 
        --primary-color: #667eea; 
        --secondary-color: #764ba2; 
        --success-color: #28a745; 
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --background-color: #f8f9fa;
        --text-color: #333; 
        --text-light: #6c757d; 
        --nav-height: 60px; 
    }
    html, body { height: 100%; margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--background-color); }
    .app-container { width: 100%; height: 100vh; display: flex; flex-direction: column; }
    main { flex-grow: 1; overflow: hidden; position: relative; }
    .page { width: 100%; height: 100%; display: none; flex-direction: column; overflow: hidden; }
    .page.active { display: flex; }
    
    /* --- 新導航列 --- */
    .app-nav { height: var(--nav-height); width: 100%; background: #fff; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-light); font-size: 12px; cursor: pointer; transition: color 0.2s; width: 100%; height: 100%; }
    .nav-item i { font-size: 22px; margin-bottom: 4px; }
    .nav-item.active { color: var(--primary-color); }
    .nav-item-add { position: relative; top: -15px; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: white; border-radius: 50%; width: 56px; height: 56px; flex-shrink: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 2px solid white; }
    .nav-item-add i { font-size: 24px; margin: 0; }
    .nav-item-add.active { /* 中間按鈕不需要 active 狀態 */ }
    
    /* --- 通用頁面標頭與內容 --- */
    .page-header { padding: 15px 20px; background-color: #fff; border-bottom: 1px solid #eee; text-align: center; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
    .page-header h2 { margin: 0; font-size: 18px; color: var(--text-color); display: flex; align-items: center; justify-content: center; flex-grow: 1; }
    .page-header h2 i { margin-right: 10px; color: var(--primary-color); }
    .header-action { font-size: 16px; color: var(--primary-color); text-decoration: none; cursor: pointer; font-weight: 500; }
    .header-action-placeholder { width: 60px; }
    .page-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
    .placeholder-text { text-align: center; color: var(--text-light); margin-top: 50px; padding: 20px; }

    /* --- 按鈕樣式 --- */
    .btn { padding: 10px 20px; border-radius: 20px; border: none; font-size: 16px; cursor: pointer; font-weight: bold; }
    .btn-primary { background-color: var(--primary-color); color: white; }
    .btn-full-width { width: 100%; }
    .btn-fixed-bottom { position: absolute; bottom: 20px; left: 20px; right: 20px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }

    /* --- 地圖頁 --- */
    #map-page { padding: 0; }
    #map-page .page-content { padding: 0; flex-grow: 1; display: flex; flex-direction: column; }
    #map-panel { flex-grow: 1; position: relative; background: #e5e3df; }
    #list-panel { max-height: 40%; height: 40%; border-top: 1px solid #ddd; display: flex; flex-direction: column; background: white; overflow: hidden; flex-shrink: 0; }
    #map { width: 100%; height: 100%; }
    .search-area { padding: 15px; border-bottom: 1px solid #eee; background: var(--background-color); flex-shrink: 0; position: relative; }
    .search-input { width: 100%; padding: 12px 40px 12px 15px; font-size: 16px; border-radius: 25px; border: 1px solid #ccc; box-sizing: border-box; }
    .location-btn { position: absolute; bottom: 20px; right: 20px; z-index: 10; width: 50px; height: 50px; border-radius: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .info-window-content p, .info-window-content h4, .info-window-content div { font-family: inherit; margin: 0 0 8px 0; }
    .info-window-content h4 { font-weight: 600; font-size: 16px; }
    .info-window-content i { margin-right: 8px; color: var(--primary-color); width: 16px; text-align: center; }

    /* --- 美食隨機選頁 --- */
    #random-picker-page .page-content { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    .picker-result-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); min-height: 150px; width: 80%; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; }
    .picker-result-name { font-size: 24px; font-weight: bold; color: var(--primary-color); }
    .picker-result-address { font-size: 14px; color: var(--text-light); margin-top: 8px; }
    .picker-button { padding: 15px 40px; font-size: 18px; border-radius: 30px; }

    /* --- 個人資料 & 記帳頁 --- */
    #profile-page .page-content, #accounting-content { padding: 0; }
    .profile-tabs { display: flex; background: #fff; border-bottom: 1px solid #eee; flex-shrink: 0; }
    .tab-item { flex: 1; text-align: center; padding: 14px 0; cursor: pointer; color: var(--text-light); font-size: 15px; border-bottom: 3px solid transparent; }
    .tab-item.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 600; }
    .profile-tab-content { display: none; height: 100%; overflow-y: auto; }
    .profile-tab-content.active { display: block; }
    .accounting-summary { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; }
    .summary-card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; }
    .summary-card-title { font-size: 14px; color: var(--text-light); margin-bottom: 8px; }
    .summary-card-value { font-size: 22px; font-weight: 600; color: var(--primary-color); }
    .daily-accounting-list { padding: 15px; }

    /* --- 美食挑戰頁 --- */
    #challenges-page .page-content { padding-bottom: 90px; }
    .challenge-card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
    .challenge-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .challenge-title { font-size: 18px; font-weight: 600; flex-grow: 1; }
    
    /* --- 登入/註冊頁 --- */
    #auth-page { justify-content: flex-start; background: #fff; }
    .auth-header { padding: 15px 20px; background-color: #fff; text-align: center; flex-shrink: 0; display: flex; justify-content: flex-start; align-items: center; }
    .auth-header .close-btn { font-size: 24px; color: var(--text-color); cursor: pointer; }
    .auth-container { padding: 30px; width: 100%; max-width: 350px; text-align: center; box-sizing: border-box; }
  </style>
</head>
<body>
  <div class="app-container">
    <main>
      <!-- 地圖頁 -->
      <div id="map-page" class="page active">
        <div class="page-header map-header">
            <div class="header-action-placeholder"></div><h2><i class="fas fa-map-marked-alt"></i>探索美食</h2><a href="#" class="header-action" onclick="showAuthPage()">登入/註冊</a>
        </div>
        <div class="page-content">
            <div id="map-panel"><div id="map"></div><button class="btn btn-primary location-btn" onclick="centerOnUserGPS()"><i class="fas fa-crosshairs"></i></button></div>
            <div id="list-panel">
                <div class="search-area"><input type="text" id="search-input" class="search-input" placeholder="搜尋餐廳..." /></div>
                <div id="list-content-area" class="list-content"><p class="list-status-text">拖動地圖以搜尋附近餐廳</p></div>
            </div>
        </div>
      </div>

      <!-- 美食隨機選頁 -->
      <div id="random-picker-page" class="page">
        <div class="page-header"><div class="header-action-placeholder"></div><h2><i class="fas fa-dice"></i>美食隨機選</h2><div class="header-action-placeholder"></div></div>
        <div class="page-content">
            <div class="picker-result-card"><div id="picker-result-display"><span class="picker-result-name">?</span></div></div>
            <button class="btn btn-primary picker-button" onclick="startRandomPick()">今天吃什麼？</button>
            <p class="placeholder-text" style="margin-top: 20px;">提示：隨機選會從您目前地圖上的餐廳列表抽取喔！</p>
        </div>
      </div>
      
      <!-- 新增頁 -->
      <div id="posts-page" class="page">
        <div class="page-header"><h2><i class="fas fa-plus-square"></i>新增</h2></div>
        <div class="page-content"><p class="placeholder-text">您可以在餐廳的資訊卡中新增貼文，<br>或是在個人資料的記帳頁面<br>快速新增一筆消費。</p></div>
      </div>

      <!-- 美食挑戰頁 -->
      <div id="challenges-page" class="page">
        <div class="page-header"><div class="header-action-placeholder"></div><h2><i class="fas fa-trophy"></i>美食挑戰</h2><a href="#" class="header-action" onclick="showAuthPage()">登入/註冊</a></div>
        <div class="page-content" id="challenges-content"></div>
      </div>
      
      <!-- 個人資料頁 -->
      <div id="profile-page" class="page"></div>

      <!-- 登入/註冊頁 -->
      <div id="auth-page" class="page"></div>
    </main>

    <footer class="app-nav">
      <div class="nav-item active" onclick="showPage('map-page', this)"><i class="fas fa-map-marked-alt"></i><span>地圖</span></div>
      <div class="nav-item" onclick="showPage('random-picker-page', this)"><i class="fas fa-dice"></i><span>隨機選</span></div>
      <div class="nav-item nav-item-add" onclick="showPage('posts-page', this)"><i class="fas fa-plus"></i></div>
      <div class="nav-item" onclick="showPage('challenges-page', this)"><i class="fas fa-trophy"></i><span>挑戰</span></div>
      <div class="nav-item" onclick="showPage('profile-page', this)"><i class="fas fa-user"></i><span>個人資料</span></div>
    </footer>
  </div>

<script>
// --- 全域變數 ---
let currentUser = null; 
let map, userGpsPosition, infoWindow, placesService, autocomplete;
let currentPlaces = []; // 當前地圖上的餐廳列表，供隨機選使用
let restaurantMarkers = [];
let pageHistory = ['map-page']; 
let accountingCurrentDate = new Date();
const POSTS_DB_KEY = 'foodieAppPosts'; 
const CHALLENGES_DB_KEY = 'foodieAppUserChallenges';
const mockFriendData = { 'friend1': { name: '小明' }, 'friend2': { name: '花花' } };
const mockFriendReviews = { 'ChIJ____wJy_QjQR1bI4m_d1jYg': [{ friendId: 'friend1', rating: 4, comment: '這家氣氛超棒，甜點必吃！下次還要再來。' }] };

// --- 地圖 API & 功能 (目標2) ---
function initMap() {
    userGpsPosition = { lat: 25.0479, lng: 121.5171 };
    map = new google.maps.Map(document.getElementById("map"), { center: userGpsPosition, zoom: 15, disableDefaultUI: true, zoomControl: true });
    placesService = new google.maps.places.PlacesService(map);
    infoWindow = new google.maps.InfoWindow();
    setupAutocomplete();
    setupMapListeners();
    updateUserGPS();
}
function setupMapListeners() {
    map.addListener("idle", () => {
        setTimeout(() => searchNearbyRestaurants(map.getCenter()), 500);
    });
}
function setupAutocomplete() {
    const input = document.getElementById('search-input');
    autocomplete = new google.maps.places.Autocomplete(input, { types: ['establishment'], componentRestrictions: { country: 'tw' } });
    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (place.geometry) {
            map.setCenter(place.geometry.location);
            map.setZoom(17);
        }
    });
}
function updateUserGPS() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            userGpsPosition = { lat: position.coords.latitude, lng: position.coords.longitude };
            map.setCenter(userGpsPosition);
        }, () => console.log("無法取得地理位置"));
    }
}
function centerOnUserGPS() { if (map && userGpsPosition) map.setCenter(userGpsPosition); }
function searchNearbyRestaurants(location) {
    const request = { location, radius: 2000, type: 'restaurant' };
    placesService.nearbySearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && results) {
            restaurantMarkers.forEach(marker => marker.setMap(null));
            restaurantMarkers = [];
            currentPlaces = results.map(place => ({ ...place, distance: google.maps.geometry.spherical.computeDistanceBetween(location, place.geometry.location) }));
            currentPlaces.forEach(place => addRestaurantMarker(place));
        }
    });
}
function addRestaurantMarker(place) {
    const isDistant = place.distance > 1500; // 目標2：超過1.5公里的餐廳標籤顯示
    const marker = new google.maps.Marker({
        position: place.geometry.location, map, title: place.name,
        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: isDistant ? '#9E9E9E' : '#EA4335', fillOpacity: 1, strokeWeight: 1, strokeColor: 'white' }
    });
    marker.addListener('click', () => showPlaceDetails(place, marker));
    restaurantMarkers.push(marker);
}
function showPlaceDetails(place, marker) { // 目標4 & 5
    placesService.getDetails({ placeId: place.place_id, fields: ['name', 'rating', 'opening_hours', 'vicinity'] }, (details, status) => {
        if (status !== google.maps.places.PlacesServiceStatus.OK || !details) return;

        const friendReview = mockFriendReviews[place.place_id] ? mockFriendReviews[place.place_id][0] : null;
        let friendReviewHtml = '';
        if (currentUser && friendReview) { // 只在登入後顯示好友評論
            const friendStars = Array(friendReview.rating).fill('<i class="fas fa-star" style="color:#667eea;"></i>').join('');
            const shortComment = friendReview.comment.substring(0, 20) + (friendReview.comment.length > 20 ? '...' : '');
            friendReviewHtml = `<p><i class="fas fa-user-friends"></i> <strong>好友評分:</strong> ${friendStars}</p><p style="font-style:italic; margin-left: 24px;">“${shortComment}”</p>`;
        }

        let hoursHtml = '<p><i class="fas fa-clock"></i> 暫無營業時間資訊</p>';
        if (details.opening_hours) { // 目標2：營業時間優化
            const isOpen = details.opening_hours.isOpen();
            const statusText = isOpen ? "營業中" : "打烊中";
            const color = isOpen ? "var(--success-color)" : "var(--danger-color)";
            hoursHtml = `<p><i class="fas fa-clock"></i> <strong>狀態:</strong> <span style="color:${color}; font-weight:bold;">${statusText}</span></p>`;
        }
        
        infoWindow.setContent(`
            <div class="info-window-content">
                <h4>${details.name}</h4><p><i class="fas fa-map-marker-alt"></i> ${details.vicinity}</p>
                <p><i class="fas fa-star" style="color:#FDBF42;"></i> <strong>Google評分:</strong> ${details.rating || '無'}</p>
                ${hoursHtml}${friendReviewHtml} 
            </div>`); // 目標5: 好友評論在營業時間之後
        infoWindow.open(map, marker);
    });
}

// --- App 主邏輯 ---
document.addEventListener('DOMContentLoaded', () => {
    // --- Firebase & Auth ---
    const firebaseConfig = { apiKey: "AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs", authDomain: "foodiedata-b4982.firebaseapp.com", projectId: "foodiedata-b4982" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    auth.onAuthStateChanged(user => { currentUser = user; updateUserUI(user); });

    // --- 頁面導航 ---
    window.showPage = (pageId, navElement) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if (navElement) navElement.classList.add('active');
        if (pageId === 'profile-page') renderProfilePage();
        else if (pageId === 'challenges-page') renderChallengesPage();
    };
    window.goBack = () => { /* ... */ };
    window.showAuthPage = () => { /* ... */ };

    // --- 美食隨機選 ---
    window.startRandomPick = () => {
        const display = document.getElementById('picker-result-display');
        if (currentPlaces.length === 0) { display.innerHTML = `<span class="picker-result-name">請先在地圖上<br>搜尋區域喔！</span>`; return; }
        let spinCount = 0;
        const spinInterval = setInterval(() => {
            spinCount++;
            display.innerHTML = `<span class="picker-result-name">${currentPlaces[Math.floor(Math.random() * currentPlaces.length)].name}</span>`;
            if (spinCount > 20) {
                clearInterval(spinInterval);
                const finalPlace = currentPlaces[Math.floor(Math.random() * currentPlaces.length)];
                display.innerHTML = `<span class="picker-result-name">${finalPlace.name}</span><p class="picker-result-address">${finalPlace.vicinity}</p><button class="btn btn-primary" style="margin-top:15px;" onclick="showPlaceOnMap('${finalPlace.place_id}')">在地圖上顯示</button>`;
            }
        }, 100);
    };
    window.showPlaceOnMap = (placeId) => {
        const place = currentPlaces.find(p => p.place_id === placeId);
        const marker = restaurantMarkers.find(m => m.getTitle() === place.name);
        showPage('map-page', document.querySelector('.nav-item'));
        map.setCenter(place.geometry.location);
        map.setZoom(17);
        if (marker) showPlaceDetails(place, marker);
    };

    // --- 個人資料 (目標3) & 記帳 (目標1) ---
    window.renderProfilePage = () => {
        const container = document.getElementById('profile-page');
        if (currentUser) {
            container.innerHTML = `<div class="page-header"><div class="header-action-placeholder"></div><h2><i class="fas fa-user-circle"></i>個人資料</h2><a href="#" class="header-action" onclick="handleSignOut()">登出</a></div><div class="profile-tabs"><div class="tab-item active" onclick="showProfileTab('accounting-content', this)">記帳顯示</div><div class="tab-item" onclick="showProfileTab('myposts-content', this)">我的貼文</div><div class="tab-item" onclick="showProfileTab('favorites-content', this)">最愛餐廳</div></div><div class="page-content"><div id="accounting-content" class="profile-tab-content active"></div><div id="myposts-content" class="profile-tab-content"><p class="placeholder-text">功能開發中</p></div><div id="favorites-content" class="profile-tab-content"><p class="placeholder-text">功能開發中</p></div></div>`;
            renderAccountingRecords();
        } else {
            container.innerHTML = `<div class="page-header"><h2><i class="fas fa-user-circle"></i>個人資料</h2></div><div class="page-content"><div class="profile-login-prompt"><i class="fas fa-sign-in-alt"></i><h3>登入以使用完整功能</h3><button class="btn btn-primary" onclick="showAuthPage()">登入 / 註冊</button></div></div>`;
        }
    };
    window.showProfileTab = (tabId, element) => {
        document.querySelectorAll('.profile-tab-content, .tab-item').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        element.classList.add('active');
    };
    window.renderAccountingRecords = () => {
        const container = document.getElementById('accounting-content');
        if (!currentUser || !container) return;
        
        const posts = getPosts(); // 取得真實數據
        const now = new Date();
        const startOfWeek = new Date(now); startOfWeek.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1)); startOfWeek.setHours(0,0,0,0);
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        
        let weeklyCost = 0, monthlyCost = 0;
        posts.forEach(p => {
            const postDate = new Date(p.timestamp);
            if(postDate >= startOfWeek) weeklyCost += Number(p.cost);
            if(postDate >= startOfMonth) monthlyCost += Number(p.cost);
        });

        container.innerHTML = `<div class="accounting-summary"><div class="summary-card"><div class="summary-card-title">本週支出</div><div class="summary-card-value">$${weeklyCost.toLocaleString()}</div></div><div class="summary-card"><div class="summary-card-title">本月支出</div><div class="summary-card-value">$${monthlyCost.toLocaleString()}</div></div></div><div id="daily-accounting-section"></div>`;
        renderDailyAccountingView(accountingCurrentDate); // 渲染每日記帳
    };
    function renderDailyAccountingView(date){ /* 與前版相同，此處省略 */ };
    function getPosts() { return JSON.parse(localStorage.getItem(`${POSTS_DB_KEY}_${currentUser.uid}`)) || []; }
    
    // --- 美食挑戰 ---
    window.renderChallengesPage = () => { /* 與前版相同，此處省略 */ };
    
    // --- UI 更新 & 初始化 ---
    const updateUserUI = (user) => { /* 與前版相同，此處省略 */ };
    updateUserUI(auth.currentUser);
    showPage('map-page', document.querySelector('.nav-item'));
});
</script>
</body>
</html>
