<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>FoodieApp</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs&libraries=places,geometry&callback=initMap"
    async
    defer
  ></script>

  <style>
    /* --- 全域與基本樣式 --- */
    :root { 
        --primary-color: #667eea; 
        --secondary-color: #764ba2; 
        --success-color: #28a745; 
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --background-color: #f8f9fa;
        --text-color: #333; 
        --text-light: #6c757d; 
        --nav-height: 60px; 
    }
    html, body { height: 100%; margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--background-color); }
    .app-container { width: 100%; height: 100vh; display: flex; flex-direction: column; }
    main { flex-grow: 1; overflow: hidden; position: relative; }
    .page { width: 100%; height: 100%; display: none; flex-direction: column; overflow: hidden; }
    .page.active { display: flex; }
    .app-nav { height: var(--nav-height); width: 100%; background: #fff; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-light); font-size: 12px; cursor: pointer; transition: color 0.2s; width: 100%; }
    .nav-item i { font-size: 22px; margin-bottom: 4px; }
    .nav-item.active { color: var(--primary-color); }
    
    /* --- 通用頁面標頭與內容 --- */
    .page-header { padding: 15px 20px; background-color: #fff; border-bottom: 1px solid #eee; text-align: center; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
    .page-header h2 { margin: 0; font-size: 18px; color: var(--text-color); display: flex; align-items: center; justify-content: center; flex-grow: 1; }
    .page-header h2 i { margin-right: 10px; color: var(--primary-color); }
    .header-action { font-size: 16px; color: var(--primary-color); text-decoration: none; cursor: pointer; font-weight: 500; }
    .header-action-placeholder { width: 60px; }
    .page-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
    .placeholder-text { text-align: center; color: var(--text-light); margin-top: 50px; padding: 20px; }

    /* --- 按鈕樣式 --- */
    .btn { padding: 10px 20px; border-radius: 20px; border: none; font-size: 16px; cursor: pointer; font-weight: bold; }
    .btn-primary { background-color: var(--primary-color); color: white; }
    .btn-full-width { width: 100%; }
    .btn-fixed-bottom { position: absolute; bottom: 20px; left: 20px; right: 20px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }

    /* --- 地圖頁樣式 --- */
    #map-page { flex-direction: column; padding: 0; }
    .map-header { flex-shrink: 0; }
    #map-page .page-content { padding: 0; flex-grow: 1; display: flex; flex-direction: column; }
    #map-panel { flex-grow: 1; position: relative; background: #e5e3df; }
    #list-panel { max-height: 40%; height: 40%; border-top: 1px solid #ddd; display: flex; flex-direction: column; background: white; overflow: hidden; flex-shrink: 0; }
    #map { width: 100%; height: 100%; }
    .search-area { padding: 15px; border-bottom: 1px solid #eee; background: var(--background-color); flex-shrink: 0; position: relative; }
    .search-input { width: 100%; padding: 12px 40px 12px 15px; font-size: 16px; border-radius: 25px; border: 1px solid #ccc; box-sizing: border-box; }
    .clear-search-btn { position: absolute; top: 50%; right: 25px; transform: translateY(-50%); background: #ccc; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 14px; font-weight: bold; color: white; display: none; justify-content: center; align-items: center; }
    .list-content { overflow-y: auto; flex-grow: 1; }
    .location-btn { position: absolute; bottom: 20px; right: 20px; background: #fff; color: var(--primary-color); border: none; width: 50px; height: 50px; border-radius: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); cursor: pointer; z-index: 10; font-size: 24px; display: flex; justify-content: center; align-items: center; }

    /* --- 個人資料頁樣式 --- */
    #profile-page .page-content { padding: 0; }
    .profile-tabs { display: flex; background: #fff; border-bottom: 1px solid #eee; flex-shrink: 0; }
    .tab-item { flex: 1; text-align: center; padding: 14px 0; cursor: pointer; color: var(--text-light); font-size: 15px; border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; }
    .tab-item.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 600; }
    .profile-tab-content { display: none; height: 100%; overflow-y: auto; }
    .profile-tab-content.active { display: block; }
    .profile-login-prompt { text-align: center; padding: 50px 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; box-sizing: border-box; }
    .profile-login-prompt i { font-size: 50px; color: var(--primary-color); margin-bottom: 20px; }
    .profile-login-prompt h3 { font-size: 20px; color: var(--text-color); margin-bottom: 10px; }
    .profile-login-prompt p { color: var(--text-light); margin-bottom: 25px; max-width: 280px; }
    .login-prompt-btn { background-color: var(--primary-color); color: white; border: none; padding: 12px 40px; border-radius: 25px; font-size: 16px; cursor: pointer; font-weight: bold; }
    
    /* --- 記帳頁樣式 --- */
    #accounting-content { padding: 0; background-color: var(--background-color); }
    .accounting-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: #fff; }
    .accounting-header h3 { margin: 0; font-size: 16px; font-weight: 500; color: var(--text-color); }
    .date-nav-btn { background: none; border: none; font-size: 20px; color: var(--primary-color); cursor: pointer; padding: 5px 10px; }
    .daily-accounting-list { padding: 15px; }
    .daily-total-card { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; text-align: left; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3); }
    .daily-total-card .total-title { font-size: 14px; opacity: 0.9; margin-bottom: 5px; }
    .daily-total-card .total-amount { font-size: 32px; font-weight: bold; }
    .meal-item { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 12px 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .meal-info { display: flex; align-items: center; gap: 15px; }
    .meal-icon { font-size: 20px; color: var(--primary-color); width: 25px; text-align: center; }
    .meal-name { font-size: 16px; color: var(--text-color); }
    .meal-entry { display: flex; align-items: center; gap: 10px; }
    .add-expense-btn { background: #e8f5e9; border: none; font-size: 16px; color: var(--success-color); cursor: pointer; transition: all 0.2s; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .add-expense-btn:hover { background: #dceddd; }
    .expense-display, .expense-input-form { display: flex; align-items: center; gap: 10px; }
    .expense-display .cost { font-size: 16px; font-weight: 500; color: var(--text-color); }
    .delete-expense-btn { background: #fdeaea; color: #dc3545; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
    .cost-input { border: 1px solid #ccc; border-radius: 6px; padding: 6px 10px; width: 70px; font-size: 16px; text-align: right; }
    .confirm-expense-btn { background: var(--success-color); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
    
    /* --- 美食挑戰頁樣式 --- */
    #challenges-page .page-content { padding-bottom: 90px; }
    .challenge-card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
    .challenge-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .challenge-title { font-size: 18px; font-weight: 600; color: var(--text-color); flex-grow: 1; }
    .challenge-title-input { font-size: 18px; font-weight: 600; color: var(--text-color); flex-grow: 1; border: none; border-bottom: 2px solid var(--primary-color); padding: 4px 0; background: transparent; }
    .challenge-title-input:focus { outline: none; }
    .challenge-actions button { background: none; border: none; font-size: 18px; color: var(--text-light); cursor: pointer; padding: 5px; margin-left: 10px; }
    .challenge-actions button.save-btn { color: var(--success-color); }
    .challenge-actions button.delete-btn { color: var(--danger-color); }
    .progress-bar-container { background-color: #e9ecef; border-radius: 8px; height: 16px; overflow: hidden; }
    .progress-bar { background-color: var(--warning-color); height: 100%; width: 0%; border-radius: 8px; transition: width 0.3s ease-in-out; text-align: center; color: white; font-size: 12px; line-height: 16px; }
    .challenge-login-prompt { text-align: center; padding-top: 50px; }

    /* --- 登入/註冊頁 (#auth-page) 樣式 --- */
    #auth-page { justify-content: flex-start; background: #fff; }
    .auth-header { padding: 15px 20px; background-color: #fff; text-align: center; flex-shrink: 0; display: flex; justify-content: flex-start; align-items: center; }
    .auth-header .close-btn { font-size: 24px; color: var(--text-color); cursor: pointer; }
    .auth-container { padding: 30px; width: 100%; max-width: 350px; text-align: center; box-sizing: border-box; }
    .auth-container h2 { margin-top: 0; }
    .auth-form { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
    .auth-form input { padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
    .auth-btn { background-color: var(--primary-color); color: white; border: none; padding: 12px; border-radius: 5px; font-size: 16px; cursor: pointer; }
    .auth-divider { text-align: center; margin: 20px 0; color: #aaa; }
    .google-btn { background-color: #db4437; color: white; }
    .toggle-auth { color: var(--primary-color); cursor: pointer; margin-top: 15px; }
  </style>
</head>
<body>
  <div class="app-container">
    <main>
      <!-- 地圖頁 -->
      <div id="map-page" class="page active">
        <div class="page-header map-header">
            <div class="header-action-placeholder"></div>
            <h2><i class="fas fa-map-marked-alt"></i>探索美食</h2>
            <a href="#" class="header-action" onclick="showAuthPage()">登入/註冊</a>
        </div>
        <div class="page-content">
            <div id="map-panel">
                <div id="map"></div>
                <button class="location-btn" onclick="centerOnUserGPS()"><i class="fas fa-crosshairs"></i></button>
            </div>
            <div id="list-panel">
                <div class="search-area"><input type="text" id="search-input" class="search-input" placeholder="搜尋餐廳、地址或地標..." /><button id="clear-search" class="clear-search-btn" onclick="clearSearch()">×</button></div>
                <div id="list-content-area" class="list-content"><p class="list-status-text">拖動地圖以搜尋附近餐廳</p></div>
            </div>
        </div>
      </div>

      <!-- 美食挑戰頁 -->
      <div id="challenges-page" class="page">
        <div class="page-header">
            <div class="header-action-placeholder"></div>
            <h2><i class="fas fa-trophy"></i>美食挑戰</h2>
            <a href="#" class="header-action" onclick="showAuthPage()">登入/註冊</a>
        </div>
        <div class="page-content" id="challenges-content">
            <!-- 挑戰內容由 JS 動態生成 -->
        </div>
      </div>
      
      <!-- 發文頁 -->
      <div id="posts-page" class="page">
        <div class="page-header">
            <div class="header-action-placeholder"></div>
            <h2><i class="fas fa-plus-square"></i>新增貼文</h2>
            <a href="#" class="header-action" onclick="showAuthPage()">登入/註冊</a>
        </div>
        <div class="page-content"><p class="placeholder-text">找到喜歡的餐廳後，<br>在地圖的資訊卡中即可新增貼文與評論！</p></div>
      </div>
      
      <!-- 個人資料頁 -->
      <div id="profile-page" class="page">
          <!-- 個人資料內容由 JS 動態生成 -->
      </div>

      <!-- 登入/註冊頁 -->
      <div id="auth-page" class="page">
        <div class="auth-header"><button class="close-btn" onclick="goBack()">×</button></div>
        <div class="auth-content">
            <div id="login-container" class="auth-container">
                <h2>登入 FoodieApp</h2>
                <div class="auth-form"><input type="email" id="login-email" placeholder="電子郵件"><input type="password" id="login-password" placeholder="密碼"><button class="auth-btn" onclick="handleSignIn()">登入</button></div>
                <div class="auth-divider">或</div>
                <button class="auth-btn google-btn" onclick="handleGoogleSignIn()"><i class="fab fa-google"></i> 使用 Google 登入</button>
                <p class="toggle-auth" onclick="toggleAuthForms()">還沒有帳號？點此註冊</p>
            </div>
            <div id="register-container" class="auth-container" style="display: none;">
                <h2>註冊新帳號</h2>
                <div class="auth-form"><input type="email" id="register-email" placeholder="電子郵件"><input type="password" id="register-password" placeholder="密碼 (至少6位數)"><button class="auth-btn" onclick="handleRegister()">註冊</button></div>
                <p class="toggle-auth" onclick="toggleAuthForms()">已經有帳號了？點此登入</p>
            </div>
        </div>
      </div>
    </main>
    <footer class="app-nav">
      <div class="nav-item active" onclick="showPage('map-page', this)"><i class="fas fa-map-marked-alt"></i><span>地圖</span></div>
      <div class="nav-item" onclick="showPage('challenges-page', this)"><i class="fas fa-trophy"></i><span>美食挑戰</span></div>
      <div class="nav-item" onclick="showPage('posts-page', this)"><i class="fas fa-plus-square"></i><span>發文</span></div>
      <div class="nav-item" onclick="showPage('profile-page', this)"><i class="fas fa-user"></i><span>個人資料</span></div>
    </footer>
  </div>

<script>
// --- 全域變數 ---
let currentUser = null; 
let map, userGpsPosition, userMarker, restaurantMarkers, debounceTimer, placesService, autocomplete, infoWindow, directionsService, directionsRenderer;
let selectedPlace = null;
let currentPlaces = []; 
let isMapReady = false; 
const POSTS_DB_KEY = 'foodieAppPosts'; 
const CHALLENGES_DB_KEY = 'foodieAppUserChallenges';
let pageHistory = ['map-page']; 
let accountingCurrentDate = new Date();

// --- 地圖相關功能 (全域) ---
function initMap() {
    isMapReady = true;
    userGpsPosition = { lat: 25.0479, lng: 121.5171 };
    map = new google.maps.Map(document.getElementById("map"), { center: userGpsPosition, zoom: 15, disableDefaultUI: true, zoomControl: true });
    // ... 其他地圖相關服務初始化 ...
};
// ... 此處應包含所有地圖相關的輔助函式 ...
function centerOnUserGPS() { if(map && userGpsPosition) map.setCenter(userGpsPosition); }
function clearSearch() { document.getElementById('search-input').value = ''; }

// --- App 主邏輯 ---
document.addEventListener('DOMContentLoaded', () => {
    // --- Firebase 初始化 ---
    const firebaseConfig = { apiKey: "AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs", authDomain: "foodiedata-b4982.firebaseapp.com", projectId: "foodiedata-b4982", storageBucket: "foodiedata-b4982.firebasestorage.app", messagingSenderId: "90315404352", appId: "1:90315404352:web:e12b4fc3f5a87a11191ba5", measurementId: "G-5FD72CVKGB" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    
    // --- 頁面導航 & 狀態管理 ---
    window.showPage = function(pageId, navElement = null) {
        if (pageHistory.length > 0 && pageHistory[pageHistory.length - 1] !== pageId) {
            pageHistory.push(pageId);
        } else if (pageHistory.length === 0) {
            pageHistory.push(pageId);
        }
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        if (navElement) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            navElement.classList.add('active');
        }
        if (pageId === 'profile-page') renderProfilePage();
        else if (pageId === 'challenges-page') renderChallengesPage();
    };
    
    window.goBack = function() {
        if (pageHistory.length > 1) {
            pageHistory.pop();
            const prevPageId = pageHistory[pageHistory.length - 1];
            const navItem = document.querySelector(`.nav-item[onclick*="'${prevPageId}'"]`);
            showPage(prevPageId, navItem);
        } else {
            showPage('map-page', document.querySelector('.nav-item'));
        }
    };
    
    window.showAuthPage = function() { showPage('auth-page'); };
    window.toggleAuthForms = function() {
        const loginContainer = document.getElementById('login-container');
        const registerContainer = document.getElementById('register-container');
        loginContainer.style.display = loginContainer.style.display === 'none' ? 'block' : 'none';
        registerContainer.style.display = registerContainer.style.display === 'none' ? 'block' : 'none';
    };
    
    // --- Firebase Auth & UI 更新 ---
    window.handleRegister = function() {
        auth.createUserWithEmailAndPassword(document.getElementById('register-email').value, document.getElementById('register-password').value)
            .then(() => alert('註冊成功！'))
            .catch(error => alert(`註冊失敗：${error.message}`));
    };
    window.handleSignIn = function() {
        auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value)
            .then(() => alert('登入成功！'))
            .catch(error => alert(`登入失敗：${error.message}`));
    };
    window.handleGoogleSignIn = function() {
        auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
            .then(() => alert('Google 登入成功！'))
            .catch(error => alert(`Google 登入失敗：${error.message}`));
    };
    window.handleSignOut = function() {
        if (confirm('確定要登出嗎？')) auth.signOut().catch(error => alert(`登出時發生錯誤：${error.message}`));
    };
    
    function updateUserUI(user) {
        const headerActions = document.querySelectorAll('.header-action');
        headerActions.forEach(btn => {
            if (user) {
                if (btn.closest('#profile-page .page-header')) {
                    btn.textContent = '登出';
                    btn.onclick = handleSignOut;
                    btn.style.display = 'block';
                } else {
                    btn.style.display = 'none';
                }
            } else {
                if (btn.closest('#profile-page .page-header')) {
                    btn.style.display = 'none';
                } else {
                    btn.textContent = '登入/註冊';
                    btn.onclick = showAuthPage;
                    btn.style.display = 'block';
                }
            }
        });
        renderProfilePage();
        renderChallengesPage();
    }

    // --- 本地儲存 ---
    function getPosts() { if (!currentUser) return []; const key = `${POSTS_DB_KEY}_${currentUser.uid}`; return JSON.parse(localStorage.getItem(key)) || []; }
    function savePosts(posts) { if (!currentUser) return; const key = `${POSTS_DB_KEY}_${currentUser.uid}`; localStorage.setItem(key, JSON.stringify(posts)); }
    function getChallenges() { if (!currentUser) return []; const key = `${CHALLENGES_DB_KEY}_${currentUser.uid}`; return JSON.parse(localStorage.getItem(key)) || []; }
    function saveChallenges(challenges) { if (!currentUser) return; const key = `${CHALLENGES_DB_KEY}_${currentUser.uid}`; localStorage.setItem(key, JSON.stringify(challenges)); }
    
    // --- 美食挑戰頁 ---
    window.renderChallengesPage = function() {
        const container = document.getElementById('challenges-content');
        if (!currentUser) {
            container.innerHTML = `<div class="challenge-login-prompt"><p class="placeholder-text">登入後即可設定您的專屬美食挑戰！</p><button class="btn btn-primary" onclick="showAuthPage()">前往登入</button></div>`;
            return;
        }
        const challenges = getChallenges();
        let challengesHtml = (challenges.length > 0) ? challenges.map(c => `
            <div class="challenge-card" id="${c.id}">
                <div class="challenge-header">
                    <span class="challenge-title">${c.title}</span>
                    <div class="challenge-actions"><button onclick="editChallenge('${c.id}')"><i class="fas fa-pencil-alt"></i></button></div>
                </div>
                <div class="progress-bar-container"><div class="progress-bar" style="width: ${c.progress || 0}%;"></div></div>
            </div>`).join('') : '<p class="placeholder-text">還沒有任何挑戰，快新增一個吧！</p>';
        container.innerHTML = `${challengesHtml}<button class="btn btn-primary btn-full-width btn-fixed-bottom" onclick="addChallenge()"><i class="fas fa-plus"></i> 新增挑戰</button>`;
    }
    window.addChallenge = function() {
        const title = prompt("請輸入新的挑戰標題：");
        if (title && title.trim()) {
            const challenges = getChallenges();
            challenges.push({ id: `challenge_${Date.now()}`, title: title.trim(), progress: 0 });
            saveChallenges(challenges);
            renderChallengesPage();
        }
    };
    window.editChallenge = function(challengeId) {
        const titleElement = document.querySelector(`#${challengeId} .challenge-title`);
        const actionsElement = document.querySelector(`#${challengeId} .challenge-actions`);
        const currentTitle = titleElement.textContent;
        titleElement.innerHTML = `<input type="text" class="challenge-title-input" value="${currentTitle}" autofocus>`;
        actionsElement.innerHTML = `<button class="save-btn" onclick="saveChallengeTitle('${challengeId}')"><i class="fas fa-check"></i></button><button class="delete-btn" onclick="deleteChallenge('${challengeId}')"><i class="fas fa-trash-alt"></i></button>`;
        titleElement.querySelector('input').select();
    };
    window.saveChallengeTitle = function(challengeId) {
        const newTitle = document.querySelector(`#${challengeId} .challenge-title-input`).value.trim();
        if (newTitle) {
            let challenges = getChallenges().map(c => c.id === challengeId ? { ...c, title: newTitle } : c);
            saveChallenges(challenges);
        }
        renderChallengesPage();
    };
    window.deleteChallenge = function(challengeId) {
        if (confirm("確定要刪除這個挑戰嗎？")) {
            saveChallenges(getChallenges().filter(c => c.id !== challengeId));
            renderChallengesPage();
        }
    };

    // --- 個人資料 & 記帳頁 ---
    window.renderProfilePage = function() {
        const container = document.getElementById('profile-page');
        if (currentUser) {
            container.innerHTML = `
                <div class="page-header"><div class="header-action-placeholder"></div><h2><i class="fas fa-user-circle"></i>個人資料</h2><a href="#" class="header-action">登出</a></div>
                <div class="profile-tabs"><div class="tab-item active" onclick="showProfileTab('accounting-content', this)">記帳</div><div class="tab-item" onclick="showProfileTab('myposts-content', this)">我的貼文</div><div class="tab-item" onclick="showProfileTab('favorites-content', this)">收藏餐廳</div></div>
                <div class="page-content"><div id="accounting-content" class="profile-tab-content active"></div><div id="myposts-content" class="profile-tab-content"></div><div id="favorites-content" class="profile-tab-content"></div></div>`;
            document.querySelector('#profile-page .header-action').onclick = handleSignOut;
            showProfileTab('accounting-content', document.querySelector('#profile-page .tab-item'));
        } else {
            container.innerHTML = `<div class="page-header"><h2><i class="fas fa-user-circle"></i>個人資料</h2></div><div class="page-content"><div class="profile-login-prompt"><i class="fas fa-sign-in-alt"></i><h3>登入您的 FoodieApp 帳號</h3><p>登入後即可開始記錄您的美食花費、收藏喜愛的餐廳，並查看好友的評論！</p><button class="login-prompt-btn" onclick="showAuthPage()">登入 / 註冊</button></div></div>`;
        }
    }
    window.showProfileTab = function(tabId, tabElement) {
        if (!currentUser) return;
        document.querySelectorAll('.profile-tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.profile-tabs .tab-item').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        tabElement.classList.add('active');
        if(tabId === 'accounting-content') renderAccountingRecords();
    };
    window.renderAccountingRecords = function() {
        if (!currentUser) return;
        renderDailyAccountingView(accountingCurrentDate);
    }
    function renderDailyAccountingView(date) {
        const container = document.getElementById('accounting-content'); if (!container) return;
        const posts = getPosts();
        const startOfDay = new Date(date); startOfDay.setHours(0, 0, 0, 0);
        const endOfDay = new Date(date); endOfDay.setHours(23, 59, 59, 999);
        const todaysPosts = posts.filter(p => new Date(p.timestamp) >= startOfDay && new Date(p.timestamp) <= endOfDay && p.cost > 0);
        const dailyTotal = todaysPosts.reduce((sum, p) => sum + Number(p.cost), 0);
        const mealTypes = [ { type: 'breakfast', name: '早餐', icon: 'fa-mug-saucer' }, { type: 'lunch', name: '午餐', icon: 'fa-utensils' }, { type: 'snack', name: '點心', icon: 'fa-cookie-bite' }, { type: 'dinner', name: '晚餐', icon: 'fa-drumstick-bite' }, { type: 'supper', name: '宵夜', icon: 'fa-pizza-slice' } ];
        let mealItemsHtml = mealTypes.map(meal => {
            const post = todaysPosts.find(p => p.mealType === meal.type);
            let entryHtml = post ? `<div class="expense-display"><span class="cost">$${post.cost.toLocaleString()}</span><button class="delete-expense-btn" onclick="deleteExpense('${post.id}')"><i class="fas fa-trash-alt"></i></button></div>` : `<button class="add-expense-btn" onclick="showExpenseInput(this, '${meal.type}')"><i class="fas fa-plus"></i></button>`;
            return `<div class="meal-item"><div class="meal-info"><i class="fas ${meal.icon} meal-icon"></i><span class="meal-name">${meal.name}</span></div><div class="meal-entry">${entryHtml}</div></div>`;
        }).join('');
        container.innerHTML = `<div class="accounting-header"><button class="date-nav-btn" onclick="changeDate(-1)"><i class="fas fa-chevron-left"></i></button><h3>${date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}</h3><button class="date-nav-btn" onclick="changeDate(1)"><i class="fas fa-chevron-right"></i></button></div><div class="daily-accounting-list"><div class="daily-total-card"><div class="total-title">本日餐飲支出</div><div class="total-amount">$${dailyTotal.toLocaleString()}</div></div>${mealItemsHtml}</div>`;
    }
    window.showExpenseInput = function(button, mealType) {
        button.parentElement.innerHTML = `<form class="expense-input-form" onsubmit="event.preventDefault(); addExpense(this, '${mealType}')"><input type="number" class="cost-input" placeholder="金額" required min="1" step="any" autofocus><button type="submit" class="confirm-expense-btn"><i class="fas fa-check"></i></button></form>`;
    };
    window.addExpense = function(form, mealType) {
        const cost = Number(form.querySelector('.cost-input').value);
        if (isNaN(cost) || cost <= 0) { alert('請輸入有效的正數金額。'); return; }
        const posts = getPosts();
        posts.unshift({ id: `post_${Date.now()}`, name: `${mealType}消費`, cost, mealType, timestamp: accountingCurrentDate.getTime() });
        savePosts(posts);
        renderDailyAccountingView(accountingCurrentDate);
    };
    window.deleteExpense = function(postId) {
        savePosts(getPosts().filter(p => p.id !== postId));
        renderDailyAccountingView(accountingCurrentDate);
    };
    window.changeDate = function(direction) {
        accountingCurrentDate.setDate(accountingCurrentDate.getDate() + direction);
        renderDailyAccountingView(accountingCurrentDate);
    };

    // --- App 初始化 & Auth 狀態監聽 ---
    auth.onAuthStateChanged(user => { 
        currentUser = user; 
        updateUserUI(user);
        if (document.getElementById('auth-page').classList.contains('active')) goBack();
    });
    showPage('map-page', document.querySelector('.nav-item')); 
    updateUserUI(auth.currentUser); 
});
</script>
</body>
</html>
