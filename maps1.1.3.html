<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>FoodieApp</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  <!-- External libraries are loaded first in the head -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <style>
    :root { 
      --primary-color: #667eea; 
      --secondary-color: #764ba2; 
      --success-color: #28a745; 
      --danger-color: #dc3545; 
      --background-color: #f8f9fa; 
      --text-color: #333; 
      --text-light: #6c757d; 
      --nav-height: 60px;
      --vh: 1vh; 
    }
    html {
        height: 100%;
    }
    body { 
        height: 100%; 
        margin: 0; 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        background-color: #e9ebee;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }
    .app-container { 
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background-color: var(--background-color);
      position: relative;
      overflow: hidden;
      box-sizing: border-box;
    }
    main { 
      flex: 1;
      overflow: hidden; 
      position: relative;
      display: flex;
    }
    .page { 
      width: 100%; height: 100%; 
      display: none; 
      flex-direction: column; 
      overflow: hidden; 
    }
    .page.active { 
      display: flex; 
    }
    .app-nav { height: var(--nav-height); width: 100%; background: #fff; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-light); font-size: 12px; cursor: pointer; transition: color 0.2s; width: 100%; }
    .nav-item i { font-size: 22px; margin-bottom: 4px; }
    .nav-item.active { color: var(--primary-color); }
    #map-page { 
      flex-direction: column; 
    }
    #map-panel { 
      flex: 6.5;
      position: relative; 
      background: #e5e3df; 
      width: 100%; 
    }
    #list-panel { 
      flex: 3.5;
      border-top: 1px solid #ddd; 
      display: flex; 
      flex-direction: column; 
      background: white; 
      overflow: hidden; 
      width: 100%; 
    }
    #map { width: 100%; height: 100%; }
    .search-area { padding: 15px; border-bottom: 1px solid #eee; background: white; flex-shrink: 0; position: relative; }
    .search-input { width: 100%; padding: 12px 40px 12px 15px; font-size: 16px; border-radius: 25px; border: 1px solid #ccc; box-sizing: border-box; }
    .clear-search-btn { position: absolute; top: 50%; right: 25px; transform: translateY(-50%); background: #ccc; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 14px; font-weight: bold; color: white; display: none; justify-content: center; align-items: center; }
    
    .filter-tags-container {
      display: flex;
      justify-content: flex-start;
      gap: 8px;
      padding: 0 15px 15px 15px;
      background: white;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch; 
    }
    
    .filter-tags-container::-webkit-scrollbar { height: 8px; }
    .filter-tags-container::-webkit-scrollbar-track { background: #f1f1f1; }
    .filter-tags-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    .filter-tags-container::-webkit-scrollbar-thumb:hover { background: #aaa; }

    .filter-tag { display: inline-flex; align-items: center; justify-content: center; padding: 6px 14px; border: 1px solid #ccc; border-radius: 20px; background-color: #f0f0f0; color: var(--text-color); font-size: 14px; font-weight: 500; cursor: pointer; white-space: nowrap; transition: all 0.2s ease-in-out; }
    .filter-tag:not([data-filter-value="distance"]):hover { filter: brightness(0.95); }
    .filter-tag.active { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    
    .filter-tag[data-filter-value="台式"]     { background-color: #e3f2fd; border-color: #bbdefb; color: #1565c0; }
    .filter-tag[data-filter-value="日式"]     { background-color: #ffebee; border-color: #ffcdd2; color: #c62828; }
    .filter-tag[data-filter-value="居酒屋"]   { background-color: #f3e5f5; border-color: #e1bee7; color: #6a1b9a; }
    .filter-tag[data-filter-value="酒吧"]     { background-color: #ede7f6; border-color: #d1c4e9; color: #4527a0; }
    .filter-tag[data-filter-value="熱炒"]     { background-color: #fff8e1; border-color: #ffecb3; color: #ffa000; }
    .filter-tag[data-filter-value="火鍋"]     { background-color: #fff3e0; border-color: #ffe0b2; color: #ef6c00; }
    .filter-tag[data-filter-value="美式"]     { background-color: #e1f5fe; border-color: #b3e5fc; color: #0277bd; }
    .filter-tag[data-filter-value="中式"]     { background-color: #fbe9e7; border-color: #ffccbc; color: #d84315; }
    .filter-tag[data-filter-value="義式"]     { background-color: #e8f5e9; border-color: #c8e6c9; color: #2e7d32; }
    .filter-tag[data-filter-value="泰式"]     { background-color: #e0f2f1; border-color: #b2dfdb; color: #00695c; }
    .filter-tag[data-filter-value="越式"]     { background-color: #f1f8e9; border-color: #dcedc8; color: #558b2f; }
    .filter-tag[data-filter-value="咖啡廳"]   { background-color: #efebe9; border-color: #d7ccc8; color: #5d4037; }
    .filter-tag[data-filter-value="早午餐"]   { background-color: #fffde7; border-color: #fff9c4; color: #f57f17; }
    .filter-tag[data-filter-value="手搖飲"]   { background-color: #e0f7fa; border-color: #b2ebf2; color: #00838f; }
    .filter-tag[data-filter-value="小吃"]     { background-color: #eceff1; border-color: #cfd8dc; color: #37474f; }

    .filter-tag[data-filter-value="台式"].active     { background-color: #42a5f5; border-color: #42a5f5; color: white; }
    .filter-tag[data-filter-value="日式"].active     { background-color: #e57373; border-color: #e57373; color: white; }
    .filter-tag[data-filter-value="居酒屋"].active   { background-color: #ab47bc; border-color: #ab47bc; color: white; }
    .filter-tag[data-filter-value="酒吧"].active     { background-color: #7e57c2; border-color: #7e57c2; color: white; }
    .filter-tag[data-filter-value="熱炒"].active     { background-color: #ffca28; border-color: #ffca28; color: #333; }
    .filter-tag[data-filter-value="火鍋"].active     { background-color: #ff9800; border-color: #fb8c00; color: white; }
    .filter-tag[data-filter-value="美式"].active     { background-color: #29b6f6; border-color: #29b6f6; color: white; }
    .filter-tag[data-filter-value="中式"].active     { background-color: #ff7043; border-color: #ff7043; color: white; }
    .filter-tag[data-filter-value="義式"].active     { background-color: #66bb6a; border-color: #66bb6a; color: white; }
    .filter-tag[data-filter-value="泰式"].active     { background-color: #26a69a; border-color: #26a69a; color: white; }
    .filter-tag[data-filter-value="越式"].active     { background-color: #9ccc65; border-color: #9ccc65; color: #333; }
    .filter-tag[data-filter-value="咖啡廳"].active   { background-color: #795548; border-color: #6d4c41; color: white; }
    .filter-tag[data-filter-value="早午餐"].active   { background-color: #ffee58; border-color: #fdd835; color: #333; }
    .filter-tag[data-filter-value="手搖飲"].active   { background-color: #26c6da; border-color: #26c6da; color: white; }
    .filter-tag[data-filter-value="小吃"].active     { background-color: #78909c; border-color: #78909c; color: white; }

    .list-content { overflow-y: auto; flex-grow: 1; }
    .list-item { display: flex; align-items: flex-start; gap: 15px; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background-color 0.2s; }
    .list-item.is-selected { background-color: #e8eaf6; border-left: 4px solid var(--primary-color); padding-left: 11px; }
    .item-icon { font-size: 18px; color: var(--primary-color); margin-top: 3px; flex-shrink: 0; }
    .item-info { flex-grow: 1; min-width: 0; }
    .item-name { font-weight: 600; font-size: 16px; }
    .item-details, .item-address { font-size: 13px; color: var(--text-light); margin-top: 4px; }
    .item-address { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-distance { font-weight: 500; font-size: 14px; color: var(--text-color); white-space: nowrap; text-align: right; }
    .open-status.open { color: #28a745; }
    .open-status.closed { color: #dc3545; }
    .list-status-text { text-align: center; color: #999; padding: 40px 20px; }
    .location-btn { position: absolute; bottom: 20px; right: 20px; background: #fff; color: var(--primary-color); border: none; width: 50px; height: 50px; border-radius: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); cursor: pointer; z-index: 10; font-size: 24px; display: flex; justify-content: center; align-items: center; }
    
    .gm-style-iw.gm-style-iw-c { padding: 0 !important; max-width: 320px !important; }
    .gm-style-iw-d { overflow: hidden !important; }

    .place-info-window { font-family: inherit; color: var(--text-color); }
    .place-info-window h3 { font-size: 20px; font-weight: 600; margin: 0 0 8px 0; padding: 12px 15px 0 15px; }
    .place-info-window .place-detail-row { display: flex; align-items: flex-start; gap: 12px; font-size: 14px; padding: 8px 15px; line-height: 1.5; }
    .place-info-window .place-detail-row i.detail-icon { color: var(--text-light); font-size: 18px; margin-top: 2px; width: 20px; text-align: center; }
    .place-info-window .hours-header { cursor: pointer; }
    .place-info-window .hours-header.current-day-bold { font-weight: bold; }
    .place-info-window .hours-detail { display: none; padding: 0 15px 10px 47px; }
    .place-info-window .day-hours { display: flex; justify-content: space-between; font-size: 14px; padding: 4px 0; }
    .place-info-window .day-hours.current-day { font-weight: bold; color: #1a73e8; }
    .place-info-window .day-hours span:first-child { flex-shrink: 0; margin-right: 10px; }
    .place-info-window .day-hours span:last-child { text-align: right; }
    .info-window-status { padding: 15px; text-align: center; color: var(--text-light); }
    .place-info-actions { border-top: 1px solid #eee; padding: 10px 15px; text-align: right; }
    .btn-navigate { background-color: #4285F4; color: white; padding: 8px 15px; border-radius: 20px; border: none; font-size: 14px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
    .btn-navigate:hover { background-color: #3367D6; }
    .btn-navigate i { margin-right: 8px; }

    #directions-panel { display: none; position: absolute; top: 10px; left: 10px; right: 10px; background: white; z-index: 20; padding: 10px 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); flex-direction: column; gap: 8px; max-width: 350px; }
    .directions-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    .travel-modes { display: flex; gap: 5px; }
    .travel-mode-btn { background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; padding: 6px 10px; cursor: pointer; transition: all 0.2s; }
    .travel-mode-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    .directions-close-btn { background: none; border: none; font-size: 20px; color: #999; cursor: pointer; padding: 0 5px; }
    .directions-info { font-size: 14px; font-weight: 500; }
    .directions-info span { margin-right: 15px; }
    .directions-info i { margin-right: 5px; color: var(--text-light); }
    
    .page-header { padding: 15px 20px; background-color: #fff; border-bottom: 1px solid #eee; text-align: center; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
    .page-header h2 { margin: 0; font-size: 18px; color: var(--text-color); display: flex; align-items: center; justify-content: center; flex-grow: 1; }
    .page-header h2 i { margin-right: 10px; color: var(--primary-color); }
    .header-action { font-size: 16px; color: var(--primary-color); text-decoration: none; cursor: pointer; }
    .header-back-btn { font-size: 20px; color: var(--text-color); cursor: pointer; }
    .page-header .placeholder { width: 24px; }
    .page-content { flex-grow: 1; overflow-y: auto; padding: 20px; box-sizing: border-box; }
    .placeholder-text { text-align: center; color: var(--text-light); margin-top: 50px; padding: 20px; }
    .btn { display: block; width: 100%; padding: 15px; background-color: var(--success-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; }
    #random-picker-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; box-sizing: border-box; }
    
    #picker-wheel { width: 280px; height: 280px; border: 10px solid #ddd; border-radius: 50%; position: relative; margin-bottom: 30px; transition: transform 4s cubic-bezier(0.25, 1, 0.5, 1); overflow: hidden; }
    .slice-text { position: absolute; top: 50%; left: 50%; width: 90px; height: 60px; margin-left: -45px; margin-top: -30px; display: flex; align-items: center; justify-content: center; transform-origin: center center; color: white; font-weight: 600; font-size: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); text-align: center; pointer-events: none; }
    #picker-arrow { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid var(--danger-color); position: absolute; top: -35px; left: 50%; transform: translateX(-50%); z-index: 10; }
    #picker-result { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; background-color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: bold; color: var(--primary-color); text-align: center; z-index: 5; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
    #random-status-text { min-height: 40px; font-size: 16px; font-weight: 500; color: var(--text-color); white-space: pre-wrap; line-height: 1.6; }
    #random-status-text.placeholder-text { font-size: 14px; font-weight: normal; color: var(--text-light); }

    .form-group { margin-bottom: 20px; position: relative; } .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color); } .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; } .form-group select { background-color: white; -webkit-appearance: none; } .form-group textarea { min-height: 120px; resize: vertical; } .rating-hearts { display: flex; gap: 10px; font-size: 30px; color: #ddd; cursor: pointer; } .rating-hearts .fa-heart:hover, .rating-hearts .fa-heart.active { color: #ff4d6d; } 
    .photo-upload-container { background: #f0f0f0; border: 2px dashed #ccc; border-radius: 8px; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
    .photo-upload-buttons { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
    .btn-upload { background: #fff; color: var(--text-color); padding: 10px 20px; border-radius: 8px; cursor: pointer; border: 1px solid #ddd; display: inline-flex; align-items: center; }
    .btn-upload i { margin-right: 8px; }
    #photo-preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; justify-content: center; }
    .photo-preview-item { position: relative; width: 80px; height: 80px; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }
    .photo-preview-item img { width: 100%; height: 100%; object-fit: cover; }
    .delete-photo-btn { position: absolute; top: 3px; right: 3px; width: 20px; height: 20px; background-color: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: bold; line-height: 20px; }
    .profile-tabs { display: flex; gap: 10px; padding: 15px 20px; background: #fff; border-bottom: 1px solid #eee; overflow-x: auto; flex-shrink: 0; } .tab-btn { background: #f0f0f0; border: none; border-radius: 20px; padding: 8px 15px; font-size: 14px; cursor: pointer; white-space: nowrap; } .tab-btn.active { background: var(--primary-color); color: #fff; } .tab-content { display: none; } .tab-content.active { display: block; }
    .record-card, .post-card { position: relative; background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); } .record-card .title, .post-card .title { font-weight: 600; margin-bottom: 5px; } .record-card .details, .post-card .details { font-size: 14px; color: var(--text-light); } .record-card .cost { font-weight: bold; color: var(--success-color); float: right; } .post-card .content { margin-top: 10px; font-size: 15px; line-height: 1.6; } .post-card .post-rating { margin-top: 10px; color: #ff4d6d; }
    .post-photos { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .post-photos img { width: 70px; height: 70px; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }
    .card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; }
    .action-btn { background: none; border: 1px solid #ccc; border-radius: 5px; padding: 3px 8px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
    .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .action-btn.btn-edit { color: var(--primary-color); border-color: var(--primary-color); }
    .action-btn.btn-edit:hover:not(:disabled) { background: var(--primary-color); color: white; }
    .action-btn.btn-delete { color: var(--danger-color); border-color: var(--danger-color); }
    .action-btn.btn-delete:hover:not(:disabled) { background: var(--danger-color); color: white; }
    .auth-form-container { width: 100%; max-width: 400px; margin: 0 auto; padding: 20px;}
    .auth-form-container h3 { text-align: center; margin-bottom: 20px; font-size: 20px; }
    .auth-form-container input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; font-size: 16px; }
    .btn-auth { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; margin-bottom: 10px; color: #fff; font-weight: bold; }
    .btn-auth.primary { background-color: var(--primary-color); }
    .btn-auth.secondary { background-color: #fff; color: #4285F4; border: 1px solid #ddd; display:flex; align-items:center; justify-content:center; gap: 10px;}
    .auth-separator { display: flex; align-items: center; text-align: center; color: #aaa; margin: 20px 0; }
    .auth-separator::before, .auth-separator::after { content: ''; flex: 1; border-bottom: 1px solid #ddd; }
    .auth-separator:not(:empty)::before { margin-right: .25em; }
    .auth-separator:not(:empty)::after { margin-left: .25em; }
    .auth-switch-link { text-align: center; margin-top: 15px; font-size: 14px; color: var(--primary-color); cursor: pointer; }
    #auth-error { color: #dc3545; margin-top: 15px; min-height: 20px; font-weight: 500; text-align: center; }
    .btn-scan-qr { position: absolute; top: 0; right: 0; background: var(--primary-color); color: white; border: none; border-radius: 0 8px 0 8px; padding: 5px 10px; font-size: 13px; cursor: pointer; }
    .btn-scan-qr i { margin-right: 5px; }
    #qr-scanner-modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); flex-direction: column; justify-content: center; align-items: center; }
    .qr-scanner-content { position: relative; background-color: #111; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 10px; text-align: center; }
    #qr-scanner-video { width: 100%; border-radius: 8px; }
    #qr-status-text { color: white; font-size: 16px; margin-top: 15px; height: 40px; line-height: 1.4; }
    .qr-scanner-close-btn { position: absolute; top: -15px; right: -15px; color: white; background-color: #dc3545; border-radius: 50%; width: 30px; height: 30px; font-size: 20px; font-weight: bold; cursor: pointer; border: 2px solid white; display:flex; justify-content:center; align-items:center; }
    #scan-box { position: absolute; left: 50%; top: 50%; width: 60%; height: 50%; transform: translate(-50%, -50%); border: 3px solid rgba(255, 255, 255, 0.7); border-radius: 10px; box-shadow: 0 0 0 2000px rgba(0,0,0,0.5); }
    
    .challenge-item { display: flex; align-items: center; justify-content: space-between; background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: background-color 0.2s; }
    .challenge-text { font-size: 16px; flex-grow: 1; margin-right: 15px; }
    .challenge-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .accounting-date-group { margin-bottom: 20px; }
    .accounting-date-header { font-size: 16px; font-weight: 600; padding-bottom: 8px; border-bottom: 1px solid #eee; margin-bottom: 10px; }
    .accounting-meal-header { font-size: 14px; font-weight: 500; color: var(--text-light); margin: 15px 0 5px 0; }
    
    @media (min-width: 1200px) {
      .app-container { width: 100%; max-width: 1280px; height: 90vh; max-height: 800px; border-radius: 12px; border: 1px solid #ccc; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
      #map-page { flex-direction: row; }
      #map-panel { width: 60%; height: 100%; flex: 6; }
      #list-panel { width: 40%; height: 100%; flex: 4; border-top: none; border-left: 1px solid #ddd; }
      #add-review-page .page-content, #challenge-page .page-content, #profile-page .page-content, #login-page .page-content, #register-page .page-content { max-width: 700px; width: 100%; margin: 0 auto; }
      #directions-panel { right: auto; left: 10px; top: 10px; }
    }
    
    .fa-spin { animation: fa-spin 2s infinite linear; }
    @keyframes fa-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="app-container">
    <main>
      <div id="map-page" class="page active">
        <div id="map-panel">
          <div id="map"></div>
          <div id="directions-panel" style="display: none;">
            <div class="directions-header">
                <div class="travel-modes">
                    <button id="driving-mode-btn" class="travel-mode-btn" onclick="calculateAndShowRoute(currentRouteDestination, 'DRIVING')"><i class="fa-solid fa-car"></i></button>
                    <button id="walking-mode-btn" class="travel-mode-btn" onclick="calculateAndShowRoute(currentRouteDestination, 'WALKING')"><i class="fa-solid fa-person-walking"></i></button>
                </div>
                <button class="directions-close-btn" onclick="clearRoute()">×</button>
            </div>
            <div class="directions-info" id="directions-info-content"></div>
          </div>
          <button class="location-btn" onclick="centerOnUserGPS()"><i class="fas fa-location-arrow"></i></button>
        </div>
        <div id="list-panel">
          <div class="search-area">
            <input type="text" id="search-input" class="search-input" placeholder="搜尋餐廳或地點...">
            <button class="clear-search-btn" id="clear-search" onclick="clearSearch()">×</button>
          </div>
          <div class="filter-tags-container">
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="早午餐" onclick="applyFilter(this)">早午餐</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="台式" onclick="applyFilter(this)">台式</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="日式" onclick="applyFilter(this)">日式</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="熱炒" onclick="applyFilter(this)">熱炒</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="火鍋" onclick="applyFilter(this)">火鍋</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="美式" onclick="applyFilter(this)">美式</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="中式" onclick="applyFilter(this)">中式</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="義式" onclick="applyFilter(this)">義式</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="泰式" onclick="applyFilter(this)">泰式</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="越式" onclick="applyFilter(this)">越式</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="咖啡廳" onclick="applyFilter(this)">咖啡廳</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="手搖飲" onclick="applyFilter(this)">手搖飲</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="小吃" onclick="applyFilter(this)">小吃</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="居酒屋" onclick="applyFilter(this)">居酒屋</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="酒吧" onclick="applyFilter(this)">酒吧</button>
          </div>
          <div class="list-content" id="list-content-area"><p class="list-status-text">正在初始化地圖...</p></div>
        </div>
      </div>
      <div id="random-page" class="page">
        <div class="page-header"><h2><i class="fa-solid fa-dice"></i>美食隨機選</h2><div class="placeholder"></div></div>
        <div id="random-picker-container">
            <div id="picker-arrow"></div>
            <div id="picker-wheel">
                <div id="picker-result">?</div>
            </div>
            <button class="btn" id="random-pick-btn" onclick="startRandomPick()">從我的最愛抽籤！</button>
            <p id="random-status-text" class="placeholder-text" style="background: none; margin-top: 20px;"></p>
        </div>
      </div>
      <div id="add-review-page" class="page">
        <div class="page-header"><h2 id="add-review-header"><i class="fa-solid fa-pencil"></i>新增美食評論</h2><div class="placeholder"></div></div>
        <div class="page-content">
            <div class="form-group"><label for="review-restaurant-name">餐廳名稱</label><input type="text" id="review-restaurant-name" placeholder="輸入吃過的餐廳"></div>
            <div class="form-group">
                <label for="review-meal-items">餐點項目</label>
                <button class="btn-scan-qr" onclick="openQrScanner()"><i class="fa-solid fa-qrcode"></i>掃描發票</button>
                <textarea id="review-meal-items" placeholder="吃了什麼好料？ (例如：小籠包、牛肉麵)
或點擊右上角掃描發票自動帶入"></textarea>
            </div>
            <div class="form-group"><label for="review-cost">花費金額 (NT$)</label><input type="number" id="review-cost" placeholder="大約花了多少錢？"></div>
             <div class="form-group">
                <label for="review-meal-type">用餐類型</label>
                <select id="review-meal-type">
                    <option value="other">其他</option>
                    <option value="breakfast">早餐</option>
                    <option value="lunch">午餐</option>
                    <option value="dinner">晚餐</option>
                </select>
            </div>
            <div class="form-group"><label>喜愛程度</label><div class="rating-hearts" id="review-rating" data-rating="0"><i class="fa-solid fa-heart" data-value="1"></i><i class="fa-solid fa-heart" data-value="2"></i><i class="fa-solid fa-heart" data-value="3"></i><i class="fa-solid fa-heart" data-value="4"></i><i class="fa-solid fa-heart" data-value="5"></i></div></div>
            <div class="form-group"><label for="review-content">評論內容 (會成為貼文)</label><textarea id="review-content" placeholder="分享你的心得、推薦或建議..."></textarea></div>
            <div class="form-group">
                <label>新增照片</label>
                <div class="photo-upload-container">
                    <div class="photo-upload-buttons">
                        <div id="btn-select-from-album" class="btn-upload"><i class="fa-solid fa-images"></i>從相簿選擇</div>
                        <div id="btn-open-camera" class="btn-upload"><i class="fa-solid fa-camera"></i>開啟相機</div>
                    </div>
                    <input type="file" id="photo-file-input" accept="image/*" multiple style="display: none;">
                    <input type="file" id="camera-file-input" accept="image/*" capture="environment" style="display: none;">
                    <div id="photo-preview-container"></div>
                </div>
            </div>
            <button class="btn" id="save-review-btn" onclick="saveReview()">儲存評論與貼文</button>
        </div>
      </div>
      <div id="challenge-page" class="page">
        <div class="page-header"><h2><i class="fa-solid fa-trophy"></i>美食挑戰榜</h2><div class="placeholder"></div></div>
        <div class="page-content" id="challenge-page-content">
            <div id="challenge-list-view">
                <div class="form-group" style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h4><i class="fa-solid fa-plus-circle" style="margin-right: 8px;"></i>建立新的挑戰</h4>
                    <input type="text" id="new-challenge-title" placeholder="挑戰主標題，例如：拉麵制霸戰" style="margin-bottom: 10px;">
                    <input type="text" id="new-challenge-subtitle" placeholder="次標題，例如：一個月內誰吃最多家！">
                    <button class="btn" style="margin-top: 10px;" onclick="createChallengeBoard()">建立挑戰榜</button>
                </div>
                <div id="challenge-boards-container" style="margin-top: 20px;"></div>
            </div>
            <div id="challenge-detail-view" style="display: none;"></div>
        </div>
      </div>
      <div id="profile-page" class="page">
        <div class="page-header">
          <div class="placeholder"></div>
          <h2 id="profile-header"><i class="fa-solid fa-user"></i>個人檔案</h2>
          <a id="profile-login-btn" class="header-action" style="display: none;" onclick="showPage('login-page')">登入/註冊</a>
          <a id="profile-logout-btn" class="header-action" style="display: none;" onclick="handleSignOut()">登出</a>
        </div>
        <div class="profile-tabs">
            <button class="tab-btn active" onclick="showProfileTab('accounting', this)">記帳顯示</button>
            <button class="tab-btn" onclick="showProfileTab('posts', this)">我的貼文</button>
            <button class="tab-btn" onclick="showProfileTab('favorites', this)">最愛餐廳</button>
            <button class="tab-btn" onclick="showProfileTab('friends', this)">好友名單</button>
        </div>
        <div class="page-content" style="padding-top:10px;">
            <div id="accounting-content" class="tab-content active"></div>
            <div id="posts-content" class="tab-content">
                <div class="sort-container" style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px; padding: 0;">
                    <label for="post-sort-order" style="font-size: 14px; color: var(--text-light); margin-right: 8px;">排序:</label>
                    <select id="post-sort-order" onchange="renderMyPosts()" style="border-radius: 15px; border: 1px solid #ddd; padding: 5px 10px; font-size: 14px; background-color: white;">
                        <option value="newest">由新到舊</option>
                        <option value="oldest">由舊到新</option>
                    </select>
                </div>
                <div id="posts-list-container"></div>
            </div>
            <div id="favorites-content" class="tab-content"></div>
            <div id="friends-content" class="tab-content">
                <div class="search-area" style="padding: 0 0 20px 0; border-bottom: none; background: transparent;">
                    <p style="font-size: 14px; color: var(--text-light); margin-bottom: 10px;">透過 ID 或 Email 搜尋好友：</p>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="friend-search-input" class="search-input" placeholder="輸入好友ID或Email..." style="border-radius: 8px; padding: 12px 15px; width: auto; flex-grow: 1;">
                        <button class="btn" style="padding: 0; width: 80px; height: 44px; flex-shrink: 0;" onclick="searchFriend()">搜尋</button>
                    </div>
                </div>
                <div id="friends-list-container"></div>
            </div>
        </div>
      </div>
      <div id="login-page" class="page">
        <div class="page-header">
          <i class="fa-solid fa-chevron-left header-back-btn" onclick="goBack()"></i>
          <h2>會員登入</h2>
          <div class="placeholder"></div>
        </div>
        <div class="page-content">
          <div class="auth-form-container">
            <input type="email" id="login-email-input" placeholder="電子郵件" required>
            <input type="password" id="login-password-input" placeholder="密碼" required>
            <div id="login-error" class="auth-error-message"></div>
            <button class="btn-auth primary" onclick="handleSignIn()">登入</button>
            <div class="auth-separator">或</div>
            <button class="btn-auth secondary" onclick="handleGoogleSignIn()">
              <i class="fab fa-google"></i> 使用 Google 登入
            </button>
            <div class="auth-switch-link" onclick="showPage('register-page')">
              還沒有帳號？點此註冊
            </div>
          </div>
        </div>
      </div>
      <div id="register-page" class="page">
         <div class="page-header">
          <i class="fa-solid fa-chevron-left header-back-btn" onclick="goBack()"></i>
          <h2>註冊新帳號</h2>
          <div class="placeholder"></div>
        </div>
        <div class="page-content">
          <div class="auth-form-container">
            <input type="text" id="register-name-input" placeholder="姓名或暱稱" required>
            <input type="email" id="register-email-input" placeholder="電子郵件" required>
            <input type="password" id="register-password-input" placeholder="設定密碼 (至少6位數)" required>
            <div id="register-error" class="auth-error-message"></div>
            <button class="btn-auth primary" onclick="handleRegister()">註冊送出</button>
            <div class="auth-switch-link" onclick="showPage('login-page')">
              已經有帳號了？點此登入
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="app-nav">
      <div class="nav-item active" onclick="showPage('map-page', this)"><i class="fa-solid fa-map-location-dot"></i><span>地圖</span></div>
      <div class="nav-item" onclick="showPage('random-page', this)"><i class="fa-solid fa-dice"></i><span>隨機選</span></div>
      <div class="nav-item" onclick="showPage('add-review-page', this)"><i class="fa-solid fa-plus-circle"></i><span>新增</span></div>
      <div class="nav-item" onclick="showPage('challenge-page', this)"><i class="fa-solid fa-trophy"></i><span>挑戰榜</span></div>
      <div class="nav-item" onclick="showPage('profile-page', this)"><i class="fa-solid fa-user"></i><span>個人</span></div>
    </footer>
  </div>

  <div id="qr-scanner-modal">
    <div class="qr-scanner-content">
        <span class="qr-scanner-close-btn" onclick="closeQrScanner()">×</span>
        <video id="qr-scanner-video" playsinline></video>
        <div id="scan-box"></div>
        <canvas id="qr-canvas" style="display: none;"></canvas>
        <p id="qr-status-text">請將發票 QR Code 對準掃描框</p>
    </div>
  </div>

  <script>
    // --- 全域變數定義 ---
    var currentUser = null, map, userGpsPosition, userMarker, debounceTimer, placesService, autocomplete, infoWindow;
    var isMapReady = false, editingPostId = null, viewingChallengeId = null, activeFilter = null, pageHistory = [], auth;
    var restaurantMarkers = [];
    var qrModal, video, canvasElement, canvas, qrStatusText, scanBox, stream, animationFrameId, selectedPlaceForReview;
    var activePlaceId = null; 
    
    var directionsService, drivingRenderer, walkingRenderer;
    var currentRouteDestination = null;
    var currentTravelMode = 'DRIVING';

    const POSTS_DB_KEY = 'foodieAppPosts', CHALLENGE_BOARDS_DB_KEY = 'foodieAppChallengeBoards', FAVORITES_DB_KEY = 'foodieAppFavorites', FRIENDS_DB_KEY = 'foodieAppFriends';
    
    const categoryKeywords = { '早午餐': { color: '#ffee58', keywords: ['brunch', 'breakfast', '早午餐'] }, '台式': { color: '#42a5f5', keywords: ['taiwanese', '台式', '熱炒店'] }, '日式': { color: '#e57373', keywords: ['japanese', 'sushi', 'ramen', '丼', '食堂', '拉麵', '壽司', '日式'] }, '熱炒': { color: '#ffca28', keywords: ['熱炒'] }, '火鍋': { color: '#ff9800', keywords: ['hot_pot', '火鍋', '鍋物', '涮涮鍋'] }, '美式': { color: '#29b6f6', keywords: ['american', 'hamburger', '美式', '漢堡'] }, '中式': { color: '#ff7043', keywords: ['chinese', '中式', '麵館', '餃'] }, '義式': { color: '#66bb6a', keywords: ['italian', 'pasta', 'pizza', '義式', '披薩'] }, '泰式': { color: '#26a69a', keywords: ['thai', '泰式'] }, '越式': { color: '#9ccc65', keywords: ['vietnamese', '越式', '越南'] }, '咖啡廳': { color: '#795548', keywords: ['cafe', 'coffee_shop', '咖啡'] }, '手搖飲': { color: '#26c6da', keywords: ['bubble_tea_shop', '手搖', '飲料'] }, '小吃': { color: '#78909c', keywords: ['snack', '小吃', '快餐', '麵線'] }, '居酒屋': { color: '#ab47bc', keywords: ['izakaya', '居酒屋'] }, '酒吧': { color: '#7e57c2', keywords: ['bar', 'pub', '酒館', '酒吧'] } };
    const miscColors = ['#4fc3f7', '#7986cb', '#ba68c8', '#aed581', '#ff8a65', '#90a4ae'];
    let miscColorIndex = 0;
    const defaultMarkerColor = '#EA4335';
    const mockUserDB = [ { id: 'friend01', name: '美食探險家', email: 'explorer@food.com' }, { id: 'friend02', name: '吃貨小夥伴', email: 'partner@food.com' }, { id: 'friend03', name: '深夜食堂常客', email: 'nightowl@food.com' }, { id: 'friend04', name: '甜點魔人', email: 'dessert@food.com' }, { id: 'admin01', name: 'Admin User', email: 'admin@mail.com' } ];
    
    const firebaseConfig = { apiKey: "AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs", authDomain: "foodiedata-b4982.firebaseapp.com", projectId: "foodiedata-b4982", storageBucket: "foodiedata-b4982.firebasestorage.app", messagingSenderId: "90315404352", appId: "1:90315404352:web:e12b4fc3f5a87a11191ba5", measurementId: "G-5FD72CVKGB" };
    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth(); 

    // --- Google Maps Core Functions (Legacy API Version) ---

    function initMap() {
        if (window.mapInitialized) return;
        
        isMapReady = true;
        userGpsPosition = { lat: 25.0479, lng: 121.5171 };
        const mapDiv = document.getElementById("map");
        if (!mapDiv) { console.error("Map element not found."); return; }
        
        map = new google.maps.Map(mapDiv, {
            center: userGpsPosition,
            zoom: 15,
            disableDefaultUI: true,
            zoomControl: true
        });

        placesService = new google.maps.places.PlacesService(map);
        infoWindow = new google.maps.InfoWindow({ content: '', disableAutoPan: true });

        infoWindow.addListener('closeclick', () => {
            activePlaceId = null;
        });
        
        directionsService = new google.maps.DirectionsService();
        drivingRenderer = new google.maps.DirectionsRenderer({
            map: map,
            polylineOptions: { strokeColor: '#4285F4', strokeWeight: 6, zIndex: 50 },
            suppressMarkers: true
        });
        walkingRenderer = new google.maps.DirectionsRenderer({
            map: map,
            polylineOptions: { strokeColor: '#34A853', strokeOpacity: 0.8, strokeWeight: 6, zIndex: 49 },
            suppressMarkers: true
        });

        map.addListener("idle", () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => searchNearbyRestaurants(map.getCenter()), 500);
        });

        setupAutocomplete();
        updateUserGPS(true);
        window.mapInitialized = true;
    }
    window.initMap = initMap;

    function setupAutocomplete() {
        const input = document.getElementById('search-input');
        autocomplete = new google.maps.places.Autocomplete(input, { types: ['establishment'] });
        autocomplete.bindTo('bounds', map);
        autocomplete.addListener('place_changed', () => {
            infoWindow.close();
            activePlaceId = null;
            clearRoute();
            const place = autocomplete.getPlace();
            if (!place.geometry) { searchNearbyRestaurants(null, place.name); return; }
            if (place.geometry.viewport) { map.fitBounds(place.geometry.viewport); } else { map.setCenter(place.geometry.location); map.setZoom(17); }
            displayPlaces([place], true);
        });
    }

    function searchNearbyRestaurants(location, query) {
        if (!isMapReady) return;
        const listContentArea = document.getElementById("list-content-area");
        listContentArea.innerHTML = `<p class="list-status-text"><i class="fas fa-spinner fa-spin"></i> 正在搜尋附近餐廳...</p>`;
        
        let request;
        const searchLocation = location || map.getCenter();

        if (query) { request = { location: searchLocation, radius: 5000, keyword: query }; } 
        else if (activeFilter && activeFilter.type === 'keyword') { request = { location: searchLocation, radius: 2000, keyword: activeFilter.value }; } 
        else { request = { location: searchLocation, radius: 1000, types: ['restaurant', 'cafe', 'food'] }; }

        placesService.nearbySearch(request, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                displayPlaces(results);
            } else {
                displayPlaces([]);
                listContentArea.innerHTML = `<p class="list-status-text">在此區域找不到符合條件的餐廳。</p>`;
            }
        });
    }

    function displayPlaces(places, isSingleResult = false) {
        const listContentArea = document.getElementById("list-content-area");
        let html = '';
        restaurantMarkers.forEach(marker => { marker.setMap(null); });
        restaurantMarkers = [];
        if (!places || places.length === 0) { listContentArea.innerHTML = `<p class="list-status-text">找不到符合的餐廳。</p>`; return; }
        
        places.forEach(place => {
            if (!place.geometry || !place.geometry.location) return;
            const marker = createMarker(place);
            restaurantMarkers.push(marker);
            
            const ratingHtml = place.rating ? `${place.rating} <i class="fas fa-star" style="color: #fbbc05;"></i>` : '無評分';
            const detailsHtml = `${getPlaceCategory(place) || ''} · ${ratingHtml} ${createPriceLevel(place.price_level)}`;
            
            html += `<div class="list-item" id="item-${place.place_id}" onclick="selectListItem('${place.place_id}')"><i class="item-icon fas fa-utensils"></i><div class="item-info"><div class="item-name">${place.name}</div><div class="item-details">${detailsHtml}</div><div class="item-address">${place.vicinity}</div></div></div>`;
        });
        
        listContentArea.innerHTML = html;
        if (isSingleResult && restaurantMarkers.length > 0) { selectListItem(restaurantMarkers[0].placeId); }
    }

    function createMarker(place) {
        const marker = new google.maps.Marker({
            map,
            position: place.geometry.location,
            title: place.name,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: getCategoryColor(place),
                fillOpacity: 1,
                strokeColor: 'white',
                strokeWeight: 2,
                scale: 9 
            }
        });
        marker.placeId = place.place_id;
        marker.addListener('click', () => selectRestaurant(place.place_id));
        return marker;
    }

    function selectRestaurant(placeId) {
        const marker = restaurantMarkers.find(m => m.placeId === placeId);
        if (!marker) return;
        clearRoute();
        highlightListItem(placeId);
        map.panTo(marker.getPosition());
        activePlaceId = placeId;
        infoWindow.setContent(`<div class="place-info-window"><div class="info-window-status"><i class="fas fa-spinner fa-spin"></i> 正在載入詳細資訊...</div></div>`);
        infoWindow.open({ anchor: marker, map: map });
        fetchPlaceDetailsWithRetry(placeId, marker, 2);
    }

    function fetchPlaceDetailsWithRetry(placeId, marker, retriesLeft) {
        const request = { placeId: placeId, fields: ['name', 'formatted_address', 'formatted_phone_number', 'rating', 'user_ratings_total', 'opening_hours', 'utc_offset_minutes', 'business_status', 'website', 'price_level', 'types', 'vicinity', 'geometry'] };
        placesService.getDetails(request, (details, status) => {
            if (activePlaceId !== placeId) return;
            switch (status) {
                case google.maps.places.PlacesServiceStatus.OK: showPlaceDetailsInWindow(details, marker); break;
                case google.maps.places.PlacesServiceStatus.UNKNOWN_ERROR: if (retriesLeft > 0) { setTimeout(() => fetchPlaceDetailsWithRetry(placeId, marker, retriesLeft - 1), 1500); } else { infoWindow.setContent(`<div class="place-info-window"><div class="info-window-status" style="color:var(--danger-color)">載入失敗，請稍後再試。</div></div>`); } break;
                default: infoWindow.setContent(`<div class="place-info-window"><div class="info-window-status" style="color:var(--danger-color)">無法載入此地點資訊。</div></div>`); break;
            }
        });
    }
    
    function highlightListItem(placeId) {
        document.querySelectorAll('.list-item').forEach(item => item.classList.remove('is-selected'));
        if (placeId) {
            const selectedItem = document.getElementById(`item-${placeId}`);
            if (selectedItem) { selectedItem.classList.add('is-selected'); selectedItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
        }
    }
    
    window.selectListItem = (placeId) => selectRestaurant(placeId);

    // --- UI & Page Logic ---
    window.applyFilter = function(element) { infoWindow.close(); activePlaceId = null; clearRoute(); const filterValue = element.dataset.filterValue; if (element.classList.contains('active')) { activeFilter = null; element.classList.remove('active'); } else { activeFilter = { type: 'keyword', value: filterValue }; document.querySelectorAll('.filter-tag').forEach(tag => tag.classList.remove('active')); element.classList.add('active'); } if (map) { clearSearch(true); searchNearbyRestaurants(map.getCenter()); } }
    window.showPage = function(pageId, navElement = null) { if (pageId === 'add-review-page' && !editingPostId) resetReviewForm(); const activePage = document.querySelector('.page.active'); if (activePage && (!['login-page', 'register-page'].includes(activePage.id) || !['login-page', 'register-page'].includes(pageId))) { pageHistory.push(activePage.id); } document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); if (navElement) { document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active')); navElement.classList.add('active'); pageHistory = []; } if (pageId === 'random-page') updateRandomPageStatus(); if (pageId === 'challenge-page') { viewingChallengeId = null; renderChallengePage(); } if (pageId === 'profile-page') renderProfilePage(); };
    window.goBack = function() { editingPostId = null; resetReviewForm(); if (pageHistory.length > 0) { const lastPageId = pageHistory.pop(); document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(lastPageId).classList.add('active'); } else { window.showPage('map-page', document.querySelector('.nav-item[onclick*="map-page"]')); } };
    window.centerOnUserGPS = () => updateUserGPS(true);
    
    function updateUserGPS(centerMap = false) { 
        if (!isMapReady) return;
        document.getElementById("list-content-area").innerHTML = `<p class="list-status-text">正在獲取您的位置...</p>`;
        if (navigator.geolocation) { 
            navigator.geolocation.getCurrentPosition( (position) => { 
                userGpsPosition = { lat: position.coords.latitude, lng: position.coords.longitude }; 
                if (!userMarker) {
                    const userIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28"><circle cx="14" cy="14" r="12" fill="#4285F4" stroke="white" stroke-width="2"/><path d="M14.05 6.25L10.3 17.8l1.7 1.05 2.1-6.1 6.1-2.1-1.05-1.7-4.1 1.2z" fill="white"/></svg>`;
                    userMarker = new google.maps.Marker({ 
                        position: userGpsPosition, 
                        map, 
                        title: "您的位置", 
                        icon: {
                           url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(userIconSvg),
                           scaledSize: new google.maps.Size(28, 28)
                        },
                        zIndex: 1000 
                    });
                } else { 
                    userMarker.setPosition(userGpsPosition); 
                } 
                if (centerMap) { map.panTo(userGpsPosition); if (!activePlaceId) searchNearbyRestaurants(userGpsPosition); } 
            }, () => { 
                if (!activePlaceId) searchNearbyRestaurants(map.getCenter()); 
            }); 
        } else { 
            if (!activePlaceId) searchNearbyRestaurants(map.getCenter()); 
        } 
    }

    window.clearSearch = function(suppressSearch = false) { infoWindow.close(); activePlaceId = null; clearRoute(); const input = document.getElementById('search-input'); input.value = ''; input.dispatchEvent(new Event('input')); highlightListItem(null); if (!suppressSearch) { searchNearbyRestaurants(userGpsPosition || map.getCenter()); } }
    
    // --- Helper & UI Detail Functions ---
    function getPlaceCategory(place) { if (!place || !place.types) return ''; const placeName = (place.name || '').toLowerCase(); for (const categoryName in categoryKeywords) { const data = categoryKeywords[categoryName]; for (const keyword of data.keywords) { if (placeName.includes(keyword) || place.types.some(t => t.replace(/_/g, ' ').includes(keyword))) { return categoryName; } } } const mainType = place.types[0]; if (mainType) return mainType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); return ''; }
    function getCategoryColor(place) { if (!place) return defaultMarkerColor; const placeName = (place.name || '').toLowerCase(); const placeTypes = place.types || []; for (const categoryName in categoryKeywords) { const data = categoryKeywords[categoryName]; for (const keyword of data.keywords) { if (placeName.includes(keyword) || placeTypes.some(t => t.replace(/_/g, ' ').includes(keyword))) { return data.color; } } } const color = miscColors[miscColorIndex]; miscColorIndex = (miscColorIndex + 1) % miscColors.length; return color; }
    window.toggleHoursDetail = function(element) { const detailDiv = element.nextElementSibling; if (detailDiv) { detailDiv.style.display = detailDiv.style.display === 'block' ? 'none' : 'block'; } }
    function getOpeningHoursInfo(details) { if (details && details.business_status === "CLOSED_PERMANENTLY") { return { statusText: '永久停業', statusColor: 'var(--danger-color)', weekday_text: [], currentDayIndex: -1 }; } if (!details || !details.opening_hours || typeof details.utc_offset_minutes === 'undefined') { return { statusText: '營業時間資訊不明', statusColor: 'var(--text-light)', weekday_text: [], currentDayIndex: -1 }; } const oh = details.opening_hours; const isOpen = typeof oh.isOpen === 'function' ? oh.isOpen() : false; const now = new Date(); const userTimezoneOffset = now.getTimezoneOffset(); const restaurantNow = new Date(now.getTime() + (details.utc_offset_minutes + userTimezoneOffset) * 60000); const dayOfWeek = restaurantNow.getDay(); const googleDayIndex = (dayOfWeek + 6) % 7; let statusText = isOpen ? "營業中" : "休息中"; if (isOpen && oh.periods) { const period = oh.periods.find(p => p.open && p.open.day === dayOfWeek && p.close); if (period && period.close) { let closeTime = period.close.time; if (typeof closeTime === 'string') { statusText += ` • ${closeTime.substring(0, 2)}:${closeTime.substring(2, 4)} 關店`; } } } return { statusText, statusColor: isOpen ? "var(--success-color)" : "var(--danger-color)", weekday_text: oh.weekday_text || [], currentDayIndex: googleDayIndex }; }
    
    function showPlaceDetailsInWindow(details, marker) {
        if (activePlaceId !== details.place_id) return;
        const hoursInfo = getOpeningHoursInfo(details);
        const weeklyHoursHtml = hoursInfo.weekday_text.map((text, index) => { const parts = text.split(/:\s(.*)/s); const day = parts[0]; const time = parts.length > 1 ? parts[1] : '休息'; return `<div class="day-hours ${index === hoursInfo.currentDayIndex ? 'current-day' : ''}"><span>${day}</span><span>${time}</span></div>`; }).join('');
        let content = `
            <div class="place-info-window">
                <h3>${details.name}</h3>
                <div class="place-detail-row"><i class="detail-icon fas fa-map-marker-alt"></i><div>${details.formatted_address || details.vicinity}</div></div>
                ${details.rating ? `<div class="place-detail-row"><i class="detail-icon fas fa-star"></i><div>${details.rating} (${details.user_ratings_total || 0} 則評論)</div></div>` : ''}
                ${details.formatted_phone_number ? `<div class="place-detail-row"><i class="detail-icon fas fa-phone"></i><div>${details.formatted_phone_number}</div></div>` : ''}
                <div class="place-detail-row" onclick="toggleHoursDetail(this)" style="cursor: pointer;"><i class="detail-icon far fa-clock"></i><div class="hours-header ${hoursInfo.currentDayIndex !== -1 ? 'current-day-bold' : ''}" style="width:100%; color:${hoursInfo.statusColor};">${hoursInfo.statusText}</div></div>
                <div class="hours-detail">${weeklyHoursHtml}</div>
                <div class="place-info-actions">
                    <button class="btn-navigate" onclick="calculateAndShowRoute({ lat: ${details.geometry.location.lat()}, lng: ${details.geometry.location.lng()} })">
                        <i class="fa-solid fa-route"></i> 規劃路線
                    </button>
                </div>
            </div>`;
        infoWindow.setContent(content);
    }

    function createPriceLevel(level) { if (typeof level !== 'number') return ''; return '· ' + '$'.repeat(level); }

    // --- Directions Functions ---
    function calculateAndShowRoute(destination, travelMode = 'DRIVING') {
        if (!userGpsPosition) {
            alert('無法獲取您的目前位置，請開啟定位服務後再試。');
            return;
        }
        clearRoute();
        currentRouteDestination = destination;
        currentTravelMode = travelMode;

        const panel = document.getElementById('directions-panel');
        const infoContent = document.getElementById('directions-info-content');
        infoContent.innerHTML = `<span><i class="fa-solid fa-spinner fa-spin"></i> 正在計算路線...</span>`;
        document.getElementById('driving-mode-btn').classList.toggle('active', currentTravelMode === 'DRIVING');
        document.getElementById('walking-mode-btn').classList.toggle('active', currentTravelMode === 'WALKING');
        panel.style.display = 'flex';
        infoWindow.close();

        directionsService.route(
            {
                origin: userGpsPosition,
                destination: destination,
                travelMode: google.maps.TravelMode[travelMode],
            },
            displayRoute
        );
    }

    function displayRoute(response, status) {
        const infoContent = document.getElementById('directions-info-content');
        if (status === 'OK' && response.routes && response.routes.length > 0) {
            const leg = response.routes[0].legs[0];
            infoContent.innerHTML = `<span><i class="fa-solid fa-clock"></i> ${leg.duration.text}</span> <span><i class="fa-solid fa-map-pin"></i> ${leg.distance.text}</span>`;
            
            const renderer = (currentTravelMode === 'DRIVING') ? drivingRenderer : walkingRenderer;
            renderer.setDirections(response);
        } else {
            let errorMessage = '無法規劃路線。';
            switch (status) {
                case google.maps.DirectionsStatus.NOT_FOUND: errorMessage = '找不到起點或終點。'; break;
                case google.maps.DirectionsStatus.ZERO_RESULTS: errorMessage = '找不到可行的路線。'; break;
                case google.maps.DirectionsStatus.OVER_QUERY_LIMIT: errorMessage = 'API用量超限，請稍後再試。'; break;
                default: errorMessage = '網路錯誤或未知問題。'; break;
            }
            infoContent.innerHTML = `<span style="color: var(--danger-color);"><i class="fa-solid fa-triangle-exclamation"></i> ${errorMessage}</span>`;
        }
    }

    function clearRoute() {
        drivingRenderer.setDirections({routes: []});
        walkingRenderer.setDirections({routes: []});
        document.getElementById('directions-panel').style.display = 'none';
        currentRouteDestination = null;
    }
    
    // --- Auth, Data & Other Features ---
    function handleRegister() { const name = document.getElementById('register-name-input').value.trim(); const email = document.getElementById('register-email-input').value; const password = document.getElementById('register-password-input').value; const errorDiv = document.getElementById('register-error'); errorDiv.textContent = ''; if (!name || !email || !password) { errorDiv.textContent = '所有欄位都必須填寫！'; return; } auth.createUserWithEmailAndPassword(email, password).then(userCredential => userCredential.user.updateProfile({ displayName: name })).then(() => { window.goBack(); }).catch(error => { switch(error.code) { case 'auth/email-already-in-use': errorDiv.textContent = '此電子郵件已被註冊。'; break; case 'auth/invalid-email': errorDiv.textContent = '電子郵件格式不正確。'; break; case 'auth/weak-password': errorDiv.textContent = '密碼強度不足 (至少6位數)。'; break; default: errorDiv.textContent = '註冊失敗，請稍後再試。'; } }); }
    function handleSignIn() { const email = document.getElementById('login-email-input').value; const password = document.getElementById('login-password-input').value; const errorDiv = document.getElementById('login-error'); errorDiv.textContent = ''; if (!email || !password) { errorDiv.textContent = '請輸入電子郵件和密碼。'; return; } auth.signInWithEmailAndPassword(email, password).then(() => { window.goBack(); }).catch(error => { errorDiv.textContent = '登入失敗，請檢查信箱或密碼。'; }); }
    function handleGoogleSignIn() { const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).then(() => { window.goBack(); }).catch(error => { document.getElementById('login-error').textContent = 'Google 登入失敗，請稍後再試。'; }); }
    function handleSignOut() { auth.signOut().catch(error => console.error("登出錯誤:", error)); }
    function setupLoggedInUI(user) { document.getElementById('profile-login-btn').style.display = 'none'; document.getElementById('profile-logout-btn').style.display = 'block'; const userName = user.displayName || user.email.split('@')[0]; document.getElementById('profile-header').innerHTML = `<i class="fa-solid fa-user"></i> ${userName}`; renderProfilePage(); }
    function setupLoggedOutUI() { document.getElementById('profile-login-btn').style.display = 'block'; document.getElementById('profile-logout-btn').style.display = 'none'; document.getElementById('profile-header').innerHTML = `<i class="fa-solid fa-user"></i> 個人檔案`; renderProfilePage(); updateRandomPageStatus(); renderChallengePage(); }
    function getPosts() { if (!currentUser) return []; return JSON.parse(localStorage.getItem(`${POSTS_DB_KEY}_${currentUser.uid}`)) || []; }
    function savePosts(posts) { if (!currentUser) return; localStorage.setItem(`${POSTS_DB_KEY}_${currentUser.uid}`, JSON.stringify(posts)); }
    function saveReview() { if (!currentUser) { alert('請先登入！'); window.showPage('login-page'); return; } const name = document.getElementById('review-restaurant-name').value.trim(); const rating = document.getElementById('review-rating').dataset.rating; if (!name || rating === "0") { alert("請務必填寫「餐廳名称」和「喜愛程度」！"); return; } const photos = Array.from(document.querySelectorAll('#photo-preview-container .photo-preview-item img')).map(img => img.src); const posts = getPosts(); const postData = { id: editingPostId || Date.now().toString(), userId: currentUser.uid, restaurantName: name, mealItems: document.getElementById('review-meal-items').value.trim(), cost: Number(document.getElementById('review-cost').value) || 0, mealType: document.getElementById('review-meal-type').value, rating: Number(rating), content: document.getElementById('review-content').value.trim(), photos, timestamp: new Date().getTime(), location: selectedPlaceForReview ? selectedPlaceForReview.location : null }; if (editingPostId) { const postIndex = posts.findIndex(p => p.id === editingPostId); if (postIndex > -1) { posts[postIndex] = postData; } } else { posts.unshift(postData); } savePosts(posts); alert(editingPostId ? "評論已成功更新！" : "評論已成功儲存！"); editingPostId = null; resetReviewForm(); window.showPage('profile-page', document.querySelector('.nav-item[onclick*="profile-page"]')); }
    function editPost(postId) { const posts = getPosts(); const postToEdit = posts.find(p => p.id === postId); if (!postToEdit) return; editingPostId = postId; document.getElementById('review-restaurant-name').value = postToEdit.restaurantName; document.getElementById('review-meal-items').value = postToEdit.mealItems || ''; document.getElementById('review-cost').value = postToEdit.cost || ''; document.getElementById('review-meal-type').value = postToEdit.mealType || 'other'; document.getElementById('review-content').value = postToEdit.content || ''; document.getElementById('review-rating').dataset.rating = postToEdit.rating; updateHeartDisplay(postToEdit.rating); const previewContainer = document.getElementById('photo-preview-container'); previewContainer.innerHTML = ''; if (postToEdit.photos && postToEdit.photos.length > 0) { displayPhotoPreviews(postToEdit.photos); } document.getElementById('add-review-header').innerHTML = `<i class="fa-solid fa-pen-to-square"></i>編輯美食評論`; document.getElementById('save-review-btn').textContent = "更新評論"; window.showPage('add-review-page'); }
    function deletePost(postId) { if (confirm('確定要刪除這筆紀錄嗎？')) { let posts = getPosts(); posts = posts.filter(p => p.id !== postId); savePosts(posts); renderMyPosts(); } }
    function openQrScanner() { qrModal.style.display = 'flex'; qrStatusText.textContent = '請將發票左方(總金額)或右方(明細) QR Code 對準掃描框'; scanBox.style.borderColor = 'rgba(255, 255, 255, 0.7)'; navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => { stream = s; video.srcObject = stream; video.setAttribute("playsinline", true); video.play(); requestAnimationFrame(tick); }).catch(err => { qrStatusText.textContent = '無法啟動相機。請確認已授權。'; console.error("相機錯誤:", err); }); }
    function closeQrScanner() { qrModal.style.display = 'none'; if (stream) stream.getTracks().forEach(track => track.stop()); if (animationFrameId) cancelAnimationFrame(animationFrameId); animationFrameId = null; }
    function tick() { if (video.readyState === video.HAVE_ENOUGH_DATA) { canvasElement.height = video.videoHeight; canvasElement.width = video.videoWidth; canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height); var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height); var code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" }); if (code) { handleQrCodeResult(code.data); return; } } animationFrameId = requestAnimationFrame(tick); }
    function parseLeftQRCode(data) { try { if (typeof data !== 'string' || data.length < 77) return null; const totalAmount = parseInt(data.substring(29, 37), 16); return isNaN(totalAmount) ? null : { totalAmount }; } catch (e) { return null; } }
    function parseRightQRCode(data) { try { if (typeof data !== 'string' || !data.startsWith('**') && data.indexOf('*:') === -1) return null; const parts = (data.startsWith('**') ? data.substring(2) : data).split(':'); if (parts.length < 2) return null; const itemCount = parseInt(parts[1]); if (isNaN(itemCount) || itemCount <= 0) return null; let parsedItems = []; for (let i = 0, idx = 3; i < itemCount && idx + 2 < parts.length; i++, idx += 3) { if (parts[idx] && parts[idx + 1]) parsedItems.push(`${parts[idx]} x ${parts[idx + 1]}`); } return parsedItems.length > 0 ? { items: parsedItems } : null; } catch (e) { return null; } }
    function handleQrCodeResult(qrData) { if (animationFrameId) cancelAnimationFrame(animationFrameId); animationFrameId = null; const leftQRResult = parseLeftQRCode(qrData); const rightQRResult = parseRightQRCode(qrData); if (!leftQRResult && !rightQRResult) { qrStatusText.textContent = '無法辨識的發票 QR Code 格式。'; scanBox.style.borderColor = 'var(--danger-color)'; setTimeout(() => { scanBox.style.borderColor = 'rgba(255, 255, 255, 0.7)'; if (qrModal.style.display === 'flex') requestAnimationFrame(tick); }, 2500); return; } scanBox.style.borderColor = 'var(--success-color)'; let feedback = []; if (leftQRResult) { document.getElementById('review-cost').value = leftQRResult.totalAmount; feedback.push(`總金額 $${leftQRResult.totalAmount} 已填入！`); } if (rightQRResult) { const currentItems = document.getElementById('review-meal-items').value; const newItems = rightQRResult.items.join('\n'); document.getElementById('review-meal-items').value = currentItems ? `${currentItems}\n${newItems}` : newItems; feedback.push(`${rightQRResult.items.length}筆商品明細已加入！`); } const feedbackMessage = feedback.join('\n'); qrStatusText.textContent = feedbackMessage; setTimeout(() => { if (confirm(feedbackMessage + '\n\n是否要繼續掃描下一個 QR Code？')) { qrStatusText.textContent = '請對準下一個 QR Code...'; scanBox.style.borderColor = 'rgba(255, 255, 255, 0.7)'; requestAnimationFrame(tick); } else { closeQrScanner(); } }, 500); }
    function displayPhotoPreviews(items) { const previewContainer = document.getElementById('photo-preview-container'); if (!items) return; for (const item of items) { if (item instanceof File && item.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = e => createPreviewElement(e.target.result); reader.readAsDataURL(item); } else if (typeof item === 'string' && item.startsWith('data:image')) { createPreviewElement(item); } } function createPreviewElement(src) { const previewItem = document.createElement('div'); previewItem.className = 'photo-preview-item'; const img = document.createElement('img'); img.src = src; const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-photo-btn'; deleteBtn.innerHTML = '×'; deleteBtn.onclick = () => previewItem.remove(); previewItem.append(img, deleteBtn); previewContainer.appendChild(previewItem); } }
    function handleRatingClick(e) { if (!e.target.matches('.fa-heart')) return; const rating = e.target.dataset.value; document.getElementById('review-rating').dataset.rating = rating; updateHeartDisplay(rating); }
    function handleRatingHover(e) { if (!e.target.matches('.fa-heart')) return; updateHeartDisplay(e.target.dataset.value); }
    function handleRatingMouseout() { updateHeartDisplay(document.getElementById('review-rating').dataset.rating); }
    function updateHeartDisplay(rating) { document.querySelectorAll('.rating-hearts .fa-heart').forEach(heart => heart.classList.toggle('active', heart.dataset.value <= rating)); }
    function resetReviewForm() { editingPostId = null; document.getElementById('add-review-header').innerHTML = `<i class="fa-solid fa-pencil"></i>新增美食評論`; document.getElementById('save-review-btn').textContent = "儲存評論與貼文"; ['review-restaurant-name', 'review-meal-items', 'review-cost', 'review-content'].forEach(id => document.getElementById(id).value = ''); document.getElementById('review-meal-type').value = 'other'; document.getElementById('review-rating').dataset.rating = 0; updateHeartDisplay(0); document.getElementById('photo-preview-container').innerHTML = ''; }
    const loggedOutPlaceholder = (message) => `<p class="placeholder-text">請先<a href="#" onclick="window.showPage('login-page')">登入</a>${message}</p>`;
    function renderProfilePage() { const activeTabBtn = document.querySelector('#profile-page .tab-btn.active') || document.querySelector('#profile-page .tab-btn'); if(activeTabBtn) window.showProfileTab(activeTabBtn.getAttribute('onclick').match(/'([^']+)'/)[1], activeTabBtn); }
    function showProfileTab(tabId, tabElement) { document.querySelectorAll('#profile-page .tab-btn').forEach(btn => btn.classList.remove('active')); tabElement.classList.add('active'); document.querySelectorAll('#profile-page .tab-content').forEach(content => content.classList.remove('active')); document.getElementById(`${tabId}-content`).classList.add('active'); if (tabId === 'accounting') renderAccountingRecords(); if (tabId === 'posts') renderMyPosts(); if (tabId === 'favorites') renderFavoriteRestaurants(); if (tabId === 'friends') renderFriendsList(); }
    function renderAccountingRecords() { const container = document.getElementById('accounting-content'); if (!currentUser) { container.innerHTML = loggedOutPlaceholder('以查看您的消費紀錄。'); return; } const posts = getPosts().filter(p => p.cost > 0); if (posts.length === 0) { container.innerHTML = `<p class="placeholder-text">尚無消費紀錄。</p>`; return; } const mealTypeNames = { breakfast: '早餐', lunch: '午餐', dinner: '晚餐', other: '其他' }; const mealTypeOrder = ['breakfast', 'lunch', 'dinner', 'other']; const groupedByDate = posts.reduce((acc, post) => { const date = new Date(post.timestamp).toLocaleDateString(); if (!acc[date]) acc[date] = []; acc[date].push(post); return acc; }, {}); const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a)); let html = ''; sortedDates.forEach(date => { html += `<div class="accounting-date-group"><div class="accounting-date-header">${date}</div>`; const dayPosts = groupedByDate[date]; mealTypeOrder.forEach(mealType => { const mealPosts = dayPosts.filter(p => (p.mealType || 'other') === mealType); if (mealPosts.length > 0) { html += `<h4 class="accounting-meal-header">${mealTypeNames[mealType]}</h4>`; html += mealPosts.map(p => `<div class="record-card"><span class="cost">$${p.cost}</span><div class="title">${p.restaurantName}</div><div class="details">${p.mealItems || '無品項紀錄'}</div></div>`).join(''); } }); html += `</div>`; }); container.innerHTML = html || `<p class="placeholder-text">尚無消費紀錄。</p>`; }
    function renderMyPosts() { const listContainer = document.getElementById('posts-list-container'); if (!currentUser) { document.getElementById('posts-content').innerHTML = loggedOutPlaceholder('以查看您的貼文。'); return; } let posts = getPosts(); if (posts.length === 0) { listContainer.innerHTML = `<p class="placeholder-text">您還沒有發表過貼文。</p>`; return; } const sortOrder = document.getElementById('post-sort-order').value; posts.sort((a, b) => sortOrder === 'newest' ? b.timestamp - a.timestamp : a.timestamp - b.timestamp); listContainer.innerHTML = posts.map(p => { const ratingHtml = Array(parseInt(p.rating)).fill('<i class="fa-solid fa-heart"></i>').join(''); let photosHtml = p.photos && p.photos.length > 0 ? `<div class="post-photos">${p.photos.map(src => `<img src="${src}" alt="Post photo">`).join('')}</div>` : ''; return `<div class="post-card"><div class="card-actions"><button class="action-btn btn-edit" onclick="editPost('${p.id}')">編輯</button><button class="action-btn btn-delete" onclick="deletePost('${p.id}')">刪除</button></div><div class="title">${p.restaurantName}</div><div class="details">${new Date(p.timestamp).toLocaleString()}</div><p class="content" style="white-space: pre-wrap;">${p.content || '（無詳細評論）'}</p><div class="post-rating">${ratingHtml}</div>${photosHtml}</div>`; }).join(''); }
    function renderFavoriteRestaurants() { const container = document.getElementById('favorites-content'); if (!currentUser) { container.innerHTML = loggedOutPlaceholder('以查看您的最愛餐廳。'); return; } const favorites = getFavorites(); if (favorites.length === 0) { container.innerHTML = `<p class="placeholder-text">您還沒有加入任何最愛餐廳。<br>可以從地圖上點擊餐廳的<i class="far fa-bookmark" style="color:#ccc"></i>來加入喔！</p>`; return; } container.innerHTML = '<h3>我的最愛餐廳</h3>' + favorites.map(f => `<div class="record-card"><div class="card-actions"><button class="action-btn btn-delete" onclick="toggleFavorite({place_id: '${f.place_id}', name: '${f.name}'}, null)">移除</button></div><div class="title"><i class="fa-solid fa-utensils" style="margin-right:8px; color: var(--primary-color)"></i>${f.name}</div></div>`).join(''); }
    function renderFriendsList() { const listContainer = document.getElementById('friends-list-container'); if (!currentUser) { document.getElementById('friends-content').innerHTML = loggedOutPlaceholder('以查看好友名單。'); return; } const friends = getFriends(); listContainer.innerHTML = friends.length === 0 ? `<p class="placeholder-text">您還沒有加入任何好友。</p>` : friends.map(f => `<div class="record-card"><div class="card-actions"><button class="action-btn btn-delete" onclick="deleteFriend('${f.id}')">刪除</button></div><div class="title"><i class="fa-solid fa-user-group" style="margin-right:8px; color: var(--text-light)"></i>${f.name}</div><div class="details">ID: ${f.id}</div></div>`).join(''); }
    function isFavorite(place_id) { if (!currentUser) return false; return getFavorites().some(f => f.place_id === place_id); }
    function toggleFavorite(place, element) { if (!currentUser) { alert('請先登入才能使用此功能！'); return; } let favorites = getFavorites(); const isFav = isFavorite(place.place_id); if (isFav) { favorites = favorites.filter(fav => fav.place_id !== place.place_id); } else { favorites.push({ place_id: place.place_id, name: place.name }); } saveFavorites(favorites); if (element) { element.classList.toggle('is-favorite', !isFav); } if (document.getElementById('favorites-content').classList.contains('active')) { renderFavoriteRestaurants(); } }
    function updateRandomPageStatus() { const statusText = document.getElementById('random-status-text'); if (!currentUser) { statusText.innerHTML = loggedOutPlaceholder('以使用您的最愛清單進行抽籤！'); statusText.classList.remove('placeholder-text'); return; } const favorites = getFavorites(); if (favorites.length < 2) { statusText.textContent = `您的最愛餐廳少於2家，無法啟動輪盤！請到地圖上將更多餐廳加入最愛。`; statusText.classList.remove('placeholder-text'); } else { statusText.textContent = `您的最愛清單中有 ${favorites.length} 家餐廳，準備好抽籤了嗎？`; statusText.classList.add('placeholder-text'); } }
    function getFavorites() { if (!currentUser) return []; return JSON.parse(localStorage.getItem(`${FAVORITES_DB_KEY}_${currentUser.uid}`)) || []; }
    function saveFavorites(favorites) { if (!currentUser) return; localStorage.setItem(`${FAVORITES_DB_KEY}_${currentUser.uid}`, JSON.stringify(favorites)); updateRandomPageStatus(); }
    function getFriends() { if (!currentUser) return []; return JSON.parse(localStorage.getItem(`${FRIENDS_DB_KEY}_${currentUser.uid}`)) || []; }
    function saveFriends(friends) { if (!currentUser) return; localStorage.setItem(`${FRIENDS_DB_KEY}_${currentUser.uid}`, JSON.stringify(friends)); }
    function searchFriend() { if (!currentUser) return; const searchTerm = document.getElementById('friend-search-input').value.trim().toLowerCase(); if (!searchTerm) return; const foundUser = mockUserDB.find(user => user.id.toLowerCase() === searchTerm || user.email.toLowerCase() === searchTerm); if (foundUser) { if (foundUser.email === currentUser.email) { alert('您無法將自己加為好友。'); return; } const friends = getFriends(); if (friends.some(f => f.id === foundUser.id)) { alert('你們已經是好友了！'); } else if (confirm(`找到用戶「${foundUser.name}」，要將他加入好友嗎？`)) { friends.push(foundUser); saveFriends(friends); renderFriendsList(); } } else { alert('找不到該用戶。'); } document.getElementById('friend-search-input').value = ''; };
    function deleteFriend(id) { if (confirm("確定要刪除這位好友嗎？")) { saveFriends(getFriends().filter(f => f.id !== id)); renderFriendsList(); } };
    function startRandomPick() { if (!currentUser) { alert('請先登入才能使用您的最愛清單進行抽籤！'); window.showPage('login-page'); return; } const favorites = getFavorites(); if (favorites.length < 2) { alert("您的最愛餐廳少於2家，無法啟動輪盤！\n請到地圖上將更多餐廳加入最愛。"); return; } const wheel = document.getElementById('picker-wheel'); const resultDiv = document.getElementById('picker-result'); const statusText = document.getElementById('random-status-text'); const pickButton = document.getElementById('random-pick-btn'); pickButton.disabled = true; resultDiv.textContent = '...'; resultDiv.style.color = 'var(--text-light)'; statusText.style.visibility = 'hidden'; const winnerIndex = Math.floor(Math.random() * favorites.length); const winner = favorites[winnerIndex]; const sliceAngle = 360 / favorites.length; const targetSliceCenter = (sliceAngle * winnerIndex) + (sliceAngle / 2); const rotationEnd = 360 - targetSliceCenter + 270; const finalAngle = rotationEnd + (360 * (Math.floor(Math.random() * 4) + 4)); wheel.style.transition = 'none'; wheel.style.transform = `rotate(0deg)`; wheel.offsetHeight; wheel.style.transition = 'transform 4s cubic-bezier(0.25, 1, 0.5, 1)'; wheel.style.transform = `rotate(${finalAngle}deg)`; setTimeout(() => { resultDiv.textContent = '?'; resultDiv.style.color = 'var(--primary-color)'; statusText.innerHTML = `您抽中「<strong>${winner.name}</strong>」！`; statusText.classList.remove('placeholder-text'); statusText.style.visibility = 'visible'; pickButton.disabled = false; }, 4100); }
    function renderChallengePage() { /* Placeholder */ console.log("renderChallengePage needs implementation"); } function createChallengeBoard() { /*...*/ }

    // --- DOMContentLoaded Initializer ---
    document.addEventListener('DOMContentLoaded', () => {
        const setVh = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
        setVh(); window.addEventListener('resize', setVh);
        auth.onAuthStateChanged(user => { currentUser = user; if (user) setupLoggedInUI(user); else setupLoggedOutUI(); });
        const ratingHeartsContainer = document.getElementById('review-rating');
        ratingHeartsContainer.addEventListener('click', handleRatingClick); ratingHeartsContainer.addEventListener('mouseover', handleRatingHover); ratingHeartsContainer.addEventListener('mouseout', handleRatingMouseout);
        qrModal = document.getElementById('qr-scanner-modal'); video = document.getElementById('qr-scanner-video'); canvasElement = document.getElementById('qr-canvas'); canvas = canvasElement.getContext('2d'); qrStatusText = document.getElementById('qr-status-text'); scanBox = document.getElementById('scan-box');
        const btnSelectAlbum = document.getElementById('btn-select-from-album'); const btnOpenCamera = document.getElementById('btn-open-camera'); const photoFileInput = document.getElementById('photo-file-input'); const cameraFileInput = document.getElementById('camera-file-input');
        btnSelectAlbum.addEventListener('click', () => photoFileInput.click()); btnOpenCamera.addEventListener('click', () => cameraFileInput.click());
        const handleFileSelection = (event) => { if (event.target.files && event.target.files.length > 0) displayPhotoPreviews(event.target.files); event.target.value = null; };
        photoFileInput.addEventListener('change', handleFileSelection); cameraFileInput.addEventListener('change', handleFileSelection);
        const searchInput = document.getElementById('search-input'); const clearSearchBtn = document.getElementById('clear-search');
        searchInput.addEventListener('input', () => { clearSearchBtn.style.display = searchInput.value ? 'flex' : 'none'; });
        window.showPage('map-page', document.querySelector('.nav-item')); 
    });
  </script>
  
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCR47ndYnp0jxNAWB-QJ8gUbdHtrYnQdHs&libraries=places,geometry,directions&callback=initMap"
    defer
  ></script>

</body>
</html>
