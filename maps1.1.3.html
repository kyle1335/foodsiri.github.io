<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>FoodieApp</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  <!-- External libraries are loaded first in the head -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <style>
    :root { 
      --primary-color: #667eea; 
      --secondary-color: #764ba2; 
      --success-color: #28a745; 
      --danger-color: #dc3545; 
      --background-color: #f8f9fa; 
      --text-color: #333; 
      --text-light: #6c757d; 
      --nav-height: 60px;
      --vh: 1vh; /* Fallback for browsers that don't support the dynamic vh */
    }
    html {
        height: 100%;
    }
    body { 
        margin: 0; 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        background-color: #e9ebee;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        /* Use the dynamic viewport height unit */
        height: 100vh; /* Fallback */
        height: calc(var(--vh, 1vh) * 100);
    }
    .app-container { 
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background-color: var(--background-color);
      position: relative;
      overflow: hidden;
      box-sizing: border-box;
      /* Mobile-first: no border, no radius by default */
      border: none;
      border-radius: 0;
    }
    
    /* START: UI MODIFICATION - Modified media query for a cleaner desktop view without the hard phone frame. */
    @media (min-width: 500px) {
      .app-container {
        max-width: 390px;
        max-height: 844px;
        box-shadow: 0 15px 45px rgba(0, 0, 0, 0.25);
        border-radius: 20px; /* Softened the radius */
        /* The hard border that creates the "phone frame" look is removed. */
      }
    }
    /* END: UI MODIFICATION */

    main { 
      flex: 1;
      overflow: hidden; 
      position: relative;
      display: flex;
    }
    .page { 
      width: 100%; height: 100%; 
      display: none; 
      flex-direction: column; 
      overflow: hidden; 
    }
    .page.active { 
      display: flex; 
    }
    .app-nav { height: var(--nav-height); width: 100%; background: #fff; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-light); font-size: 12px; cursor: pointer; transition: color 0.2s; width: 100%; }
    .nav-item i { font-size: 22px; margin-bottom: 4px; }
    .nav-item.active { color: var(--primary-color); }
    #map-page { 
      flex-direction: column; 
    }
    #map-panel { 
      flex: 0 1 65%; /* Default height ratio, will be overridden by JS */
      position: relative; 
      background: #e5e3df; 
      width: 100%; 
    }
    #list-panel { 
      flex: 0 1 35%; /* Default height ratio, will be overridden by JS */
      display: flex; 
      flex-direction: column; 
      background: white; 
      overflow: hidden; 
      width: 100%; 
    }

    /* START: UI MODIFICATION - Added CSS for the new resizer element */
    #resizer {
        width: 100%;
        height: 12px;
        background: #f0f0f0;
        cursor: ns-resize; /* North-South resize cursor */
        position: relative;
        flex-shrink: 0;
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
    }
    #resizer::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 4px;
        background-color: #ccc;
        border-radius: 2px;
    }
    /* END: UI MODIFICATION */

    #map { width: 100%; height: 100%; }
    .search-area { padding: 15px; border-bottom: 1px solid #eee; background: white; flex-shrink: 0; position: relative; }
    .search-input { width: 100%; padding: 12px 40px 12px 15px; font-size: 16px; border-radius: 25px; border: 1px solid #ccc; box-sizing: border-box; }
    .clear-search-btn { position: absolute; top: 50%; right: 25px; transform: translateY(-50%); background: #ccc; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 14px; font-weight: bold; color: white; display: none; justify-content: center; align-items: center; }
    
    .filter-tags-container {
      display: flex;
      justify-content: flex-start;
      gap: 8px;
      padding: 15px;
      padding-top: 0;
      background: white;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch; 
    }
    
    .filter-tags-container::-webkit-scrollbar { display: none; /* Hide scrollbar for cleaner look */ }

    .filter-tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 14px;
      border: 1px solid #ccc;
      border-radius: 20px;
      background-color: #f0f0f0;
      color: var(--text-color);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap; 
      transition: all 0.2s ease-in-out;
    }
    
    .filter-tag[data-filter-value="distance"]:hover { background-color: #e8eaf6; }
    .filter-tag[data-filter-value="distance"].active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    .filter-tag:not([data-filter-value="distance"]):hover { filter: brightness(0.95); }
    .filter-tag.active { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    
    .filter-tag[data-filter-value="台式"]     { background-color: #e3f2fd; border-color: #bbdefb; color: #1565c0; }
    .filter-tag[data-filter-value="日式"]     { background-color: #ffebee; border-color: #ffcdd2; color: #c62828; }
    .filter-tag[data-filter-value="居酒屋"]   { background-color: #f3e5f5; border-color: #e1bee7; color: #6a1b9a; }
    .filter-tag[data-filter-value="酒吧"]     { background-color: #ede7f6; border-color: #d1c4e9; color: #4527a0; }
    .filter-tag[data-filter-value="熱炒"]     { background-color: #fff8e1; border-color: #ffecb3; color: #ffa000; }
    .filter-tag[data-filter-value="火鍋"]     { background-color: #fff3e0; border-color: #ffe0b2; color: #ef6c00; }
    .filter-tag[data-filter-value="美式"]     { background-color: #e1f5fe; border-color: #b3e5fc; color: #0277bd; }
    .filter-tag[data-filter-value="中式"]     { background-color: #fbe9e7; border-color: #ffccbc; color: #d84315; }
    .filter-tag[data-filter-value="義式"]     { background-color: #e8f5e9; border-color: #c8e6c9; color: #2e7d32; }
    .filter-tag[data-filter-value="泰式"]     { background-color: #e0f2f1; border-color: #b2dfdb; color: #00695c; }
    .filter-tag[data-filter-value="越式"]     { background-color: #f1f8e9; border-color: #dcedc8; color: #558b2f; }
    .filter-tag[data-filter-value="咖啡廳"]   { background-color: #efebe9; border-color: #d7ccc8; color: #5d4037; }
    .filter-tag[data-filter-value="早午餐"]   { background-color: #fffde7; border-color: #fff9c4; color: #f57f17; }
    .filter-tag[data-filter-value="手搖飲"]   { background-color: #e0f7fa; border-color: #b2ebf2; color: #00838f; }
    .filter-tag[data-filter-value="小吃"]     { background-color: #eceff1; border-color: #cfd8dc; color: #37474f; }

    .filter-tag[data-filter-value="台式"].active     { background-color: #42a5f5; border-color: #42a5f5; color: white; }
    .filter-tag[data-filter-value="日式"].active     { background-color: #e57373; border-color: #e57373; color: white; }
    .filter-tag[data-filter-value="居酒屋"].active   { background-color: #ab47bc; border-color: #ab47bc; color: white; }
    .filter-tag[data-filter-value="酒吧"].active     { background-color: #7e57c2; border-color: #7e57c2; color: white; }
    .filter-tag[data-filter-value="熱炒"].active     { background-color: #ffca28; border-color: #ffca28; color: #333; }
    .filter-tag[data-filter-value="火鍋"].active     { background-color: #ff9800; border-color: #fb8c00; color: white; }
    .filter-tag[data-filter-value="美式"].active     { background-color: #29b6f6; border-color: #29b6f6; color: white; }
    .filter-tag[data-filter-value="中式"].active     { background-color: #ff7043; border-color: #ff7043; color: white; }
    .filter-tag[data-filter-value="義式"].active     { background-color: #66bb6a; border-color: #66bb6a; color: white; }
    .filter-tag[data-filter-value="泰式"].active     { background-color: #26a69a; border-color: #26a69a; color: white; }
    .filter-tag[data-filter-value="越式"].active     { background-color: #9ccc65; border-color: #9ccc65; color: #333; }
    .filter-tag[data-filter-value="咖啡廳"].active   { background-color: #795548; border-color: #6d4c41; color: white; }
    .filter-tag[data-filter-value="早午餐"].active   { background-color: #ffee58; border-color: #fdd835; color: #333; }
    .filter-tag[data-filter-value="手搖飲"].active   { background-color: #26c6da; border-color: #26c6da; color: white; }
    .filter-tag[data-filter-value="小吃"].active     { background-color: #78909c; border-color: #78909c; color: white; }

    .list-content { overflow-y: auto; flex-grow: 1; }
    .list-item { display: flex; align-items: flex-start; gap: 15px; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background-color 0.2s; }
    .list-item.is-selected { background-color: #e8eaf6; border-left: 4px solid var(--primary-color); padding-left: 11px; }
    .item-icon { font-size: 18px; color: var(--primary-color); margin-top: 3px; flex-shrink: 0; }
    .item-info { flex-grow: 1; min-width: 0; }
    .item-name { font-weight: 600; font-size: 16px; }
    .item-details, .item-address { font-size: 13px; color: var(--text-light); margin-top: 4px; }
    .item-address { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-distance { font-weight: 500; font-size: 14px; color: var(--text-color); white-space: nowrap; text-align: right; }
    .open-status.open { color: #28a745; font-weight: bold; }
    .open-status.closed { color: #dc3545; font-weight: bold; }
    .list-status-text { text-align: center; color: #999; padding: 40px 20px; }
    .location-btn { position: absolute; bottom: 20px; right: 20px; background: #fff; color: var(--primary-color); border: none; width: 50px; height: 50px; border-radius: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); cursor: pointer; z-index: 10; font-size: 24px; display: flex; justify-content: center; align-items: center; }
    .gm-style-iw-d { overflow: auto !important; }
    .info-window-content { font-family: inherit; padding: 5px; max-width: 280px; }
    .info-window-content h4 { font-size: 16px; margin: 0 0 8px 0; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    .info-window-content p { font-size: 14px; margin: 0 0 5px 0; color: #555; display: flex; align-items: center; }
    .info-window-content i { margin-right: 8px; color: var(--primary-color); width: 16px; text-align: center; flex-shrink: 0; }
    .favorite-btn { background: none; border: none; font-size: 22px; cursor: pointer; padding: 0 5px; color: #ddd; }
    .favorite-btn.is-favorite { color: var(--danger-color); }
    .page-header { padding: 15px 20px; background-color: #fff; border-bottom: 1px solid #eee; text-align: center; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
    .page-header h2 { margin: 0; font-size: 18px; color: var(--text-color); display: flex; align-items: center; justify-content: center; flex-grow: 1; }
    .page-header h2 i { margin-right: 10px; color: var(--primary-color); }
    .header-action { font-size: 16px; color: var(--primary-color); text-decoration: none; cursor: pointer; }
    .header-back-btn { font-size: 20px; color: var(--text-color); cursor: pointer; }
    .page-header .placeholder { width: 24px; }
    .page-content { flex-grow: 1; overflow-y: auto; padding: 20px; box-sizing: border-box; }
    .placeholder-text { text-align: center; color: var(--text-light); margin-top: 50px; padding: 20px; }
    .btn { display: block; width: 100%; padding: 15px; background-color: var(--success-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; }
    #random-picker-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; box-sizing: border-box; }
    
    #picker-wheel { 
      width: 280px; 
      height: 280px; 
      border: 10px solid #ddd; 
      border-radius: 50%; 
      position: relative; 
      margin-bottom: 30px; 
      transition: transform 4s cubic-bezier(0.25, 1, 0.5, 1);
      overflow: hidden; 
    }
    .slice-text {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 90px; 
        height: 60px; 
        margin-left: -45px;
        margin-top: -30px;
        display: flex;
        align-items: center;
        justify-content: center;
        transform-origin: center center;
        color: white;
        font-weight: 600;
        font-size: 12px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        text-align: center;
        pointer-events: none; 
    }
    #picker-arrow { 
      width: 0; 
      height: 0; 
      border-left: 15px solid transparent; 
      border-right: 15px solid transparent; 
      border-top: 25px solid var(--danger-color); 
      position: absolute; 
      top: -35px;
      left: 50%; 
      transform: translateX(-50%); 
      z-index: 10; 
    }
    #picker-result { 
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      background-color: white;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px; 
      font-weight: bold; 
      color: var(--primary-color); 
      text-align: center; 
      z-index: 5;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    #random-status-text {
        min-height: 40px; 
        font-size: 16px;
        font-weight: 500;
        color: var(--text-color);
    }
    #random-status-text.placeholder-text {
        font-size: 14px;
        font-weight: normal;
        color: var(--text-light);
    }

    .form-group { margin-bottom: 20px; position: relative; } .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color); } .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; } .form-group select { background-color: white; -webkit-appearance: none; } .form-group textarea { min-height: 120px; resize: vertical; } .rating-hearts { display: flex; gap: 10px; font-size: 30px; color: #ddd; cursor: pointer; } .rating-hearts .fa-heart:hover, .rating-hearts .fa-heart.active { color: #ff4d6d; } 
    .photo-upload-container { background: #f0f0f0; border: 2px dashed #ccc; border-radius: 8px; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
    .photo-upload-buttons { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
    .btn-upload { background: #fff; color: var(--text-color); padding: 10px 20px; border-radius: 8px; cursor: pointer; border: 1px solid #ddd; display: inline-flex; align-items: center; }
    .btn-upload i { margin-right: 8px; }
    #photo-preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; justify-content: center; }
    .photo-preview-item { position: relative; width: 80px; height: 80px; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }
    .photo-preview-item img { width: 100%; height: 100%; object-fit: cover; }
    .delete-photo-btn { position: absolute; top: 3px; right: 3px; width: 20px; height: 20px; background-color: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: bold; line-height: 20px; }
    .profile-tabs { display: flex; gap: 10px; padding: 15px 20px; background: #fff; border-bottom: 1px solid #eee; overflow-x: auto; flex-shrink: 0; } .tab-btn { background: #f0f0f0; border: none; border-radius: 20px; padding: 8px 15px; font-size: 14px; cursor: pointer; white-space: nowrap; } .tab-btn.active { background: var(--primary-color); color: #fff; } .tab-content { display: none; } .tab-content.active { display: block; }
    .record-card, .post-card { position: relative; background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); } .record-card .title, .post-card .title { font-weight: 600; margin-bottom: 5px; } .record-card .details, .post-card .details { font-size: 14px; color: var(--text-light); } .record-card .cost { font-weight: bold; color: var(--success-color); float: right; } .post-card .content { margin-top: 10px; font-size: 15px; line-height: 1.6; } .post-card .post-rating { margin-top: 10px; color: #ff4d6d; }
    .post-photos { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .post-photos img { width: 70px; height: 70px; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }
    .card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; }
    .action-btn { background: none; border: 1px solid #ccc; border-radius: 5px; padding: 3px 8px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
    .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .action-btn.btn-edit { color: var(--primary-color); border-color: var(--primary-color); }
    .action-btn.btn-edit:hover:not(:disabled) { background: var(--primary-color); color: white; }
    .action-btn.btn-delete { color: var(--danger-color); border-color: var(--danger-color); }
    .action-btn.btn-delete:hover:not(:disabled) { background: var(--danger-color); color: white; }
    .auth-form-container { width: 100%; max-width: 400px; margin: 0 auto; padding: 20px;}
    .auth-form-container h3 { text-align: center; margin-bottom: 20px; font-size: 20px; }
    .auth-form-container input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; font-size: 16px; }
    .btn-auth { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; margin-bottom: 10px; color: #fff; font-weight: bold; }
    .btn-auth.primary { background-color: var(--primary-color); }
    .btn-auth.secondary { background-color: #fff; color: #4285F4; border: 1px solid #ddd; display:flex; align-items:center; justify-content:center; gap: 10px;}
    .auth-separator { display: flex; align-items: center; text-align: center; color: #aaa; margin: 20px 0; }
    .auth-separator::before, .auth-separator::after { content: ''; flex: 1; border-bottom: 1px solid #ddd; }
    .auth-separator:not(:empty)::before { margin-right: .25em; }
    .auth-separator:not(:empty)::after { margin-left: .25em; }
    .auth-switch-link { text-align: center; margin-top: 15px; font-size: 14px; color: var(--primary-color); cursor: pointer; }
    #auth-error { color: #dc3545; margin-top: 15px; min-height: 20px; font-weight: 500; text-align: center; }
    .btn-scan-qr { position: absolute; top: 0; right: 0; background: var(--primary-color); color: white; border: none; border-radius: 0 8px 0 8px; padding: 5px 10px; font-size: 13px; cursor: pointer; }
    .btn-scan-qr i { margin-right: 5px; }
    #qr-scanner-modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); flex-direction: column; justify-content: center; align-items: center; }
    .qr-scanner-content { position: relative; background-color: #111; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 10px; text-align: center; }
    #qr-scanner-video { width: 100%; border-radius: 8px; }
    #qr-status-text { color: white; font-size: 16px; margin-top: 15px; height: 40px; line-height: 1.4; }
    .qr-scanner-close-btn { position: absolute; top: -15px; right: -15px; color: white; background-color: #dc3545; border-radius: 50%; width: 30px; height: 30px; font-size: 20px; font-weight: bold; cursor: pointer; border: 2px solid white; display:flex; justify-content:center; align-items:center; }
    #scan-box { position: absolute; left: 50%; top: 50%; width: 60%; height: 50%; transform: translate(-50%, -50%); border: 3px solid rgba(255, 255, 255, 0.7); border-radius: 10px; box-shadow: 0 0 0 2000px rgba(0,0,0,0.5); }
    
    .challenge-item { display: flex; align-items: center; justify-content: space-between; background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: background-color 0.2s; }
    .challenge-text { font-size: 16px; flex-grow: 1; margin-right: 15px; }
    .challenge-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .accounting-date-group { margin-bottom: 20px; }
    .accounting-date-header { font-size: 16px; font-weight: 600; padding-bottom: 8px; border-bottom: 1px solid #eee; margin-bottom: 10px; }
    .accounting-meal-header { font-size: 14px; font-weight: 500; color: var(--text-light); margin: 15px 0 5px 0; }
    
    /* Loading spinner style */
    .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 40px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Desktop-specific layout for map page */
    @media (min-width: 768px) {
      #map-page { flex-direction: row; }
      #map-panel { flex: 0 1 60%; border-right: 1px solid #ddd; }
      #list-panel { flex: 0 1 40%; border-top: none; }
      /* START: UI MODIFICATION - Hide vertical resizer on horizontal desktop layout */
      #resizer { display: none; }
      /* END: UI MODIFICATION */
      
      #add-review-page .page-content,
      #challenge-page .page-content,
      #profile-page .page-content,
      #login-page .page-content,
      #register-page .page-content {
        max-width: 700px;
        width: 100%;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <main>
      <div id="map-page" class="page active">
        <div id="map-panel">
          <div id="map"></div>
          <button class="location-btn" onclick="centerOnUserGPS()"><i class="fas fa-location-arrow"></i></button>
        </div>
        <!-- START: UI MODIFICATION - Added the resizer element -->
        <div id="resizer"></div>
        <!-- END: UI MODIFICATION -->
        <div id="list-panel">
          <div class="search-area">
            <input type="text" id="search-input" class="search-input" placeholder="搜尋餐廳或地點...">
            <button class="clear-search-btn" id="clear-search" onclick="clearSearch()">×</button>
          </div>
          <div class="filter-tags-container">
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="早午餐" onclick="applyFilter(this)">早午餐</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="台式" onclick="applyFilter(this)">台式</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="日式" onclick="applyFilter(this)">日式</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="熱炒" onclick="applyFilter(this)">熱炒</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="火鍋" onclick="applyFilter(this)">火鍋</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="美式" onclick="applyFilter(this)">美式</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="中式" onclick="applyFilter(this)">中式</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="義式" onclick="applyFilter(this)">義式</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="泰式" onclick="applyFilter(this)">泰式</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="越式" onclick="applyFilter(this)">越式</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="咖啡廳" onclick="applyFilter(this)">咖啡廳</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="手搖飲" onclick="applyFilter(this)">手搖飲</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="小吃" onclick="applyFilter(this)">小吃</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="居酒屋" onclick="applyFilter(this)">居酒屋</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="酒吧" onclick="applyFilter(this)">酒吧</button>
          </div>
          <div class="list-content" id="list-content-area"><p class="list-status-text">正在初始化地圖...</p></div>
        </div>
      </div>
      <!-- Other pages remain the same -->
      <div id="random-page" class="page">
        <div class="page-header"><h2><i class="fa-solid fa-dice"></i>美食隨機選</h2><div class="placeholder"></div></div>
        <div id="random-picker-container">
            <div id="picker-arrow"></div>
            <div id="picker-wheel">
                <div id="picker-result">?</div>
            </div>
            <button class="btn" id="random-pick-btn" onclick="startRandomPick()">開始抽籤！</button>
            <p id="random-status-text" class="placeholder-text" style="background: none; margin-top: 20px;"></p>
        </div>
      </div>
      <div id="add-review-page" class="page">
        <div class="page-header"><h2 id="add-review-header"><i class="fa-solid fa-pencil"></i>新增美食評論</h2><div class="placeholder"></div></div>
        <div class="page-content">
            <div class="form-group"><label for="review-restaurant-name">餐廳名稱</label><input type="text" id="review-restaurant-name" placeholder="輸入吃過的餐廳"></div>
            <div class="form-group">
                <label for="review-meal-items">餐點項目</label>
                <button class="btn-scan-qr" onclick="openQrScanner()"><i class="fa-solid fa-qrcode"></i>掃描發票</button>
                <textarea id="review-meal-items" placeholder="吃了什麼好料？ (例如：小籠包、牛肉麵)
或點擊右上角掃描發票自動帶入"></textarea>
            </div>
            <div class="form-group"><label for="review-cost">花費金額 (NT$)</label><input type="number" id="review-cost" placeholder="大約花了多少錢？"></div>
             <div class="form-group">
                <label for="review-meal-type">用餐類型</label>
                <select id="review-meal-type">
                    <option value="other">其他</option>
                    <option value="breakfast">早餐</option>
                    <option value="lunch">午餐</option>
                    <option value="dinner">晚餐</option>
                </select>
            </div>
            <div class="form-group"><label>喜愛程度</label><div class="rating-hearts" id="review-rating" data-rating="0"><i class="fa-solid fa-heart" data-value="1"></i><i class="fa-solid fa-heart" data-value="2"></i><i class="fa-solid fa-heart" data-value="3"></i><i class="fa-solid fa-heart" data-value="4"></i><i class="fa-solid fa-heart" data-value="5"></i></div></div>
            <div class="form-group"><label for="review-content">評論內容 (會成為貼文)</label><textarea id="review-content" placeholder="分享你的心得、推薦或建議..."></textarea></div>
            <div class="form-group">
                <label>新增照片</label>
                <div class="photo-upload-container">
                    <div class="photo-upload-buttons">
                        <div id="btn-select-from-album" class="btn-upload"><i class="fa-solid fa-images"></i>從相簿選擇</div>
                        <div id="btn-open-camera" class="btn-upload"><i class="fa-solid fa-camera"></i>開啟相機</div>
                    </div>
                    <input type="file" id="photo-file-input" accept="image/*" multiple style="display: none;">
                    <input type="file" id="camera-file-input" accept="image/*" capture="environment" style="display: none;">
                    <div id="photo-preview-container"></div>
                </div>
            </div>
            <button class="btn" id="save-review-btn" onclick="saveReview()">儲存評論與貼文</button>
        </div>
      </div>
      <div id="challenge-page" class="page">
        <div class="page-header"><h2><i class="fa-solid fa-trophy"></i>美食挑戰榜</h2><div class="placeholder"></div></div>
        <div class="page-content" id="challenge-page-content">
            <div id="challenge-list-view">
                <div class="form-group" style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h4><i class="fa-solid fa-plus-circle" style="margin-right: 8px;"></i>建立新的挑戰</h4>
                    <input type="text" id="new-challenge-title" placeholder="挑戰主標題，例如：拉麵制霸戰" style="margin-bottom: 10px;">
                    <input type="text" id="new-challenge-subtitle" placeholder="次標題，例如：一個月內誰吃最多家！">
                    <button class="btn" style="margin-top: 10px;" onclick="createChallengeBoard()">建立挑戰榜</button>
                </div>
                <div id="challenge-boards-container" style="margin-top: 20px;"></div>
            </div>
            <div id="challenge-detail-view" style="display: none;"></div>
        </div>
      </div>
      <div id="profile-page" class="page">
        <div class="page-header">
          <div class="placeholder"></div>
          <h2 id="profile-header"><i class="fa-solid fa-user"></i>個人檔案</h2>
          <a id="profile-login-btn" class="header-action" style="display: none;" onclick="showPage('login-page')">登入/註冊</a>
          <a id="profile-logout-btn" class="header-action" style="display: none;" onclick="handleSignOut()">登出</a>
        </div>
        <div class="profile-tabs">
            <button class="tab-btn active" onclick="showProfileTab('accounting', this)">記帳顯示</button>
            <button class="tab-btn" onclick="showProfileTab('posts', this)">我的貼文</button>
            <button class="tab-btn" onclick="showProfileTab('favorites', this)">最愛餐廳</button>
            <button class="tab-btn" onclick="showProfileTab('friends', this)">好友名單</button>
        </div>
        <div class="page-content" style="padding-top:10px;">
            <div id="accounting-content" class="tab-content active"></div>
            <div id="posts-content" class="tab-content">
                <div class="sort-container" style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px; padding: 0;">
                    <label for="post-sort-order" style="font-size: 14px; color: var(--text-light); margin-right: 8px;">排序:</label>
                    <select id="post-sort-order" onchange="renderMyPosts()" style="border-radius: 15px; border: 1px solid #ddd; padding: 5px 10px; font-size: 14px; background-color: white;">
                        <option value="newest">由新到舊</option>
                        <option value="oldest">由舊到新</option>
                    </select>
                </div>
                <div id="posts-list-container"></div>
            </div>
            <div id="favorites-content" class="tab-content"></div>
            <div id="friends-content" class="tab-content">
                <div class="search-area" style="padding: 0 0 20px 0; border-bottom: none; background: transparent;">
                    <p style="font-size: 14px; color: var(--text-light); margin-bottom: 10px;">透過 Email 搜尋好友：</p>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="friend-search-input" class="search-input" placeholder="輸入好友Email..." style="border-radius: 8px; padding: 12px 15px; width: auto; flex-grow: 1;">
                        <button class="btn" style="padding: 0; width: 80px; height: 44px; flex-shrink: 0;" onclick="searchFriend()">搜尋</button>
                    </div>
                </div>
                <div id="friends-list-container"></div>
            </div>
        </div>
      </div>
      <div id="login-page" class="page">
        <div class="page-header">
          <i class="fa-solid fa-chevron-left header-back-btn" onclick="goBack()"></i>
          <h2>會員登入</h2>
          <div class="placeholder"></div>
        </div>
        <div class="page-content">
          <div class="auth-form-container">
            <input type="email" id="login-email-input" placeholder="電子郵件" required>
            <input type="password" id="login-password-input" placeholder="密碼" required>
            <div id="login-error" class="auth-error-message"></div>
            <button class="btn-auth primary" onclick="handleSignIn()">登入</button>
            <div class="auth-separator">或</div>
            <button class="btn-auth secondary" onclick="handleGoogleSignIn()">
              <i class="fab fa-google"></i> 使用 Google 登入
            </button>
            <div class="auth-switch-link" onclick="showPage('register-page')">
              還沒有帳號？點此註冊
            </div>
          </div>
        </div>
      </div>
      <div id="register-page" class="page">
         <div class="page-header">
          <i class="fa-solid fa-chevron-left header-back-btn" onclick="goBack()"></i>
          <h2>註冊新帳號</h2>
          <div class="placeholder"></div>
        </div>
        <div class="page-content">
          <div class="auth-form-container">
            <input type="text" id="register-name-input" placeholder="姓名或暱稱" required>
            <input type="email" id="register-email-input" placeholder="電子郵件" required>
            <input type="password" id="register-password-input" placeholder="設定密碼 (至少6位數)" required>
            <div id="register-error" class="auth-error-message"></div>
            <button class="btn-auth primary" onclick="handleRegister()">註冊送出</button>
            <div class="auth-switch-link" onclick="showPage('login-page')">
              已經有帳號了？點此登入
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="app-nav">
      <div class="nav-item active" onclick="showPage('map-page', this)"><i class="fa-solid fa-map-location-dot"></i><span>地圖</span></div>
      <div class="nav-item" onclick="showPage('random-page', this)"><i class="fa-solid fa-dice"></i><span>隨機選</span></div>
      <div class="nav-item" onclick="showPage('add-review-page', this)"><i class="fa-solid fa-plus-circle"></i><span>新增</span></div>
      <div class="nav-item" onclick="showPage('challenge-page', this)"><i class="fa-solid fa-trophy"></i><span>挑戰榜</span></div>
      <div class="nav-item" onclick="showPage('profile-page', this)"><i class="fa-solid fa-user"></i><span>個人</span></div>
    </footer>
  </div>

  <div id="qr-scanner-modal">
    <div class="qr-scanner-content">
        <span class="qr-scanner-close-btn" onclick="closeQrScanner()">×</span>
        <video id="qr-scanner-video" playsinline></video>
        <div id="scan-box"></div>
        <canvas id="qr-canvas" style="display: none;"></canvas>
        <p id="qr-status-text">請將發票 QR Code 對準掃描框</p>
    </div>
  </div>

  <script>
    // --- START: Full JavaScript Application Logic ---

    // --- 0. Layout and Environment Fixes ---

    // Function to fix the 100vh issue on mobile browsers
    function setVh() {
      let vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }

    // Set the value on initial load
    setVh();
    // Set the value on resize
    window.addEventListener('resize', setVh);


    // --- 1. Global Variables ---
    let map;
    let placesService;
    let infoWindow;
    let markers = [];
    let userLocation;
    let activeFilters = new Set();
    let pageHistory = ['map-page'];

    // --- 2. Map and Places Initialization ---
    function initMap() {
        const initialPosition = { lat: 25.0479, lng: 121.5171 }; // Taipei Main Station

        map = new google.maps.Map(document.getElementById("map"), {
            center: initialPosition,
            zoom: 15,
            disableDefaultUI: true,
            gestureHandling: 'greedy'
        });
        
        placesService = new google.maps.places.PlacesService(map);
        infoWindow = new google.maps.InfoWindow();

        map.addListener('idle', performSearch);
        
        getUserLocation();

        document.getElementById('list-content-area').innerHTML = `<p class="list-status-text">正在取得您的位置...</p>`;

        // Add event listeners for search input
        const searchInput = document.getElementById('search-input');
        const clearSearchBtn = document.getElementById('clear-search');
        
        searchInput.addEventListener('input', () => {
            clearSearchBtn.style.display = searchInput.value ? 'flex' : 'none';
        });
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                performSearch();
            }
        });

        // START: UI MODIFICATION - Initialize the resizer functionality
        initResizer();
        // END: UI MODIFICATION
    }

    function getUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    map.setCenter(userLocation);
                    document.getElementById('list-content-area').innerHTML = `<p class="list-status-text">地圖已移動到您的位置，正在搜尋附近餐廳...</p>`;
                    performSearch();
                },
                () => { handleLocationError(true); }
            );
        } else {
            handleLocationError(false);
        }
    }

    function handleLocationError(browserHasGeolocation) {
        const statusText = browserHasGeolocation
            ? "定位失敗。請允許存取您的位置。"
            : "您的瀏覽器不支援定位功能。";
        document.getElementById('list-content-area').innerHTML = `<p class="list-status-text">${statusText} 將以預設地點搜尋。</p>`;
        performSearch();
    }

    function centerOnUserGPS() {
        if (userLocation) {
            map.setCenter(userLocation);
            map.setZoom(16);
        } else {
            alert("無法取得您的目前位置，請先開啟定位權限。");
            getUserLocation();
        }
    }

    // START: UI MODIFICATION - Added the entire resizer logic
    // --- 3. Panel Resizer Logic ---
    function initResizer() {
        const resizer = document.getElementById('resizer');
        const mapPanel = document.getElementById('map-panel');
        const listPanel = document.getElementById('list-panel');
        const container = document.getElementById('map-page');

        let isResizing = false;

        const startResize = (e) => {
            isResizing = true;
            container.style.cursor = 'ns-resize';
            document.addEventListener('mousemove', onResize);
            document.addEventListener('mouseup', stopResize);
            document.addEventListener('touchmove', onResize, { passive: false });
            document.addEventListener('touchend', stopResize);
            e.preventDefault();
        };

        const onResize = (e) => {
            if (!isResizing) return;
            const clientY = e.clientY || e.touches[0].clientY;
            const containerRect = container.getBoundingClientRect();
            
            let newMapHeight = clientY - containerRect.top;
            
            // Constrain the resize
            const minHeight = containerRect.height * 0.20; // 20%
            const maxHeight = containerRect.height * 0.80; // 80%
            if (newMapHeight < minHeight) newMapHeight = minHeight;
            if (newMapHeight > maxHeight) newMapHeight = maxHeight;

            const mapFlex = newMapHeight;
            const listFlex = containerRect.height - newMapHeight;

            mapPanel.style.flex = `0 1 ${mapFlex}px`;
            listPanel.style.flex = `0 1 ${listFlex}px`;
        };

        const stopResize = () => {
            isResizing = false;
            container.style.cursor = 'default';
            document.removeEventListener('mousemove', onResize);
            document.removeEventListener('mouseup', stopResize);
            document.removeEventListener('touchmove', onResize);
            document.removeEventListener('touchend', stopResize);
        };
        
        resizer.addEventListener('mousedown', startResize);
        resizer.addEventListener('touchstart', startResize, { passive: false });
    }
    // END: UI MODIFICATION


    // --- 4. Search and Filter Logic ---
    function performSearch() {
        if(!map.getBounds()) return; // Don't search if map bounds are not ready
        
        const request = {
            bounds: map.getBounds(),
            keyword: buildSearchQuery()
        };

        document.getElementById('list-content-area').innerHTML = `<div class="loading-spinner"></div>`;
        
        placesService.nearbySearch(request, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                clearMarkers();
                displayResults(results);
            } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                 document.getElementById('list-content-area').innerHTML = `<p class="list-status-text">在此範圍內找不到符合條件的餐廳。</p>`;
            } else {
                console.error("PlacesService error:", status);
                document.getElementById('list-content-area').innerHTML = `<p class="list-status-text">搜尋時發生錯誤，請稍後再試。</p>`;
            }
        });
    }

    function buildSearchQuery() {
        const searchInput = document.getElementById('search-input').value.trim();
        const filterKeywords = Array.from(activeFilters);
        return [searchInput, ...filterKeywords].filter(Boolean).join(' ');
    }

    function applyFilter(element) {
        const filterValue = element.getAttribute('data-filter-value');
        element.classList.toggle('active');
        if (activeFilters.has(filterValue)) {
            activeFilters.delete(filterValue);
        } else {
            activeFilters.add(filterValue);
        }
        performSearch();
    }

    function clearSearch() {
        const searchInput = document.getElementById('search-input');
        searchInput.value = "";
        document.getElementById('clear-search').style.display = 'none';
        performSearch();
    }


    // --- 5. Display Results ---
    function displayResults(places) {
        const listContent = document.getElementById('list-content-area');
        listContent.innerHTML = "";

        places.forEach(place => {
            if (!place.geometry || !place.geometry.location) return;
            
            const marker = new google.maps.Marker({
                map,
                position: place.geometry.location,
                title: place.name,
                animation: google.maps.Animation.DROP,
            });
            markers.push(marker);

            const listItem = document.createElement('div');
            listItem.className = 'list-item';
            listItem.setAttribute('data-place-id', place.place_id);

            let distanceText = '';
            if (userLocation) {
                const distance = google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(userLocation.lat, userLocation.lng),
                    place.geometry.location
                );
                distanceText = distance > 1000 ? `${(distance / 1000).toFixed(1)} km` : `${Math.round(distance)} m`;
            }
            
            listItem.innerHTML = `
                <i class="item-icon fas fa-utensils"></i>
                <div class="item-info">
                    <div class="item-name">${place.name}</div>
                    <div class="item-details">
                        <span class="open-status ${place.opening_hours?.isOpen() ? 'open' : 'closed'}">
                            ${place.opening_hours ? (place.opening_hours.isOpen() ? '營業中' : '休息中') : '營業時間未知'}
                        </span>
                         •  評分: ${place.rating || '無'} (${place.user_ratings_total || 0})
                    </div>
                    <div class="item-address">${place.vicinity}</div>
                </div>
                <div class="item-distance">${distanceText}</div>
            `;
            listContent.appendChild(listItem);

            const handleItemClick = () => {
                document.querySelectorAll('.list-item').forEach(item => item.classList.remove('is-selected'));
                listItem.classList.add('is-selected');
                map.panTo(place.geometry.location);
                infoWindow.setContent(`
                    <div class="info-window-content">
                        <h4>${place.name}</h4>
                        <p><i class="fas fa-map-marker-alt"></i> ${place.vicinity}</p>
                        <p><i class="fas fa-star"></i> 評分: ${place.rating || '無'}</p>
                    </div>
                `);
                infoWindow.open({ anchor: marker, map });
            };

            marker.addListener('click', handleItemClick);
            listItem.addEventListener('click', handleItemClick);
        });
    }

    function clearMarkers() {
        markers.forEach(marker => marker.setMap(null));
        markers = [];
    }


    // --- 6. Page Navigation ---
    function showPage(pageId, navElement = null) {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.add('active');
        }
        
        if (navElement) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            navElement.classList.add('active');
        }

        if (pageHistory[pageHistory.length - 1] !== pageId) {
            pageHistory.push(pageId);
        }
        
        if (pageId === 'profile-page') {
            console.log("Switched to profile page.");
        }
    }

    function goBack() {
        if (pageHistory.length > 1) {
            pageHistory.pop();
            const previousPageId = pageHistory[pageHistory.length - 1];
            showPage(previousPageId);

            const navItem = document.querySelector(`.nav-item[onclick*="'${previousPageId}'"]`);
            if(navItem) {
                 document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                 navItem.classList.add('active');
            }
        }
    }

    // --- 7. Placeholder functions ---
    function startRandomPick() { alert("隨機選功能正在開發中！"); }
    function openQrScanner() { alert("掃描功能正在開發中！"); }
    function closeQrScanner() { document.getElementById('qr-scanner-modal').style.display = 'none'; }
    function saveReview() { alert("儲存評論功能正在開發中！"); }
    function createChallengeBoard() { alert("建立挑戰榜功能正在開發中！"); }
    function handleSignOut() { alert("登出功能正在開發中！"); }
    function handleSignIn() { alert("登入功能正在開發中！"); }
    function handleGoogleSignIn() { alert("Google 登入功能正在開發中！"); }
    function handleRegister() { alert("註冊功能正在開發中！"); }
    function searchFriend() { alert("搜尋好友功能正在開發中！"); }
    function renderMyPosts() { console.log("Rendering my posts..."); }

    function showProfileTab(tabName, buttonElement) {
        document.querySelectorAll('.profile-tabs .tab-btn').forEach(btn => btn.classList.remove('active'));
        buttonElement.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabName}-content`).classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', () => {
        const firstTab = document.querySelector('.profile-tabs .tab-btn');
        if (firstTab) {
            showProfileTab('accounting', firstTab);
        }
    });

  </script>
  
  <script
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places,geometry&callback=initMap"
    async
  ></script>
</body>
</html>
