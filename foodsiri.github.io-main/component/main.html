<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>FoodieApp - Firestore Edition</title>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />

    <!-- OpenLayers -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>

    <!-- 自訂 CSS -->
    <link rel="stylesheet" href="../assets/css/style.css" />

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>




    <!-- 其他套件 -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>


</head>

<body>
  <div class="app-container">
    <main>
      <div id="map-page" class="page active">
        <div id="map-panel">
          <div id="map"></div>
          <button class="location-btn" onclick="centerOnUserGPS()"><i class="fas fa-location-arrow"></i></button>
        </div>
        <div id="list-panel">
          <div class="search-area">
            <input type="text" id="search-input" class="search-input" placeholder="搜尋餐廳或地點...">
            <button class="clear-search-btn" id="clear-search" onclick="clearSearch()">×</button>
          </div>
          <div class="filter-tags-container">
            <button class="filter-tag active" data-filter-type="sort" data-filter-value="全部" onclick="applyFilter(this)">全部</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="日式料理" onclick="applyFilter(this)">日式</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="火鍋" onclick="applyFilter(this)">火鍋</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="咖啡廳" onclick="applyFilter(this)">咖啡廳</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="義大利麵" onclick="applyFilter(this)">義式</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="早午餐" onclick="applyFilter(this)">早午餐</button>
            <button class="filter-tag" data-filter-type="keyword" data-filter-value="小吃" onclick="applyFilter(this)">小吃</button>
          </div>
          <div class="list-content" id="list-content-area"><p class="list-status-text">正在初始化地圖...</p></div>
        </div>
      </div>

      <div id="random-page" class="page">
        <div class="page-header"><h2><i class="fa-solid fa-dice"></i>美食隨機選</h2><div class="placeholder"></div></div>
        <div id="random-picker-container">
            
            <div id="picker-wheel">
                <div id="picker-result">?</div>
                 
            </div>
            <div id="picker-arrow"></div>
            <button class="btn" id="random-pick-btn" onclick="startRandomPick()">開始抽籤！</button>
            <p id="random-status-text" class="placeholder-text" style="background: none; margin-top: 20px;"></p>
        </div>
      </div>
      <div id="add-review-page" class="page">
        <div class="page-header"><h2 id="add-review-header"><i class="fa-solid fa-pencil"></i>新增美食評論</h2><div class="placeholder"></div></div>
        <div class="page-content">
            <div class="form-group"><label for="review-restaurant-name">餐廳名稱</label><input type="text" id="review-restaurant-name" placeholder="輸入吃過的餐廳"></div>
            <div class="form-group">
                 <label for="review-date">用餐日期：</label>
                <input type="date" id="review-date">
                <label for="review-meal-items">餐點項目</label>
                <button class="btn-scan-qr" onclick="openQrScanner()"><i class="fa-solid fa-qrcode"></i>掃描發票</button>
                <textarea id="review-meal-items" placeholder="吃了什麼好料？ (例如：小籠包、牛肉麵)
或點擊右上角掃描發票自動帶入"></textarea>
            </div>
            <div class="form-group"><label for="review-cost">花費金額 (NT$)</label><input type="number" id="review-cost" placeholder="大約花了多少錢？"></div>
             <div class="form-group">
                <label for="review-meal-type">用餐類型</label>
                <select id="review-meal-type">
                    <option value="breakfast">早餐</option>
                    <option value="lunch">午餐</option>
                    <option value="dinner">晚餐</option>
                    <option value="other">其他</option>
                </select>
            </div>
            <div class="form-group"><label>喜愛程度</label><div class="rating-hearts" id="review-rating" data-rating="0"><i class="fa-solid fa-heart" data-value="1"></i><i class="fa-solid fa-heart" data-value="2"></i><i class="fa-solid fa-heart" data-value="3"></i><i class="fa-solid fa-heart" data-value="4"></i><i class="fa-solid fa-heart" data-value="5"></i></div></div>
            <div class="form-group"><label for="review-content">評論內容 (會成為貼文)</label><textarea id="review-content" placeholder="分享你的心得、推薦或建議..."></textarea></div>
            <div class="form-group">
                <label>新增照片</label>
                <div class="photo-upload-container">
                    <div class="photo-upload-buttons">
                        <div id="btn-select-from-album" class="btn-upload"><i class="fa-solid fa-images"></i>從相簿選擇</div>
                        <div id="btn-open-camera" class="btn-upload"><i class="fa-solid fa-camera"></i>開啟相機</div>
                    </div>
                    <input type="file" id="photo-file-input" accept="image/*" multiple style="display: none;">
                    <input type="file" id="camera-file-input" accept="image/*" capture="environment" style="display: none;">
                    <div id="photo-preview-container"></div>
                </div>
            </div>
            <button class="btn" id="save-review-btn" onclick="saveReview()">儲存評論與貼文</button>
        </div>
      </div>
      <div id="challenge-page" class="page">
        <div class="page-header"><h2><i class="fa-solid fa-trophy"></i>美食挑戰榜</h2><div class="placeholder"></div></div>
        <div class="page-content" id="challenge-page-content">
            <div id="challenge-list-view">
                <div class="form-group" style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h4><i class="fa-solid fa-plus-circle" style="margin-right: 8px;"></i>建立新的挑戰</h4>
                    <input type="text" id="new-challenge-title" placeholder="挑戰主標題，例如：拉麵制霸戰" style="margin-bottom: 10px;">
                    <input type="text" id="new-challenge-subtitle" placeholder="次標題，例如：一個月內誰吃最多家！">
                    <button class="btn" style="margin-top: 10px;" onclick="createChallengeBoard()">建立挑戰榜</button>
                </div>
                <div id="challenge-boards-container" style="margin-top: 20px;"></div>
            </div>
            <div id="challenge-detail-view" style="display: none;"></div>
        </div>
      </div>
      <div id="profile-page" class="page">
        <div class="page-header">
          <div class="placeholder"></div>
          <h2 id="profile-header"><i class="fa-solid fa-user"></i>個人檔案</h2>
          <a id="profile-login-btn" class="header-action" style="display: none;" onclick="showPage('login-page')">登入/註冊</a>
          <a id="profile-logout-btn" class="header-action" style="display: none;" onclick="handleSignOut()">登出</a>
        </div>
        <div class="profile-tabs">
            <button class="tab-btn active" onclick="showProfileTab('accounting', this)">記帳顯示</button>
            <button class="tab-btn" onclick="showProfileTab('posts', this)">我的貼文</button>
            <button class="tab-btn" onclick="showProfileTab('favorites', this)">最愛餐廳</button>
            <button class="tab-btn" onclick="showProfileTab('friends', this)">好友名單</button>
        </div>
        <div class="page-content" style="padding-top:10px;">
            <div id="accounting-content" class="tab-content active"></div>
            <div id="posts-content" class="tab-content">
                <div class="sort-container" style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px; padding: 0;">
                    <label for="post-sort-order" style="font-size: 14px; color: var(--text-light); margin-right: 8px;">排序:</label>
                    <select id="post-sort-order" onchange="renderMyPosts()" style="border-radius: 15px; border: 1px solid #ddd; padding: 5px 10px; font-size: 14px; background-color: white;">
                        <option value="newest">由新到舊</option>
                        <option value="oldest">由舊到新</option>
                    </select>
                </div>
                <div id="posts-list-container"></div>
            </div>
            <div id="favorites-content" class="tab-content"></div>
            <div id="friends-content" class="tab-content">
                <div class="search-area" style="padding: 0 0 20px 0; border-bottom: none; background: transparent;">
                    <p style="font-size: 14px; color: var(--text-light); margin-bottom: 10px;">透過 Email 搜尋好友：</p>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="friend-search-input" class="search-input" placeholder="輸入好友的 Email..." style="border-radius: 8px; padding: 12px 15px; width: auto; flex-grow: 1;">
                        <button class="btn" style="padding: 0; width: 80px; height: 44px; flex-shrink: 0;" onclick="searchFriend()">搜尋</button>
                    </div>
                </div>
                <div id="friends-list-container"></div>
            </div>
        </div>
      </div>
      <div id="login-page" class="page">
        <div class="page-header">
          <i class="fa-solid fa-chevron-left header-back-btn" onclick="goBack()"></i>
          <h2>會員登入</h2>
          <div class="placeholder"></div>
        </div>
        <div class="page-content">
          <div class="auth-form-container">
            <input type="email" id="login-email-input" placeholder="電子郵件" required>
            <input type="password" id="login-password-input" placeholder="密碼" required>
            <div id="login-error" class="auth-error-message"></div>
            <button class="btn-auth primary" onclick="handleSignIn()">登入</button>
            <div class="auth-separator">或</div>

            <div class="auth-switch-link" onclick="showPage('register-page')">
              還沒有帳號？點此註冊
            </div>
          </div>
        </div>
      </div>
      <div id="register-page" class="page">
         <div class="page-header">
          <i class="fa-solid fa-chevron-left header-back-btn" onclick="goBack()"></i>
          <h2>註冊新帳號</h2>
          <div class="placeholder"></div>
        </div>
        <div class="page-content">
          <div class="auth-form-container">
            <input type="text" id="register-name-input" placeholder="姓名或暱稱" required>
            <input type="email" id="register-email-input" placeholder="電子郵件" required>
            <input type="password" id="register-password-input" placeholder="設定密碼 (至少6位數)" required>
            <div id="register-error" class="auth-error-message"></div>
            <button class="btn-auth primary" onclick="handleRegister()">註冊送出</button>
            <div class="auth-switch-link" onclick="showPage('login-page')">
              已經有帳號了？點此登入
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="app-nav">
      <div class="nav-item active" onclick="showPage('map-page', this)"><i class="fa-solid fa-map-location-dot"></i><span>地圖</span></div>
      <div class="nav-item" onclick="showPage('random-page', this)"><i class="fa-solid fa-dice"></i><span>隨機選</span></div>
      <div class="nav-item" onclick="showPage('add-review-page', this)"><i class="fa-solid fa-plus-circle"></i><span>新增</span></div>
      <div class="nav-item" onclick="showPage('challenge-page', this)"><i class="fa-solid fa-trophy"></i><span>挑戰榜</span></div>
      <div class="nav-item" onclick="showPage('profile-page', this)"><i class="fa-solid fa-user"></i><span>個人</span></div>
    </footer>
  </div>

  <div id="qr-scanner-modal">
    <div class="qr-scanner-content">
        <span class="qr-scanner-close-btn" onclick="closeQrScanner()">×</span>
        <video id="qr-scanner-video" playsinline></video>
        <div id="scan-box"></div>
        <canvas id="qr-canvas" style="display: none;"></canvas>
        <p id="qr-status-text">請將發票 QR Code 對準掃描框</p>
    </div>
  </div>

  <script>
    // --- 全域變數定義 ---
    var currentUser = null;
        // --- 模擬登入使用者 ---
    currentUser = {
        uid: 'user_001',
        displayName: '測試使用者',
        email: 'test@example.com'
    };
    var  userGpsPosition, userMarker, restaurantMarkers, debounceTimer, placesService, autocomplete, infoWindow, directionsService, directionsRenderer;
    var isMapReady = false;
    var pageHistory = [];
    var auth, db;
    var selectedPlaceForReview = null;
    var editingPostId = null;
    var viewingChallengeId = null;
    var activeFilter = { type: 'sort', value: 'distance' };

    // --- QR Code 掃描器相關變數 ---
    var qrModal, video, canvasElement, canvas, qrStatusText, scanBox, stream, animationFrameId;


    // --- Favorite Functions ---
    window.toggleFavorite = async function(place, element) {
        if (!currentUser) { alert('請先登入才能使用此功能！'); return; }

        const favRef = db.collection('users').doc(currentUser.uid).collection('favorites').doc(place.place_id);
        const isCurrentlyFav = await isFavorite(place.place_id);

        try {
            if (isCurrentlyFav) {
                await favRef.delete();
            } else {
                await favRef.set({ name: place.name, place_id: place.place_id });
            }

            if (element) {
                element.classList.toggle('is-favorite', !isCurrentlyFav);
                element.querySelector('i').className = !isCurrentlyFav ? 'fa-solid fa-heart' : 'fa-regular fa-heart';
            }

            if(document.getElementById('favorites-content').classList.contains('active')) {
                await renderFavoriteRestaurants();
            }
            if(document.getElementById('random-page').classList.contains('active')) {
                await updateRandomPageStatus();
            }

        } catch (error) {
            console.error("Error toggling favorite:", error);
            alert("操作失敗，請稍後再試。");
        }
    }

    // --- 內部專用函式 ---
    async function setupLoggedInUI(user) { document.getElementById('profile-login-btn').style.display = 'none'; document.getElementById('profile-logout-btn').style.display = 'block'; const userName = user.displayName || user.email.split('@')[0]; document.getElementById('profile-header').innerHTML = `<i class="fa-solid fa-user"></i> ${userName}`; await renderProfilePage(); }
    async function setupLoggedOutUI() { document.getElementById('profile-login-btn').style.display = 'block'; document.getElementById('profile-logout-btn').style.display = 'none'; document.getElementById('profile-header').innerHTML = `<i class="fa-solid fa-user"></i> 個人檔案`; await renderProfilePage(); await renderChallengePage(); await updateRandomPageStatus(); }
    async function renderProfilePage() { const activeTabBtn = document.querySelector('#profile-page .tab-btn.active'); if(activeTabBtn) { await window.showProfileTab(activeTabBtn.getAttribute('onclick').match(/'([^']+)'/)[1], activeTabBtn); } else { await window.showProfileTab('accounting', document.querySelector('#profile-page .tab-btn')); } }
    const loggedOutPlaceholder = (message) => `<p class="placeholder-text">請先<a href="#" onclick="window.showPage('login-page')">登入</a>${message}</p>`;







    // --- Firestore Data Access Functions ---
    async function getPosts() { if (!currentUser) return []; try { const snapshot = await db.collection('users').doc(currentUser.uid).collection('posts').get(); return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); } catch (error) { console.error("Error getting posts: ", error); return []; } }
    async function getChallengeBoards() { if (!currentUser) return []; try { const snapshot = await db.collection('challenges').where('participantIds', 'array-contains', currentUser.uid).get(); return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); } catch (error) { console.error("Error getting challenge boards: ", error); return []; } }
    async function getFavorites() { if (!currentUser) return []; try { const snapshot = await db.collection('users').doc(currentUser.uid).collection('favorites').get(); return snapshot.docs.map(doc => doc.data()); } catch (error) { console.error("Error getting favorites: ", error); return []; } }
    async function isFavorite(place_id) { if (!currentUser) return false; try { const doc = await db.collection('users').doc(currentUser.uid).collection('favorites').doc(place_id).get(); return doc.exists; } catch (error) { console.error("Error checking favorite status: ", error); return false; } }
    async function getFriends() { if (!currentUser) return []; try { const snapshot = await db.collection('users').doc(currentUser.uid).collection('friends').get(); return snapshot.docs.map(doc => doc.data()); } catch (error) { console.error("Error getting friends: ", error); return []; } }

    function createUserMarker(position) { const userIcon = { path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z", fillColor: '#4285F4', fillOpacity: 1, strokeWeight: 0, scale: 1.5, anchor: new google.maps.Point(12, 24) }; if (userMarker) { userMarker.setPosition(position); } else { userMarker = new google.maps.Marker({ position, map, title: "您的位置", icon: userIcon, zIndex: 1000 }); } }
    function setupMapListeners() { map.addListener("idle", () => { if (!directionsRenderer.getDirections() || directionsRenderer.getDirections().routes.length === 0) { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => searchNearbyRestaurants(map.getCenter()), 500); } }); map.addListener("click", (e) => { if (e.placeId) { e.stop(); } window.clearSearch(); }); }
    function setupAutocomplete() {
        const input = document.getElementById('search-input');
        const clearBtn = document.getElementById('clear-search');
        autocomplete = new google.maps.places.Autocomplete(input, { componentRestrictions: { country: 'tw' }, types: ['establishment', 'geocode'], fields: ['place_id', 'geometry', 'name', 'formatted_address', 'vicinity', 'business_status', 'types'] });
        input.addEventListener('input', () => { clearBtn.style.display = input.value ? 'flex' : 'none'; });
        autocomplete.addListener('place_changed', () => { const place = autocomplete.getPlace(); if (place.geometry && place.geometry.location) { window.clearSearch(true); handlePlaceSelection(place); } });
    }
    function updateUserGPS() { if (!isMapReady) return; document.getElementById("list-content-area").innerHTML = `<p class="list-status-text">正在獲取您的位置...</p>`; if (navigator.geolocation) { navigator.geolocation.getCurrentPosition( (position) => { userGpsPosition = { lat: position.coords.latitude, lng: position.coords.longitude }; createUserMarker(userGpsPosition); window.centerOnUserGPS(); }, () => searchNearbyRestaurants(map.getCenter()) ); } else { searchNearbyRestaurants(map.getCenter()); } }

    function searchNearbyRestaurants(location) {
        if (!isMapReady) return;
        const listContainer = document.getElementById("list-content-area");
        listContainer.innerHTML = `<p class="list-status-text">正在搜尋附近餐廳...</p>`;
        clearRestaurantMarkers();

        const request = {
            location: location,
            radius: 1500,
            type: 'restaurant'
        };

        if (activeFilter.type === 'keyword' && activeFilter.value) {
            request.keyword = activeFilter.value;
            listContainer.innerHTML = `<p class="list-status-text">正在搜尋「${activeFilter.value}」...</p>`;
        }

        placesService.nearbySearch(request, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                processAndDisplayResults(results, location);
            } else {
                listContainer.innerHTML = `<p class="list-status-text">此區域找不到符合條件的餐廳</p>`;
            }
        });
    }

    function processAndDisplayResults(places, center) { const listContainer = document.getElementById("list-content-area"); const placesWithDistance = places.map((place) => ({ ...place, distance: google.maps.geometry.spherical.computeDistanceBetween(center, place.geometry.location) })); placesWithDistance.sort((a, b) => a.distance - b.distance); listContainer.innerHTML = ""; placesWithDistance.forEach((place) => { addRestaurantMarker(place); addRestaurantToList(place); }); }

    function addRestaurantMarker(place) {
        const markerColor = (activeFilter.type === 'keyword' && categoryKeywords[activeFilter.value])
                            ? categoryKeywords[activeFilter.value].color
                            : getCategoryColor(place);

        const marker = new google.maps.Marker({
            position: place.geometry.location,
            map: map,
            title: place.name,
            icon: {
                path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z",
                fillColor: markerColor,
                fillOpacity: 1,
                strokeWeight: 0,
                scale: 1.5,
                anchor: new google.maps.Point(12, 24)
            }
        });

        marker.markerColor = markerColor;

        marker.addListener('click', (e) => {
            e.domEvent.stopPropagation();
            handlePlaceSelection(place);
        });
        marker.place_id = place.place_id;
        restaurantMarkers.push(marker);
    }

    function addRestaurantToList(place, routeInfo = null, details = null) {
        const listContainer = document.getElementById("list-content-area");
        const item = document.createElement("div");
        item.className = "list-item";
        item.dataset.placeId = place.place_id;
        let openStatusHtml = "";
        if (place.opening_hours && typeof place.opening_hours.open_now !== 'undefined') {

        }
        if (place.business_status === "CLOSED_PERMANENTLY") {
            openStatusHtml = `<span class="open-status closed">永久停業</span>`;
        } else if (details && details.opening_hours) {

            const isOpen = place.opening_hours.open_now;
            openStatusHtml = isOpen ? `<span class="open-status open">營業中</span>` : `<span class="open-status closed">休息中</span>`;
        }
        const ratingHtml = place.rating ? `<i class="fas fa-star" style="color: #ffd700;"></i> ${place.rating}` : `無評分`;

        const detailsText = [ratingHtml, openStatusHtml].filter(Boolean).join(' · ');
        const addressHtml = `<div class="item-address">${place.vicinity || place.formatted_address || ''}</div>`;
        let distanceHtml = '';
        if (routeInfo && routeInfo.driving) { distanceHtml = `<div class="item-distance"><i class="fas fa-car"></i> ${routeInfo.driving.distance}</div>`; } else if (place.distance) { distanceHtml = `<div class="item-distance">${Math.round(place.distance)}m</div>`; }
        item.innerHTML = `<div class="item-icon"><i class="fas fa-utensils"></i></div><div class="item-info"><div class="item-name">${place.name}</div>${addressHtml}<div class="item-details">${detailsText}</div></div>${distanceHtml}`;
        item.onclick = (e) => { e.stopPropagation(); handlePlaceSelection(place); };
        listContainer.appendChild(item);
    }

    function handlePlaceSelection(place) {
        const marker = restaurantMarkers.find((m) => m.place_id === place.place_id);
        const markerColor = marker ? marker.markerColor : getCategoryColor(place);

        if (marker) {
            map.panTo(marker.getPosition());
        } else {
            map.panTo(place.geometry.location);
        }
        highlightListItem(place.place_id, true);
        initiateRouteAndDetailsFetch(place, markerColor);
    }

    async function initiateRouteAndDetailsFetch(place, color) {
        if (!userGpsPosition || !place.geometry || !place.geometry.location) {
            await showPlaceDetailsInWindow(place, null, {});
            return;
        }
        document.getElementById('clear-search').style.display = 'flex';
        clearRestaurantMarkers();
        const [drivingResult, walkingResult, placeDetails] = await Promise.all([
            getRoutePromise(userGpsPosition, place.geometry.location, google.maps.TravelMode.DRIVING),
            getRoutePromise(userGpsPosition, place.geometry.location, google.maps.TravelMode.WALKING),
            getPlaceDetailsPromise(place.place_id)
        ]);
        const routeInfo = { driving: drivingResult, walking: walkingResult };
        if (drivingResult) {
            directionsRenderer.setDirections(drivingResult.response);
            map.fitBounds(drivingResult.response.routes[0].bounds);
        } else {
            directionsRenderer.setDirections({ routes: [] });
        }

        const finalPlaceDataForColor = { ...place, types: (placeDetails && placeDetails.types) || place.types || [] };
        const markerColor = color || getCategoryColor(finalPlaceDataForColor);

        const destinationMarker = new google.maps.Marker({
            position: place.geometry.location,
            map: map,
            title: place.name,
            icon: {
                path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z",
                fillColor: markerColor,
                fillOpacity: 1,
                strokeWeight: 0,
                scale: 1.5,
                anchor: new google.maps.Point(12, 24)
            }
        });

        destinationMarker.addListener('click', (e) => {
            e.stopPropagation();
            handlePlaceSelection(place);
        });
        restaurantMarkers.push(destinationMarker);
        await showPlaceDetailsInWindow(place, destinationMarker, routeInfo, placeDetails);
        showSinglePlaceResult(place, routeInfo, placeDetails);
    }

    function getRoutePromise(origin, destination, travelMode) { return new Promise(resolve => { const request = { origin, destination, travelMode }; directionsService.route(request, (res, stat) => { if (stat === 'OK') { const leg = res.routes[0].legs[0]; resolve({ distance: leg.distance.text, duration: leg.duration.text, response: res }); } else { resolve(null); } }); }); }

    function getPlaceDetailsPromise(placeId) {
        const request = { placeId: placeId, fields: ['name', 'rating', 'formatted_phone_number', 'opening_hours', 'vicinity', 'business_status', 'formatted_address', 'place_id', 'types'] };
        return new Promise(resolve => {
            placesService.getDetails(request, (details, status) => { if (status === google.maps.places.PlacesServiceStatus.OK && details) { resolve(details); } else { resolve(null); } });
        });
    }

    function showSinglePlaceResult(place, routeInfo, placeDetails) { const listContainer = document.getElementById("list-content-area"); listContainer.innerHTML = ""; addRestaurantToList(place, routeInfo, placeDetails); highlightListItem(place.place_id); }
    async function showPlaceDetailsInWindow(place, marker, routeInfo = {}, details = null) {
        const isFav = await isFavorite(place.place_id);
        const favIconClass = isFav ? 'fa-solid fa-heart' : 'fa-regular fa-heart';
        const favBtnClass = isFav ? 'is-favorite' : '';
        const placeDataStr = JSON.stringify({ name: place.name, place_id: place.place_id }).replace(/"/g, "'");

        let content = `<div class="info-window-content">
            <h4>
                <span>${place.name}</span>
                <button class="favorite-btn ${favBtnClass}" onclick="toggleFavorite(${placeDataStr}, this)">
                    <i class="${favIconClass}"></i>
                </button>
            </h4>`;

        const finalDetails = details || place;
        const address = finalDetails.formatted_address || finalDetails.vicinity;
        if (address) content += `<p><i class="fas fa-map-marker-alt"></i><span>${address}</span></p>`;
        if (routeInfo.driving) { content += `<p><i class="fas fa-car"></i><span>${routeInfo.driving.distance} (${routeInfo.driving.duration})</span></p>`; }
        if (routeInfo.walking) { content += `<p><i class="fas fa-walking"></i><span>${routeInfo.walking.distance} (${routeInfo.walking.duration})</span></p>`; }
        if (details && details.formatted_phone_number) { content += `<p><i class="fas fa-phone"></i><span>${details.formatted_phone_number}</span></p>`; }
        if (details && details.business_status === "CLOSED_PERMANENTLY") {
            content += `<p><i class="fas fa-store-slash"></i><span style="color: var(--danger-color); font-weight: bold;">永久停業</span></p>`;
        } else if (details && details.opening_hours) {
            const isOpen = place.opening_hours.open_now;
            const statusText = isOpen ? "營業中" : "休息中";
            const color = isOpen ? "var(--success-color)" : "var(--danger-color)";
            content += `<p><i class="fas fa-clock"></i><span style="color: ${color}; font-weight: bold;">${statusText}</span></p>`;
        } else {
            content += `<p><i class="fas fa-clock"></i><span>營業時間資訊不明</span></p>`;
        }
        selectedPlaceForReview = { name: place.name };
        const reviewLinkHtml = `<p style="margin-top: 10px; text-align: center;"><a href="#" onclick="window.goToReviewPageFromMap(); return false;" style="text-decoration:none; background-color: var(--primary-color); color: white; padding: 6px 12px; border-radius: 5px; font-weight: 500; font-size:14px; display: inline-block;"><i class="fa-solid fa-pencil" style="color: white; margin-right: 5px;"></i>新增評論</a></p>`;
        content += reviewLinkHtml;
        content += '</div>';
        infoWindow.setContent(content);
        infoWindow.open({ anchor: marker, map: map, shouldFocus: false });
    }
    function highlightListItem(placeId, scroll) { document.querySelectorAll(".list-item.is-selected").forEach((el) => el.classList.remove("is-selected")); if(placeId) { const listItem = document.querySelector(`.list-item[data-place-id="${placeId}"]`); if (listItem) { listItem.classList.add("is-selected"); if (scroll) { listItem.scrollIntoView({ behavior: "smooth", block: "center" }); } } } }
    function clearRestaurantMarkers() { restaurantMarkers.forEach((marker) => marker.setMap(null)); restaurantMarkers = []; }



    async function updateRandomPageStatus() {
        const statusText = document.getElementById('random-status-text');
        const pickerResult = document.getElementById('picker-result');

        statusText.style.visibility = 'visible';
        statusText.classList.add('placeholder-text');

        if (!currentUser) {
            statusText.textContent = '登入後，系統會從您的「最愛餐廳」中隨機抽選！';
            drawPickerWheel([]);
            if(pickerResult) pickerResult.textContent = "?";
            return;
        }

        const favorites = await getFavorites();
        pickerResult.textContent = "?";
        pickerResult.style.color = 'var(--primary-color)';

        drawPickerWheel(favorites);

        if (favorites.length === 0) {
            statusText.innerHTML = "您還沒有加入任何最愛餐廳！<br>請到地圖上點擊♡來加入吧！";
        } else if (favorites.length < 2) {
            statusText.textContent = `目前有 ${favorites.length} 家餐廳。至少需要2家才能開始抽籤喔！`;
        }
        else {
            statusText.textContent = `目前有 ${favorites.length} 家餐廳在您的最愛清單中。`;
        }
    }

    function handleRatingClick(e) { const rating = e.target.dataset.value; document.getElementById('review-rating').dataset.rating = rating; updateHeartDisplay(rating); }
    function handleRatingHover(e) { updateHeartDisplay(e.target.dataset.value); }
    function handleRatingMouseout() { updateHeartDisplay(document.getElementById('review-rating').dataset.rating); }
    function updateHeartDisplay(rating) { document.querySelectorAll('.rating-hearts .fa-heart').forEach(heart => { heart.classList.toggle('active', heart.dataset.value <= rating); }); }












  </script>

  <!-- 你自己的 JS 檔（放在最後）-->
  <script src="js/map.js"></script>
  <script src="js/challenge.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/review.js"></script>
  <script src="js/randompick.js"></script>
  <script src="js/navigation.js"></script>
  <script src="js/QRcode.js"></script>
  <script src="js/personal.js"></script>
  <script src="js/function.js"></script>
</body>
</html>
